<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>silenceper â€“ Hairpin</title><link>/tags/hairpin/</link><description>Recent content in Hairpin on silenceper</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Thu, 30 Apr 2020 11:26:59 +0800</lastBuildDate><atom:link href="/tags/hairpin/index.xml" rel="self" type="application/rss+xml"/><item><title>è®°ä¸€æ¬¡é—®é¢˜æ’æŸ¥ï¼šä¸ºä»€ä¹ˆåœ¨PODæ— æ³•é€šè¿‡Serviceè®¿é—®è‡ªå·±ï¼Ÿ</title><link>/blog/202004/bridge-hairpin-mod/</link><pubDate>Thu, 30 Apr 2020 11:26:59 +0800</pubDate><guid>/blog/202004/bridge-hairpin-mod/</guid><description>
&lt;h2&gt;é—®é¢˜ç°è±¡&lt;span class="hx-absolute -hx-mt-20" id="é—®é¢˜ç°è±¡"&gt;&lt;/span&gt;
&lt;a href="#%e9%97%ae%e9%a2%98%e7%8e%b0%e8%b1%a1" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;åˆ›å»ºä¸€ä¸ªnginx podï¼Œå¹¶é…ç½®äº†serviceè®¿é—®ï¼Œserviceåç«¯æŒ‡å‘podã€‚&lt;/p&gt;
&lt;p&gt;è¿›å…¥podä¸­ä½¿ç”¨service ip æˆ–è€…service åŸŸåï¼Œæ— æ³•è®¿é—®ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ç¯å¢ƒé…ç½®æˆ–è€…k8sç‰ˆæœ¬ï¼ˆ1.9ï¼‰çš„é—®é¢˜ï¼Œåœ¨å…¶ä»–1.13çš„kubernetesç¯å¢ƒä¸‹ä¹Ÿè¯•äº†ï¼Œè¿˜æ˜¯åŒæ ·çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2&gt;ç¯å¢ƒé…ç½®&lt;span class="hx-absolute -hx-mt-20" id="ç¯å¢ƒé…ç½®"&gt;&lt;/span&gt;
&lt;a href="#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;ä½¿ç”¨çš„cniæ’ä»¶æ˜¯flannelï¼Œä½†ä¸æ˜¯å®¹å™¨åŒ–å®‰è£…ï¼Œä¹Ÿä¸æ˜¯æ ‡å‡†åŒ–çš„é€šè¿‡kubeletæŒ‡å®šcni pluginï¼ˆ&amp;ndash;cni-bin-dir,&amp;ndash;cni-conf-dirå‚æ•°ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡dockerd æä¾›çš„&lt;code&gt;-bip&lt;/code&gt;å‚æ•°æŒ‡å®šå®¹å™¨çš„å­ç½‘ï¼Œè€Œè¿™ä¸ªå€¼æ˜¯ä»&lt;code&gt;/run/flannel/subnet.env&lt;/code&gt;(flannelä¼šå°†è·å–åˆ°çš„å­ç½‘å†™å…¥åˆ°è¯¥æ–‡ä»¶)&lt;/p&gt;
&lt;h2&gt;æ’æŸ¥è¿‡ç¨‹&lt;span class="hx-absolute -hx-mt-20" id="æ’æŸ¥è¿‡ç¨‹"&gt;&lt;/span&gt;
&lt;a href="#%e6%8e%92%e6%9f%a5%e8%bf%87%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1ã€é¦–å…ˆå°è¯•é€šè¿‡pod ipå°è¯•æ˜¯å¦å¯è®¿é—®ï¼Œå·²éªŒè¯æ˜¯å¯é€šçš„ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2ã€å°è¯•å¯¹docker0ç½‘æ¡¥è¿›è¡ŒæŠ“åŒ…&lt;/strong&gt;&lt;/p&gt;
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code"&gt;
&lt;div&gt;&lt;pre&gt;&lt;code&gt;tcpdump -i docker0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
&gt;
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"&gt;&lt;/div&gt;
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;ç¥å¥‡çš„åœ¨è¿™é‡Œï¼Œå†æ¬¡å°è¯•é€šè¿‡service è®¿é—®æ˜¯å±…ç„¶å¯ä»¥é€šï¼Œå‘ç°åªè¦tcpdumpæ–­å¼€å°±ä¸è¡Œäº†ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;åˆ°è¿™é‡Œçš„æ—¶å€™æœ‰ç‚¹è§‰å¾—è¯¡å¼‚äº†&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨podå†…é€šè¿‡serviceè®¿é—®çš„æ—¶å€™ç½‘ç»œçš„æµå‘åº”è¯¥æ˜¯&lt;/p&gt;
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code"&gt;
&lt;div&gt;&lt;pre&gt;&lt;code&gt;podå†…éƒ¨è®¿é—®service-&amp;gt;docker0ç½‘æ¡¥-&amp;gt;å®¿ä¸»æœºçš„iptablesè§„åˆ™-&amp;gt;docker0ç½‘æ¡¥-&amp;gt;podå†…éƒ¨&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
&gt;
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"&gt;&lt;/div&gt;
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;æŸ¥é˜…äº†ç›¸å…³èµ„æ–™åï¼Œçœ‹åˆ°kubeletæœ‰ä¸ª&lt;code&gt;--hairpin-mod&lt;/code&gt;å‚æ•°ï¼š&lt;/p&gt;
&lt;p&gt;æ–‡æ¡£è¯´æ˜ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚æœç½‘ç»œæ²¡æœ‰ä¸ºâ€œå‘å¤¹æ¨¡å¼â€æµé‡ç”Ÿæˆæ­£ç¡®é…ç½®ï¼Œé€šå¸¸å½“ kube-proxy ä»¥ iptables æ¨¡å¼è¿è¡Œï¼Œå¹¶ä¸” Pod ä¸æ¡¥æ¥ç½‘ç»œè¿æ¥æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚Kubelet å…¬å¼€äº†ä¸€ä¸ª hairpin-mode æ ‡å¿—ï¼Œå¦‚æœ pod è¯•å›¾è®¿é—®å®ƒä»¬è‡ªå·±çš„ Service VIPï¼Œå°±å¯ä»¥è®© Service çš„ç«¯ç‚¹é‡æ–°è´Ÿè½½åˆ°ä»–ä»¬è‡ªå·±èº«ä¸Šã€‚hairpin-mode æ ‡å¿—å¿…é¡»è®¾ç½®ä¸º hairpin-veth æˆ–è€… promiscuous-bridgeã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¯æ˜¯æˆ‘è®¾ç½®ä¹‹åè¿˜æ˜¯æ²¡æœ‰è¿˜æ˜¯ä¸è¡Œï¼Œç¿»äº†ä¸€ä¸‹kubeleté‡Œé¢çš„ä»£ç ï¼Œå‘ç°cniç»„ä»¶å¹¶æ²¡æœ‰å–è¿™ä¸ªå€¼åšä»»ä½•æ‰åšï¼ˆåœ¨kubnetä¸­æœ‰ï¼‰&lt;/p&gt;
&lt;p&gt;æŸ¥çœ‹è¿™ä¸ªè®¨è®ºï¼š
&lt;a href="https://github.com/kubernetes/kubernetes/issues/45790" target="_blank" rel="noopener"&gt;https://github.com/kubernetes/kubernetes/issues/45790&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¤§è‡´ç»“è®ºæ˜¯ï¼Œåº”è¯¥ç”±cniæ’ä»¶æ¥æ ¹æ®è¿™ä¸ªå€¼æ¥åšå¯¹åº”çš„æ“ä½œã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿˜æ˜¯æ²¡è§£å†³æˆ‘çš„é—®é¢˜ï¼Ÿ&lt;/p&gt;
&lt;p&gt;ä¸è¿‡æˆ‘çœ‹åˆ°hairpinå¼€å¯çš„æ ‡å¿—ä½æ˜¯é€šè¿‡&lt;code&gt;/sys/devices/virtual/net/docker0/brif/veth-xxx/hairpin_mod&lt;/code&gt; å†…å®¹è®¾ç½®ä¸º1å¼€å¯çš„ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥æˆ‘å°†æ‰€æœ‰vethè¯¥æ–‡ä»¶å†…å®¹è®¾ç½®&lt;code&gt;1&lt;/code&gt;&lt;/p&gt;
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code"&gt;
&lt;div&gt;&lt;pre&gt;&lt;code&gt;for intf in /sys/devices/virtual/net/docker0/brif/*; do echo 1&amp;gt; $intf/hairpin_mod; done&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0"&gt;
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
&gt;
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"&gt;&lt;/div&gt;
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"&gt;&lt;/div&gt;
&lt;/button&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¯ä»¥è®¿é—®äº†ã€‚ğŸ˜º&lt;/p&gt;
&lt;h2&gt;è§£ç–‘ï¼špromiscuous-bridge ä¸ hairpin-veth&lt;span class="hx-absolute -hx-mt-20" id="è§£ç–‘promiscuous-bridge-ä¸-hairpin-veth"&gt;&lt;/span&gt;
&lt;a href="#%e8%a7%a3%e7%96%91promiscuous-bridge-%e4%b8%8e-hairpin-veth" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆæˆ‘æ— æ³•è®¿é—®&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;bridgeä¸å…è®¸åŒ…ä»æ”¶åˆ°åŒ…çš„ç«¯å£å‘å‡ºï¼Œæ¯”å¦‚è¿™ç§æƒ…å†µï¼Œåœ¨podå†…é€šè¿‡docker0è®¿é—®serviceï¼Œåç»­åˆé€šè¿‡docker0ç½‘æ¡¥è¿›æ¥ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯&lt;code&gt;hairpin_mod&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆä½¿ç”¨tcpdump å¯ä»¥è®©è®¿é—®å¯é€šï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å› ä¸ºtcpdumpè¦æŠ“å–æ‰€æœ‰ç»è¿‡è¯¥ç½‘å¡ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯æ··æ‚æ¨¡å¼ã€‚å¯ä»¥åœ¨/var/log/messageçœ‹åˆ°&lt;code&gt;device docker0 entered promiscuous mode&lt;/code&gt;çš„logã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ··æ‚æ¨¡å¼ï¼ˆè‹±èªï¼špromiscuous modeï¼‰æ˜¯ç”µè„‘ç½‘ç»œä¸­çš„æœ¯è¯­ã€‚ æ˜¯æŒ‡ä¸€å°æœºå™¨çš„ç½‘å¡èƒ½å¤Ÿæ¥æ”¶æ‰€æœ‰ç»è¿‡å®ƒçš„æ•°æ®æµï¼Œè€Œä¸è®ºå…¶ç›®çš„åœ°å€æ˜¯å¦æ˜¯å®ƒã€‚ ä¸€èˆ¬è®¡ç®—æœºç½‘å¡éƒ½å·¥ä½œåœ¨éæ··æ‚æ¨¡å¼ä¸‹ï¼Œæ­¤æ—¶ç½‘å¡åªæ¥å—æ¥è‡ªç½‘ç»œç«¯å£çš„ç›®çš„åœ°å€æŒ‡å‘è‡ªå·±çš„æ•°æ®ã€‚ å½“ç½‘å¡å·¥ä½œåœ¨æ··æ‚æ¨¡å¼ä¸‹æ—¶ï¼Œç½‘å¡å°†æ¥è‡ªæ¥å£çš„æ‰€æœ‰æ•°æ®éƒ½æ•è·å¹¶äº¤ç»™ç›¸åº”çš„é©±åŠ¨ç¨‹åºã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ‰‹åŠ¨å¼€å…³å‘½ä»¤ï¼š
&lt;code&gt;ifconfig docker0 promisc on/off&lt;/code&gt;&lt;/p&gt;
&lt;h2&gt;æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“"&gt;&lt;/span&gt;
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section"&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;å…¶å®æˆ‘ä»¬é›†ç¾¤é€šè¿‡è¿™ç§æ¯”è¾ƒå¦ç±»çš„æ–¹å¼æ¥åˆ†é…POD IPä¹Ÿç”¨äº†äº†å¾ˆä¹…äº†ï¼Œä¹‹æ‰€ä»¥æ²¡å‡ºé—®é¢˜ï¼Œåº”è¯¥æ˜¯ä¸šåŠ¡åŸºæœ¬æ²¡é‡åˆ°è¿™ç§podå†…é€šè¿‡serviceè®¿é—®è‡ªå·±çš„æƒ…å†µã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥è¿˜æ˜¯è¦è·Ÿç€æ ‡å‡†çš„k8sæ–¹å¼æ¥å®‰è£…cniï¼Œé¿å…å…¥å‘ï¼Œæ¯”å¦‚flannelå°±å·²ç»æä¾›ç»™äº†&lt;code&gt;hairpinMode &lt;/code&gt;å‚æ•°æ¥è¿›è¡Œé…ç½®å¼€å¯ã€‚&lt;/p&gt;</description></item></channel></rss>
<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Go on silenceper blog</title>
    <link>https://silenceper.github.io/tags/go/</link>
    <description>Recent content in Go on silenceper blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-CN</language>
    <lastBuildDate>Sun, 20 Nov 2016 02:40:59 +0800</lastBuildDate>
    <atom:link href="https://silenceper.github.io/tags/go/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>èŠèŠTCPè¿æ¥æ± </title>
      <link>https://silenceper.github.io/blog/201611/%E8%81%8A%E8%81%8Atcp%E8%BF%9E%E6%8E%A5%E6%B1%A0/</link>
      <pubDate>Sun, 20 Nov 2016 02:40:59 +0800</pubDate>
      
      <guid>https://silenceper.github.io/blog/201611/%E8%81%8A%E8%81%8Atcp%E8%BF%9E%E6%8E%A5%E6%B1%A0/</guid>
      <description>

&lt;p&gt;æ¦‚è§ˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± &#34;&gt;ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;è¿æ¥å¤±æ•ˆ&#34;&gt;è¿æ¥å¤±æ•ˆ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;database/sql ä¸­çš„è¿æ¥æ± &#34;&gt;database/sql ä¸­çš„è¿æ¥æ± &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;ä½¿ç”¨è¿æ¥æ± ç®¡ç†Thrifté“¾æ¥&#34;&gt;ä½¿ç”¨è¿æ¥æ± ç®¡ç†Thrifté“¾æ¥&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h1 id=&#34;ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± &#34;&gt;ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± &lt;/h1&gt;

&lt;p&gt;æˆ‘è§‰å¾—ä½¿ç”¨è¿æ¥æ± æœ€å¤§çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯&lt;strong&gt;å‡å°‘è¿æ¥çš„åˆ›å»ºå’Œå…³é—­ï¼Œå¢åŠ ç³»ç»Ÿè´Ÿè½½èƒ½åŠ›&lt;/strong&gt;ï¼Œ
ä¹‹å‰å°±æœ‰é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼š&lt;a href=&#34;http://silenceper.com/blog/201601/tcp-time_wait%E8%BF%9E%E6%8E%A5%E6%95%B0%E8%BF%87%E5%A4%9A%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E4%B8%8D%E5%8F%AF%E7%94%A8/&#34;&gt;TCP TIME_WAITè¿æ¥æ•°è¿‡å¤šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨&lt;/a&gt;ï¼Œå› ä¸ºæœªå¼€å¯æ•°æ®åº“è¿æ¥æ± ï¼Œå†åŠ ä¸Šmysqlå¹¶å‘è¾ƒå¤§ï¼Œå¯¼è‡´éœ€è¦é¢‘ç¹çš„åˆ›å»ºé“¾æ¥ï¼Œæœ€ç»ˆäº§ç”Ÿäº†ä¸Šä¸‡çš„TIME_WAITçš„tcpé“¾æ¥ï¼Œå½±å“äº†ç³»ç»Ÿæ€§èƒ½ã€‚&lt;/p&gt;

&lt;p&gt;é“¾æ¥æ± ä¸­çš„çš„åŠŸèƒ½ä¸»è¦æ˜¯ç®¡ç†ä¸€å †çš„é“¾æ¥ï¼ŒåŒ…æ‹¬åˆ›å»ºå’Œå…³é—­ï¼Œæ‰€ä»¥è‡ªå·±åœ¨&lt;a href=&#34;fatih/pool&#34;&gt;fatih/pool&lt;/a&gt;åŸºç¡€ä¸Šï¼Œæ”¹é€ äº†ä¸€ä¸‹ï¼š&lt;a href=&#34;https://github.com/silenceper/pool&#34;&gt;https://github.com/silenceper/pool&lt;/a&gt; ï¼Œä½¿å¾—æ›´åŠ é€šç”¨ä¸€äº›ï¼Œå¢åŠ çš„ä¸€äº›åŠŸèƒ½ç‚¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è¿æ¥å¯¹è±¡ä¸å•å•æ˜¯&lt;code&gt;net.Conn&lt;/code&gt;,å˜ä¸ºäº†&lt;code&gt;interface{}&lt;/code&gt;ï¼ˆæ± ä¸­å­˜å‚¨è‡ªå·±æƒ³è¦çš„æ ¼å¼ï¼‰&lt;/li&gt;
&lt;li&gt;å¢åŠ äº†é“¾æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼ˆä¿è¯äº†å½“è¿æ¥ç©ºé—²å¤ªä¹…ï¼Œé“¾æ¥å¤±æ•ˆçš„é—®é¢˜ï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸»è¦æ˜¯ç”¨åˆ°äº†&lt;code&gt;channel&lt;/code&gt;æ¥ç®¡ç†è¿æ¥ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¾ˆå¥½çš„åˆ©ç”¨ç®¡é“çš„é¡ºåºæ€§ï¼Œå½“éœ€è¦ä½¿ç”¨çš„æ—¶å€™&lt;code&gt;Get&lt;/code&gt;ä¸€ä¸ªè¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•ä¹‹å&lt;code&gt;Put&lt;/code&gt;æ”¾å›&lt;code&gt;channel&lt;/code&gt;ä¸­ã€‚&lt;/p&gt;

&lt;h1 id=&#34;è¿æ¥å¤±æ•ˆ&#34;&gt;è¿æ¥å¤±æ•ˆ&lt;/h1&gt;

&lt;p&gt;ä½¿ç”¨è¿æ¥æ± ä¹‹åå°±ä¸å†æ˜¯çŸ­è¿æ¥ï¼Œè€Œæ˜¯é•¿è¿æ¥äº†ï¼Œå°±å¼•å‘äº†ä¸€äº›é—®é¢˜ï¼š&lt;/p&gt;

&lt;h4 id=&#34;1-é•¿æ—¶é—´ç©ºé—²-è¿æ¥æ–­å¼€&#34;&gt;1ã€é•¿æ—¶é—´ç©ºé—²ï¼Œè¿æ¥æ–­å¼€ï¼Ÿ&lt;/h4&gt;

&lt;p&gt;å› ä¸ºç½‘ç»œç¯å¢ƒæ˜¯å¤æ‚çš„ï¼Œä¸­é—´å¯èƒ½å› ä¸ºé˜²ç«å¢™ç­‰åŸå› ï¼Œå¯¼è‡´é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥ä¼šæ–­å¼€ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸¤ä¸ªæ–¹æ³•æ¥è§£å†³ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å®¢æˆ·ç«¯å¢åŠ å¿ƒè·³ï¼Œå®šæ—¶çš„ç»™æœåŠ¡ç«¯å‘é€è¯·æ±‚&lt;/li&gt;
&lt;li&gt;ç»™è¿æ¥æ± ä¸­çš„è¿æ¥å¢åŠ æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œè¶…æ—¶çš„è¿æ¥ä¸å†ä½¿ç”¨&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åœ¨&lt;a href=&#34;[https://github.com/silenceper/pool]&#34;&gt;https://github.com/silenceper/pool&lt;/a&gt;å°±å¢åŠ äº†ä¸€ä¸ªè¿™æ ·æœ€å¤§ç©ºé—²æ—¶é—´çš„å‚æ•°ï¼Œåœ¨è¿æ¥åˆ›å»ºæˆ–è€…è¿æ¥è¢«é‡æ–°è¿”å›è¿æ¥æ± ä¸­æ—¶é‡ç½®ï¼Œç»™æ¯ä¸ªè¿æ¥éƒ½å¢åŠ äº†ä¸€ä¸ªè¿æ¥çš„åˆ›å»ºæ—¶é—´ï¼Œåœ¨å–å‡ºçš„æ—¶å€™å¯¹æ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼š&lt;a href=&#34;https://github.com/silenceper/pool/blob/master/channel.go#L85&#34;&gt;https://github.com/silenceper/pool/blob/master/channel.go#L85&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&#34;2-å½“æœåŠ¡ç«¯é‡å¯ä¹‹å-è¿æ¥å¤±æ•ˆ&#34;&gt;2ã€å½“æœåŠ¡ç«¯é‡å¯ä¹‹åï¼Œè¿æ¥å¤±æ•ˆï¼Ÿ&lt;/h4&gt;

&lt;p&gt;è¿œç¨‹æœåŠ¡ç«¯å¾ˆæœ‰å¯èƒ½é‡å¯ï¼Œé‚£ä¹ˆä¹‹å‰åˆ›å»ºçš„é“¾æ¥å°±å¤±æ•ˆäº†ã€‚å®¢æˆ·ç«¯åœ¨ä½¿ç”¨çš„æ—¶å€™å°±éœ€è¦åˆ¤æ–­è¿™äº›å¤±æ•ˆçš„è¿æ¥å¹¶ä¸¢å¼ƒï¼Œåœ¨&lt;code&gt;database/sql&lt;/code&gt;ä¸­å°±åˆ¤æ–­äº†è¿™äº›å¤±æ•ˆçš„è¿æ¥ï¼Œä½¿ç”¨è¿™ç§é”™è¯¯è¡¨ç¤º&lt;code&gt;var ErrBadConn = errors.New(&amp;quot;driver: bad connection&amp;quot;)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;å¦å¤–å€¼å¾—ä¸€æçš„å°±æ˜¯åœ¨&lt;code&gt;database/sql&lt;/code&gt;å¯¹è¿™ç§&lt;code&gt;ErrBadConn&lt;/code&gt;é”™è¯¯è¿›è¡Œäº†é‡è¯•ï¼Œé»˜è®¤é‡è¯•æ¬¡æ•°æ˜¯ä¸¤æ¬¡ï¼Œæ‰€ä»¥èƒ½å¤Ÿä¿è¯å³ä¾¿æ˜¯é“¾æ¥å¤±æ•ˆæˆ–è€…æ–­å¼€äº†ï¼Œæœ¬æ¬¡çš„è¯·æ±‚èƒ½å¤Ÿæ­£å¸¸å“åº”ï¼ˆç»§ç»­å¾€ä¸‹çœ‹å°±æ˜¯åˆ†æäº†ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;è¿æ¥å¤±æ•ˆçš„ç‰¹å¾&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¯¹è¿æ¥è¿›è¡Œreadè¯»æ“ä½œæ—¶ï¼Œè¿”å›&lt;code&gt;EOF&lt;/code&gt;é”™è¯¯&lt;/li&gt;
&lt;li&gt;å¯¹è¿æ¥è¿›è¡Œwriteæ“ä½œæ—¶ï¼Œè¿”å›&lt;code&gt;write tcp 127.0.0.1:52089-&amp;gt;127.0.0.1:8002: write: broken pipe&lt;/code&gt;é”™è¯¯&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;database-sql-ä¸­çš„è¿æ¥æ± &#34;&gt;database/sql ä¸­çš„è¿æ¥æ± &lt;/h1&gt;

&lt;p&gt;åœ¨&lt;code&gt;database/sql&lt;/code&gt;ä¸­ä½¿ç”¨è¿æ¥è¿æ¥æ± å¾ˆç®€å•ï¼Œä¸»è¦æ¶‰åŠä¸‹é¢è¿™äº›é…ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;	db.SetMaxIdleConns(10) //è¿æ¥æ± ä¸­æœ€å¤§ç©ºé—²è¿æ¥æ•°
	db.SetMaxOpenConns(20) //æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°
	db.SetConnMaxLifetime(300*time.Second)//è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´(å¯é€‰)
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æ³¨ï¼šå¦‚æœ&lt;code&gt;MaxIdleConns&lt;/code&gt;å¤§äº0å¹¶ä¸”&lt;code&gt;MaxOpenConns&lt;/code&gt;å°äº&lt;code&gt;MaxIdleConns&lt;/code&gt;,é‚£ä¹ˆä¼šå°†&lt;code&gt;MaxIdleConns&lt;/code&gt;ç½®ä¸º&lt;code&gt;MaxIdleConns&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ¥çœ‹ä¸‹dbè¿™ä¸ªç»“æ„ï¼Œä»¥åŠå­—æ®µç›¸å…³è¯´æ˜ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;type DB struct {
	//å…·ä½“çš„æ•°æ®åº“å®ç°çš„interface{},
	//ä¾‹å¦‚https://github.com/go-sql-driver/mysql å°±æ³¨å†Œå¹¶å¹¶å®ç°äº†driver.Openæ–¹æ³•ï¼Œä¸»è¦æ˜¯åœ¨é‡Œé¢å®ç°äº†ä¸€äº›é‰´æƒçš„æ“ä½œ
	driver driver.Driver  
	//dsnè¿æ¥
	dsn    string
	//åœ¨prepared statementä¸­ç”¨åˆ°
	numClosed uint64

	mu           sync.Mutex // protects following fields
	//å¯ä½¿ç”¨çš„ç©ºé—²çš„é“¾æ¥
	freeConn     []*driverConn
	//ç”¨æ¥ä¼ é€’è¿æ¥è¯·æ±‚çš„ç®¡é“
	connRequests []chan connRequest
	//å½“å‰æ‰“å¼€çš„è¿æ¥æ•°
	numOpen      int	
	//å½“éœ€è¦åˆ›å»ºæ–°çš„é“¾æ¥çš„æ—¶å€™ï¼Œå¾€è¿™ä¸ªç®¡é“ä¸­å‘é€ä¸€ä¸ªstructæ•°æ®ï¼Œ
	//å› ä¸ºåœ¨Openæ•°æ®åº“çš„å°±å¯ç”¨äº†ä¸€ä¸ªgoroutineæ‰§è¡ŒconnectionOpeneræ–¹æ³•è¯»å–ç®¡é“ä¸­çš„æ•°æ®
	openerCh    chan struct{}
	//æ•°æ®åº“æ˜¯å¦å·²ç»è¢«å…³é—­
	closed      bool
	//ç”¨æ¥ä¿è¯é”è¢«æ­£ç¡®çš„å…³é—­
	dep         map[finalCloser]depSet
	//stacktrace of last conn&#39;s put; debug only
	lastPut     map[*driverConn]string 
	//æœ€å¤§ç©ºé—²è¿æ¥
	maxIdle     int                  
	//æœ€å¤§æ‰“å¼€çš„è¿æ¥
	maxOpen     int                    
	//è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´
	maxLifetime time.Duration          
	//å®šæ—¶æ¸…ç†ç©ºé—²è¿æ¥çš„ç®¡é“
	cleanerCh   chan struct{}
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;çœ‹ä¸€ä¸ªæŸ¥è¯¢æ•°æ®åº“çš„ä¾‹å­ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;	rows, err := db.Query(&amp;quot;select * from table1&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨è°ƒç”¨&lt;code&gt;db.Query&lt;/code&gt;æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (db *DB) Query(query string, args ...interface{}) (*Rows, error) {
	var rows *Rows
	var err error
	//è¿™é‡Œå°±åšäº†å¯¹å¤±æ•ˆçš„é“¾æ¥çš„é‡è¯•æ“ä½œ
	for i := 0; i &amp;lt; maxBadConnRetries; i++ {
		rows, err = db.query(query, args, cachedOrNewConn)
		if err != driver.ErrBadConn {
			break
		}
	}
	if err == driver.ErrBadConn {
		return db.query(query, args, alwaysNewConn)
	}
	return rows, err
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¿”å›ï¼Œå¯ä»¥ä»è¿™é‡Œçœ‹åˆ°ï¼š
&lt;a href=&#34;https://github.com/go-sql-driver/mysql/blob/master/packets.go#L35&#34;&gt;readPack&lt;/a&gt;ï¼Œ&lt;a href=&#34;https://github.com/go-sql-driver/mysql/blob/master/packets.go#L132&#34;&gt;writePack&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç»§ç»­è·Ÿè¿›å»å°±åˆ°äº†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (db *DB) conn(strategy connReuseStrategy) (*driverConn, error) {
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ–¹æ³•ä¸»è¦æ˜¯åˆ›å»ºtcpè¿æ¥ï¼Œå¹¶åˆ¤æ–­äº†è¿æ¥çš„ç”Ÿå­˜æ—¶é—´lifetimeï¼Œä»¥åŠè¿æ¥æ•°çš„ä¸€äº›é™åˆ¶ï¼Œå¦‚æœè¶…è¿‡çš„è®¾å®šçš„æœ€å¤§æ‰“å¼€é“¾æ¥æ•°é™åˆ¶ç­‰å¾…&lt;code&gt;connRequest&lt;/code&gt;ç®¡é“ä¸­æœ‰è¿æ¥äº§ç”Ÿ(åœ¨&lt;code&gt;putConn&lt;/code&gt;é‡Šæ”¾é“¾æ¥çš„æ—¶å€™å°±ä¼šå¾€è¿™ä¸ªç®¡é“ä¸­å†™å…¥æ•°æ®)&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ä½•æ—¶é‡Šæ”¾é“¾æ¥?&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å½“æˆ‘ä»¬è°ƒç”¨&lt;code&gt;rows.Close()&lt;/code&gt;çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠå½“å‰æ­£åœ¨ä½¿ç”¨çš„é“¾æ¥é‡æ–°æ”¾å›&lt;code&gt;freeConn&lt;/code&gt;æˆ–è€…å†™å…¥åˆ°&lt;code&gt;db.connRequests&lt;/code&gt;ç®¡é“ä¸­&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;	//putConnDBLocked æ–¹æ³•
	
	//å¦‚æœæœ‰db.connRequestsæœ‰åœ¨ç­‰å¾…è¿æ¥çš„è¯ï¼Œå°±æŠŠå½“å‰è¿æ¥ç»™å®ƒç”¨
	if c := len(db.connRequests); c &amp;gt; 0 {
		req := db.connRequests[0]
		// This copy is O(n) but in practice faster than a linked list.
		// TODO: consider compacting it down less often and
		// moving the base instead?
		copy(db.connRequests, db.connRequests[1:])
		db.connRequests = db.connRequests[:c-1]
		if err == nil {
			dc.inUse = true
		}
		req &amp;lt;- connRequest{
			conn: dc,
			err:  err,
		}
		return true
	} else if err == nil &amp;amp;&amp;amp; !db.closed &amp;amp;&amp;amp; db.maxIdleConnsLocked() &amp;gt; len(db.freeConn) {
	//æ²¡äººéœ€è¦æˆ‘è¿™ä¸ªé“¾æ¥ï¼Œæˆ‘å°±æŠŠä»–é‡æ–°è¿”å›`freeConn`è¿æ¥æ± ä¸­
		db.freeConn = append(db.freeConn, dc)
		db.startCleanerLocked()
		return true
	}

&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;ä½¿ç”¨è¿æ¥æ± ç®¡ç†thrifté“¾æ¥&#34;&gt;ä½¿ç”¨è¿æ¥æ± ç®¡ç†Thrifté“¾æ¥&lt;/h1&gt;

&lt;p&gt;è¿™é‡Œæ˜¯ä½¿ç”¨è¿æ¥æ± &lt;a href=&#34;https://github.com/silenceper/pool&#34;&gt;https://github.com/silenceper/pool&lt;/a&gt;ï¼Œå¦‚ä½•æ„å»ºä¸€ä¸ªthrifté“¾æ¥&lt;/p&gt;

&lt;p&gt;å®¢æˆ·ç«¯åˆ›å»ºThriftçš„ä»£ç ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;type Client struct {
	*user.UserClient
}


//åˆ›å»ºThriftå®¢æˆ·ç«¯é“¾æ¥çš„æ–¹æ³•
factory := func() (interface{}, error) {
	protocolFactory := thrift.NewTBinaryProtocolFactoryDefault()
	transportFactory := thrift.NewTTransportFactory()

	var transport thrift.TTransport
	var err error
	transport, err = thrift.NewTSocket(rpcConfig.Listen)
	if err != nil {
		panic(err)
	}
	transport = transportFactory.GetTransport(transport)
	//defer transport.Close()
	if err := transport.Open(); err != nil {
		panic(err)
	}
	rpcClient := user.NewUserClientFactory(transport, protocolFactory)
	//åœ¨è¿æ¥æ± ä¸­ç›´æ¥æ”¾ç½®Clientå¯¹è±¡
	return &amp;amp;Client{UserClient: rpcClient}, nil
}
//å…³é—­è¿æ¥çš„æ–¹æ³•
close := func(v interface{}) error {
	v.(*Client).Transport.Close()
	return nil
}

//åˆ›å»ºäº†ä¸€ä¸ª åˆå§‹åŒ–è¿æ¥æ˜¯
poolConfig := &amp;amp;pool.PoolConfig{
	InitialCap: 10,
	MaxCap:     20,
	Factory:     factory,
	Close:       close,
	IdleTimeout: 300 * time.Second,
}
p, err := pool.NewChannelPool(poolConfig)
if err != nil {
	panic(err)
}

//å–å¾—é“¾æ¥
conn, err := p.Get()
if err != nil {
	return nil, err
}
v, ok := conn.(*Client)

...ä½¿ç”¨è¿æ¥è°ƒç”¨è¿œç¨‹æ–¹æ³•

//å°†è¿æ¥é‡æ–°æ”¾å›è¿æ¥æ± ä¸­
p.Put(conn)

&lt;/code&gt;&lt;/pre&gt;

&lt;hr /&gt;

&lt;p&gt;å†™å®Œï¼Œå¤–é¢å¬è§ğŸ“å¼€å§‹æ‰“é¸£äº†ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Golang ä¸­httpåŒ…é»˜è®¤è·¯ç”±åŒ¹é…è§„åˆ™é˜…è¯»ç¬”è®°</title>
      <link>https://silenceper.github.io/blog/201605/golang-%E4%B8%ADhttp%E5%8C%85%E9%BB%98%E8%AE%A4%E8%B7%AF%E7%94%B1%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/</link>
      <pubDate>Sat, 28 May 2016 18:00:59 +0800</pubDate>
      
      <guid>https://silenceper.github.io/blog/201605/golang-%E4%B8%ADhttp%E5%8C%85%E9%BB%98%E8%AE%A4%E8%B7%AF%E7%94%B1%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/</guid>
      <description>

&lt;h1 id=&#34;ä¸€-æ‰§è¡Œæµç¨‹&#34;&gt;ä¸€ã€æ‰§è¡Œæµç¨‹&lt;/h1&gt;

&lt;p&gt;æ„å»ºä¸€ä¸ªç®€å•http serverï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;package main

import (
	&amp;quot;log&amp;quot;
	&amp;quot;net/http&amp;quot;
)

func main() {
	http.HandleFunc(&amp;quot;/&amp;quot;, func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte(&amp;quot;hello world&amp;quot;))
	})
	log.Fatal(http.ListenAndServe(&amp;quot;:8080&amp;quot;, nil))
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;http://127.0.0.1:8080/&lt;/code&gt; å°±å¯ä»¥çœ‹åˆ°è¾“å‡ºäº†&lt;/p&gt;

&lt;p&gt;é€šè¿‡è·Ÿè¸ªhttp.goåŒ…ä»£ç ï¼Œå¯ä»¥å‘ç°æ‰§è¡Œæµç¨‹åŸºæœ¬å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;h4 id=&#34;1-åˆ›å»ºä¸€ä¸ª-listener-ç›‘å¬-8080-ç«¯å£&#34;&gt;1.åˆ›å»ºä¸€ä¸ª&lt;code&gt;Listener&lt;/code&gt;ç›‘å¬&lt;code&gt;8080&lt;/code&gt;ç«¯å£&lt;/h4&gt;

&lt;h4 id=&#34;2-è¿›å…¥-for-å¾ªç¯å¹¶acceptè¯·æ±‚-æ²¡æœ‰è¯·æ±‚åˆ™å¤„äºé˜»å¡çŠ¶æ€&#34;&gt;2.è¿›å…¥&lt;code&gt;for&lt;/code&gt;å¾ªç¯å¹¶Acceptè¯·æ±‚ï¼Œæ²¡æœ‰è¯·æ±‚åˆ™å¤„äºé˜»å¡çŠ¶æ€&lt;/h4&gt;

&lt;h4 id=&#34;3-æ¥æ”¶åˆ°è¯·æ±‚-å¹¶åˆ›å»ºä¸€ä¸ªconnå¯¹è±¡-æ”¾å…¥goroutineå¤„ç†-å®ç°é«˜å¹¶å‘å…³é”®&#34;&gt;3.æ¥æ”¶åˆ°è¯·æ±‚ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªconnå¯¹è±¡ï¼Œæ”¾å…¥goroutineå¤„ç†ï¼ˆå®ç°é«˜å¹¶å‘å…³é”®ï¼‰&lt;/h4&gt;

&lt;h4 id=&#34;4-è§£æè¯·æ±‚æ¥æºä¿¡æ¯è·å¾—è¯·æ±‚è·¯å¾„ç­‰é‡è¦ä¿¡æ¯&#34;&gt;4.è§£æè¯·æ±‚æ¥æºä¿¡æ¯è·å¾—è¯·æ±‚è·¯å¾„ç­‰é‡è¦ä¿¡æ¯&lt;/h4&gt;

&lt;h4 id=&#34;5-è¯·æ±‚serverhttpæ–¹æ³•-å·²ç»é€šè¿‡ä¸Šä¸€æ­¥è·å¾—äº†responsewriterå’Œrequestå¯¹è±¡&#34;&gt;5.è¯·æ±‚ServerHTTPæ–¹æ³•ï¼Œå·²ç»é€šè¿‡ä¸Šä¸€æ­¥è·å¾—äº†ResponseWriterå’ŒRequestå¯¹è±¡&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (sh serverHandler) ServeHTTP(rw ResponseWriter, req *Request) {
	//æ­¤handlerå³ä¸ºhttp.ListenAndServe ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°
	handler := sh.srv.Handler 
	if handler == nil {
		//å¦‚æœhandlerä¸ºç©ºåˆ™ä½¿ç”¨å†…éƒ¨çš„DefaultServeMux è¿›è¡Œå¤„ç†
		handler = DefaultServeMux
	}
	if req.RequestURI == &amp;quot;*&amp;quot; &amp;amp;&amp;amp; req.Method == &amp;quot;OPTIONS&amp;quot; {
		handler = globalOptionsHandler{}
	}
	//è¿™é‡Œå°±å¼€å§‹å¤„ç†httpè¯·æ±‚
	//å¦‚æœéœ€è¦ä½¿ç”¨è‡ªå®šä¹‰çš„muxï¼Œå°±éœ€è¦å®ç°ServeHTTPæ–¹æ³•ï¼Œå³å®ç°Handleræ¥å£ã€‚
	handler.ServeHTTP(rw, req)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;6.è¿›å…¥DefaultServeMuxä¸­çš„é€»è¾‘å°±æ˜¯æ ¹æ®è¯·æ±‚pathåœ¨mapä¸­åŒ¹é…æŸ¥æ‰¾handlerï¼Œå¹¶äº¤ç”±handlerå¤„ç†&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;httpè¯·æ±‚å¤„ç†æµç¨‹æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒ&lt;a href=&#34;https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/03.3.md&#34;&gt;ã€ŠGo Web ç¼–ç¨‹
ã€‹3.3 Goå¦‚ä½•ä½¿å¾—Webå·¥ä½œ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;äºŒ-defaultservemux-è·¯ç”±åŒ¹é…è§„åˆ™&#34;&gt;äºŒã€DefaultServeMux è·¯ç”±åŒ¹é…è§„åˆ™&lt;/h1&gt;

&lt;p&gt;å…ˆçœ‹å‡ ä¸ªè·¯ç”±è§„åˆ™ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;package main

import (
	&amp;quot;log&amp;quot;
	&amp;quot;net/http&amp;quot;
)

func main() {
	//è§„åˆ™1
	http.HandleFunc(&amp;quot;/&amp;quot;, func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte(&amp;quot;hello world&amp;quot;))
	})
	
	//è§„åˆ™2
	http.HandleFunc(&amp;quot;/path/&amp;quot;, func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte(&amp;quot;pattern path: /path/ &amp;quot;))
	})

	//è§„åˆ™3
	http.HandleFunc(&amp;quot;/path/subpath&amp;quot;, func(w http.ResponseWriter, r *http.Request) {
		w.Write([]byte(&amp;quot;pattern path: /path/subpath&amp;quot;))
	})

	log.Fatal(http.ListenAndServe(&amp;quot;:8080&amp;quot;, nil))
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æƒ…æ™¯ä¸€ï¼š&lt;/p&gt;

&lt;p&gt;è®¿é—®ï¼š&lt;code&gt;http://127.0.0.1:8080/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;è¿”å›ï¼š&lt;code&gt;hello world&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;æƒ…æ™¯äºŒï¼š&lt;/p&gt;

&lt;p&gt;è®¿é—®ï¼š&lt;code&gt;http://127.0.0.1:8080/path&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;è¿”å›ï¼š&lt;code&gt;pattern path: /path/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;æƒ…æ™¯ä¸‰ï¼š&lt;/p&gt;

&lt;p&gt;è®¿é—®ï¼š&lt;code&gt;http://127.0.0.1:8080/path/subpath/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;è¿”å›ï¼š&lt;code&gt;pattern path: /path/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;æƒ…æ™¯å››ï¼š&lt;/p&gt;

&lt;p&gt;è®¿é—®ï¼š&lt;code&gt;http://127.0.0.1:8080/hahaha/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;è¿”å›ï¼š&lt;code&gt;hello world&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;å…ˆè¯´æ˜ä¸€äº›è§„åˆ™å§ï¼Œå†çœ‹ä»£ç æ˜¯æ€ä¹ˆå®ç°çš„ï¼š&lt;/p&gt;

&lt;p&gt;1.å¦‚æœåŒ¹é…è·¯å¾„ä¸­åå¸¦æœ‰&lt;code&gt;/&lt;/code&gt;ï¼Œåˆ™ä¼šè‡ªåŠ¨å¢åŠ ä¸€ä¸ªåŒ¹é…è§„åˆ™ä¸å¸¦&lt;code&gt;/&lt;/code&gt;åç¼€çš„ï¼Œå¹¶è·³è½¬è½¬åˆ°&lt;code&gt;path/&lt;/code&gt;,è§£é‡Šäº†æƒ…æ™¯äºŒçš„åœºæ™¯ï¼Œä¸ºä»€ä¹ˆåŒ¹é…åˆ°çš„&lt;code&gt;/path/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;2.æˆ‘è®¾ç½®äº†è¿™ä¹ˆå¤šè§„åˆ™ä¸ºä»€ä¹ˆè§„åˆ™ä¸€å¯ä»¥é€šç”¨åŒ¹é…æœªè®¾ç½®çš„è·¯ç”±ä¿¡æ¯ï¼Œè€Œä¸”åˆä¸å½±å“å·²ç»å­˜åœ¨è·¯ç”±ï¼Œ å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ&lt;/p&gt;

&lt;h2 id=&#34;2-1-æ·»åŠ è·¯ç”±è§„åˆ™&#34;&gt;2.1 æ·»åŠ è·¯ç”±è§„åˆ™&lt;/h2&gt;

&lt;p&gt;å…ˆçœ‹ä¸¤ä¸ªstructï¼Œè¿™æ˜¯å­˜æ”¾é»˜è®¤è·¯ç”±è§„åˆ™çš„ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;type ServeMux struct {
	mu    sync.RWMutex  //å¤„ç†å¹¶å‘ï¼Œå¢åŠ è¯»å†™é”
	m     map[string]muxEntry  //å­˜æ”¾è§„åˆ™mapï¼Œkeyå³ä¸ºè®¾ç½®çš„path
	hosts bool // whether any patterns contain hostnamesï¼ˆæ˜¯å¦åŒ…å«hostï¼‰
}

type muxEntry struct {
	explicit bool //æ˜¯å¦å®Œå…¨åŒ¹é…
	h        Handler//ç›¸åº”åŒ¹é…è§„åˆ™çš„handler
	pattern  string//åŒ¹é…è·¯å¾„
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡è·Ÿè¸ª&lt;code&gt;http.HandleFunc&lt;/code&gt;å®šä½åˆ°å¦‚ä¸‹ä»£ç ï¼Œæ­£æ˜¯å¾€ä¸Šé¢ä¸¤ä¸ª&lt;code&gt;struct&lt;/code&gt;ä¸­å¢åŠ è§„åˆ™ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (mux *ServeMux) Handle(pattern string, handler Handler) {
	mux.mu.Lock()
	defer mux.mu.Unlock()

	if pattern == &amp;quot;&amp;quot; {
		panic(&amp;quot;http: invalid pattern &amp;quot; + pattern)
	}
	if handler == nil {
		panic(&amp;quot;http: nil handler&amp;quot;)
	}
	//å¦‚æœå·²ç»åŒ¹é…åˆ°äº†åˆ™panic
	if mux.m[pattern].explicit {
		panic(&amp;quot;http: multiple registrations for &amp;quot; + pattern)
	}
    
    //å¢åŠ ä¸€ä¸ªæ–°çš„åŒ¹é…è§„åˆ™
	mux.m[pattern] = muxEntry{explicit: true, h: handler, pattern: pattern}
	
	//æ ¹æ®pathçš„ç¬¬ä¸€ä¸ªå­—æ¯åˆ¤æ–­æ˜¯å¦æœ‰host
	if pattern[0] != &#39;/&#39; {
		mux.hosts = true
	}

	//ï¼ï¼è¿™é‡Œçœ‹æ¸…æ¥š å°±æ˜¯å®ç°äº†æƒ…æ™¯äºŒçš„æƒ…å†µ ï¼Œçœ‹åˆ¤æ–­æ¡ä»¶
	n := len(pattern)
	if n &amp;gt; 0 &amp;amp;&amp;amp; pattern[n-1] == &#39;/&#39; &amp;amp;&amp;amp; !mux.m[pattern[0:n-1]].explicit{
		// If pattern contains a host name, strip it and use remaining
		// path for redirect.
		path := pattern
		if pattern[0] != &#39;/&#39; {
			// In pattern, at least the last character is a &#39;/&#39;, so
			// strings.Index can&#39;t be -1.
			path = pattern[strings.Index(pattern, &amp;quot;/&amp;quot;):]
		}
		url := &amp;amp;url.URL{Path: path}
		mux.m[pattern[0:n-1]] = muxEntry{h: RedirectHandler(url.String(), StatusMovedPermanently), pattern: pattern}
	}
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Šé¢æœ‰ä¸ª&lt;code&gt;Helpful behavior&lt;/code&gt;çš„æ³¨é‡Šè¡Œä¸ºï¼Œå°±æ˜¯å®ç°äº†æƒ…æ™¯äºŒçš„æƒ…å†µï¼Œä»–æ˜¯åˆ¤æ–­å¦‚æœåŒ¹é…çš„è·¯å¾„ä¸­æœ€åå«æœ‰&lt;code&gt;/&lt;/code&gt;ï¼Œå¹¶ä¸”ä¹‹å‰ä¹Ÿä¸å­˜åœ¨æ·»åŠ å»é™¤åæ–œæ çš„è§„åˆ™çš„è¯ï¼Œå°±è‡ªåŠ¨ç»™ä»–å¢åŠ ä¸€ä¸ª301çš„è·³è½¬æŒ‡å‘&lt;code&gt;/path/&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&#34;2-2-æŸ¥æ‰¾è·¯ç”±è§„åˆ™&#34;&gt;2.2 æŸ¥æ‰¾è·¯ç”±è§„åˆ™&lt;/h2&gt;

&lt;p&gt;è·¯ç”±è§„åˆ™çš„æŸ¥æ‰¾å°±æ˜¯ä»&lt;code&gt;ServeMux&lt;/code&gt;ä¸­çš„mapå»åŒ¹é…æŸ¥æ‰¾çš„,çš„åˆ°è¿™ä¸ªhandlerå¹¶æ‰§è¡Œï¼Œåªæ˜¯ä¼šæœ‰ä¸€äº›å¤„ç†æœºåˆ¶ï¼Œæ¯”å¦‚æ€ä¹ˆæ ·ç¡®ä¿è®¿é—®&lt;code&gt;/path/subpath&lt;/code&gt;çš„æ—¶å€™æ˜¯å…ˆåŒ¹é…&lt;code&gt;/path/subpath&lt;/code&gt;è€Œä¸æ˜¯åŒ¹é…&lt;code&gt;/path/&lt;/code&gt;å‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œè·Ÿè¸ªåˆ°äº†&lt;code&gt;mux.match&lt;/code&gt;æ–¹æ³•ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;è¿‡ç¨‹&lt;code&gt;mux.ServerHTTP&lt;/code&gt;-&amp;gt;&lt;code&gt;mux.Handler&lt;/code&gt;-&amp;gt;&lt;code&gt;mux.handler&lt;/code&gt;-&amp;gt;&lt;code&gt;mux.match&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (mux *ServeMux) match(path string) (h Handler, pattern string) {
	var n = 0
	for k, v := range mux.m {
		if !pathMatch(k, path) {
			continue
		}
		//å¦‚æœåŒ¹é…åˆ°äº†ä¸€ä¸ªè§„åˆ™ï¼Œå¹¶æ²¡æœ‰é©¬ä¸Šè¿”å›handlerï¼Œè€Œä¸”ç»§ç»­åŒ¹é…å¹¶ä¸”åˆ¤æ–­pathçš„é•¿åº¦æ˜¯å¦æ˜¯æœ€é•¿çš„ï¼Œè¿™æ˜¯å…³é”®ï¼ï¼ï¼
		if h == nil || len(k) &amp;gt; n {
			n = len(k)
			h = v.h
			pattern = v.pattern
		}
	}
	return
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;1.è¿™é‡Œå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆè®¾ç½®çš„ç²¾ç¡®çš„pathæ˜¯æœ€ä¼˜åŒ¹é…åˆ°çš„ï¼Œå› ä¸ºå®ƒæ˜¯æ ¹æ®pathçš„é•¿åº¦åˆ¤æ–­ã€‚
å½“ç„¶ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ&lt;code&gt;/&lt;/code&gt;å¯ä»¥åŒ¹é…æ‰€æœ‰ï¼ˆçœ‹&lt;code&gt;pathMatch&lt;/code&gt;å‡½æ•°å°±çŸ¥é“äº†ï¼Œ&lt;code&gt;/&lt;/code&gt;æ˜¯åŒ¹é…æ‰€æœ‰çš„ï¼Œåªæ˜¯è¿™æ˜¯æœ€åæ‰è¢«åŒ¹é…æˆåŠŸï¼‰&lt;/p&gt;

&lt;p&gt;2.å¾—åˆ°äº†å¤„ç†è¯·æ±‚çš„handlerï¼Œå†è°ƒç”¨&lt;code&gt;h.ServeHTTP(w, r)&lt;/code&gt;ï¼Œå»æ‰§è¡Œç›¸åº”çš„handleræ–¹æ³•ã€‚&lt;/p&gt;

&lt;p&gt;ç­‰ä¸€ä¸‹ï¼Œhandlerä¸­å“ªé‡Œæœ‰&lt;code&gt;ServeHTTP&lt;/code&gt;è¿™ä¸ªæ–¹æ³•ï¼Ÿï¼Ÿ&lt;/p&gt;

&lt;p&gt;å› ä¸ºåœ¨è°ƒç”¨ &lt;code&gt;http.HandleFunc&lt;/code&gt;çš„æ—¶å€™å·²ç»å°†è‡ªå®šä¹‰çš„handlerå¤„ç†å‡½æ•°ï¼Œå¼ºåˆ¶è½¬ä¸º&lt;code&gt;HandlerFunc&lt;/code&gt;ç±»å‹çš„ï¼Œå°±æ‹¥æœ‰äº†&lt;code&gt;ServeHTTP&lt;/code&gt;æ–¹æ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;type HandlerFunc func(ResponseWriter, *Request)

// ServeHTTP calls f(w, r).
func (f HandlerFunc) ServeHTTP(w ResponseWriter, r *Request) {
	f(w, r)
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;f(w,r)&lt;/code&gt;å°±å®ç°äº†handlerçš„æ‰§è¡Œã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;è„‘å­é‡Œé¢æ¸…æ¥šï¼Œä½†çœŸåˆ°è¡¨è¿°çš„æ—¶å€™ï¼Œå‘µå‘µï¼Œå½“åšç¬”è®°å•¦ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
</description>
    </item>
    
    <item>
      <title>tcp time_waitè¿æ¥æ•°è¿‡å¤šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨</title>
      <link>https://silenceper.github.io/blog/201601/tcp-time_wait%E8%BF%9E%E6%8E%A5%E6%95%B0%E8%BF%87%E5%A4%9A%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E4%B8%8D%E5%8F%AF%E7%94%A8/</link>
      <pubDate>Sun, 03 Jan 2016 15:40:59 +0800</pubDate>
      
      <guid>https://silenceper.github.io/blog/201601/tcp-time_wait%E8%BF%9E%E6%8E%A5%E6%95%B0%E8%BF%87%E5%A4%9A%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E4%B8%8D%E5%8F%AF%E7%94%A8/</guid>
      <description>

&lt;h1 id=&#34;é—®é¢˜å‡ºç°&#34;&gt;é—®é¢˜å‡ºç°ï¼š&lt;/h1&gt;

&lt;p&gt;åœ¨å…ƒæ—¦å‰å¤•ï¼Œè‡ªå·±ç»´æŠ¤çš„ä¸€ä¸ªæœåŠ¡çªç„¶åœ¨é«˜å³°æ—¶æœŸæ”¶åˆ°å¤§é‡æŠ¥è­¦ï¼Œèµ¶ç´§ç™»ä¸ŠæœåŠ¡å™¨çœ‹ä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;æœ€å¼€å§‹çš„ååº”æ˜¯memcache tcp read time out ,å› ä¸ºä¹‹å‰ä¹Ÿå‡ºç°è¿‡ç±»ä¼¼çš„è­¦å‘Šæ‰€ä»¥å¼€å§‹å°è¯•åˆ‡æ¢memcacheï¼Œä½†æ˜¯è¿ç»´åé¦ˆå·²ç»åˆ‡æ¢äº†å¥½å‡ å°è¿˜æ˜¯ä¸èµ·ä½œç”¨ã€‚&lt;/p&gt;

&lt;p&gt;åˆçœ‹åˆ°æœ‰mysql è¿æ¥ä¸ä¸ŠæŠ¥é”™ï¼Œæ€€ç–‘æœºæˆ¿å†…ç½‘æœ‰é—®é¢˜ï¼Œç„¶åæœ‰å¼€å§‹åˆ‡æ¢æœºæˆ¿åŠ æœºå™¨ï¼Œå½“æ—¶é—®é¢˜è¿˜æ˜¯æ²¡æœ‰å¾—åˆ°è§£å†³ï¼Œè¿™ä¸‹çœŸæ™•äº†ã€‚ã€‚ã€‚ã€‚ å®Œå…¨æ’æŸ¥ä¸å‡ºä»€ä¹ˆé—®é¢˜ï¼ˆå› ä¸ºæ˜¯é«˜å³°æ—¶æœŸï¼Œtcpè¿æ¥æ•°è‡ªç„¶å¾ˆé«˜ï¼Œæ²¡æœ‰åœ¨æ„æ˜¯è¿™ä¸ªé—®é¢˜ï¼Œè‡ªå·±é¢„ä¼°ä¸å¤Ÿï¼‰&lt;/p&gt;

&lt;p&gt;åæ¥ååº”è¿‡æ¥çœ‹åˆ°æœ‰å¥½å‡ ä¸ªæ¥å£è¯·æ±‚æ•°å¢åŠ ï¼Œå› ä¸ºå‘ç‰ˆæœ¬çš„åŸå› ï¼Œæ˜¯æ–°ç‰ˆæœ¬æ‰ä¼šè¯·æ±‚è¿™äº›æ¥å£ï¼Œæ‰€ä»¥ æˆ‘æš‚æ—¶å±è”½äº†è¿™å‡ ä¸ªå£æ¥å£é—®é¢˜å¾—åˆ°éåˆ¶ï¼ˆå¹¸å¥½æ˜¯ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°çš„æ¥å£ï¼‰ã€‚&lt;/p&gt;

&lt;h1 id=&#34;æ’æŸ¥&#34;&gt;æ’æŸ¥ï¼š&lt;/h1&gt;

&lt;p&gt;è¿™ä¸ªé—®é¢˜å›´ç»•æˆ‘å¥½å‡ å¤©ï¼Œæˆ‘å±è”½çš„é‚£å‡ ä¸ªæ¥å£ï¼Œåå¤çœ‹äº†å¥½å‡ éï¼Œè€Œä¸”åˆå°†å…¶ä¸­çš„sqlæŸ¥è¯¢åˆ†æï¼Œå¹¶æ²¡æœ‰æ…¢è¯·æ±‚ã€‚ã€‚ã€‚  è¿™ä¸‹åˆå½»åº•æ‡µäº†ï¼Œæ²¡æœ‰å¤´ç»ªã€‚&lt;/p&gt;

&lt;p&gt;è¯´æ¥ä¹Ÿå·§ï¼Œé«˜å³°æ—¶æœŸæˆ‘ç”¨&lt;code&gt;netstat -an&lt;/code&gt; å‘½ä»¤æŸ¥çœ‹äº†ä¸€äº›ï¼Œçœ‹åˆ°å¤§é‡tcp time_wait çš„è¿æ¥ï¼Œèµ¶ç´§Googleäº†ä¸‹ï¼Œtcp time_waitçŠ¶æ€æ˜¯åœ¨ä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹ä¿æŒçš„ä¸€ä¸ªçŠ¶æ€ï¼ˆä¸€èˆ¬æŒ‡å®¢æˆ·ç«¯ï¼‰ï¼Œ&lt;/p&gt;

&lt;p&gt;æ€»å…±çš„è¿æ¥æ•°åœ¨è¿‘3w(ss -så¯æŸ¥)ï¼Œå…¶ä¸­æœ‰2wå¤šéƒ½æ˜¯è¿™ç§è¿æ¥ï¼Œè€Œä¸”éƒ½æ˜¯mysql è¿æ¥ï¼ˆè¿™é‡Œè¾¹æœåŠ¡å™¨ç¨‹åºå°±ç›¸å½“äºå®¢æˆ·ç«¯å»è¿æ¥mysqlæœåŠ¡å™¨ï¼‰ï¼Œåˆ°è¿™é‡Œå¿ƒé‡Œå¤§è‡´æœ‰åº•äº†ï¼ŒæŠŠæ•°æ®åº“è¿æ¥æ± åŠ ä¸Šå°±å¥½äº†ï¼ŒGolangæä¾›äº†ä¸¤ä¸ªå‡½æ•°å¯è¿›è¡Œé…ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;SetMaxOpenConnsç”¨äºè®¾ç½®æœ€å¤§æ‰“å¼€çš„è¿æ¥æ•°ï¼Œé»˜è®¤å€¼ä¸º0è¡¨ç¤ºä¸é™åˆ¶ã€‚
SetMaxIdleConnsç”¨äºè®¾ç½®é—²ç½®çš„è¿æ¥æ•°ã€‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆä¼šæœ‰TIME_WAITçŠ¶æ€ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;æºäºtcpé“¾æ¥å…³é—­ä¸­çš„å››æ¬¡æŒ¥æ‰‹ï¼Œæ˜¯ä¸»åŠ¨å…³é—­é“¾æ¥çš„ä¸€æ–¹äº§ç”Ÿçš„çŠ¶æ€ï¼š
TCPçŠ¶æ€è½¬åŒ–å›¾ä¸‰æ¬¡æ¡æ‰‹/å››æ¬¡æŒ¥æ‰‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;./images/tcp.png&#34; alt=&#34;TCPçŠ¶æ€è½¬åŒ–å›¾&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹ï¼Œè°ƒç”¨close()ï¼›åè®®å±‚å‘é€FINåŒ…&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;è¢«åŠ¨å…³é—­çš„ä¸€æ–¹æ”¶åˆ°FINåŒ…åï¼Œåè®®å±‚å›å¤ACKï¼›ç„¶åè¢«åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œè¿›å…¥CLOSE_WAITçŠ¶æ€ï¼Œä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ç­‰å¾…å¯¹æ–¹å…³é—­ï¼Œåˆ™è¿›å…¥FIN_WAIT_2çŠ¶æ€ï¼›æ­¤æ—¶ï¼Œä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ ç­‰å¾… è¢«åŠ¨å…³é—­ä¸€æ–¹çš„åº”ç”¨ç¨‹åºï¼Œè°ƒç”¨closeæ“ä½œ&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;è¢«åŠ¨å…³é—­çš„ä¸€æ–¹åœ¨å®Œæˆæ‰€æœ‰æ•°æ®å‘é€åï¼Œè°ƒç”¨close()æ“ä½œï¼›æ­¤æ—¶ï¼Œåè®®å±‚å‘é€FINåŒ…ç»™ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œç­‰å¾…å¯¹æ–¹çš„ACKï¼Œè¢«åŠ¨å…³é—­çš„ä¸€æ–¹è¿›å…¥LAST_ACKçŠ¶æ€ï¼›&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹æ”¶åˆ°FINåŒ…ï¼Œåè®®å±‚å›å¤ACKï¼›æ­¤æ—¶ï¼Œä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹ï¼Œè¿›å…¥TIME_WAITçŠ¶æ€ï¼›è€Œè¢«åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œè¿›å…¥CLOSEDçŠ¶æ€&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ç­‰å¾…2MSLæ—¶é—´ï¼Œä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œç»“æŸTIME_WAITï¼Œè¿›å…¥CLOSEDçŠ¶æ€&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ‰€ä»¥time_waitå±äºtcpæ­£å¸¸çš„ä¸€ä¸ªçŠ¶æ€ï¼Œæ˜¯ä¸ºäº†è§£å†³ç½‘ç»œçš„ä¸¢åŒ…å’Œç½‘ç»œä¸ç¨³å®šé”å­˜åœ¨çš„ä¸€ä¸ªçŠ¶æ€ã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸ºå½“å‰æœåŠ¡å™¨å¹¶å‘ç›¸å¯¹è¾ƒå¤§ï¼Œæ‰€ä»¥å­˜åœ¨äº†å¤§é‡çš„é“¾æ¥ä¸ºå…³é—­ï¼Œå¦‚æœåªæ˜¯å‡ ç™¾çš„è¯ï¼Œä¹Ÿä¸ä¼šå½±å“æœåŠ¡å™¨æ€§èƒ½ã€‚&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨è¿æ¥æ± ä¿å­˜é•¿é“¾æ¥ï¼Œå¯ä½¿å¾—é“¾æ¥å¤ç”¨ï¼Œä¸ä¼šå‡ºç°å¤§é‡çš„è¿™ç§çŠ¶æ€ã€‚&lt;/p&gt;

&lt;h1 id=&#34;åæ€&#34;&gt;åæ€ï¼š&lt;/h1&gt;

&lt;p&gt;é—®é¢˜ç»ˆäºæ‰¾åˆ°è§£å†³ï¼Œä½†æ˜¯å›è¿‡å¤´æ¥æƒ³äº†ä¸€ä¸‹ï¼Œå…¶å®ä¸€å¼€å§‹å°±å¯ä»¥å®šä½åˆ°çš„ï¼Œåªæ˜¯å¾ˆå¤šé—®é¢˜é›†ä¸­åœ¨ä¸€èµ·å‡ºç°åè€Œè®©è‡ªå·±ä¸çŸ¥æ‰€æªï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæ˜¯æ•æ„Ÿçš„äººçš„è¯åº”è¯¥é©¬ä¸Šèƒ½å¤Ÿä»tcpçŠ¶æ€ä¸Šçœ‹å‡ºé—®é¢˜ï¼Œä¹‹åçº¿ä¸Šé‡åˆ°é—®é¢˜ï¼Œé‡è¦çš„æ˜¯å…ˆè§£å†³ï¼ˆä¸ç®¡é€šè¿‡ä»€ä¹ˆæ–¹å¼ï¼‰ï¼Œä¹‹åå†ä¸€æ­¥æ­¥æ’æŸ¥ã€‚&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
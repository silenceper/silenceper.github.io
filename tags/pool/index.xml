<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>silenceper â€“ Pool</title><link>//localhost:1313/tags/pool/</link><description>Recent content in Pool on silenceper</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sun, 20 Nov 2016 02:40:59 +0800</lastBuildDate><atom:link href="//localhost:1313/tags/pool/index.xml" rel="self" type="application/rss+xml"/><item><title>èŠèŠè¿æ¥æ± </title><link>//localhost:1313/blog/201611/tcp_connection_pool/</link><pubDate>Sun, 20 Nov 2016 02:40:59 +0800</pubDate><guid>//localhost:1313/blog/201611/tcp_connection_pool/</guid><description>
&lt;p>ä»¥ä¸‹ä¸»è¦ä½¿ç”¨Golangä½œä¸ºç¼–ç¨‹è¯­è¨€&lt;/p>
&lt;h1>ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± &lt;/h1>&lt;p>æˆ‘è§‰å¾—ä½¿ç”¨è¿æ¥æ± æœ€å¤§çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯&lt;strong>å‡å°‘è¿æ¥çš„åˆ›å»ºå’Œå…³é—­ï¼Œå¢åŠ ç³»ç»Ÿè´Ÿè½½èƒ½åŠ›&lt;/strong>ï¼Œ
ä¹‹å‰å°±æœ‰é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼š&lt;a href="http://silenceper.com/blog/201601/tcp-time_wait%E8%BF%9E%E6%8E%A5%E6%95%B0%E8%BF%87%E5%A4%9A%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E4%B8%8D%E5%8F%AF%E7%94%A8/" target="_blank" rel="noopener">TCP TIME_WAITè¿æ¥æ•°è¿‡å¤šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨&lt;/a>ï¼Œå› ä¸ºæœªå¼€å¯æ•°æ®åº“è¿æ¥æ± ï¼Œå†åŠ ä¸Šmysqlå¹¶å‘è¾ƒå¤§ï¼Œå¯¼è‡´éœ€è¦é¢‘ç¹çš„åˆ›å»ºé“¾æ¥ï¼Œæœ€ç»ˆäº§ç”Ÿäº†ä¸Šä¸‡çš„TIME_WAITçš„tcpé“¾æ¥ï¼Œå½±å“äº†ç³»ç»Ÿæ€§èƒ½ã€‚&lt;/p>
&lt;p>é“¾æ¥æ± ä¸­çš„çš„åŠŸèƒ½ä¸»è¦æ˜¯ç®¡ç†ä¸€å †çš„é“¾æ¥ï¼ŒåŒ…æ‹¬åˆ›å»ºå’Œå…³é—­ï¼Œæ‰€ä»¥è‡ªå·±åœ¨&lt;a href="fatih/pool" >fatih/pool&lt;/a>åŸºç¡€ä¸Šï¼Œæ”¹é€ äº†ä¸€ä¸‹ï¼š&lt;a href="https://github.com/silenceper/pool" target="_blank" rel="noopener">https://github.com/silenceper/pool&lt;/a> ï¼Œä½¿å¾—æ›´åŠ é€šç”¨ä¸€äº›ï¼Œå¢åŠ çš„ä¸€äº›åŠŸèƒ½ç‚¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>è¿æ¥å¯¹è±¡ä¸å•å•æ˜¯&lt;code>net.Conn&lt;/code>,å˜ä¸ºäº†&lt;code>interface{}&lt;/code>ï¼ˆæ± ä¸­å­˜å‚¨è‡ªå·±æƒ³è¦çš„æ ¼å¼ï¼‰&lt;/li>
&lt;li>å¢åŠ äº†é“¾æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼ˆä¿è¯äº†å½“è¿æ¥ç©ºé—²å¤ªä¹…ï¼Œé“¾æ¥å¤±æ•ˆçš„é—®é¢˜ï¼‰&lt;/li>
&lt;/ul>
&lt;p>ä¸»è¦æ˜¯ç”¨åˆ°äº†&lt;code>channel&lt;/code>æ¥ç®¡ç†è¿æ¥ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¾ˆå¥½çš„åˆ©ç”¨ç®¡é“çš„é¡ºåºæ€§ï¼Œå½“éœ€è¦ä½¿ç”¨çš„æ—¶å€™&lt;code>Get&lt;/code>ä¸€ä¸ªè¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•ä¹‹å&lt;code>Put&lt;/code>æ”¾å›&lt;code>channel&lt;/code>ä¸­ã€‚&lt;/p>
&lt;h1>è¿æ¥å¤±æ•ˆé—®é¢˜&lt;/h1>&lt;p>ä½¿ç”¨è¿æ¥æ± ä¹‹åå°±ä¸å†æ˜¯çŸ­è¿æ¥ï¼Œè€Œæ˜¯é•¿è¿æ¥äº†ï¼Œå°±å¼•å‘äº†ä¸€äº›é—®é¢˜ï¼š&lt;/p>
&lt;h2>1ã€é•¿æ—¶é—´ç©ºé—²ï¼Œè¿æ¥æ–­å¼€ï¼Ÿ&lt;span class="hx-absolute -hx-mt-20" id="1é•¿æ—¶é—´ç©ºé—²è¿æ¥æ–­å¼€">&lt;/span>
&lt;a href="#1%e9%95%bf%e6%97%b6%e9%97%b4%e7%a9%ba%e9%97%b2%e8%bf%9e%e6%8e%a5%e6%96%ad%e5%bc%80" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å› ä¸ºç½‘ç»œç¯å¢ƒæ˜¯å¤æ‚çš„ï¼Œä¸­é—´å¯èƒ½å› ä¸ºé˜²ç«å¢™ç­‰åŸå› ï¼Œå¯¼è‡´é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥ä¼šæ–­å¼€ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸¤ä¸ªæ–¹æ³•æ¥è§£å†³ï¼š&lt;/p>
&lt;ul>
&lt;li>å®¢æˆ·ç«¯å¢åŠ å¿ƒè·³ï¼Œå®šæ—¶çš„ç»™æœåŠ¡ç«¯å‘é€è¯·æ±‚&lt;/li>
&lt;li>ç»™è¿æ¥æ± ä¸­çš„è¿æ¥å¢åŠ æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œè¶…æ—¶çš„è¿æ¥ä¸å†ä½¿ç”¨&lt;/li>
&lt;/ul>
&lt;p>åœ¨&lt;a href="[https://github.com/silenceper/pool]" >https://github.com/silenceper/pool&lt;/a>å°±å¢åŠ äº†ä¸€ä¸ªè¿™æ ·æœ€å¤§ç©ºé—²æ—¶é—´çš„å‚æ•°ï¼Œåœ¨è¿æ¥åˆ›å»ºæˆ–è€…è¿æ¥è¢«é‡æ–°è¿”å›è¿æ¥æ± ä¸­æ—¶é‡ç½®ï¼Œç»™æ¯ä¸ªè¿æ¥éƒ½å¢åŠ äº†ä¸€ä¸ªè¿æ¥çš„åˆ›å»ºæ—¶é—´ï¼Œåœ¨å–å‡ºçš„æ—¶å€™å¯¹æ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼š&lt;a href="https://github.com/silenceper/pool/blob/master/channel.go#L85" target="_blank" rel="noopener">https://github.com/silenceper/pool/blob/master/channel.go#L85&lt;/a>&lt;/p>
&lt;h2>2ã€å½“æœåŠ¡ç«¯é‡å¯ä¹‹åï¼Œè¿æ¥å¤±æ•ˆï¼Ÿ&lt;span class="hx-absolute -hx-mt-20" id="2å½“æœåŠ¡ç«¯é‡å¯ä¹‹åè¿æ¥å¤±æ•ˆ">&lt;/span>
&lt;a href="#2%e5%bd%93%e6%9c%8d%e5%8a%a1%e7%ab%af%e9%87%8d%e5%90%af%e4%b9%8b%e5%90%8e%e8%bf%9e%e6%8e%a5%e5%a4%b1%e6%95%88" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è¿œç¨‹æœåŠ¡ç«¯å¾ˆæœ‰å¯èƒ½é‡å¯ï¼Œé‚£ä¹ˆä¹‹å‰åˆ›å»ºçš„é“¾æ¥å°±å¤±æ•ˆäº†ã€‚å®¢æˆ·ç«¯åœ¨ä½¿ç”¨çš„æ—¶å€™å°±éœ€è¦åˆ¤æ–­è¿™äº›å¤±æ•ˆçš„è¿æ¥å¹¶ä¸¢å¼ƒï¼Œåœ¨&lt;code>database/sql&lt;/code>ä¸­å°±åˆ¤æ–­äº†è¿™äº›å¤±æ•ˆçš„è¿æ¥ï¼Œä½¿ç”¨è¿™ç§é”™è¯¯è¡¨ç¤º&lt;code>var ErrBadConn = errors.New(&amp;quot;driver: bad connection&amp;quot;)&lt;/code>&lt;/p>
&lt;p>å¦å¤–å€¼å¾—ä¸€æçš„å°±æ˜¯åœ¨&lt;code>database/sql&lt;/code>å¯¹è¿™ç§&lt;code>ErrBadConn&lt;/code>é”™è¯¯è¿›è¡Œäº†é‡è¯•ï¼Œé»˜è®¤é‡è¯•æ¬¡æ•°æ˜¯ä¸¤æ¬¡ï¼Œæ‰€ä»¥èƒ½å¤Ÿä¿è¯å³ä¾¿æ˜¯é“¾æ¥å¤±æ•ˆæˆ–è€…æ–­å¼€äº†ï¼Œæœ¬æ¬¡çš„è¯·æ±‚èƒ½å¤Ÿæ­£å¸¸å“åº”ï¼ˆç»§ç»­å¾€ä¸‹çœ‹å°±æ˜¯åˆ†æäº†ï¼‰ã€‚&lt;/p>
&lt;p>&lt;strong>è¿æ¥å¤±æ•ˆçš„ç‰¹å¾&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>å¯¹è¿æ¥è¿›è¡Œreadè¯»æ“ä½œæ—¶ï¼Œè¿”å›&lt;code>EOF&lt;/code>é”™è¯¯&lt;/li>
&lt;li>å¯¹è¿æ¥è¿›è¡Œwriteæ“ä½œæ—¶ï¼Œè¿”å›&lt;code>write tcp 127.0.0.1:52089-&amp;gt;127.0.0.1:8002: write: broken pipe&lt;/code>é”™è¯¯&lt;/li>
&lt;/ul>
&lt;h1>database/sql ä¸­çš„è¿æ¥æ± &lt;/h1>&lt;p>åœ¨&lt;code>database/sql&lt;/code>ä¸­ä½¿ç”¨è¿æ¥è¿æ¥æ± å¾ˆç®€å•ï¼Œä¸»è¦æ¶‰åŠä¸‹é¢è¿™äº›é…ç½®ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetMaxIdleConns&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//è¿æ¥æ± ä¸­æœ€å¤§ç©ºé—²è¿æ¥æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetMaxOpenConns&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetConnMaxLifetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">300&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="c1">//è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´(å¯é€‰)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>æ³¨ï¼šå¦‚æœ&lt;code>MaxIdleConns&lt;/code>å¤§äº0å¹¶ä¸”&lt;code>MaxOpenConns&lt;/code>å°äº&lt;code>MaxIdleConns &lt;/code>,é‚£ä¹ˆä¼šå°†&lt;code>MaxIdleConns&lt;/code>ç½®ä¸º&lt;code>MaxOpenConns&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>æ¥çœ‹ä¸‹dbè¿™ä¸ªç»“æ„ï¼Œä»¥åŠå­—æ®µç›¸å…³è¯´æ˜ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">DB&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å…·ä½“çš„æ•°æ®åº“å®ç°çš„interface{},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ä¾‹å¦‚https://github.com/go-sql-driver/mysql å°±æ³¨å†Œå¹¶å¹¶å®ç°äº†driver.Openæ–¹æ³•ï¼Œä¸»è¦æ˜¯åœ¨é‡Œé¢å®ç°äº†ä¸€äº›é‰´æƒçš„æ“ä½œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">driver&lt;/span> &lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Driver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//dsnè¿æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dsn&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åœ¨prepared statementä¸­ç”¨åˆ°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">numClosed&lt;/span> &lt;span class="kt">uint64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">// protects following fields&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¯ä½¿ç”¨çš„ç©ºé—²çš„é“¾æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">freeConn&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">driverConn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ç”¨æ¥ä¼ é€’è¿æ¥è¯·æ±‚çš„ç®¡é“&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">connRequests&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">connRequest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å½“å‰æ‰“å¼€çš„è¿æ¥æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">numOpen&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å½“éœ€è¦åˆ›å»ºæ–°çš„é“¾æ¥çš„æ—¶å€™ï¼Œå¾€è¿™ä¸ªç®¡é“ä¸­å‘é€ä¸€ä¸ªstructæ•°æ®ï¼Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å› ä¸ºåœ¨Openæ•°æ®åº“çš„å°±å¯ç”¨äº†ä¸€ä¸ªgoroutineæ‰§è¡ŒconnectionOpeneræ–¹æ³•è¯»å–ç®¡é“ä¸­çš„æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">openerCh&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ•°æ®åº“æ˜¯å¦å·²ç»è¢«å…³é—­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">closed&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ç”¨æ¥ä¿è¯é”è¢«æ­£ç¡®çš„å…³é—­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dep&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">finalCloser&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">depSet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//stacktrace of last conn&amp;#39;s put; debug only&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">lastPut&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">driverConn&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æœ€å¤§ç©ºé—²è¿æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">maxIdle&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æœ€å¤§æ‰“å¼€çš„è¿æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">maxOpen&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">maxLifetime&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å®šæ—¶æ¸…ç†ç©ºé—²è¿æ¥çš„ç®¡é“&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cleanerCh&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>çœ‹ä¸€ä¸ªæŸ¥è¯¢æ•°æ®åº“çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code> rows, err := db.Query(&amp;#34;select * from table1&amp;#34;)&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨è°ƒç”¨&lt;code>db.Query&lt;/code>æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">rows&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Rows&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿™é‡Œå°±åšäº†å¯¹å¤±æ•ˆçš„é“¾æ¥çš„é‡è¯•æ“ä½œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">maxBadConnRetries&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cachedOrNewConn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrBadConn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrBadConn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">alwaysNewConn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¿”å›ï¼Œå¯ä»¥ä»è¿™é‡Œçœ‹åˆ°ï¼š
&lt;a href="https://github.com/go-sql-driver/mysql/blob/master/packets.go#L35" target="_blank" rel="noopener">readPack&lt;/a>ï¼Œ&lt;a href="https://github.com/go-sql-driver/mysql/blob/master/packets.go#L132" target="_blank" rel="noopener">writePack&lt;/a>&lt;/p>
&lt;p>ç»§ç»­è·Ÿè¿›å»å°±åˆ°äº†&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">conn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strategy&lt;/span> &lt;span class="nx">connReuseStrategy&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">driverConn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ–¹æ³•ä¸»è¦æ˜¯åˆ›å»ºtcpè¿æ¥ï¼Œå¹¶åˆ¤æ–­äº†è¿æ¥çš„ç”Ÿå­˜æ—¶é—´lifetimeï¼Œä»¥åŠè¿æ¥æ•°çš„ä¸€äº›é™åˆ¶ï¼Œå¦‚æœè¶…è¿‡çš„è®¾å®šçš„æœ€å¤§æ‰“å¼€é“¾æ¥æ•°é™åˆ¶ç­‰å¾…&lt;code>connRequest&lt;/code>ç®¡é“ä¸­æœ‰è¿æ¥äº§ç”Ÿ(åœ¨&lt;code>putConn&lt;/code>é‡Šæ”¾é“¾æ¥çš„æ—¶å€™å°±ä¼šå¾€è¿™ä¸ªç®¡é“ä¸­å†™å…¥æ•°æ®)&lt;/p>
&lt;p>&lt;strong>ä½•æ—¶é‡Šæ”¾é“¾æ¥?&lt;/strong>&lt;/p>
&lt;p>å½“æˆ‘ä»¬è°ƒç”¨&lt;code>rows.Close()&lt;/code>çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠå½“å‰æ­£åœ¨ä½¿ç”¨çš„é“¾æ¥é‡æ–°æ”¾å›&lt;code>freeConn&lt;/code>æˆ–è€…å†™å…¥åˆ°&lt;code>db.connRequests&lt;/code>ç®¡é“ä¸­&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//putConnDBLocked æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¦‚æœæœ‰db.connRequestsæœ‰åœ¨ç­‰å¾…è¿æ¥çš„è¯ï¼Œå°±æŠŠå½“å‰è¿æ¥ç»™å®ƒç”¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// This copy is O(n) but in practice faster than a linked list.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// TODO: consider compacting it down less often and&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// moving the base instead?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">copy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">inUse&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">connRequest&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">conn&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">dc&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">maxIdleConnsLocked&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">freeConn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ²¡äººéœ€è¦æˆ‘è¿™ä¸ªé“¾æ¥ï¼Œæˆ‘å°±æŠŠä»–é‡æ–°è¿”å›`freeConn`è¿æ¥æ± ä¸­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">freeConn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">freeConn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">dc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">startCleanerLocked&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>ä½¿ç”¨è¿æ¥æ± ç®¡ç†Thrifté“¾æ¥&lt;/h1>&lt;p>è¿™é‡Œæ˜¯ä½¿ç”¨è¿æ¥æ± &lt;a href="https://github.com/silenceper/pool" target="_blank" rel="noopener">https://github.com/silenceper/pool&lt;/a>ï¼Œå¦‚ä½•æ„å»ºä¸€ä¸ªthrifté“¾æ¥&lt;/p>
&lt;p>å®¢æˆ·ç«¯åˆ›å»ºThriftçš„ä»£ç ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Client&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UserClient&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//åˆ›å»ºThriftå®¢æˆ·ç«¯é“¾æ¥çš„æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">factory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">protocolFactory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">thrift&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTBinaryProtocolFactoryDefault&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">transportFactory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">thrift&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTTransportFactory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">transport&lt;/span> &lt;span class="nx">thrift&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TTransport&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">transport&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">thrift&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTSocket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rpcConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Listen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">transport&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">transportFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetTransport&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">transport&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//defer transport.Close()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpcClient&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewUserClientFactory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">transport&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">protocolFactory&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åœ¨è¿æ¥æ± ä¸­ç›´æ¥æ”¾ç½®Clientå¯¹è±¡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">UserClient&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">rpcClient&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å…³é—­è¿æ¥çš„æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">close&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">v&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">Transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//åˆ›å»ºäº†ä¸€ä¸ª åˆå§‹åŒ–è¿æ¥æ˜¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">poolConfig&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PoolConfig&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">InitialCap&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MaxCap&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Factory&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">factory&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Close&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">close&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">IdleTimeout&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">300&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewChannelPool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">poolConfig&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å–å¾—é“¾æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>&lt;span class="nx">ä½¿ç”¨è¿æ¥è°ƒç”¨è¿œç¨‹æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å°†è¿æ¥é‡æ–°æ”¾å›è¿æ¥æ± ä¸­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;hr>
&lt;p>å†™å®Œï¼Œå¬è§å¤–é¢çš„ğŸ“å¼€å§‹æ‰“é¸£äº†ã€‚&lt;/p></description></item></channel></rss>
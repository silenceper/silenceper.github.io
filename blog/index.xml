<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>silenceper â€“ åšå®¢</title><link>/blog/</link><description>Recent content in åšå®¢ on silenceper</description><generator>Hugo -- gohugo.io</generator><language>en</language><atom:link href="/blog/index.xml" rel="self" type="application/rss+xml"/><item><title>åœ¨Claude Codeä¸­ä½¿ç”¨DeepSeek v3.1æ¨¡å‹ï¼šå®Œæ•´æŒ‡å—</title><link>/blog/2025-08-21-deepseek-claude-code/</link><pubDate>Thu, 21 Aug 2025 00:00:00 +0000</pubDate><guid>/blog/2025-08-21-deepseek-claude-code/</guid><description>
&lt;h2>DeepSeek v3.1 æ¨¡å‹ä»‹ç»&lt;span class="hx-absolute -hx-mt-20" id="deepseek-v31-æ¨¡å‹ä»‹ç»">&lt;/span>
&lt;a href="#deepseek-v31-%e6%a8%a1%e5%9e%8b%e4%bb%8b%e7%bb%8d" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>DeepSeek v3.1 äº 2025 å¹´ 8 æœˆ 21 æ—¥å‘å¸ƒï¼Œæ˜¯åœ¨ V3 åŸºç¡€ä¸Šçš„é‡è¦å‡çº§ï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>æ··åˆæ¨ç†æ¶æ„&lt;/strong>ï¼šåŒä¸€æ¨¡å‹æ”¯æŒâ€œéæ€è€ƒæ¨¡å¼â€å’Œâ€œæ€è€ƒæ¨¡å¼â€ï¼Œåˆ†åˆ«å¯¹åº” &lt;code>deepseek-chat&lt;/code> ä¸ &lt;code>deepseek-reasoner&lt;/code>ï¼Œä¾¿äºåœ¨é€Ÿåº¦ä¸æ¨ç†æ·±åº¦é—´çµæ´»å–èˆã€‚&lt;/li>
&lt;li>&lt;strong>128K ä¸Šä¸‹æ–‡é•¿åº¦&lt;/strong>ï¼šæ›´é•¿ä¸Šä¸‹æ–‡ï¼Œé€‚åˆä»£ç åº“åˆ†æã€é•¿æ–‡æ¡£å¤„ç†ä¸å¤šæ–‡ä»¶åä½œã€‚&lt;/li>
&lt;li>&lt;strong>æ€è€ƒæ•ˆç‡æå‡&lt;/strong>ï¼šåœ¨æ€ç»´é“¾å‹ç¼©åï¼ŒV3.1-Think ç”¨æ›´å°‘çš„ tokens è¾¾åˆ°ä¸ R1-0528 è¿‘ä¼¼çš„æ•ˆæœã€‚&lt;/li>
&lt;li>&lt;strong>å·¥å…·ä¸æ™ºèƒ½ä½“èƒ½åŠ›å¢å¼º&lt;/strong>ï¼šåœ¨ä»£ç ä¿®å¤ï¼ˆSWEï¼‰ä¸å¤æ‚ç»ˆç«¯ä»»åŠ¡ï¼ˆTerminal-Benchï¼‰ä¸Šæ˜¾è‘—æå‡ï¼Œæ›´é€‚åˆå·¥å…·è°ƒç”¨/å¤šæ­¥ä»»åŠ¡ã€‚&lt;/li>
&lt;li>&lt;strong>Function Callingï¼ˆstrictï¼‰æ”¯æŒ&lt;/strong>ï¼šBeta æ¥å£æ”¯æŒä¸¥æ ¼æ¨¡å¼ï¼Œç¡®ä¿å‡½æ•°è¾“å‡ºæ»¡è¶³ schemaï¼ˆè¯¦è§å®˜æ–¹æ–‡æ¡£ï¼‰ã€‚&lt;/li>
&lt;li>&lt;strong>Anthropic API å…¼å®¹&lt;/strong>ï¼šå¯ç›´æ¥ä»¥ Anthropic API å½¢å¼æ¥å…¥ Claude Code ä¸å…¶ç”Ÿæ€ã€‚&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒï¼š&lt;/p>
&lt;ul>
&lt;li>DeepSeek V3.1 å‘å¸ƒè¯´æ˜ï¼š&lt;a href="https://api-docs.deepseek.com/zh-cn/news/news250821" target="_blank" rel="noopener">DeepSeek V3.1 å‘å¸ƒ 2025/08/21&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2>Claude Code å®‰è£…æŒ‡å—&lt;span class="hx-absolute -hx-mt-20" id="claude-code-å®‰è£…æŒ‡å—">&lt;/span>
&lt;a href="#claude-code-%e5%ae%89%e8%a3%85%e6%8c%87%e5%8d%97" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>ç³»ç»Ÿè¦æ±‚&lt;span class="hx-absolute -hx-mt-20" id="ç³»ç»Ÿè¦æ±‚">&lt;/span>
&lt;a href="#%e7%b3%bb%e7%bb%9f%e8%a6%81%e6%b1%82" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>macOSã€Windows æˆ– Linux ç³»ç»Ÿ&lt;/li>
&lt;li>Node.js 16+ ç‰ˆæœ¬&lt;/li>
&lt;li>ç¨³å®šçš„ç½‘ç»œè¿æ¥&lt;/li>
&lt;/ul>
&lt;h3>å®‰è£…æ­¥éª¤&lt;span class="hx-absolute -hx-mt-20" id="å®‰è£…æ­¥éª¤">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%85%e6%ad%a5%e9%aa%a4" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>&lt;strong>ä¸‹è½½ Claude Code&lt;/strong>
&lt;ul>
&lt;li>è®¿é—® &lt;a href="https://claude.ai/code" target="_blank" rel="noopener">Claude Code å®˜ç½‘&lt;/a> ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å®‰è£…åŒ…&lt;/li>
&lt;li>æˆ–è€…é€šè¿‡ npm å®‰è£…ï¼š&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">npm install -g @anthropic-ai/claude-code&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;/li>
&lt;/ol>
&lt;h2>åœ¨ Claude Code ä¸­é…ç½® DeepSeek v3.1&lt;span class="hx-absolute -hx-mt-20" id="åœ¨-claude-code-ä¸­é…ç½®-deepseek-v31">&lt;/span>
&lt;a href="#%e5%9c%a8-claude-code-%e4%b8%ad%e9%85%8d%e7%bd%ae-deepseek-v31" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æŒ‰ç…§ Anthropic API å…¼å®¹è§„èŒƒï¼ŒClaude Code åªéœ€è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡å³å¯åˆ‡æ¢åˆ° DeepSeek æ¨¡å‹ï¼š&lt;/p>
&lt;h3>è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¸´æ—¶ä¼šè¯ï¼‰&lt;span class="hx-absolute -hx-mt-20" id="è®¾ç½®ç¯å¢ƒå˜é‡ä¸´æ—¶ä¼šè¯">&lt;/span>
&lt;a href="#%e8%ae%be%e7%bd%ae%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e4%b8%b4%e6%97%b6%e4%bc%9a%e8%af%9d" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DeepSeek æä¾›çš„ Anthropic å…¼å®¹å…¥å£&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">ANTHROPIC_BASE_URL&lt;/span>&lt;span class="o">=&lt;/span>https://api.deepseek.com/anthropic
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ä½¿ç”¨ DeepSeek çš„ API Keyï¼ˆClaude Code è¯»å– ANTHROPIC_AUTH_TOKENï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">ANTHROPIC_AUTH_TOKEN&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">DEEPSEEK_API_KEY&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># é»˜è®¤ä¸»æ¨¡å‹ï¼ˆéæ€è€ƒæ¨¡å¼ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">ANTHROPIC_MODEL&lt;/span>&lt;span class="o">=&lt;/span>deepseek-chat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å¿«é€Ÿå°æ¨¡å‹ï¼ˆåŒæ ·å¯è®¾ä¸º deepseek-chatï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">ANTHROPIC_SMALL_FAST_MODEL&lt;/span>&lt;span class="o">=&lt;/span>deepseek-chat&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è‹¥å¸Œæœ›åœ¨ Claude Code ä¸­å¯ç”¨â€œæ€è€ƒæ¨¡å¼â€ï¼Œå°† &lt;code>ANTHROPIC_MODEL&lt;/code> æ”¹ä¸ºï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">ANTHROPIC_MODEL&lt;/span>&lt;span class="o">=&lt;/span>deepseek-reasoner&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>æç¤ºï¼šä¸Šè¿°æ–¹å¼ä»…å¯¹å½“å‰ shell ä¼šè¯ç”Ÿæ•ˆã€‚è‹¥éœ€é•¿æœŸç”Ÿæ•ˆï¼Œå¯å°†è¿™äº› &lt;code>export&lt;/code> è¡ŒåŠ å…¥ &lt;code>~/.zshrc&lt;/code> æˆ– &lt;code>~/.bashrc&lt;/code>ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3>å¯åŠ¨ä¸éªŒè¯&lt;span class="hx-absolute -hx-mt-20" id="å¯åŠ¨ä¸éªŒè¯">&lt;/span>
&lt;a href="#%e5%90%af%e5%8a%a8%e4%b8%8e%e9%aa%8c%e8%af%81" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> your-project
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">claude&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨åï¼ŒClaude Code å°†è¯»å–ç¯å¢ƒå˜é‡å¹¶ä½¿ç”¨ DeepSeek æ¨¡å‹ã€‚ä½ å¯ä»¥ç›´æ¥åœ¨å‘½ä»¤è¡Œå¯¹è¯è¿›è¡Œä»£ç åä½œä¸ä¿®æ”¹ã€‚è‹¥éœ€ç¡®è®¤æ¨¡å‹ï¼ŒæŸ¥çœ‹å¯åŠ¨æ—¥å¿—æˆ–åœ¨ä¼šè¯ä¸­è¯¢é—®å½“å‰æ¨¡å‹é…ç½®ã€‚&lt;/p>
&lt;p>æ›´å¤šå…¼å®¹ç»†èŠ‚ä¸å­—æ®µæ”¯æŒçŸ©é˜µï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š&lt;a href="https://api-docs.deepseek.com/zh-cn/guides/anthropic_api" target="_blank" rel="noopener">Anthropic API æŒ‡å—&lt;/a>ã€‚&lt;/p>
&lt;h2>å¸¸è§é—®é¢˜ä¸æ³¨æ„äº‹é¡¹&lt;span class="hx-absolute -hx-mt-20" id="å¸¸è§é—®é¢˜ä¸æ³¨æ„äº‹é¡¹">&lt;/span>
&lt;a href="#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98%e4%b8%8e%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;strong>æ¨¡å‹ä¸æ¨¡å¼é€‰æ‹©&lt;/strong>ï¼š
&lt;ul>
&lt;li>&lt;code>deepseek-chat&lt;/code>ï¼šéæ€è€ƒæ¨¡å¼ï¼Œå“åº”æ›´çŸ­æ›´å¿«ã€‚&lt;/li>
&lt;li>&lt;code>deepseek-reasoner&lt;/code>ï¼šæ€è€ƒæ¨¡å¼ï¼Œé€‚åˆå¤æ‚å¤šæ­¥æ¨ç†åœºæ™¯ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>ä¸Šä¸‹æ–‡é•¿åº¦&lt;/strong>ï¼šV3.1 API é»˜è®¤æ”¯æŒ 128K ä¸Šä¸‹æ–‡ï¼Œé€‚åˆé•¿æ–‡æ¡£/å¤šæ–‡ä»¶åä½œã€‚&lt;/li>
&lt;li>&lt;strong>å·¥å…·è°ƒç”¨ä¸å‡½æ•°&lt;/strong>ï¼šæ”¯æŒ &lt;code>tools&lt;/code> ä¸ &lt;code>tool_choice&lt;/code>ï¼ˆ&lt;code>none&lt;/code>/&lt;code>auto&lt;/code>/&lt;code>any&lt;/code>/&lt;code>tool&lt;/code>ï¼‰ã€‚Beta æ¥å£æ”¯æŒ strict Function Calling ä»¥ä¿è¯è¾“å‡ºç¬¦åˆ schemaï¼ˆä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†ï¼‰ã€‚&lt;/li>
&lt;li>&lt;strong>å­—æ®µå…¼å®¹æ€§è¦ç‚¹&lt;/strong>ï¼š
&lt;ul>
&lt;li>&lt;code>temperature&lt;/code>ï¼ˆ0.0~2.0ï¼‰ã€&lt;code>max_tokens&lt;/code>ã€&lt;code>system&lt;/code>ã€&lt;code>stream&lt;/code> å‡æ”¯æŒã€‚&lt;/li>
&lt;li>&lt;code>thinking&lt;/code> å­—æ®µåœ¨å…¼å®¹æ¨¡å¼ä¸‹è¢«å¿½ç•¥ï¼›å›¾ç‰‡/æ–‡æ¡£/æœç´¢ç»“æœç­‰éƒ¨åˆ†å¤æ‚ message ç±»å‹æš‚ä¸æ”¯æŒã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>Tokenizer/æ¨¡æ¿å·®å¼‚&lt;/strong>ï¼šV3.1 å¯¹åˆ†è¯å™¨ä¸ chat template æœ‰è¾ƒå¤§è°ƒæ•´ï¼Œä¸ V3 å­˜åœ¨å·®å¼‚ï¼Œè¿ç§»å‰è¯·é˜…è¯»æ–°ç‰ˆè¯´æ˜ã€‚&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒï¼š&lt;/p>
&lt;ul>
&lt;li>å‘å¸ƒè¯´æ˜ï¼š&lt;a href="https://api-docs.deepseek.com/zh-cn/news/news250821" target="_blank" rel="noopener">DeepSeek V3.1 å‘å¸ƒ 2025/08/21&lt;/a>&lt;/li>
&lt;li>å…¼å®¹è¯´æ˜ï¼š&lt;a href="https://api-docs.deepseek.com/zh-cn/guides/anthropic_api" target="_blank" rel="noopener">Anthropic API æŒ‡å—&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2>æˆªå›¾&lt;span class="hx-absolute -hx-mt-20" id="æˆªå›¾">&lt;/span>
&lt;a href="#%e6%88%aa%e5%9b%be" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;img src="https://public-1251960616.cos.ap-nanjing.myqcloud.com/file/9zH9z6.png" alt="Claude Code é›†æˆ DeepSeek v3.1 æ¼”ç¤ºï¼ˆå ä½ï¼‰" loading="lazy" />&lt;/p>
&lt;h2>å‚è€ƒèµ„æ–™&lt;span class="hx-absolute -hx-mt-20" id="å‚è€ƒèµ„æ–™">&lt;/span>
&lt;a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>DeepSeek å®˜æ–¹æ–‡æ¡£ Â· æ–°é—»ï¼š&lt;a href="https://api-docs.deepseek.com/zh-cn/news/news250821" target="_blank" rel="noopener">DeepSeek V3.1 å‘å¸ƒ 2025/08/21&lt;/a>&lt;/li>
&lt;li>DeepSeek å®˜æ–¹æ–‡æ¡£ Â· æŒ‡å—ï¼š&lt;a href="https://api-docs.deepseek.com/zh-cn/guides/anthropic_api" target="_blank" rel="noopener">Anthropic API&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Windows-MCPï¼šè®©AIç›´æ¥æ“ä½œä½ çš„Windowsç³»ç»Ÿ</title><link>/blog/2025-08-15-windows-mcp/</link><pubDate>Fri, 15 Aug 2025 00:00:00 +0000</pubDate><guid>/blog/2025-08-15-windows-mcp/</guid><description>
&lt;h2>é¡¹ç›®ä¿¡æ¯&lt;span class="hx-absolute -hx-mt-20" id="é¡¹ç›®ä¿¡æ¯">&lt;/span>
&lt;a href="#%e9%a1%b9%e7%9b%ae%e4%bf%a1%e6%81%af" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>é¡¹ç›®åç§°&lt;/th>
&lt;th>Windows-MCP&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>å¼€æºåè®®&lt;/td>
&lt;td>MIT License&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GitHub Stars&lt;/td>
&lt;td>2k+&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é¡¹ç›®åœ°å€&lt;/td>
&lt;td>&lt;a href="https://github.com/CursorTouch/Windows-MCP" target="_blank" rel="noopener">https://github.com/CursorTouch/Windows-MCP&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æ‰€å±å…¬å¸&lt;/td>
&lt;td>CursorTouch&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æ”¯æŒç³»ç»Ÿ&lt;/td>
&lt;td>Windows 7/8/8.1/10/11&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ç¼–ç¨‹è¯­è¨€&lt;/td>
&lt;td>Python&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2>æ¼”ç¤ºè§†é¢‘&lt;span class="hx-absolute -hx-mt-20" id="æ¼”ç¤ºè§†é¢‘">&lt;/span>
&lt;a href="#%e6%bc%94%e7%a4%ba%e8%a7%86%e9%a2%91" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h2>ä»€ä¹ˆæ˜¯Windows-MCPï¼Ÿ&lt;span class="hx-absolute -hx-mt-20" id="ä»€ä¹ˆæ˜¯windows-mcp">&lt;/span>
&lt;a href="#%e4%bb%80%e4%b9%88%e6%98%afwindows-mcp" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;strong>Windows-MCP&lt;/strong> æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å¼€æºé¡¹ç›®ï¼Œå®ƒä½œä¸ºMCPï¼ˆModel Context Protocolï¼‰æœåŠ¡å™¨ï¼Œåœ¨AIä»£ç†å’ŒWindowsæ“ä½œç³»ç»Ÿä¹‹é—´æ¶èµ·äº†ä¸€åº§æ¡¥æ¢ã€‚é€šè¿‡è¿™ä¸ªå·¥å…·ï¼ŒAIä»£ç†å¯ä»¥ç›´æ¥ä¸Windowsç³»ç»Ÿäº¤äº’ï¼Œæ‰§è¡Œå„ç§è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚&lt;/p>
&lt;h2>æ ¸å¿ƒç‰¹æ€§&lt;span class="hx-absolute -hx-mt-20" id="æ ¸å¿ƒç‰¹æ€§">&lt;/span>
&lt;a href="#%e6%a0%b8%e5%bf%83%e7%89%b9%e6%80%a7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>ğŸ¯ æ— ç¼Windowsé›†æˆ&lt;span class="hx-absolute -hx-mt-20" id="-æ— ç¼windowsé›†æˆ">&lt;/span>
&lt;a href="#-%e6%97%a0%e7%bc%9dwindows%e9%9b%86%e6%88%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>ä¸Windows UIå…ƒç´ åŸç”Ÿäº¤äº’&lt;/li>
&lt;li>æ‰“å¼€åº”ç”¨ç¨‹åºã€æ§åˆ¶çª—å£&lt;/li>
&lt;li>æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥æ“ä½œ&lt;/li>
&lt;li>æ”¯æŒæ–‡ä»¶å¯¼èˆªå’Œç®¡ç†&lt;/li>
&lt;/ul>
&lt;h3>ğŸ¤– æ”¯æŒä»»æ„LLM&lt;span class="hx-absolute -hx-mt-20" id="-æ”¯æŒä»»æ„llm">&lt;/span>
&lt;a href="#-%e6%94%af%e6%8c%81%e4%bb%bb%e6%84%8fllm" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>ä¸è®¸å¤šè‡ªåŠ¨åŒ–å·¥å…·ä¸åŒï¼ŒWindows-MCPä¸ä¾èµ–ä¼ ç»Ÿçš„è®¡ç®—æœºè§†è§‰æŠ€æœ¯æˆ–ç‰¹å®šçš„å¾®è°ƒæ¨¡å‹ã€‚å®ƒå¯ä»¥ä½¿ç”¨ä»»ä½•LLMï¼Œé™ä½äº†å¤æ‚æ€§å’Œè®¾ç½®æ—¶é—´ã€‚&lt;/p>
&lt;h3>ğŸ› ï¸ ä¸°å¯Œçš„UIè‡ªåŠ¨åŒ–å·¥å…·é›†&lt;span class="hx-absolute -hx-mt-20" id="-ä¸°å¯Œçš„uiè‡ªåŠ¨åŒ–å·¥å…·é›†">&lt;/span>
&lt;a href="#-%e4%b8%b0%e5%af%8c%e7%9a%84ui%e8%87%aa%e5%8a%a8%e5%8c%96%e5%b7%a5%e5%85%b7%e9%9b%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>åŸºç¡€é”®ç›˜å’Œé¼ æ ‡æ“ä½œ&lt;/li>
&lt;li>çª—å£/UIçŠ¶æ€æ•è·&lt;/li>
&lt;li>å®æ—¶äº¤äº’ï¼ˆå…¸å‹å»¶è¿Ÿ0.7-2.5ç§’ï¼‰&lt;/li>
&lt;/ul>
&lt;h3>ğŸ”§ è½»é‡çº§å’Œå¯æ‰©å±•&lt;span class="hx-absolute -hx-mt-20" id="-è½»é‡çº§å’Œå¯æ‰©å±•">&lt;/span>
&lt;a href="#-%e8%bd%bb%e9%87%8f%e7%ba%a7%e5%92%8c%e5%8f%af%e6%89%a9%e5%b1%95" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>æœ€å°ä¾èµ–&lt;/li>
&lt;li>æ˜“äºè®¾ç½®&lt;/li>
&lt;li>å®Œå…¨å¼€æºï¼ˆMITè®¸å¯è¯ï¼‰&lt;/li>
&lt;li>å¯æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰å’Œæ‰©å±•&lt;/li>
&lt;/ul>
&lt;h2>æ”¯æŒçš„MCPå·¥å…·&lt;span class="hx-absolute -hx-mt-20" id="æ”¯æŒçš„mcpå·¥å…·">&lt;/span>
&lt;a href="#%e6%94%af%e6%8c%81%e7%9a%84mcp%e5%b7%a5%e5%85%b7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Windows-MCPæä¾›äº†ä»¥ä¸‹å·¥å…·æ¥ä¸Windowsäº¤äº’ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Click-Tool&lt;/strong>: åœ¨æŒ‡å®šåæ ‡ç‚¹å‡»å±å¹•&lt;/li>
&lt;li>&lt;strong>Type-Tool&lt;/strong>: åœ¨å…ƒç´ ä¸Šè¾“å…¥æ–‡æœ¬ï¼ˆå¯é€‰æ‹©æ¸…é™¤ç°æœ‰æ–‡æœ¬ï¼‰&lt;/li>
&lt;li>&lt;strong>Clipboard-Tool&lt;/strong>: ä½¿ç”¨ç³»ç»Ÿå‰ªè´´æ¿å¤åˆ¶æˆ–ç²˜è´´&lt;/li>
&lt;li>&lt;strong>Scroll-Tool&lt;/strong>: åœ¨çª—å£æˆ–ç‰¹å®šåŒºåŸŸå‚ç›´æˆ–æ°´å¹³æ»šåŠ¨&lt;/li>
&lt;li>&lt;strong>Drag-Tool&lt;/strong>: ä»ä¸€ä¸ªç‚¹æ‹–æ‹½åˆ°å¦ä¸€ä¸ªç‚¹&lt;/li>
&lt;li>&lt;strong>Move-Tool&lt;/strong>: ç§»åŠ¨é¼ æ ‡æŒ‡é’ˆ&lt;/li>
&lt;li>&lt;strong>Shortcut-Tool&lt;/strong>: æŒ‰ä¸‹é”®ç›˜å¿«æ·é”®ï¼ˆCtrl+cã€Alt+Tabç­‰ï¼‰&lt;/li>
&lt;li>&lt;strong>Key-Tool&lt;/strong>: æŒ‰ä¸‹å•ä¸ªé”®&lt;/li>
&lt;li>&lt;strong>Wait-Tool&lt;/strong>: æš‚åœæŒ‡å®šæ—¶é—´&lt;/li>
&lt;li>&lt;strong>State-Tool&lt;/strong>: è·å–é»˜è®¤è¯­è¨€ã€æµè§ˆå™¨ã€æ´»åŠ¨åº”ç”¨ç¨‹åºå’Œäº¤äº’å¼ã€æ–‡æœ¬å’Œå¯æ»šåŠ¨å…ƒç´ çš„ç»„åˆå¿«ç…§ï¼Œä»¥åŠæ¡Œé¢æˆªå›¾&lt;/li>
&lt;li>&lt;strong>Resize-Tool&lt;/strong>: æ›´æ”¹åº”ç”¨ç¨‹åºçš„çª—å£å¤§å°æˆ–ä½ç½®&lt;/li>
&lt;li>&lt;strong>Launch-Tool&lt;/strong>: ä»å¼€å§‹èœå•å¯åŠ¨åº”ç”¨ç¨‹åº&lt;/li>
&lt;li>&lt;strong>Shell-Tool&lt;/strong>: æ‰§è¡ŒPowerShellå‘½ä»¤&lt;/li>
&lt;li>&lt;strong>Scrape-Tool&lt;/strong>: æŠ“å–æ•´ä¸ªç½‘é¡µä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;h2>ç³»ç»Ÿè¦æ±‚&lt;span class="hx-absolute -hx-mt-20" id="ç³»ç»Ÿè¦æ±‚">&lt;/span>
&lt;a href="#%e7%b3%bb%e7%bb%9f%e8%a6%81%e6%b1%82" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>å‰ç½®æ¡ä»¶&lt;span class="hx-absolute -hx-mt-20" id="å‰ç½®æ¡ä»¶">&lt;/span>
&lt;a href="#%e5%89%8d%e7%bd%ae%e6%9d%a1%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>Python 3.13+&lt;/li>
&lt;li>Anthropic Claude Desktopåº”ç”¨æˆ–å…¶ä»–MCPå®¢æˆ·ç«¯&lt;/li>
&lt;li>UVï¼ˆåŒ…ç®¡ç†å™¨ï¼‰ï¼Œé€šè¿‡&lt;code>pip install uv&lt;/code>å®‰è£…&lt;/li>
&lt;li>DXTï¼ˆæ¡Œé¢æ‰©å±•ï¼‰ï¼Œé€šè¿‡&lt;code>npm install -g @anthropic-ai/dxt&lt;/code>å®‰è£…&lt;/li>
&lt;li>Windowsé»˜è®¤è¯­è¨€ä¸ºè‹±è¯­ï¼Œæˆ–ç¦ç”¨MCPæœåŠ¡å™¨ä¸­çš„Launch-Toolå’ŒResize-Tool&lt;/li>
&lt;/ul>
&lt;h2>å¿«é€Ÿå¼€å§‹&lt;span class="hx-absolute -hx-mt-20" id="å¿«é€Ÿå¼€å§‹">&lt;/span>
&lt;a href="#%e5%bf%ab%e9%80%9f%e5%bc%80%e5%a7%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>Gemini CLIé›†æˆ&lt;span class="hx-absolute -hx-mt-20" id="gemini-clié›†æˆ">&lt;/span>
&lt;a href="#gemini-cli%e9%9b%86%e6%88%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>åœ¨æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­å¯¼èˆªåˆ°&lt;code>%USERPROFILE%/.gemini&lt;/code>å¹¶æ‰“å¼€&lt;code>settings.json&lt;/code>&lt;/li>
&lt;li>åœ¨&lt;code>settings.json&lt;/code>ä¸­æ·»åŠ &lt;code>windows-mcp&lt;/code>é…ç½®å¹¶ä¿å­˜ï¼š&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;theme&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Default&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mcpServers&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;windows-mcp&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;command&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;uv&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;args&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;--directory&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;lt;windows-mcpç›®å½•çš„è·¯å¾„&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;run&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;main.py&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol start="3">
&lt;li>åœ¨ç»ˆç«¯ä¸­é‡æ–°è¿è¡ŒGemini CLIï¼Œå¼€å§‹ä½¿ç”¨ï¼&lt;/li>
&lt;/ol>
&lt;h3>Claude Desktopé›†æˆ&lt;span class="hx-absolute -hx-mt-20" id="claude-desktopé›†æˆ">&lt;/span>
&lt;a href="#claude-desktop%e9%9b%86%e6%88%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ol>
&lt;li>å…‹éš†ä»“åº“ï¼š&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git clone https://github.com/CursorTouch/Windows-MCP.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> Windows-MCP&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol start="2">
&lt;li>æ„å»ºæ¡Œé¢æ‰©å±•DXTï¼š&lt;/li>
&lt;/ol>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">npx @anthropic-ai/dxt pack&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ol start="3">
&lt;li>æ‰“å¼€Claude Desktopï¼š
&lt;ul>
&lt;li>è¿›å…¥è®¾ç½® -&amp;gt; æ‰©å±• -&amp;gt; å®‰è£…æ‰©å±•ï¼ˆå®šä½.dxtæ–‡ä»¶ï¼‰-&amp;gt; å®‰è£…&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2>å®é™…åº”ç”¨åœºæ™¯&lt;span class="hx-absolute -hx-mt-20" id="å®é™…åº”ç”¨åœºæ™¯">&lt;/span>
&lt;a href="#%e5%ae%9e%e9%99%85%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>è‡ªåŠ¨åŒ–æµ‹è¯•&lt;span class="hx-absolute -hx-mt-20" id="è‡ªåŠ¨åŒ–æµ‹è¯•">&lt;/span>
&lt;a href="#%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%8b%e8%af%95" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>åº”ç”¨ç¨‹åºUIæµ‹è¯•&lt;/li>
&lt;li>åŠŸèƒ½éªŒè¯&lt;/li>
&lt;li>å›å½’æµ‹è¯•&lt;/li>
&lt;/ul>
&lt;h3>å·¥ä½œæµç¨‹è‡ªåŠ¨åŒ–&lt;span class="hx-absolute -hx-mt-20" id="å·¥ä½œæµç¨‹è‡ªåŠ¨åŒ–">&lt;/span>
&lt;a href="#%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b%e8%87%aa%e5%8a%a8%e5%8c%96" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>æ–‡ä»¶å¤„ç†&lt;/li>
&lt;li>åº”ç”¨ç¨‹åºæ“ä½œ&lt;/li>
&lt;li>æ•°æ®å½•å…¥&lt;/li>
&lt;/ul>
&lt;h3>è¿œç¨‹æ§åˆ¶&lt;span class="hx-absolute -hx-mt-20" id="è¿œç¨‹æ§åˆ¶">&lt;/span>
&lt;a href="#%e8%bf%9c%e7%a8%8b%e6%8e%a7%e5%88%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>é€šè¿‡SSHè¿œç¨‹æ“ä½œç”µè„‘&lt;/li>
&lt;li>ç§»åŠ¨è®¾å¤‡æ§åˆ¶æ¡Œé¢&lt;/li>
&lt;li>è·¨å¹³å°ä»»åŠ¡æ‰§è¡Œ&lt;/li>
&lt;/ul>
&lt;h2>æ³¨æ„äº‹é¡¹&lt;span class="hx-absolute -hx-mt-20" id="æ³¨æ„äº‹é¡¹">&lt;/span>
&lt;a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>âš ï¸ å®‰å…¨æé†’&lt;span class="hx-absolute -hx-mt-20" id="-å®‰å…¨æé†’">&lt;/span>
&lt;a href="#-%e5%ae%89%e5%85%a8%e6%8f%90%e9%86%92" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æ­¤MCPç›´æ¥ä¸Windowsæ“ä½œç³»ç»Ÿäº¤äº’ä»¥æ‰§è¡Œæ“ä½œã€‚è¯·è°¨æ…ä½¿ç”¨ï¼Œé¿å…åœ¨æ— æ³•æ‰¿å—æ­¤ç±»é£é™©çš„ç¯å¢ƒä¸­éƒ¨ç½²ã€‚&lt;/p>
&lt;h3>ğŸ“ å½“å‰é™åˆ¶&lt;span class="hx-absolute -hx-mt-20" id="-å½“å‰é™åˆ¶">&lt;/span>
&lt;a href="#-%e5%bd%93%e5%89%8d%e9%99%90%e5%88%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>åœ¨æ®µè½ä¸­é€‰æ‹©ç‰¹å®šæ–‡æœ¬éƒ¨åˆ†ï¼ˆæ­£åœ¨å¼€å‘ä¸­ï¼‰&lt;/li>
&lt;li>Type-Toolä¸»è¦ç”¨äºè¾“å…¥æ–‡æœ¬ï¼Œä¸é€‚åˆåœ¨IDEä¸­ç¼–ç¨‹ï¼ˆæ­£åœ¨å¼€å‘ä¸­ï¼‰&lt;/li>
&lt;/ul>
&lt;h2>ç›¸å…³èµ„æº&lt;span class="hx-absolute -hx-mt-20" id="ç›¸å…³èµ„æº">&lt;/span>
&lt;a href="#%e7%9b%b8%e5%85%b3%e8%b5%84%e6%ba%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://github.com/CursorTouch/Windows-MCP" target="_blank" rel="noopener">Windows-MCP GitHubä»“åº“&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://modelcontextprotocol.io/" target="_blank" rel="noopener">MCPå®˜æ–¹æ–‡æ¡£&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.anthropic.com/claude/docs/claude-desktop-extensions" target="_blank" rel="noopener">Claude Desktopé›†æˆæŒ‡å—&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Windows-MCPä¸ºAIä»£ç†æä¾›äº†ä¸Windowsç³»ç»Ÿæ·±åº¦é›†æˆçš„èƒ½åŠ›ï¼Œå¼€å¯äº†AIè‡ªåŠ¨åŒ–æ“ä½œçš„æ–°æ—¶ä»£ã€‚æ— è®ºæ˜¯æ—¥å¸¸ä»»åŠ¡è‡ªåŠ¨åŒ–ã€åº”ç”¨ç¨‹åºæµ‹è¯•ï¼Œè¿˜æ˜¯è¿œç¨‹ç³»ç»Ÿç®¡ç†ï¼ŒWindows-MCPéƒ½æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„å·¥å…·é›†ã€‚&lt;/p>
&lt;p>éšç€AIæŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œè¿™ç±»å·¥å…·å°†å˜å¾—è¶Šæ¥è¶Šé‡è¦ï¼Œä¸ºä¸ªäººå’Œä¼ä¸šç”¨æˆ·æä¾›æ›´é«˜æ•ˆçš„å·¥ä½œæ–¹å¼ã€‚å¦‚æœä½ å¯¹AIè‡ªåŠ¨åŒ–æ„Ÿå…´è¶£ï¼ŒWindows-MCPç»å¯¹å€¼å¾—ä¸€è¯•ï¼&lt;/p></description></item><item><title>å¦‚ä½•ä½¿ç”¨Golangå¼€å‘MCPæœåŠ¡å™¨ï¼šä»mcp-goåˆ°mcp-k8så®è·µ</title><link>/blog/2025-04-19-how-to-write-mcp-in-golang/</link><pubDate>Sat, 19 Apr 2025 09:00:00 +0800</pubDate><guid>/blog/2025-04-19-how-to-write-mcp-in-golang/</guid><description>
&lt;p>éšç€å¤§è¯­è¨€æ¨¡å‹(LLM)ä¸å¼€å‘å·¥å…·çš„æ·±åº¦èåˆï¼ŒModel Control Protocol (MCP)åè®®æ­£åœ¨æˆä¸ºAIä¸è½¯ä»¶å·¥å…·äº¤äº’çš„é‡è¦æ¡¥æ¢ã€‚MCPå…è®¸LLMä»¥ç»“æ„åŒ–çš„æ–¹å¼è°ƒç”¨å·¥å…·ï¼Œä½¿AIèƒ½å¤Ÿæ‰§è¡Œå…·ä½“çš„æ“ä½œè€Œä¸ä»…ä»…æ˜¯ç”Ÿæˆæ–‡æœ¬ã€‚&lt;/p>
&lt;p>æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨Golangå’Œ&lt;a href="https://github.com/mark3labs/mcp-go" target="_blank" rel="noopener">mcp-go&lt;/a>è¿™ä¸ªSDKæ¥å¼€å‘MCPæœåŠ¡å™¨ï¼Œå¹¶ä»¥æˆ‘çš„å¼€æºé¡¹ç›®&lt;a href="https://github.com/silenceper/mcp-k8s" target="_blank" rel="noopener">mcp-k8s&lt;/a>ä¸ºå…·ä½“æ¡ˆä¾‹ï¼Œè®²è§£å¦‚ä½•æ„å»ºä¸€ä¸ªä¸Kubernetesé›†ç¾¤äº¤äº’çš„MCPæœåŠ¡å™¨ã€‚&lt;/p>
&lt;h2>MCPåè®®ç®€ä»‹&lt;span class="hx-absolute -hx-mt-20" id="mcpåè®®ç®€ä»‹">&lt;/span>
&lt;a href="#mcp%e5%8d%8f%e8%ae%ae%e7%ae%80%e4%bb%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>MCP (Model Control Protocol)æ˜¯ä¸€ç§åè®®ï¼Œå…è®¸LLMä¸å¤–éƒ¨å·¥å…·è¿›è¡Œç»“æ„åŒ–äº¤äº’ã€‚é€šè¿‡MCPï¼ŒLLMå¯ä»¥ï¼š&lt;/p>
&lt;ol>
&lt;li>è·å–å¯ç”¨å·¥å…·åŠå…¶å‚æ•°åˆ—è¡¨&lt;/li>
&lt;li>è°ƒç”¨è¿™äº›å·¥å…·æ‰§è¡Œæ“ä½œ&lt;/li>
&lt;li>è·å–æ“ä½œç»“æœå¹¶åŸºäºç»“æœç»§ç»­äº¤äº’&lt;/li>
&lt;/ol>
&lt;p>è¿™ä½¿å¾—LLMèƒ½å¤Ÿ&amp;quot;æ§åˆ¶&amp;quot;å¤–éƒ¨ç³»ç»Ÿï¼Œæ‰§è¡Œä»æŸ¥è¯¢æ•°æ®åº“åˆ°æ“ä½œKubernetesèµ„æºç­‰å„ç§ä»»åŠ¡ã€‚&lt;/p>
&lt;h2>mcp-go SDKæ¦‚è¿°&lt;span class="hx-absolute -hx-mt-20" id="mcp-go-sdkæ¦‚è¿°">&lt;/span>
&lt;a href="#mcp-go-sdk%e6%a6%82%e8%bf%b0" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://github.com/mark3labs/mcp-go" target="_blank" rel="noopener">mcp-go&lt;/a>æ˜¯ä¸€ä¸ªç”¨Golangå®ç°çš„MCPåè®®SDKï¼Œå®ƒæä¾›äº†æ„å»ºMCPæœåŠ¡å™¨æ‰€éœ€çš„æ ¸å¿ƒç»„ä»¶ï¼š&lt;/p>
&lt;ol>
&lt;li>å·¥å…·æ³¨å†Œå’Œç®¡ç†&lt;/li>
&lt;li>åè®®æ¶ˆæ¯å¤„ç†&lt;/li>
&lt;li>å¤šç§ä¼ è¾“æ–¹å¼æ”¯æŒï¼ˆstdioã€HTTP SSEç­‰ï¼‰&lt;/li>
&lt;/ol>
&lt;p>ä½¿ç”¨mcp-goï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ„å»ºè‡ªå·±çš„MCPæœåŠ¡å™¨ï¼Œè€Œæ— éœ€å…³å¿ƒåº•å±‚åè®®ç»†èŠ‚ã€‚&lt;/p>
&lt;h2>å¼€å‘MCPæœåŠ¡å™¨çš„åŸºæœ¬æ­¥éª¤&lt;span class="hx-absolute -hx-mt-20" id="å¼€å‘mcpæœåŠ¡å™¨çš„åŸºæœ¬æ­¥éª¤">&lt;/span>
&lt;a href="#%e5%bc%80%e5%8f%91mcp%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%ad%a5%e9%aa%a4" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ä½¿ç”¨mcp-goå¼€å‘MCPæœåŠ¡å™¨é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š&lt;/p>
&lt;ol>
&lt;li>è®¾è®¡å¹¶å®šä¹‰å·¥å…·ï¼ˆToolsï¼‰&lt;/li>
&lt;li>å®ç°å·¥å…·çš„å…·ä½“åŠŸèƒ½&lt;/li>
&lt;li>åˆ›å»ºæœåŠ¡å™¨å¹¶æ³¨å†Œå·¥å…·&lt;/li>
&lt;li>é…ç½®å¹¶å¯åŠ¨æœåŠ¡å™¨&lt;/li>
&lt;/ol>
&lt;p>ä¸‹é¢æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»æ¯ä¸€æ­¥ã€‚&lt;/p>
&lt;h3>1. è®¾è®¡å¹¶å®šä¹‰å·¥å…·&lt;span class="hx-absolute -hx-mt-20" id="1-è®¾è®¡å¹¶å®šä¹‰å·¥å…·">&lt;/span>
&lt;a href="#1-%e8%ae%be%e8%ae%a1%e5%b9%b6%e5%ae%9a%e4%b9%89%e5%b7%a5%e5%85%b7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨MCPä¸­ï¼Œå·¥å…·ï¼ˆToolï¼‰æ˜¯LLMå¯ä»¥è°ƒç”¨çš„åŠŸèƒ½å•å…ƒã€‚æ¯ä¸ªå·¥å…·éœ€è¦å®šä¹‰ï¼š&lt;/p>
&lt;ul>
&lt;li>åç§°ï¼ˆNameï¼‰ï¼šå·¥å…·çš„æ ‡è¯†ç¬¦&lt;/li>
&lt;li>æè¿°ï¼ˆDescriptionï¼‰ï¼šå·¥å…·çš„åŠŸèƒ½æè¿°&lt;/li>
&lt;li>å‚æ•°ï¼ˆParametersï¼‰ï¼šå·¥å…·æ¥å—çš„å‚æ•°åŠå…¶ç±»å‹&lt;/li>
&lt;li>å¤„ç†å‡½æ•°ï¼ˆHandlerï¼‰ï¼šå®ç°å·¥å…·åŠŸèƒ½çš„å‡½æ•°&lt;/li>
&lt;/ul>
&lt;p>ä»¥mcp-k8sä¸­çš„&lt;code>get_api_resources&lt;/code>å·¥å…·ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å®šä¹‰å·¥å…·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">getAPIResourcesTool&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Tool&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;get_api_resources&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Description&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;è·å–é›†ç¾¤ä¸­æ‰€æœ‰æ”¯æŒçš„APIèµ„æºç±»å‹&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Parameters&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// æ­¤å·¥å…·ä¸éœ€è¦å‚æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Handler&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">handleGetAPIResources&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å®ç°å¤„ç†å‡½æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleGetAPIResources&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">rawParams&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RawMessage&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å…·ä½“å®ç°...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>2. å®ç°å·¥å…·çš„å…·ä½“åŠŸèƒ½&lt;span class="hx-absolute -hx-mt-20" id="2-å®ç°å·¥å…·çš„å…·ä½“åŠŸèƒ½">&lt;/span>
&lt;a href="#2-%e5%ae%9e%e7%8e%b0%e5%b7%a5%e5%85%b7%e7%9a%84%e5%85%b7%e4%bd%93%e5%8a%9f%e8%83%bd" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>å·¥å…·çš„Handlerå‡½æ•°å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚åœ¨mcp-k8sä¸­ï¼Œè¿™äº›å‡½æ•°ä¸»è¦ä¸Kubernetes APIäº¤äº’ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œè·å–APIèµ„æºåˆ—è¡¨çš„å®ç°ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleGetAPIResources&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">rawParams&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RawMessage&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ›å»ºk8s discoveryå®¢æˆ·ç«¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">discoveryClient&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">discovery&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewDiscoveryClientForConfig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeConfig&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;åˆ›å»ºdiscoveryå®¢æˆ·ç«¯å¤±è´¥: %w&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è·å–æœåŠ¡å™¨ä¸Šæ‰€æœ‰APIç»„&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">apiGroups&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">discoveryClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ServerGroups&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;è·å–APIç»„å¤±è´¥: %w&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¤„ç†ç»“æœå¹¶è¿”å›&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">processAPIGroups&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">apiGroups&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>3. åˆ›å»ºæœåŠ¡å™¨å¹¶æ³¨å†Œå·¥å…·&lt;span class="hx-absolute -hx-mt-20" id="3-åˆ›å»ºæœåŠ¡å™¨å¹¶æ³¨å†Œå·¥å…·">&lt;/span>
&lt;a href="#3-%e5%88%9b%e5%bb%ba%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%b9%b6%e6%b3%a8%e5%86%8c%e5%b7%a5%e5%85%b7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>ä½¿ç”¨mcp-goåˆ›å»ºMCPæœåŠ¡å™¨å¹¶æ³¨å†Œå·¥å…·ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ›å»ºMCPæœåŠ¡å™¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Default&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;åˆ›å»ºæœåŠ¡å™¨å¤±è´¥: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ³¨å†Œå·¥å…·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">getAPIResourcesTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">getResourceTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">listResourcesTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ... æ³¨å†Œæ›´å¤šå·¥å…·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¯åŠ¨æœåŠ¡å™¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;å¯åŠ¨æœåŠ¡å™¨å¤±è´¥: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>4. é…ç½®å¹¶å¯åŠ¨æœåŠ¡å™¨&lt;span class="hx-absolute -hx-mt-20" id="4-é…ç½®å¹¶å¯åŠ¨æœåŠ¡å™¨">&lt;/span>
&lt;a href="#4-%e9%85%8d%e7%bd%ae%e5%b9%b6%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>mcp-goæ”¯æŒå¤šç§ä¼ è¾“æ–¹å¼ï¼Œæœ€å¸¸ç”¨çš„æ˜¯stdioï¼ˆæ ‡å‡†è¾“å…¥/è¾“å‡ºï¼‰å’ŒSSEï¼ˆServer-Sent Eventsï¼‰ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// stdioæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Default&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithTransport&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransportStdio&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// SSEæ¨¡å¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Default&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithTransport&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransportSSE&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithHost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;localhost&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">8080&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>mcp-k8s: ä¸€ä¸ªå®Œæ•´çš„å®è·µæ¡ˆä¾‹&lt;span class="hx-absolute -hx-mt-20" id="mcp-k8s-ä¸€ä¸ªå®Œæ•´çš„å®è·µæ¡ˆä¾‹">&lt;/span>
&lt;a href="#mcp-k8s-%e4%b8%80%e4%b8%aa%e5%ae%8c%e6%95%b4%e7%9a%84%e5%ae%9e%e8%b7%b5%e6%a1%88%e4%be%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://github.com/silenceper/mcp-k8s" target="_blank" rel="noopener">mcp-k8s&lt;/a>æ˜¯ä¸€ä¸ªä½¿ç”¨mcp-goå¼€å‘çš„ã€ç”¨äºä¸Kubernetesé›†ç¾¤äº¤äº’çš„MCPæœåŠ¡å™¨ã€‚å®ƒæä¾›äº†ä»¥ä¸‹å·¥å…·ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>èµ„æºç±»å‹æŸ¥è¯¢å·¥å…·&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;code>get_api_resources&lt;/code>: è·å–é›†ç¾¤ä¸­æ‰€æœ‰æ”¯æŒçš„APIèµ„æºç±»å‹&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>èµ„æºæ“ä½œå·¥å…·&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;code>get_resource&lt;/code>: è·å–ç‰¹å®šèµ„æºçš„è¯¦ç»†ä¿¡æ¯&lt;/li>
&lt;li>&lt;code>list_resources&lt;/code>: åˆ—å‡ºæŸç§èµ„æºç±»å‹çš„æ‰€æœ‰å®ä¾‹&lt;/li>
&lt;li>&lt;code>create_resource&lt;/code>: åˆ›å»ºæ–°èµ„æºï¼ˆå¯é…ç½®ç¦ç”¨ï¼‰&lt;/li>
&lt;li>&lt;code>update_resource&lt;/code>: æ›´æ–°ç°æœ‰èµ„æºï¼ˆå¯é…ç½®ç¦ç”¨ï¼‰&lt;/li>
&lt;li>&lt;code>delete_resource&lt;/code>: åˆ é™¤èµ„æºï¼ˆå¯é…ç½®ç¦ç”¨ï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸‹æ˜¯mcp-k8sçš„æ ¸å¿ƒå®ç°ï¼š&lt;/p>
&lt;h3>ç›®å½•ç»“æ„&lt;span class="hx-absolute -hx-mt-20" id="ç›®å½•ç»“æ„">&lt;/span>
&lt;a href="#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>mcp-k8s/
â”œâ”€â”€ cmd/
â”‚ â””â”€â”€ server/
â”‚ â””â”€â”€ main.go # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/
â”‚ â”œâ”€â”€ config/ # é…ç½®å¤„ç†
â”‚ â”œâ”€â”€ k8s/ # Kuberneteså®¢æˆ·ç«¯
â”‚ â””â”€â”€ tools/ # MCPå·¥å…·å®ç°
â”œâ”€â”€ go.mod
â””â”€â”€ go.sum&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>ä¸»ç¨‹åºå…¥å£&lt;span class="hx-absolute -hx-mt-20" id="ä¸»ç¨‹åºå…¥å£">&lt;/span>
&lt;a href="#%e4%b8%bb%e7%a8%8b%e5%ba%8f%e5%85%a5%e5%8f%a3" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// cmd/server/main.go&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è§£æå‘½ä»¤è¡Œå‚æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">kubeconfig&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;kubeconfig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Kubernetesé…ç½®æ–‡ä»¶è·¯å¾„&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">enableCreate&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Bool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;enable-create&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;å¯ç”¨èµ„æºåˆ›å»ºæ“ä½œ&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">enableUpdate&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Bool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;enable-update&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;å¯ç”¨èµ„æºæ›´æ–°æ“ä½œ&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">enableDelete&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Bool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;enable-delete&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;å¯ç”¨èµ„æºåˆ é™¤æ“ä½œ&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">transport&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;transport&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;stdio&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ä¼ è¾“æ–¹å¼: stdioæˆ–sse&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">host&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;host&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;localhost&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;SSEæ¨¡å¼çš„ä¸»æœºå&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">port&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;port&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8080&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;SSEæ¨¡å¼çš„ç«¯å£&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆå§‹åŒ–Kuberneteså®¢æˆ·ç«¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">k8s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">InitClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">kubeconfig&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;åˆå§‹åŒ–K8så®¢æˆ·ç«¯å¤±è´¥: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ›å»ºMCPæœåŠ¡å™¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">serverOpts&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Default&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é…ç½®ä¼ è¾“æ–¹å¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">transport&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;sse&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">serverOpts&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">serverOpts&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithTransport&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransportSSE&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithHost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">host&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">port&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">serverOpts&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">serverOpts&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithTransport&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TransportStdio&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">serverOpts&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;åˆ›å»ºæœåŠ¡å™¨å¤±è´¥: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ³¨å†Œå·¥å…·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tools&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTools&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">tools&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">EnableCreate&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">enableCreate&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">EnableUpdate&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">enableUpdate&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">EnableDelete&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">enableDelete&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¯åŠ¨æœåŠ¡å™¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;å¯åŠ¨æœåŠ¡å™¨å¤±è´¥: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>å·¥å…·å®ç°ç¤ºä¾‹&lt;span class="hx-absolute -hx-mt-20" id="å·¥å…·å®ç°ç¤ºä¾‹">&lt;/span>
&lt;a href="#%e5%b7%a5%e5%85%b7%e5%ae%9e%e7%8e%b0%e7%a4%ba%e4%be%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>ä»¥&lt;code>get_resource&lt;/code>å·¥å…·ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// internal/tools/get_resource.go&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">GetResourceTool&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Tool&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;get_resource&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Description&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;è·å–ç‰¹å®šèµ„æºçš„è¯¦ç»†ä¿¡æ¯&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Parameters&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Parameter&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;apiVersion&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Description&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;èµ„æºçš„APIç‰ˆæœ¬&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Required&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;kind&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Description&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;èµ„æºç±»å‹&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Required&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Description&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;èµ„æºåç§°&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Required&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;namespace&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Description&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;èµ„æºæ‰€åœ¨çš„å‘½åç©ºé—´ï¼ˆå¦‚é€‚ç”¨ï¼‰&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;string&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Required&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Handler&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">handleGetResource&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">GetResourceParams&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">APIVersion&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;apiVersion&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Kind&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;kind&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;name&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Namespace&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;namespace&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleGetResource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">rawParams&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RawMessage&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">params&lt;/span> &lt;span class="nx">GetResourceParams&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unmarshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rawParams&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">params&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;è§£æå‚æ•°å¤±è´¥: %w&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è·å–åŠ¨æ€å®¢æˆ·ç«¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dynamicClient&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">k8s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetDynamicClient&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è·å–èµ„æºGVR (Group Version Resource)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">gvr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">namespaced&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">k8s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetGVR&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIVersion&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Kind&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç¡®å®šæ˜¯å‘½åç©ºé—´çº§åˆ«è¿˜æ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æº&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">object&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">unstructured&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Unstructured&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">namespaced&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¦‚æœæ˜¯å‘½åç©ºé—´çº§åˆ«èµ„æºä½†æœªæä¾›å‘½åç©ºé—´ï¼Œä½¿ç”¨é»˜è®¤å‘½åç©ºé—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">namespace&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Namespace&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">namespace&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">namespace&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;default&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">dynamicClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Resource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gvr&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Namespace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetOptions&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">dynamicClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Resource&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gvr&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">params&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetOptions&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;è·å–èµ„æºå¤±è´¥: %w&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">object&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>æ³¨å†Œæ‰€æœ‰å·¥å…·&lt;span class="hx-absolute -hx-mt-20" id="æ³¨å†Œæ‰€æœ‰å·¥å…·">&lt;/span>
&lt;a href="#%e6%b3%a8%e5%86%8c%e6%89%80%e6%9c%89%e5%b7%a5%e5%85%b7" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// internal/tools/tools.go&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Options&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">EnableCreate&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">EnableUpdate&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">EnableDelete&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">RegisterTools&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Server&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ³¨å†ŒæŸ¥è¯¢å·¥å…·ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">GetAPIResourcesTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">GetResourceTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ListResourcesTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ ¹æ®é…ç½®æ³¨å†Œå†™æ“ä½œå·¥å…·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EnableCreate&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">CreateResourceTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EnableUpdate&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">UpdateResourceTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EnableDelete&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterTool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">DeleteResourceTool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>ä½¿ç”¨æ–¹æ³•&lt;span class="hx-absolute -hx-mt-20" id="ä½¿ç”¨æ–¹æ³•">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>mcp-k8sæ”¯æŒä¸¤ç§é€šä¿¡æ¨¡å¼ï¼š&lt;/p>
&lt;h3>1. Stdioæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰&lt;span class="hx-absolute -hx-mt-20" id="1-stdioæ¨¡å¼é»˜è®¤">&lt;/span>
&lt;a href="#1-stdio%e6%a8%a1%e5%bc%8f%e9%bb%98%e8%ae%a4" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨stdioæ¨¡å¼ä¸‹ï¼Œmcp-k8sé€šè¿‡æ ‡å‡†è¾“å…¥/è¾“å‡ºæµä¸å®¢æˆ·ç«¯é€šä¿¡ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// MCPå®¢æˆ·ç«¯é…ç½®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mcpServers&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mcp-k8s&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;command&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/path/to/mcp-k8s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;args&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-kubeconfig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/path/to/kubeconfig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-enable-create&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-enable-delete&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-enable-update&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>2. SSEæ¨¡å¼&lt;span class="hx-absolute -hx-mt-20" id="2-sseæ¨¡å¼">&lt;/span>
&lt;a href="#2-sse%e6%a8%a1%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨SSEæ¨¡å¼ä¸‹ï¼Œmcp-k8sæš´éœ²HTTPç«¯ç‚¹ä¾›MCPå®¢æˆ·ç«¯è¿æ¥ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¿è¡ŒSSEæ¨¡å¼æœåŠ¡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./bin/mcp-k8s -kubeconfig&lt;span class="o">=&lt;/span>/path/to/kubeconfig -transport&lt;span class="o">=&lt;/span>sse -port&lt;span class="o">=&lt;/span>&lt;span class="m">8080&lt;/span> -host&lt;span class="o">=&lt;/span>localhost -enable-create -enable-delete -enable-update&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// MCPå®¢æˆ·ç«¯é…ç½®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mcpServers&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mcp-k8s&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;http://localhost:8080/sse&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;args&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>MCPæœåŠ¡å¼€å‘çš„æœ€ä½³å®è·µ&lt;span class="hx-absolute -hx-mt-20" id="mcpæœåŠ¡å¼€å‘çš„æœ€ä½³å®è·µ">&lt;/span>
&lt;a href="#mcp%e6%9c%8d%e5%8a%a1%e5%bc%80%e5%8f%91%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åŸºäºå¼€å‘mcp-k8sçš„ç»éªŒï¼Œæˆ‘æ€»ç»“äº†ä»¥ä¸‹å¼€å‘MCPæœåŠ¡çš„æœ€ä½³å®è·µï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>å·¥å…·å‘½åä¸åˆ†ç±»&lt;/strong>ï¼šä½¿ç”¨æ¸…æ™°ã€ä¸€è‡´çš„å‘½åæ–¹å¼ï¼ŒæŒ‰åŠŸèƒ½åˆ†ç±»å·¥å…·&lt;/li>
&lt;li>&lt;strong>å‚æ•°è®¾è®¡&lt;/strong>ï¼šå‚æ•°åç§°è¦ç›´è§‚ï¼Œæä¾›æ¸…æ™°çš„æè¿°ï¼Œæ˜ç¡®æ ‡è®°å¿…é€‰å‚æ•°&lt;/li>
&lt;li>&lt;strong>å®‰å…¨æ§åˆ¶&lt;/strong>ï¼šå¯¹å†™æ“ä½œæä¾›ç‹¬ç«‹çš„å¼€å…³æ§åˆ¶ï¼Œé¿å…ä¸å¿…è¦çš„æƒé™é£é™©&lt;/li>
&lt;li>&lt;strong>é”™è¯¯å¤„ç†&lt;/strong>ï¼šè¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©LLMç†è§£å¤±è´¥åŸå› &lt;/li>
&lt;li>&lt;strong>çŠ¶æ€ç®¡ç†&lt;/strong>ï¼šMCPæœåŠ¡åº”ä¿æŒæ— çŠ¶æ€ï¼Œæ‰€æœ‰å¿…è¦ä¿¡æ¯é€šè¿‡å‚æ•°ä¼ é€’&lt;/li>
&lt;li>&lt;strong>æ–‡æ¡£å®Œå–„&lt;/strong>ï¼šè¯¦ç»†è®°å½•æ¯ä¸ªå·¥å…·çš„åŠŸèƒ½ã€å‚æ•°å’Œä½¿ç”¨ç¤ºä¾‹&lt;/li>
&lt;/ol>
&lt;h2>ç»“è®º&lt;span class="hx-absolute -hx-mt-20" id="ç»“è®º">&lt;/span>
&lt;a href="#%e7%bb%93%e8%ae%ba" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ä½¿ç”¨Golangå’Œmcp-go SDKå¼€å‘MCPæœåŠ¡å™¨æ˜¯ä¸€ä¸ªç›¸å¯¹ç®€å•çš„è¿‡ç¨‹ã€‚é€šè¿‡å®šä¹‰å’Œå®ç°å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥è®©LLMå…·å¤‡ä¸å„ç§ç³»ç»Ÿäº¤äº’çš„èƒ½åŠ›ï¼Œä»è€Œå¤§å¤§æ‰©å±•å…¶åº”ç”¨åœºæ™¯ã€‚&lt;/p>
&lt;p>mcp-k8sé¡¹ç›®å±•ç¤ºäº†å¦‚ä½•æ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„MCPæœåŠ¡å™¨ï¼Œè®©LLMèƒ½å¤ŸæŸ¥è¯¢ã€åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤Kubernetesèµ„æºï¼Œä¸ºé›†ç¾¤ç®¡ç†æä¾›äº†æ–°çš„äº¤äº’æ–¹å¼ã€‚&lt;/p>
&lt;p>å¸Œæœ›æœ¬æ–‡èƒ½å¤Ÿå¸®åŠ©ä½ ç†è§£MCPåè®®å’Œä½¿ç”¨Golangå¼€å‘MCPæœåŠ¡å™¨çš„åŸºæœ¬æ–¹æ³•ã€‚æ›´å¤šè¯¦æƒ…ï¼Œæ¬¢è¿è®¿é—®&lt;a href="https://github.com/silenceper/mcp-k8s" target="_blank" rel="noopener">mcp-k8s&lt;/a>é¡¹ç›®ï¼Œæˆ–æŸ¥çœ‹&lt;a href="https://github.com/mark3labs/mcp-go" target="_blank" rel="noopener">mark3labs/mcp-go&lt;/a>çš„æ–‡æ¡£ã€‚&lt;/p>
&lt;h2>å‚è€ƒèµ„æ–™&lt;span class="hx-absolute -hx-mt-20" id="å‚è€ƒèµ„æ–™">&lt;/span>
&lt;a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ol>
&lt;li>&lt;a href="https://github.com/llm-tools/model-control-protocol" target="_blank" rel="noopener">MCPåè®®è§„èŒƒ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/mark3labs/mcp-go" target="_blank" rel="noopener">mcp-go SDK&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/silenceper/mcp-k8s" target="_blank" rel="noopener">mcp-k8sé¡¹ç›®&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener">Kubernetes client-goæ–‡æ¡£&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2>AI&amp;amp;&amp;amp;MCPäº¤æµç¾¤&lt;span class="hx-absolute -hx-mt-20" id="aimcpäº¤æµç¾¤">&lt;/span>
&lt;a href="#aimcp%e4%ba%a4%e6%b5%81%e7%be%a4" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æˆ‘å»ºäº†ä¸€ä¸ª&amp;quot;AIæŠ€æœ¯äº¤æµç¾¤&amp;quot;ï¼Œç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿å¤§å®¶äº¤æµAIç›¸å…³çš„çŸ¥è¯†å’Œå…±äº«èµ„æºï¼Œç›®å‰AIå˜åŒ–çœŸçš„æ˜¯å¤ªå¿«äº†ï¼Œå¦‚æœäºŒç»´ç å¤±æ•ˆå¤§å®¶å…³æ³¨å…¬ä¼—å·&amp;quot;AIæŠ€æœ¯å°æ—&amp;quot;ï¼Œå‘é€å…³é”®å­—â€åŠ ç¾¤â€œï¼Œæ‹‰ä½ è¿›å»ï¼Œï¼›
&lt;img src="https://public-1251960616.cos.ap-nanjing.myqcloud.com/images/WechatIMG247.jpg" alt="" loading="lazy" />
&lt;img src="https://public-1251960616.cos.ap-nanjing.myqcloud.com/images/qrcode-ai.bmp" alt="" loading="lazy" />&lt;/p></description></item><item><title>MCP-K8sï¼šå½“AIæˆä¸ºæˆ‘çš„Kuberneteså°åŠ©æ‰‹</title><link>/blog/202504/mcp-k8s/</link><pubDate>Thu, 03 Apr 2025 22:20:59 +0800</pubDate><guid>/blog/202504/mcp-k8s/</guid><description>
&lt;p>è¿˜è®°å¾—åˆšå¼€å§‹æ¥è§¦Kubernetesæ—¶çš„æ„Ÿå—å—ï¼Ÿå¤æ‚çš„æ¶æ„ã€ç¹å¤šçš„æ¦‚å¿µã€ä»¥åŠé‚£äº›éœ€è¦è®°å¿†çš„kubectlå‘½ä»¤&amp;hellip;ï¼Œç°åœ¨æœ‰äº†MCPå¯ä»¥è®©è¿™ç§äº¤äº’å˜å¾—æ›´åŠ ç®€å•ï¼Œå°è¯•é€šè¿‡AIè‡ªç„¶è¯­è¨€å¯¹è¯æ¥å®Œæˆå¯¹k8sé›†ç¾¤å„ç§èµ„æºçš„æ“ä½œä¹ƒè‡³äºå®šäºé›†ç¾¤çš„é—®é¢˜ã€‚&lt;/p>
&lt;h2>å®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ&lt;span class="hx-absolute -hx-mt-20" id="å®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„">&lt;/span>
&lt;a href="#%e5%ae%83%e6%98%af%e6%80%8e%e4%b9%88%e5%b7%a5%e4%bd%9c%e7%9a%84" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è¯´èµ·æ¥å¾ˆç®€å•ï¼ŒMCP-K8så°±åƒæ˜¯åœ¨Kuberneteså’ŒAIä¹‹é—´æ­äº†ä¸€åº§æ¡¥ã€‚é€šè¿‡MCPï¼ˆModel Control Protocolï¼‰åè®®ï¼Œå®ƒèƒ½è®©AIç†è§£ä½ çš„è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œå¹¶è½¬æ¢æˆå¯¹åº”çš„Kubernetesæ“ä½œã€‚&lt;/p>
&lt;p>è¦ç”¨èµ·æ¥ä¹Ÿè¶…çº§ç®€å•ï¼Œåªéœ€è¦åœ¨Cursorä¸­é…ç½®ä¸€ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mcpServers&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;mcp-k8s&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;command&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/path/to/mcp-k8s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;args&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-kubeconfig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;/path/to/kubeconfig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-enable-create&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-enable-delete&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;-enable-update&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>å®æˆ˜ä½“éªŒ&lt;span class="hx-absolute -hx-mt-20" id="å®æˆ˜ä½“éªŒ">&lt;/span>
&lt;a href="#%e5%ae%9e%e6%88%98%e4%bd%93%e9%aa%8c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æ¥çœ‹çœ‹å®é™…ç”¨èµ·æ¥æ˜¯ä»€ä¹ˆæ„Ÿè§‰ï¼š&lt;/p>
&lt;h3>æŸ¥è¯¢é›†ç¾¤ä¿¡æ¯&lt;span class="hx-absolute -hx-mt-20" id="æŸ¥è¯¢é›†ç¾¤ä¿¡æ¯">&lt;/span>
&lt;a href="#%e6%9f%a5%e8%af%a2%e9%9b%86%e7%be%a4%e4%bf%a1%e6%81%af" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æ¯”å¦‚æˆ‘æƒ³çœ‹çœ‹é›†ç¾¤èŠ‚ç‚¹æƒ…å†µï¼Œç›´æ¥é—®å°±å¥½äº†ï¼š&lt;/p>
&lt;p>&lt;img src="https://fastly.jsdelivr.net/gh/bucketio/img3@main/2025/04/04/1743696360238-e9a6e1a0-7e80-4ee4-a8b1-95ac9895c8d6.png" alt="" loading="lazy" />&lt;/p>
&lt;p>æŸ¥è¯¢k8sç‰ˆæœ¬
&lt;img src="https://fastly.jsdelivr.net/gh/bucketio/img1@main/2025/04/04/1743696412136-0acd7f20-dfbd-4914-88c8-97c994aaa8f3.png" alt="" loading="lazy" />&lt;/p>
&lt;h3>åˆ›å»ºèµ„æº&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»ºèµ„æº">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%ba%e8%b5%84%e6%ba%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>éœ€è¦åˆ›å»ºæ–°èµ„æºï¼Ÿå°±åƒè·ŸåŒäº‹è¯´è¯ä¸€æ ·æè¿°ä½ çš„éœ€æ±‚ï¼š&lt;/p>
&lt;p>AIä¼šå¸®ä½ å¤„ç†å¥½æ‰€æœ‰ç»†èŠ‚ï¼š&lt;/p>
&lt;p>&lt;img src="https://fastly.jsdelivr.net/gh/bucketio/img16@main/2025/04/04/1743696489031-d64a1eab-425a-45eb-ba01-919bf4e1bf2d.png" alt="" loading="lazy" />&lt;/p>
&lt;p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="https://fastly.jsdelivr.net/gh/bucketio/img5@main/2025/04/04/1743696505355-2b937898-2ba3-477c-8602-2ef41b0e340a.png" alt="" loading="lazy" />&lt;/p>
&lt;h3>æ¨¡æ‹Ÿæ’éšœ&lt;span class="hx-absolute -hx-mt-20" id="æ¨¡æ‹Ÿæ’éšœ">&lt;/span>
&lt;a href="#%e6%a8%a1%e6%8b%9f%e6%8e%92%e9%9a%9c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>è¿™ä¸ªæ˜¯æˆ‘æœ€å–œæ¬¢çš„éƒ¨åˆ†ã€‚æœ‰ä¸€æ¬¡æˆ‘æ•…æ„æäº†ä¸ªé—®é¢˜ï¼Œæœ‰ä¸€ä¸ªpodæ²¡æœ‰runningï¼š&lt;/p>
&lt;p>&lt;img src="https://fastly.jsdelivr.net/gh/bucketio/img5@main/2025/04/04/1743696613252-7db3f346-231f-45b2-9d37-17ee9a6df034.png" alt="" loading="lazy" />&lt;/p>
&lt;p>åªéœ€è¦ç®€å•è¯´æ˜æƒ…å†µï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>mcp-demo å‘½åç©ºé—´ä¸‹æœ‰ä¸ªnginx çš„podæ²¡æœ‰runningï¼Œçœ‹ä¸‹æ˜¯ä»€ä¹ˆåŸå› å¹¶è§£å†³&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;img src="https://fastly.jsdelivr.net/gh/bucketio/img15@main/2025/04/04/1743696631863-bcb23517-9775-4eac-aef8-833abea9dbfd.png" alt="" loading="lazy" />&lt;/p>
&lt;p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­AIä¼šè‡ªåŠ¨è°ƒç”¨mcp å·¥å…·ï¼Œå¹¶å°†æŸ¥è¯¢åˆ°çš„ç»“æœæäº¤ç»™å¤§æ¨¡å‹è¿›è¡Œåˆ†æï¼Œåˆ†æä¹‹å è¿›è¡Œå®šä½å¹¶è§£å†³&lt;/p>
&lt;h2>ä¸ªäººæƒ³æ³•&lt;span class="hx-absolute -hx-mt-20" id="ä¸ªäººæƒ³æ³•">&lt;/span>
&lt;a href="#%e4%b8%aa%e4%ba%ba%e6%83%b3%e6%b3%95" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è¿™é‡Œä¸å¾—ä¸å¤¸ä¸€ä¸‹Claudeæ¨¡å‹ï¼Œæ„Ÿè§‰å®ƒç‰¹åˆ«èƒ½å¤Ÿç†è§£mcpçš„toolï¼Œæ¯æ¬¡éƒ½èƒ½å¤Ÿç²¾å‡†çš„çŸ¥é“åº”è¯¥ä¼ å…¥é‚£ç§å‚æ•°ã€‚è™½ç„¶åœ¨toolå®šä¹‰ä¸­éƒ½æœ‰æè¿°ï¼Œä½†æ˜¯å¯¹æ¯”äº†å…¶ä»–çš„ä¸€äº›æ¨¡å‹å’Œmcp serverçš„äº¤äº’ï¼Œæ€»æ˜¯ä¸å°½äººæ„ï¼Œè¦ä¸å°±æ˜¯ç»™çš„å‚æ•°jsonæ ¼å¼é”™è¯¯ï¼Œè¦ä¸å°±æ˜¯ç†è§£é”™äº†å‚æ•°éœ€è¦ä¼ å…¥çš„ä¿¡æ¯ã€‚&lt;/p>
&lt;h2>æŠ€æœ¯ç‚¹åˆ†äº«&lt;span class="hx-absolute -hx-mt-20" id="æŠ€æœ¯ç‚¹åˆ†äº«">&lt;/span>
&lt;a href="#%e6%8a%80%e6%9c%af%e7%82%b9%e5%88%86%e4%ba%ab" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è¯´å®è¯ï¼Œèƒ½æŠŠè¿™ä¸ªé¡¹ç›®åšå‡ºæ¥ï¼Œä¸»è¦å½’åŠŸäºï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>AIç†è§£èƒ½åŠ›&lt;/strong>: ç‰¹åˆ«æ˜¯Claudeè¿™æ ·çš„æ¨¡å‹ï¼Œå¯¹ä¸Šä¸‹æ–‡çš„ç†è§£çœŸçš„å¾ˆåˆ°ä½&lt;/li>
&lt;li>&lt;strong>å‚æ•°å¤„ç†&lt;/strong>: AIèƒ½è‡ªåŠ¨æ¨æ–­å‡ºæ­£ç¡®çš„å‚æ•°ï¼Œè¿™ä¸ªå¤ªçœå¿ƒäº†&lt;/li>
&lt;li>&lt;strong>é—®é¢˜è¯Šæ–­&lt;/strong>: å®ƒä¸æ˜¯ç®€å•åœ°æ‰§è¡Œå‘½ä»¤ï¼Œè€Œæ˜¯çœŸçš„èƒ½ç†è§£é—®é¢˜å¹¶ç»™å‡ºè§£å†³æ–¹æ¡ˆ&lt;/li>
&lt;/ol>
&lt;h2>æœªæ¥ç•…æƒ³&lt;span class="hx-absolute -hx-mt-20" id="æœªæ¥ç•…æƒ³">&lt;/span>
&lt;a href="#%e6%9c%aa%e6%9d%a5%e7%95%85%e6%83%b3" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è¯´å®è¯ï¼Œç°åœ¨çš„åŠŸèƒ½è¿˜åªæ˜¯å†°å±±ä¸€è§’ã€‚æˆ‘è§‰å¾—æœªæ¥å¯ä»¥åšçš„äº‹æƒ…è¿˜æœ‰å¾ˆå¤šï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>æ™ºèƒ½è¿ç»´&lt;/strong>: è®©AIä¸åªæ˜¯æ‰§è¡Œå‘½ä»¤ï¼Œè¿˜èƒ½ä¸»åŠ¨å‘ç°å’Œé¢„é˜²é—®é¢˜&lt;/li>
&lt;li>&lt;strong>è¿ç»´è‡ªåŠ¨åŒ–&lt;/strong>: é€šè¿‡ç®€å•çš„å¯¹è¯å®Œæˆå¤æ‚çš„è¿ç»´æµç¨‹&lt;/li>
&lt;li>&lt;strong>ç»éªŒæ²‰æ·€&lt;/strong>: æŠŠæ¯æ¬¡æ’éšœçš„ç»éªŒéƒ½å˜æˆAIçš„çŸ¥è¯†ï¼Œè¶Šç”¨è¶Šæ™ºèƒ½&lt;/li>
&lt;/ol>
&lt;h2>å†™åœ¨æœ€å&lt;span class="hx-absolute -hx-mt-20" id="å†™åœ¨æœ€å">&lt;/span>
&lt;a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åšè¿™ä¸ªé¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å¤§çš„æ„Ÿå—å°±æ˜¯ï¼šæŠ€æœ¯å‘å±•çœŸçš„å¤ªå¿«äº†ï¼ŒAIç»™æˆ‘ä»¬å¸¦æ¥äº†å¤ªå¤šå¯èƒ½æ€§ã€‚è™½ç„¶ç°åœ¨è¿˜æœ‰å¾ˆå¤šå¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Œä½†æˆ‘ç›¸ä¿¡è¿™åªæ˜¯å¼€å§‹ã€‚æœŸå¾…çœ‹åˆ°æ›´å¤šäººåŠ å…¥è¿›æ¥ï¼Œä¸€èµ·æŠŠKubernetesè¿ç»´å˜å¾—æ›´ç®€å•ã€æ›´æ™ºèƒ½ã€‚&lt;/p>
&lt;p>å¦‚æœä½ ä¹Ÿå¯¹è¿™ä¸ªé¡¹ç›®æ„Ÿå…´è¶£ï¼Œæ¬¢è¿æ¥&lt;a href="https://github.com/silenceper/mcp-k8s" target="_blank" rel="noopener">GitHub&lt;/a>çœ‹çœ‹ï¼Œä¸€èµ·è®¨è®ºï¼Œä¸€èµ·æ”¹è¿›ã€‚&lt;/p></description></item><item><title>xfsquotaï¼šä¸€ä¸ªä¾¿æ·çš„ç®¡ç†xfsç£ç›˜é…é¢çš„å‘½ä»¤è¡Œå·¥å…·</title><link>/blog/202204/xfsquota-golang/</link><pubDate>Sat, 23 Apr 2022 22:20:59 +0800</pubDate><guid>/blog/202204/xfsquota-golang/</guid><description>
&lt;p>&lt;strong>æºç åœ°å€ï¼š&lt;/strong>&lt;a href="https://github.com/silenceper/xfsquota" target="_blank" rel="noopener">https://github.com/silenceper/xfsquota&lt;/a>&lt;/p>
&lt;h2>åŠ¨æœº&lt;span class="hx-absolute -hx-mt-20" id="åŠ¨æœº">&lt;/span>
&lt;a href="#%e5%8a%a8%e6%9c%ba" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;strong>åœ¨Linuxæœ‰ä¸€ä¸ª&lt;code>xfs_quota&lt;/code>ï¼ˆåœ¨&lt;code>xfsprogs&lt;/code>å·¥å…·åŒ…ä¸‹ï¼‰å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸ºä»€ä¹ˆè¿˜ç”¨golangå®ç°äº†ï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>ä¸»è¦æ˜¯è¦å› ä¸ºæœ€è¿‘è¦å®ç°ç£ç›˜quotaçš„æ§åˆ¶ï¼ŒåŒæ—¶è§‰å¾—çœ‹äº†dockerå†…çš„æºç ï¼Œéƒ½æ˜¯åˆ©ç”¨cgoçš„æ–¹å¼æ¥å®ç°çš„ï¼Œå¦‚æœç›´æ¥ç”¨&lt;code>xfs_quota&lt;/code>çš„æ–¹å¼æŸ¥çœ‹é…é¢ï¼Œæ— æ³•ç›´è§‚çš„çœ‹åˆ°æŸä¸€ä¸ªç›®å½•ä¸‹çš„é…é¢ï¼Œåªèƒ½åˆ—å‡ºæ‰€æœ‰ï¼Œå¹¶ä¸”æ²¡æœ‰å…·ä½“ç›®å½•ï¼Œç±»ä¼¼å¦‚ä¸‹ç»“æœï¼Œåœ¨è®¾ç½®äº†docker å®¹å™¨çš„quotaä¹‹åæŸ¥çœ‹æ¯ä¸ªå®¹å™¨çš„é…é¢ï¼Œåªæœ‰&lt;code>Project ID&lt;/code>æ— æ³•åˆ¤åˆ«åˆ°å…·ä½“æŸä¸ªç›®å½•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># xfs_quota -x -c &amp;#34;report&amp;#34; /data&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Project quota on /data &lt;span class="o">(&lt;/span>/dev/vdb&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Blocks
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Project ID Used Soft Hard Warn/Grace
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---------- --------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#0 7394256 0 0 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#2 8 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#3 8 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#4 8 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#5 2360 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#6 8 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#7 8 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#8 8 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#9 10568 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#10 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#11 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#12 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#13 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#14 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#15 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#16 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#17 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#18 0 52428800 52428800 00 [--------]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#19 0 52428800 52428800 00 [--------]&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ‰€æœ‰ç”¨cgoçš„æ–¹å¼ï¼Œå¯ä»¥å®ç°å¯¹æŸä¸ªç›®å½•çš„quotaæŸ¥çœ‹ã€‚&lt;/p>
&lt;h2>ä¸»è¦åŠŸèƒ½&lt;span class="hx-absolute -hx-mt-20" id="ä¸»è¦åŠŸèƒ½">&lt;/span>
&lt;a href="#%e4%b8%bb%e8%a6%81%e5%8a%9f%e8%83%bd" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>
&lt;p>support set quota&lt;/p>
&lt;/li>
&lt;li>
&lt;p>support get quota&lt;/p>
&lt;/li>
&lt;li>
&lt;p>clean quota&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Usage&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">xfsquota is a tool &lt;span class="k">for&lt;/span> managing XFS quotas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Usage:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> xfsquota &lt;span class="o">[&lt;/span>command&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Available Commands:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> clean clean quota information
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> completion Generate the autocompletion script &lt;span class="k">for&lt;/span> the specified shell
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> get Get quota information
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">help&lt;/span> Help about any &lt;span class="nb">command&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">set&lt;/span> Set quota information
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> version get version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Flags:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> xfsquota
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Use &lt;span class="s2">&amp;#34;xfsquota [command] --help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> more information about a command.&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>Set Quota&lt;span class="hx-absolute -hx-mt-20" id="set-quota">&lt;/span>
&lt;a href="#set-quota" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>set quota size 1MiB ,inodes 20 for path &lt;code>/data/test/quota&lt;/code>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&amp;gt; xfsquota &lt;span class="nb">set&lt;/span> /data/test/quota -s 1MiB -i &lt;span class="m">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> quota success, path: /data/test/quota, size:1MiB, inodes:20&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>Get Quota&lt;span class="hx-absolute -hx-mt-20" id="get-quota">&lt;/span>
&lt;a href="#get-quota" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>get quota for path &lt;code>/data/test/quota&lt;/code>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&amp;gt; xfsquota get /data/test/quota
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">quota Size&lt;span class="o">(&lt;/span>bytes&lt;span class="o">)&lt;/span>: &lt;span class="m">1048576&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">quota Inodes: &lt;span class="m">20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">diskUsage Size&lt;span class="o">(&lt;/span>bytes&lt;span class="o">)&lt;/span>: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">diskUsage Inodes: &lt;span class="m">1&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>Clean Quota&lt;span class="hx-absolute -hx-mt-20" id="clean-quota">&lt;/span>
&lt;a href="#clean-quota" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>xfsquota clean /data/test/quota&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>emptyDir é€šè¿‡xfs_quota å¼ºåˆ¶é™åˆ¶å¤§å°</title><link>/blog/202110/enforce-limit-emptydir-size/</link><pubDate>Sat, 30 Oct 2021 23:20:59 +0800</pubDate><guid>/blog/202110/enforce-limit-emptydir-size/</guid><description>
&lt;p>emptyDiræ”¯æŒä¸‰ç§ç±»å‹çš„ï¼Œé€šè¿‡è®¾ç½® &lt;code>medium&lt;/code> å­—æ®µ ï¼š&lt;/p>
&lt;ul>
&lt;li>æ–‡ä»¶ï¼šé»˜è®¤æƒ…å†µ&lt;/li>
&lt;li>Memoryï¼šå ç”¨å†…å­˜èµ„æº&lt;/li>
&lt;li>HugePages&lt;/li>
&lt;/ul>
&lt;h2>sizeLimité»˜è®¤è¡Œä¸º&lt;span class="hx-absolute -hx-mt-20" id="sizelimité»˜è®¤è¡Œä¸º">&lt;/span>
&lt;a href="#sizelimit%e9%bb%98%e8%ae%a4%e8%a1%8c%e4%b8%ba" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åŒæ—¶æ”¯æŒé€šè¿‡sizeLimitè®¾ç½®é™åˆ¶çš„å¤§å°ï¼Œä½†æ˜¯è¿™ä¸ªå¤§å°é»˜è®¤æƒ…å†µä¸‹(&lt;code>LocalStorageCapacityIsolation&lt;/code> ç‰¹æ€§é»˜è®¤å¼€å¯)å¹¶ä¸æ˜¯å¼ºåˆ¶é™åˆ¶çš„ï¼Œè€Œæ˜¯ç”±eviction manager æ‰«æåˆ°è¶…è¿‡è®¾å®šçš„å¤§å°ä¹‹åï¼Œå†å°†podè¿›è¡Œé©±é€ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€ç§æƒ…å†µå°±æ˜¯æ–‡ä»¶å…¶å®å·²ç»è¶…è¿‡äº†é™å®šçš„å¤§å°(å¯èƒ½å·²ç»å½±å“åˆ°äº†ç³»ç»Ÿä¸Šå…¶ä»–æœåŠ¡)ï¼Œè€Œé©±é€æ˜¯å®šæ—¶è§¦å‘çš„ï¼Œæœ‰ä¸€å®šçš„æ—¶é—´é—´éš”ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¾¾åˆ°å¼ºåˆ¶çš„æ•ˆæœçš„è¯ï¼Œå°±éœ€è¦åšä¸€äº›hackã€‚&lt;/p>
&lt;h2>é€šè¿‡xfs quota é™åˆ¶&lt;span class="hx-absolute -hx-mt-20" id="é€šè¿‡xfs-quota-é™åˆ¶">&lt;/span>
&lt;a href="#%e9%80%9a%e8%bf%87xfs-quota-%e9%99%90%e5%88%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>kubelet root-dir ä½¿ç”¨xfsæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶é™„ä¸Š &lt;code>project quota&lt;/code> å±æ€§ï¼Œä¾‹å¦‚ï¼š &lt;code>/dev/vdb /data xfs noatime,prjquota 1 2&lt;/code>&lt;/li>
&lt;li>nodeä¸Š &lt;code>xfs_quota&lt;/code> å·¥å…·ä½¿ç”¨è¾ƒæ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ”¯æŒ &lt;code>-f&lt;/code> å‚æ•°&lt;/li>
&lt;/ul>
&lt;p>å…¶å®åœ¨ k8s 1.15å¢åŠ äº†ä¸€ä¸ªç‰¹æ€§ &lt;code>LocalStorageCapacityIsolationFSQuotaMonitoring&lt;/code> (PRï¼š&lt;a href="https://github.com/kubernetes/kubernetes/pull/66928" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/pull/66928&lt;/a>) ï¼Œè¿™ä¸ªç‰¹æ€§å°±æ˜¯é€šè¿‡XFS quotasæ¥ç»™kubeletç›®å½•è®¾ç½®é…é¢ï¼Œä½†æ˜¯è¿™é‡Œä»…ä»…åªæ˜¯ç›‘æ§æ¶ˆè€—ï¼Œå¹¶æ²¡æœ‰å¼ºåˆ¶é™åˆ¶ï¼Œå¯ä»¥çœ‹ä¸‹è¿™æ®µä»£ç ï¼š&lt;/p>
&lt;p>&lt;a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/volume/util/fsquota/quota_linux.go#L342-L343" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/pkg/volume/util/fsquota/quota_linux.go#L342-L343&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">AssignQuota&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="nx">mount&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">poduid&lt;/span> &lt;span class="nx">types&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">bytes&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">resource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Quantity&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>&lt;span class="p">..&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿™é‡Œå¼ºåˆ¶è®¾ç½®æˆäº†-1 è¡¨ç¤ºæ— é™åˆ¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ibytes&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ibytes&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">setQuotaOnDir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ibytes&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">quotaPodMap&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">poduid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">quotaSizeMap&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ibytes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">podQuotaMap&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">poduid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dirQuotaMap&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dirPodMap&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">poduid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">podDirCountMap&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">poduid&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Assigning quota ID %d (%d) to %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ibytes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">removeProjectID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;assign quota FAILED %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>hack&lt;span class="hx-absolute -hx-mt-20" id="hack">&lt;/span>
&lt;a href="#hack" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>å°†å…¶ä¸­ &lt;code>ibytes &amp;gt; 0&lt;/code> åˆ¤æ–­æ”¹ä¸º &lt;code>ibytes â‰¤ 0&lt;/code> å³ï¼ŒsetQuotaçš„æ—¶å€™å°†sizeLimitè®¾ç½®è¿›å»ï¼Œå°±å¯ä»¥è¾¾åˆ°å¼ºåˆ¶é™åˆ¶çš„æ•ˆæœã€‚&lt;/p>
&lt;p>æµ‹è¯•ä¸€ä¸‹ï¼š&lt;/p>
&lt;p>pod.yaml&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pod&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">app&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pod-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;100000&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">sleep&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">IfNotPresent&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">data-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/data/test/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">data-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">emptyDir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">sizeLimit&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;50Mi&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è¿›å…¥podä¸­å†™å…¥æ–‡ä»¶æµ‹è¯•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">root@pod-test:/data/test# dd if=/dev/zero of=./bigfile bs=1M count=2000&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">dd: error writing &amp;#39;./bigfile&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">No&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">space left on device&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="m">51+0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">records in&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="m">50+0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">records out&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="m">52428800&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bytes (52 MB, 50 MiB) copied, 0.0573529 s, 914 MB/s&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è¾¾åˆ°æˆ‘ä»¬çš„é¢„æœŸã€‚&lt;/p>
&lt;h3>å‚è€ƒ&lt;span class="hx-absolute -hx-mt-20" id="å‚è€ƒ">&lt;/span>
&lt;a href="#%e5%8f%82%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>&lt;a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#emptydir" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/concepts/storage/volumes/#emptydir&lt;/a>&lt;/p></description></item><item><title>csi-driver-host-pathå®‰è£…</title><link>/kubernetes-book/csi/csi-driver-host-path.html</link><pubDate>Sat, 28 Nov 2020 15:40:59 +0800</pubDate><guid>/kubernetes-book/csi/csi-driver-host-path.html</guid><description>
&lt;blockquote>
&lt;p>é›†ç¾¤ v1.19.0&lt;/p>
&lt;/blockquote>
&lt;h2>å®‰è£…&lt;span class="hx-absolute -hx-mt-20" id="å®‰è£…">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/master/docs/deploy-1.17-and-later.md" target="_blank" rel="noopener">https://github.com/kubernetes-csi/csi-driver-host-path/blob/master/docs/deploy-1.17-and-later.md&lt;/a>&lt;/p>
&lt;h3>VolumeSnapshot CRDs and snapshot controller installation&lt;span class="hx-absolute -hx-mt-20" id="volumesnapshot-crds-and-snapshot-controller-installation">&lt;/span>
&lt;a href="#volumesnapshot-crds-and-snapshot-controller-installation" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Apply VolumeSnapshot CRDs version:v2.0.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v2.0.1/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v2.0.1/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v2.0.1/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Create snapshot controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v2.0.1/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v2.0.1/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>Deployment&lt;span class="hx-absolute -hx-mt-20" id="deployment">&lt;/span>
&lt;a href="#deployment" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>ä»£ç åœ°å€ï¼šhttps://github.com/kubernetes-csi/csi-driver-host-path&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sh deploy/kubernetes-latest/deploy.sh&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å®‰è£…æˆåŠŸï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">âœ ~ kubectl get pod&lt;span class="p">|&lt;/span>grep csi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-hostpath-attacher-0 1/1 Running &lt;span class="m">0&lt;/span> 76m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-hostpath-provisioner-0 1/1 Running &lt;span class="m">0&lt;/span> 76m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-hostpath-resizer-0 1/1 Running &lt;span class="m">1&lt;/span> 76m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-hostpath-snapshotter-0 1/1 Running &lt;span class="m">0&lt;/span> 76m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-hostpath-socat-0 1/1 Running &lt;span class="m">0&lt;/span> 76m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-hostpathplugin-0 3/3 Running &lt;span class="m">1&lt;/span> 76m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">my-csi-app 1/1 Running &lt;span class="m">0&lt;/span> 46m&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å› ä¸ºéªŒè¯è€Œå·²ï¼Œè¿™é‡Œ&lt;code>csi-hostpathplugin&lt;/code>ç»„ä»¶åªéƒ¨ç½²äº†ä¸€ä¸ªï¼Œprovisionerå’Œattacherç»„ä»¶éƒ½ä¼šè°ƒç”¨è¿™ä¸ªç»„ä»¶ä¸Šæ¥&lt;/p>
&lt;h3>éªŒè¯&lt;span class="hx-absolute -hx-mt-20" id="éªŒè¯">&lt;/span>
&lt;a href="#%e9%aa%8c%e8%af%81" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>éƒ¨ç½²æµ‹è¯•åº”ç”¨ï¼ŒstorageClass,pvc,app:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ &lt;span class="k">for&lt;/span> i in ./examples/csi-storageclass.yaml ./examples/csi-pvc.yaml ./examples/csi-app.yaml&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> kubectl apply -f &lt;span class="nv">$i&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">storageclass.storage.k8s.io/csi-hostpath-sc created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">persistentvolumeclaim/csi-pvc created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pod/my-csi-app created&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æŸ¥çœ‹pvå·²è‡ªåŠ¨åˆ›å»ºå‡ºæ¥äº†&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ kubectl get pv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e 1Gi RWO Delete Bound default/csi-pvc csi-hostpath-sc 50m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get pvc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">csi-pvc Bound pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e 1Gi RWO csi-hostpath-sc 50m&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>åœ¨èŠ‚ç‚¹ä¸Šçš„/var/lib/csi-hostpath-data/ç›®å½•ä¸‹å·²ç»æœ‰ç›®å½•åˆ›å»ºå‡ºæ¥äº†&lt;/p>
&lt;/blockquote>
&lt;p>å¯ä»¥é€šè¿‡æŸ¥çœ‹å®¹å™¨&lt;code>csi-hostpathplugin-0 &lt;/code>çš„logæ¥çœ‹æ•´ä¸ªpvçš„åˆ›å»ºä»¥åŠattachè¿‡ç¨‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">I1116 06:54:50.518286 &lt;span class="m">1&lt;/span> server.go:117&lt;span class="o">]&lt;/span> GRPC call: /csi.v1.Controller/CreateVolume
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:50.518384 &lt;span class="m">1&lt;/span> server.go:118&lt;span class="o">]&lt;/span> GRPC request: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;accessibility_requirements&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;preferred&amp;#34;&lt;/span>:&lt;span class="o">[{&lt;/span>&lt;span class="s2">&amp;#34;segments&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;topology.hostpath.csi/node&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;minikube&amp;#34;&lt;/span>&lt;span class="o">}}]&lt;/span>,&lt;span class="s2">&amp;#34;requisite&amp;#34;&lt;/span>:&lt;span class="o">[{&lt;/span>&lt;span class="s2">&amp;#34;segments&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;topology.hostpath.csi/node&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;minikube&amp;#34;&lt;/span>&lt;span class="o">}}]}&lt;/span>,&lt;span class="s2">&amp;#34;capacity_range&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;required_bytes&amp;#34;&lt;/span>:1073741824&lt;span class="o">}&lt;/span>,&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;volume_capabilities&amp;#34;&lt;/span>:&lt;span class="o">[{&lt;/span>&lt;span class="s2">&amp;#34;AccessType&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Mount&amp;#34;&lt;/span>:&lt;span class="o">{}}&lt;/span>,&lt;span class="s2">&amp;#34;access_mode&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;mode&amp;#34;&lt;/span>:1&lt;span class="o">}}]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:50.581056 &lt;span class="m">1&lt;/span> controllerserver.go:165&lt;span class="o">]&lt;/span> created volume 9f684dbc-27d8-11eb-884a-0242ac120016 at path /csi-data-dir/9f684dbc-27d8-11eb-884a-0242ac120016
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:50.581129 &lt;span class="m">1&lt;/span> server.go:123&lt;span class="o">]&lt;/span> GRPC response: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;volume&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;accessible_topology&amp;#34;&lt;/span>:&lt;span class="o">[{&lt;/span>&lt;span class="s2">&amp;#34;segments&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;topology.hostpath.csi/node&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;minikube&amp;#34;&lt;/span>&lt;span class="o">}}]&lt;/span>,&lt;span class="s2">&amp;#34;capacity_bytes&amp;#34;&lt;/span>:1073741824,&lt;span class="s2">&amp;#34;volume_id&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;9f684dbc-27d8-11eb-884a-0242ac120016&amp;#34;&lt;/span>&lt;span class="o">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:52.020457 &lt;span class="m">1&lt;/span> server.go:117&lt;span class="o">]&lt;/span> GRPC call: /csi.v1.Identity/Probe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:56.879104 &lt;span class="m">1&lt;/span> server.go:117&lt;span class="o">]&lt;/span> GRPC call: /csi.v1.Node/NodeGetCapabilities
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:56.879169 &lt;span class="m">1&lt;/span> server.go:118&lt;span class="o">]&lt;/span> GRPC request: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:56.879866 &lt;span class="m">1&lt;/span> server.go:123&lt;span class="o">]&lt;/span> GRPC response: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;capabilities&amp;#34;&lt;/span>:&lt;span class="o">[{&lt;/span>&lt;span class="s2">&amp;#34;Type&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Rpc&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>:1&lt;span class="o">}}}&lt;/span>,&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Type&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Rpc&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>:3&lt;span class="o">}}}]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.020014 &lt;span class="m">1&lt;/span> server.go:117&lt;span class="o">]&lt;/span> GRPC call: /csi.v1.Node/NodeStageVolume
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.020087 &lt;span class="m">1&lt;/span> server.go:118&lt;span class="o">]&lt;/span> GRPC request: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;staging_target_path&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/globalmount&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;volume_capability&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;AccessType&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Mount&amp;#34;&lt;/span>:&lt;span class="o">{}}&lt;/span>,&lt;span class="s2">&amp;#34;access_mode&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;mode&amp;#34;&lt;/span>:1&lt;span class="o">}}&lt;/span>,&lt;span class="s2">&amp;#34;volume_context&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;storage.kubernetes.io/csiProvisionerIdentity&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;1605508257344-8081-hostpath.csi.k8s.io&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>,&lt;span class="s2">&amp;#34;volume_id&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;9f684dbc-27d8-11eb-884a-0242ac120016&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.022399 &lt;span class="m">1&lt;/span> server.go:123&lt;span class="o">]&lt;/span> GRPC response: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.041971 &lt;span class="m">1&lt;/span> server.go:117&lt;span class="o">]&lt;/span> GRPC call: /csi.v1.Node/NodeGetCapabilities
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.042036 &lt;span class="m">1&lt;/span> server.go:118&lt;span class="o">]&lt;/span> GRPC request: &lt;span class="o">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.043319 &lt;span class="m">1&lt;/span> server.go:123&lt;span class="o">]&lt;/span> GRPC response: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;capabilities&amp;#34;&lt;/span>:&lt;span class="o">[{&lt;/span>&lt;span class="s2">&amp;#34;Type&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Rpc&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>:1&lt;span class="o">}}}&lt;/span>,&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Type&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Rpc&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;type&amp;#34;&lt;/span>:3&lt;span class="o">}}}]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.068101 &lt;span class="m">1&lt;/span> server.go:117&lt;span class="o">]&lt;/span> GRPC call: /csi.v1.Node/NodePublishVolume
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.068159 &lt;span class="m">1&lt;/span> server.go:118&lt;span class="o">]&lt;/span> GRPC request: &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;staging_target_path&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/globalmount&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;target_path&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;/var/lib/kubelet/pods/9c5aa371-e5a7-4b67-8795-ec7013811363/volumes/kubernetes.io~csi/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/mount&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;volume_capability&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;AccessType&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;Mount&amp;#34;&lt;/span>:&lt;span class="o">{}}&lt;/span>,&lt;span class="s2">&amp;#34;access_mode&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;mode&amp;#34;&lt;/span>:1&lt;span class="o">}}&lt;/span>,&lt;span class="s2">&amp;#34;volume_context&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;csi.storage.k8s.io/ephemeral&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;csi.storage.k8s.io/pod.name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;my-csi-app&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;csi.storage.k8s.io/pod.namespace&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;csi.storage.k8s.io/pod.uid&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;9c5aa371-e5a7-4b67-8795-ec7013811363&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;csi.storage.k8s.io/serviceAccount.name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;storage.kubernetes.io/csiProvisionerIdentity&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;1605508257344-8081-hostpath.csi.k8s.io&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>,&lt;span class="s2">&amp;#34;volume_id&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;9f684dbc-27d8-11eb-884a-0242ac120016&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.104975 &lt;span class="m">1&lt;/span> mount_linux.go:164&lt;span class="o">]&lt;/span> Detected OS without systemd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.146159 &lt;span class="m">1&lt;/span> nodeserver.go:166&lt;span class="o">]&lt;/span> target /var/lib/kubelet/pods/9c5aa371-e5a7-4b67-8795-ec7013811363/volumes/kubernetes.io~csi/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/mount
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fstype
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">device
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">readonly&lt;/span> &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">volumeId 9f684dbc-27d8-11eb-884a-0242ac120016
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">attributes map&lt;span class="o">[&lt;/span>csi.storage.k8s.io/ephemeral:false csi.storage.k8s.io/pod.name:my-csi-app csi.storage.k8s.io/pod.namespace:default csi.storage.k8s.io/pod.uid:9c5aa371-e5a7-4b67-8795-ec7013811363 csi.storage.k8s.io/serviceAccount.name:default storage.kubernetes.io/csiProvisionerIdentity:1605508257344-8081-hostpath.csi.k8s.io&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mountflags &lt;span class="o">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.146375 &lt;span class="m">1&lt;/span> mount_linux.go:164&lt;span class="o">]&lt;/span> Detected OS without systemd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.146449 &lt;span class="m">1&lt;/span> mount_linux.go:146&lt;span class="o">]&lt;/span> Mounting cmd &lt;span class="o">(&lt;/span>mount&lt;span class="o">)&lt;/span> with arguments &lt;span class="o">([&lt;/span>-o &lt;span class="nb">bind&lt;/span> /csi-data-dir/9f684dbc-27d8-11eb-884a-0242ac120016 /var/lib/kubelet/pods/9c5aa371-e5a7-4b67-8795-ec7013811363/volumes/kubernetes.io~csi/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/mount&lt;span class="o">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I1116 06:54:57.448129 &lt;span class="m">1&lt;/span> mount_linux.go:146&lt;span class="o">]&lt;/span> Mounting cmd &lt;span class="o">(&lt;/span>mount&lt;span class="o">)&lt;/span> with arguments &lt;span class="o">([&lt;/span>-o bind,remount /csi-data-dir/9f684dbc-27d8-11eb-884a-0242ac120016 /var/lib/kubelet/pods/9c5aa371-e5a7-4b67-8795-ec7013811363/volumes/kubernetes.io~csi/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/mount&lt;span class="o">])&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…ˆè¿›è¡Œcreate volumeï¼Œåœ¨è¿›è¡ŒNodePublishVolume&lt;/p>
&lt;h4>NodeStageVolumeçš„ä½œç”¨&lt;span class="hx-absolute -hx-mt-20" id="nodestagevolumeçš„ä½œç”¨">&lt;/span>
&lt;a href="#nodestagevolume%e7%9a%84%e4%bd%9c%e7%94%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>å¯¹äºå—å­˜å‚¨æ¥è¯´ï¼Œè®¾å¤‡åªèƒ½mountåˆ°ä¸€ä¸ªç›®å½•ä¸Šï¼Œæ‰€ä»¥NodeStageVolumeå°±æ˜¯å…ˆmountåˆ°ä¸€ä¸ªglobalmountç›®å½•(ç±»ä¼¼:/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/globalmount)ï¼Œç„¶åå†bindåˆ°podçš„ç›®å½•ï¼ˆ/var/lib/kubelet/pods/9c5aa371-e5a7-4b67-8795-ec7013811363/volumes/kubernetes.io~csi/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/mount/hello-worldï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥pvæŒ‚è½½åœ¨å¤šä¸ªpodä¸­(NodePublishVolume)ã€‚åœ¨è¿™ä¸€æ­¥å¯ä»¥è¿›è¡Œæ ¼å¼åŒ–&lt;/p>
&lt;h2>å‚è€ƒ&lt;span class="hx-absolute -hx-mt-20" id="å‚è€ƒ">&lt;/span>
&lt;a href="#%e5%8f%82%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/master/docs/deploy-1.17-and-later.md" target="_blank" rel="noopener">https://github.com/kubernetes-csi/csi-driver-host-path/blob/master/docs/deploy-1.17-and-later.md&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://arslan.io/2018/06/21/how-to-write-a-container-storage-interface-csi-plugin/" target="_blank" rel="noopener">https://arslan.io/2018/06/21/how-to-write-a-container-storage-interface-csi-plugin/&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>å¦‚ä½•ç¼–å†™ä¸€ä¸ªCSIæ’ä»¶</title><link>/kubernetes-book/csi/how-to-write-csi-driver.html</link><pubDate>Fri, 27 Nov 2020 15:40:59 +0800</pubDate><guid>/kubernetes-book/csi/how-to-write-csi-driver.html</guid><description>
&lt;blockquote>
&lt;p>è¿™é‡Œä»¥&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path" target="_blank" rel="noopener">csi-driver-host-path&lt;/a>ä½œä¸ºä¾‹å­ï¼Œæ¥çœ‹çœ‹æ˜¯å¦‚ä½•å®ç°ä¸€ä¸ªcsiæ’ä»¶çš„ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>ç›®æ ‡ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>æ”¯æŒPVåŠ¨æ€åˆ›å»ºï¼Œå¹¶ä¸”èƒ½å¤ŸæŒ‚è½½åœ¨PODä¸­&lt;/li>
&lt;li>volumeæ¥è‡ªæœ¬åœ°ç›®å½•ï¼Œä¸»è¦æ˜¯æ¨¡æ‹Ÿvolumeäº§ç”Ÿçš„è¿‡ç¨‹ï¼Œè¿™æ ·å°±ä¸ä¾èµ–äºæŸä¸ªç‰¹å®šçš„å­˜å‚¨æœåŠ¡&lt;/li>
&lt;/ul>
&lt;h2>é¢„å¤‡çŸ¥è¯†&lt;span class="hx-absolute -hx-mt-20" id="é¢„å¤‡çŸ¥è¯†">&lt;/span>
&lt;a href="#%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åœ¨&lt;a href="./README." >ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a>ä¸­ï¼Œå·²ç»å¯¹CSIæ¦‚å¿µæœ‰ä¸ªäº†è§£ï¼Œå¹¶ä¸”æå‡ºäº†CSIç»„ä»¶éœ€è¦å®ç°çš„RPCæ¥å£ï¼Œé‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›æ¥å£ï¼Œè¿™éœ€è¦ä»volumeè¦è¢«ä½¿ç”¨ç»è¿‡äº†ä»¥ä¸‹æµç¨‹ï¼š&lt;/p>
&lt;ul>
&lt;li>volumeåˆ›å»º&lt;/li>
&lt;li>volume &lt;code>attach&lt;/code>åˆ°èŠ‚ç‚¹(æ¯”å¦‚åƒEBSç¡¬ç›˜ï¼ŒNFSå¯èƒ½å°±ç›´æ¥ä¸‹ä¸€æ­¥mountäº†)&lt;/li>
&lt;li>volume è¢«&lt;code>mount&lt;/code>åˆ°æŒ‡å®šç›®å½•(è¿™ä¸ªç›®å½•å…¶å®å°±è¢«æ˜ å°„åˆ°å®¹å™¨ä¸­ï¼Œç”±kubelet ä¸­çš„&lt;code>VolumeManager&lt;/code> è°ƒç”¨)&lt;/li>
&lt;/ul>
&lt;p>è€Œå½“å¸è½½æ—¶æ­£å¥½æ˜¯ç›¸åçš„ï¼š&lt;code>unmount&lt;/code>,&lt;code>detach&lt;/code>,&lt;code>delete volume&lt;/code>&lt;/p>
&lt;p>æ­£å¥½å¯¹åº”å¦‚ä¸‹å›¾ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code> CreateVolume &amp;#43;------------&amp;#43; DeleteVolume
&amp;#43;-------------&amp;gt;| CREATED &amp;#43;--------------&amp;#43;
| &amp;#43;---&amp;#43;----^---&amp;#43; |
| Controller | | Controller v
&amp;#43;&amp;#43;&amp;#43; Publish | | Unpublish &amp;#43;&amp;#43;&amp;#43;
|X| Volume | | Volume | |
&amp;#43;-&amp;#43; &amp;#43;---v----&amp;#43;---&amp;#43; &amp;#43;-&amp;#43;
| NODE_READY |
&amp;#43;---&amp;#43;----^---&amp;#43;
Node | | Node
Stage | | Unstage
Volume | | Volume
&amp;#43;---v----&amp;#43;---&amp;#43;
| VOL_READY |
&amp;#43;---&amp;#43;----^---&amp;#43;
Node | | Node
Publish | | Unpublish
Volume | | Volume
&amp;#43;---v----&amp;#43;---&amp;#43;
| PUBLISHED |
&amp;#43;------------&amp;#43;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è€Œä¸ºä»€ä¹ˆå¤šä¸ª&lt;code>NodeStageVolume&lt;/code>çš„è¿‡ç¨‹æ˜¯å› ä¸ºï¼š&lt;/p>
&lt;blockquote>
&lt;p>å¯¹äºå—å­˜å‚¨æ¥è¯´ï¼Œè®¾å¤‡åªèƒ½mountåˆ°ä¸€ä¸ªç›®å½•ä¸Šï¼Œæ‰€ä»¥&lt;code>NodeStageVolume&lt;/code>å°±æ˜¯å…ˆmountåˆ°ä¸€ä¸ªglobalmountç›®å½•(ç±»ä¼¼:&lt;code>/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/globalmount&lt;/code>)ï¼Œç„¶åå†&lt;code>NodePublishVolume&lt;/code>è¿™ä¸€æ­¥ä¸­é€šè¿‡&lt;code>mount bind&lt;/code>åˆ°podçš„ç›®å½•ï¼ˆ&lt;code>/var/lib/kubelet/pods/9c5aa371-e5a7-4b67-8795-ec7013811363/volumes/kubernetes.io~csi/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/mount/hello-world&lt;/code>ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ä¸€ä¸ªpvæŒ‚è½½åœ¨å¤šä¸ªpodä¸­ä½¿ç”¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2>ä»£ç å®ç°&lt;span class="hx-absolute -hx-mt-20" id="ä»£ç å®ç°">&lt;/span>
&lt;a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æˆ‘ä»¬å¹¶ä¸ä¸€å®šè¦å®ç°æ‰€æœ‰çš„æ¥å£ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡CSIä¸­&lt;code>Capabilities&lt;/code>èƒ½åŠ›æ ‡è¯†å‡ºæ¥ï¼Œæˆ‘ä»¬ç»„ä»¶æä¾›çš„èƒ½åŠ›ï¼Œæ¯”å¦‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>IdentityServer&lt;/code>ä¸­çš„&lt;code>GetPluginCapabilities&lt;/code>æ–¹æ³•&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ControllerServer&lt;/code>ä¸­çš„&lt;code>ControllerGetCapabilities&lt;/code>æ–¹æ³•&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>NodeServer&lt;/code>ä¸­çš„&lt;code>NodeGetCapabilities&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>è¿™äº›æ–¹æ³•éƒ½æ˜¯åœ¨å‘Šè¯‰è°ƒç”¨æ–¹ï¼Œæˆ‘ä»¬çš„ç»„ä»¶å®ç°äº†å“ªäº›èƒ½åŠ›ï¼Œæœªå®ç°çš„æ–¹æ³•å°±ä¸ä¼šè°ƒç”¨äº†ã€‚&lt;/p>
&lt;h3>IdentityServer&lt;span class="hx-absolute -hx-mt-20" id="identityserver">&lt;/span>
&lt;a href="#identityserver" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>&lt;code>IdentityServer&lt;/code>åŒ…å«äº†ä¸‰ä¸ªæ¥å£ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦å®ç°&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// IdentityServer is the server API for Identity service.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">IdentityServer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetPluginInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GetPluginInfoRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">GetPluginInfoResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetPluginCapabilities&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GetPluginCapabilitiesRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">GetPluginCapabilitiesResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Probe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ProbeRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">ProbeResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä¸»è¦çœ‹ä¸‹&lt;code>GetPluginCapabilities&lt;/code>è¿™ä¸ªæ–¹æ³•ï¼š&lt;/p>
&lt;p>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/master/pkg/hostpath/identityserver.go#L60" target="_blank" rel="noopener">identityserver.go#L60&lt;/a>:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ids&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">identityServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">GetPluginCapabilities&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetPluginCapabilitiesRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetPluginCapabilitiesResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetPluginCapabilitiesResponse&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Capabilities&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PluginCapability&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PluginCapability_Service_&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Service&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PluginCapability_Service&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PluginCapability_Service_CONTROLLER_SERVICE&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PluginCapability_Service_&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Service&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PluginCapability_Service&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PluginCapability_Service_VOLUME_ACCESSIBILITY_CONSTRAINTS&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä»¥ä¸Šå°±å‘Šè¯‰è°ƒç”¨è€…æˆ‘ä»¬æä¾›äº†ControllerServiceçš„èƒ½åŠ›ï¼Œä»¥åŠvolumeè®¿é—®é™åˆ¶çš„èƒ½åŠ›ï¼ˆCSI å¤„ç†æ—¶éœ€è¦æ ¹æ®é›†ç¾¤æ‹“æ‰‘ä½œè°ƒæ•´ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>PSï¼šå…¶å®åœ¨k8sè¿˜æä¾›äº†ä¸€ä¸ªåŒ…ï¼šgithub.com/kubernetes-csi/drivers/pkg/csi-commonï¼Œé‡Œé¢æä¾›äº†æ¯”å¦‚&lt;code>DefaultIdentityServer&lt;/code>ï¼Œ&lt;code>DefaultControllerServer&lt;/code>,&lt;code>DefaultNodeServer&lt;/code>çš„structï¼Œåªè¦åœ¨æˆ‘ä»¬è‡ªå·±çš„&lt;code>XXXServer struct&lt;/code>ä¸­ç»§æ‰¿è¿™äº›&lt;code>struct&lt;/code>ï¼Œæˆ‘ä»¬çš„ä»£ç ä¸­å°±åªè¦åŒ…å«è‡ªå·±å®ç°çš„æ–¹æ³•å°±è¡Œäº†ï¼Œå¯ä»¥å‚è€ƒ&lt;a href="https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/pkg/disk/identityserver.go#L26" target="_blank" rel="noopener">alibaba-cloud-csi-driver&lt;/a>ä¸­çš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>###ControllerServer&lt;/p>
&lt;p>&lt;code>ControllerServer&lt;/code>æˆ‘ä»¬ä¸»è¦å…³æ³¨&lt;code>CreateVolume&lt;/code>,&lt;code>DeleteVolume&lt;/code>ï¼Œå› ä¸ºæ˜¯hostpath volumeï¼Œæ‰€ä»¥å°±æ²¡æœ‰attachçš„è¿™ä¸ªè¿‡ç¨‹äº†ï¼Œæˆ‘ä»¬æ”¾åœ¨NodeServerä¸­å®ç°ï¼š&lt;/p>
&lt;h4>CreateVolume&lt;span class="hx-absolute -hx-mt-20" id="createvolume">&lt;/span>
&lt;a href="#createvolume" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/b1cfe85dd7bfffce2bbe5b1228c994a9bc3649fb/pkg/hostpath/controllerserver.go#L73" target="_blank" rel="noopener">controllerserver.go#L73&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">cs&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">controllerServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">CreateVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreateVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreateVolumeResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ ¡éªŒå‚æ•°æ˜¯å¦æœ‰CreateVolumeçš„èƒ½åŠ›&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">cs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">validateControllerServiceRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ControllerServiceCapability_RPC_CREATE_DELETE_VOLUME&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid create volume req: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//.....è¿™é‡Œçœç•¥çš„æ ¡éªŒå‚æ•°çš„è¿‡ç¨‹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿™é‡Œæ ¹æ®volume nameåˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨äº†ï¼Œå­˜åœ¨äº†å°±è¿”å›å°±è¡Œäº†&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">exVol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getVolumeByName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetName&lt;/span>&lt;span class="p">());&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// volumeå·²ç»å­˜åœ¨ï¼Œä½†æ˜¯å¤§å°ä¸ç¬¦åˆ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">exVol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolSize&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">capacity&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AlreadyExists&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Volume with the same name: %s but with different size already exist&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿™é‡Œåˆ¤æ–­æ˜¯å¦è®¾ç½®äº†pvc.dataSourceï¼Œå°±è¡¨ç¤ºæ˜¯ä¸€ä¸ªrestoreè¿‡ç¨‹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeContentSource&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">volumeSource&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeContentSource&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">switch&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kd">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ ¡éªŒï¼šä»å¿«ç…§ä¸­æ¢å¤&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeContentSource_Snapshot&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetSnapshot&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">exVol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ParentSnapID&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">exVol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ParentSnapID&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetSnapshot&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">GetSnapshotId&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AlreadyExists&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;existing volume source snapshot id not matching&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ ¡éªŒï¼šcloneè¿‡ç¨‹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeContentSource_Volume&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolume&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">exVol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ParentVolID&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolume&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">GetVolumeId&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AlreadyExists&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;existing volume source volume id not matching&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InvalidArgument&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;%v not a proper volume source&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// TODO (sbezverk) Do I need to make sure that volume still exists?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreateVolumeResponse&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Volume&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Volume&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolumeId&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">exVol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">CapacityBytes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">exVol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolSize&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolumeContext&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetParameters&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ContentSource&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeContentSource&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ›å»ºvolume&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">volumeID&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">uuid&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewUUID&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ›å»ºhostpathçš„volume&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">vol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">createHostpathVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">volumeID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetName&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">capacity&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">requestedAccessType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="cm">/* ephemeral */&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;failed to create volume %v: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volumeID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;created volume %s at path %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">vol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">vol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ¤æ–­æ˜¯ä»å¿«ç…§æ¢å¤ï¼Œè¿˜æ˜¯clone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeContentSource&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">path&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getVolumePath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">volumeID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">volumeSource&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeContentSource&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">switch&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kd">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ä»å¿«ç…§æ¢å¤&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeContentSource_Snapshot&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">snapshot&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetSnapshot&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">snapshot&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">loadFromSnapshot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">capacity&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">snapshot&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetSnapshotId&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">requestedAccessType&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">vol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ParentSnapID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">snapshot&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetSnapshotId&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//clone&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumeContentSource_Volume&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">srcVolume&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolume&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">srcVolume&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">loadFromVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">capacity&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">srcVolume&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeId&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">requestedAccessType&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">vol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ParentVolID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">srcVolume&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeId&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InvalidArgument&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;%v not a proper volume source&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volumeSource&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">delErr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">deleteHostpathVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">volumeID&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">delErr&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;deleting hostpath volume %v failed: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volumeID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">delErr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;successfully populated volume %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">vol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//Topologyè¡¨ç¤ºvolumeèƒ½å¤Ÿéƒ¨ç½²åœ¨å“ªäº›èŠ‚ç‚¹ï¼ˆç”Ÿäº§æƒ…å†µå¯èƒ½å°±å¯¹åº”å¯ç”¨åŒºï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">topologies&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Topology&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Topology&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Segments&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">TopologyKeyNode&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">cs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nodeID&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CreateVolumeResponse&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Volume&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Volume&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolumeId&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">volumeID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">CapacityBytes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetCapacityRange&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">GetRequiredBytes&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolumeContext&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetParameters&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ContentSource&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeContentSource&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AccessibleTopology&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">topologies&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>&lt;code>createHostpathVolume&lt;/code>&lt;/strong>&lt;/p>
&lt;p>å†æ¥çœ‹ä¸‹&lt;code>createHostpathVolume&lt;/code>æ–¹æ³•ï¼Œè¿™é‡Œ&lt;code>accessType&lt;/code>æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œæ˜¯åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿï¼Œè¿˜æ˜¯åˆ›å»ºå—ï¼Œå…¶å®å°±æ˜¯å¯¹åº”pvcä¸­&lt;code>volumeMode&lt;/code>å­—æ®µï¼š&lt;/p>
&lt;p>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/b1cfe85dd7bfffce2bbe5b1228c994a9bc3649fb/pkg/hostpath/hostpath.go#L208" target="_blank" rel="noopener">pkg/hostpath/hostpath.go#L208&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// createVolume create the directory for the hostpath volume.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// It returns the volume path or err if one occurs.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">createHostpathVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">volID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cap&lt;/span> &lt;span class="kt">int64&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volAccessType&lt;/span> &lt;span class="nx">accessType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ephemeral&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">hostPathVolume&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">path&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getVolumePath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">volID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">switch&lt;/span> &lt;span class="nx">volAccessType&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nx">mountAccess&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ›å»ºæ–‡ä»¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MkdirAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0777&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nx">blockAccess&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ›å»ºå—&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">executor&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">utilexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">size&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%dM&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cap&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">mib&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Create a block file.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Stat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotExist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">out&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">executor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Command&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;fallocate&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;-l&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">CombinedOutput&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to create block device: %v, %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to stat block device: %v, %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€šè¿‡losetupå°†æ–‡ä»¶è™šæ‹Ÿæˆå—è®¾å¤‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Associate block file with the loop device.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">volPathHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">volumepathhandler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumePathHandler&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">volPathHandler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AttachFileDevice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Remove the block file because it&amp;#39;ll no longer be used again.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err2&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err2&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to cleanup block file %s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to attach device %v: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unsupported access type %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volAccessType&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hostpathVol&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">hostPathVolume&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">volID&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolName&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolSize&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">cap&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolPath&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">VolAccessType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">volAccessType&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Ephemeral&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">ephemeral&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hostPathVolumes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">volID&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">hostpathVol&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">hostpathVol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h4>DeleteVolume&lt;span class="hx-absolute -hx-mt-20" id="deletevolume">&lt;/span>
&lt;a href="#deletevolume" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>åœ¨DeleteVolumeè¿™é‡Œä¸»è¦æ˜¯åˆ é™¤volumeï¼š&lt;/p>
&lt;p>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/b1cfe85dd7bfffce2bbe5b1228c994a9bc3649fb/pkg/hostpath/controllerserver.go#L208" target="_blank" rel="noopener">pkg/hostpath/controllerserver.go#L2&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">cs&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">controllerServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">DeleteVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeleteVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeleteVolumeResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Check arguments&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeId&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InvalidArgument&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Volume ID missing in request&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">cs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">validateControllerServiceRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ControllerServiceCapability_RPC_CREATE_DELETE_VOLUME&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid delete volume req: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">volId&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeId&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">deleteHostpathVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">volId&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;failed to delete volume %v: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volId&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;volume %v successfully deleted&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volId&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeleteVolumeResponse&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨&lt;code>ControllerService&lt;/code>ä¸­è¿˜æœ‰ä¸€äº›å…¶ä»–æ¥å£ï¼Œæ¯”å¦‚&lt;code>CreateSnapshot&lt;/code>åˆ›å»ºå¿«ç…§ï¼Œ&lt;code>DeleteSnapshot&lt;/code>åˆ é™¤å¿«ç…§ï¼Œ&lt;code>æ‰©å®¹&lt;/code>ç­‰ï¼Œå…¶å®éƒ½ä¼šä¾èµ–äºæˆ‘ä»¬å­˜å‚¨æœåŠ¡ç«¯çš„æä¾›çš„èƒ½åŠ›ï¼Œè°ƒç”¨ç›¸åº”çš„æ¥å£å°±è¡Œäº†ã€‚&lt;/p>
&lt;h3>NodeServer&lt;span class="hx-absolute -hx-mt-20" id="nodeserver">&lt;/span>
&lt;a href="#nodeserver" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨&lt;code>nodeServer&lt;/code>ä¸­å°±æ˜¯å®ç°æˆ‘ä»¬çš„&lt;code>mount&lt;/code>,&lt;code>unmount&lt;/code>è¿‡ç¨‹äº†ï¼Œåˆ†åˆ«å¯¹åº”&lt;code>NodePublishVolume&lt;/code>å’Œ&lt;code>NodeUnpublishVolume&lt;/code>&lt;/p>
&lt;h4>NodePublishVolume&lt;span class="hx-absolute -hx-mt-20" id="nodepublishvolume">&lt;/span>
&lt;a href="#nodepublishvolume" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/b1cfe85dd7bfffce2bbe5b1228c994a9bc3649fb/pkg/hostpath/nodeserver.go#L50" target="_blank" rel="noopener">pkg/hostpath/nodeserver.go#L5&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ns&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nodeServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">NodePublishVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodePublishVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodePublishVolumeResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//......è¿™é‡Œçœç•¥æ ¡éªŒå‚æ•°ä»£ç &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">vol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getVolumeByID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeId&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NotFound&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¯¹åº”pvc.volumeBindå­—æ®µæ˜¯blockçš„æƒ…å†µ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeCapability&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">GetBlock&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">vol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolAccessType&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">blockAccess&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InvalidArgument&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;cannot publish a non-block volume as block volume&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">volPathHandler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">volumepathhandler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolumePathHandler&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è·å–deviceåœ°å€ï¼ˆé€šè¿‡loopset -lå‘½ä»¤ï¼Œå› ä¸ºæ˜¯é€šè¿‡æ–‡ä»¶è™šæ‹Ÿå‡ºæ¥çš„å—è®¾å¤‡ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Get loop device from the volume path.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">loopDevice&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">volPathHandler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetLoopDevice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VolPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to get the loop device: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mounter&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mount&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Check if the target path exists. Create if not present.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lstat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">targetPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotExist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mounter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MakeFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">targetPath&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to create target path: %s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">targetPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;failed to check if the target block file exists: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Check if the target path is already mounted. Prevent remounting.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">notMount&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mounter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotMountPoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">targetPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotExist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;error checking path %s for mount: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">targetPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">notMount&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">notMount&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// It&amp;#39;s already mounted.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Skipping bind-mounting subpath %s: already mounted&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">targetPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodePublishVolumeResponse&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿›è¡Œç»‘å®šæŒ‚è½½ï¼ˆmount bindï¼‰ï¼Œå°†å—è®¾å¤‡ç»‘å®šåˆ°å®¹å™¨ç›®å½•(targetpathç±»ä¼¼è¿™ç§ï¼š/var/lib/kubelet/pods/9c5aa371-e5a7-4b67-8795-ec7013811363/volumes/kubernetes.io~csi/pvc-bcfe33ed-e822-4b0e-954a-0f5c0468525e/mount)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">options&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;bind&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mount&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Mount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">loopDevice&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">targetPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to mount block device: %s at %s: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">loopDevice&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">targetPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¯¹åº”pvc.volumeBindå­—æ®µæ˜¯filesystemçš„æƒ…å†µ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeCapability&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">GetMount&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//....è¿™é‡Œçœç•¥ï¼Œå› ä¸ºè·Ÿä¸Šé¢ç±»ä¼¼ä¹Ÿæ˜¯mount bindè¿‡ç¨‹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodePublishVolumeResponse&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>####NodeUnpublishVolume&lt;/p>
&lt;p>&lt;code>NodeUnpublishVolume&lt;/code>è¿‡ç¨‹å°±æ˜¯unmountè¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/b1cfe85dd7bfffce2bbe5b1228c994a9bc3649fb/pkg/hostpath/nodeserver.go#L191" target="_blank" rel="noopener">pkg/hostpath/nodeserver.go#L191&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ns&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nodeServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">NodeUnpublishVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeUnpublishVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeUnpublishVolumeResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Check arguments&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeId&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InvalidArgument&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Volume ID missing in request&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetTargetPath&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InvalidArgument&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Target path missing in request&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">targetPath&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetTargetPath&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">volumeID&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetVolumeId&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">vol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getVolumeByID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">volumeID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NotFound&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Unmount only if the target path is really a mount point.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">notMnt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mount&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotMountPoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mount&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">targetPath&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotExist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">notMnt&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Unmounting the image or filesystem.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mount&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Unmount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">targetPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Delete the mount point.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Does not return error for non-existent path, repeated calls OK for idempotency.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RemoveAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">targetPath&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hostpath: volume %s has been unpublished.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">targetPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">vol&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ephemeral&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">glog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;deleting volume %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">volumeID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">deleteHostpathVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">volumeID&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotExist&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">codes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Internal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to delete volume: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">csi&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeUnpublishVolumeResponse&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>å¯åŠ¨grpc server&lt;span class="hx-absolute -hx-mt-20" id="å¯åŠ¨grpc-server">&lt;/span>
&lt;a href="#%e5%90%af%e5%8a%a8grpc-server" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>&lt;a href="https://github.com/kubernetes-csi/csi-driver-host-path/blob/b1cfe85dd7bfffce2bbe5b1228c994a9bc3649fb/pkg/hostpath/hostpath.go#L164" target="_blank" rel="noopener">pkg/hostpath/hostpath.go#L164&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">hp&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hostPath&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Create GRPC servers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ids&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">NewIdentityServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">version&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ns&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">NewNodeServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nodeID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ephemeral&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">maxVolumesPerNode&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">NewControllerServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ephemeral&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nodeID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewNonBlockingGRPCServer&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endpoint&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ids&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ns&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>##æµ‹è¯•&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥é€šè¿‡&lt;a href="https://github.com/rexray/gocsi/tree/master/csc" target="_blank" rel="noopener">csc&lt;/a>å·¥å…·æ¥è¿›è¡Œgrpcæ¥å£çš„æµ‹è¯•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nv">GO111MODULE&lt;/span>&lt;span class="o">=&lt;/span>off go get -u github.com/rexray/gocsi/csc&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>Get plugin info&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ csc identity plugin-info --endpoint tcp://127.0.0.1:10000
&amp;#34;csi-hostpath&amp;#34; &amp;#34;0.1.0&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>Create a volume&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ csc controller new --endpoint tcp://127.0.0.1:10000 --cap 1,block CSIVolumeName
CSIVolumeID&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>Delete a volume&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ csc controller del --endpoint tcp://127.0.0.1:10000 CSIVolumeID
CSIVolumeID&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>Validate volume capabilities&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ csc controller validate-volume-capabilities --endpoint tcp://127.0.0.1:10000 --cap 1,block CSIVolumeID
CSIVolumeID true&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>NodePublish a volume&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ csc node publish --endpoint tcp://127.0.0.1:10000 --cap 1,block --target-path /mnt/hostpath CSIVolumeID
CSIVolumeID&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>NodeUnpublish a volume&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ csc node unpublish --endpoint tcp://127.0.0.1:10000 --target-path /mnt/hostpath CSIVolumeID
CSIVolumeID&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>Get Nodeinfo&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ csc node get-info --endpoint tcp://127.0.0.1:10000
CSINode&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>éƒ¨ç½²&lt;span class="hx-absolute -hx-mt-20" id="éƒ¨ç½²">&lt;/span>
&lt;a href="#%e9%83%a8%e7%bd%b2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ä»ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒCSIçœŸæ­£è¿è¡Œèµ·æ¥ï¼Œå…¶å®è¿˜éœ€è¦ä¸€äº›å®˜æ–¹æä¾›çš„ç»„ä»¶è¿›è¡Œé…åˆï¼Œæ¯”å¦‚&lt;code>node-driver-registrar&lt;/code>ï¼Œ&lt;code>csi-provision&lt;/code>ï¼Œ&lt;code>csi-attacher&lt;/code>ï¼Œæˆ‘ä»¬å°†è¿™äº›containerä½œä¸ºæˆ‘ä»¬çš„sidecarå®¹å™¨ï¼Œé€šè¿‡volumeå…±äº«socketè¿æ¥ï¼Œæ–¹ä¾¿è°ƒç”¨ï¼Œéƒ¨ç½²åœ¨ä¸€èµ·ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æŠŠæœåŠ¡åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>controller ï¼šä»¥Deploymentæˆ–è€…Statefulsetæ–¹å¼éƒ¨ç½²ï¼Œé€šè¿‡leader selectorï¼Œæ§åˆ¶åªæœ‰ä¸€ä¸ªåœ¨å·¥ä½œã€‚&lt;/li>
&lt;li>nodeï¼šä»¥DaemonSetæ–¹å¼éƒ¨ç½²ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è°ƒåº¦&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>hostpathå› ä¸ºåªæœ‰åœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šæµ‹è¯•ç”¨ï¼Œæ‰€ä»¥å®ƒçš„éƒ½ä½¿ç”¨äº†Statefulsetï¼Œå› ä¸ºåªæ˜¯æµ‹è¯•ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ç”Ÿäº§éƒ¨ç½²çš„è¯å¯ä»¥å‚è€ƒ&lt;a href="https://github.com/kubernetes-csi/csi-driver-nfs/tree/master/deploy" target="_blank" rel="noopener">csi-driver-nfs&lt;/a> æœåŠ¡çš„éƒ¨ç½²ï¼Œè¿™ä¸ªæœåŠ¡æ¯”è¾ƒå®Œæ•´ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/kubernetes-csi/csi-driver-nfs/blob/master/deploy/csi-nfs-node.yaml" target="_blank" rel="noopener">https://github.com/kubernetes-csi/csi-driver-nfs/blob/master/deploy/csi-nfs-node.yaml&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/kubernetes-csi/csi-driver-nfs/blob/master/deploy/csi-nfs-controller.yaml" target="_blank" rel="noopener">https://github.com/kubernetes-csi/csi-driver-nfs/blob/master/deploy/csi-nfs-controller.yaml&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>å½“ç„¶è¿˜æœ‰ä¸€äº›rbacï¼ŒCSIDriverçš„åˆ›å»ºï¼Œè¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†ã€‚&lt;/p>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å›é¡¾ä¸‹æ•´ä¸ªç»„ä»¶æ˜¯æ€ä¹ˆåè°ƒå·¥ä½œçš„ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>csi-provisioner&lt;/code>ç»„ä»¶ç›‘å¬pvcçš„åˆ›å»ºï¼Œä»è€Œé€šè¿‡ CSI socket åˆ›å»º &lt;a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#createvolume" target="_blank" rel="noopener">CreateVolumeRequest&lt;/a> è¯·æ±‚è‡³&lt;code>CreateVolume&lt;/code>æ–¹æ³•&lt;/li>
&lt;li>&lt;code>csi-provisioner&lt;/code>åˆ›å»º PV ä»¥åŠæ›´æ–° PVCçŠ¶æ€è‡³ bound ï¼Œä»è€Œç”± controller-manageråˆ›å»º&lt;code>VolumeAttachment&lt;/code>å¯¹è±¡&lt;/li>
&lt;li>&lt;code>csi-attacher&lt;/code> ç›‘å¬&lt;code>VolumeAttachments&lt;/code> å¯¹è±¡åˆ›å»ºï¼Œä»è€Œè°ƒç”¨&lt;a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#controllerpublishvolume" target="_blank" rel="noopener"> ControllerPublishVolume&lt;/a> æ–¹æ³•ã€‚&lt;/li>
&lt;li>&lt;code>kubelet&lt;/code>ä¸€ç›´éƒ½åœ¨ç­‰å¾…volume attachï¼Œ ä»è€Œè°ƒç”¨ &lt;a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#nodestagevolume" target="_blank" rel="noopener">NodeStageVolume&lt;/a> (ä¸»è¦åšæ ¼å¼åŒ–ä»¥åŠmountåˆ°èŠ‚ç‚¹ä¸Šä¸€ä¸ªå…¨å±€ç›®å½•) æ–¹æ³• - &lt;em>è¿™ä¸€æ­¥å¯é€‰&lt;/em>&lt;/li>
&lt;li>CSI Driveråœ¨ åœ¨ &lt;a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#nodestagevolume" target="_blank" rel="noopener">NodeStageVolume&lt;/a> æ–¹æ³•ä¸­å°†volumemountåˆ° &lt;code>/var/lib/kubelet/plugins/kubernetes.io/csi/pv/&amp;lt;pv-name&amp;gt;/globalmount&lt;/code>è¿™ä¸ªç›®å½•å¹¶è¿”å›ç»™kubelet - &lt;em>è¿™ä¸€æ­¥å¯é€‰&lt;/em>&lt;/li>
&lt;li>&lt;code>kubelet&lt;/code>è°ƒç”¨&lt;a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#nodepublishvolume" target="_blank" rel="noopener">NodePublishVolume&lt;/a> (æŒ‚è½½åˆ°podç›®å½•é€šè¿‡&lt;code>mount bind&lt;/code>)&lt;/li>
&lt;li>CSI Driverç›¸åº”&lt;a href="https://github.com/container-storage-interface/spec/blob/master/spec.md#nodepublishvolume" target="_blank" rel="noopener"> NodePublishVolume&lt;/a> è¯·æ±‚ï¼Œå°†volumeæŒ‚è½½åˆ°podç›®å½• &lt;code>/var/lib/kubelet/pods/&amp;lt;pod-uuid&amp;gt;/volumes/[kubernetes.io](http://kubernetes.io/)~csi/&amp;lt;pvc-name&amp;gt;/mount&lt;/code>&lt;/li>
&lt;li>æœ€åï¼Œkubeletå¯åŠ¨å®¹å™¨&lt;/li>
&lt;/ul>
&lt;h2>å‚è€ƒ&lt;span class="hx-absolute -hx-mt-20" id="å‚è€ƒ">&lt;/span>
&lt;a href="#%e5%8f%82%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://medium.com/velotio-perspectives/kubernetes-csi-in-action-explained-with-features-and-use-cases-4f966b910774" target="_blank" rel="noopener">https://medium.com/velotio-perspectives/kubernetes-csi-in-action-explained-with-features-and-use-cases-4f966b910774&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://kubernetes-csi.github.io/docs/developing.html" target="_blank" rel="noopener">https://kubernetes-csi.github.io/docs/developing.html&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>CSI - å®¹å™¨å­˜å‚¨æ¥å£</title><link>/kubernetes-book/csi/</link><pubDate>Thu, 26 Nov 2020 15:40:59 +0800</pubDate><guid>/kubernetes-book/csi/</guid><description>
&lt;p>&lt;a href="https://github.com/container-storage-interface/spec/blob/master/spec.md" target="_blank" rel="noopener">å®¹å™¨å­˜å‚¨æ¥å£&lt;/a>ï¼ˆCSIï¼‰æ˜¯ç”¨äºå°†ä»»æ„å—å’Œæ–‡ä»¶å­˜å‚¨ç³»ç»Ÿæš´éœ²ç»™è¯¸å¦‚Kubernetesä¹‹ç±»çš„å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼ˆCOï¼‰ä¸Šçš„å®¹å™¨åŒ–å·¥ä½œè´Ÿè½½çš„æ ‡å‡†ã€‚ ä½¿ç”¨CSIçš„ç¬¬ä¸‰æ–¹å­˜å‚¨æä¾›å•†å¯ä»¥ç¼–å†™å’Œéƒ¨ç½²åœ¨Kubernetesä¸­å…¬å¼€æ–°å­˜å‚¨ç³»ç»Ÿçš„æ’ä»¶ï¼Œè€Œæ— éœ€æ¥è§¦æ ¸å¿ƒçš„Kubernetesä»£ç ã€‚&lt;/p>
&lt;p>å…·ä½“æ¥è¯´ï¼ŒKubernetesé’ˆå¯¹CSIè§„å®šäº†ä»¥ä¸‹å†…å®¹ï¼š&lt;/p>
&lt;ul>
&lt;li>Kubeletåˆ°CSIé©±åŠ¨ç¨‹åºçš„é€šä¿¡
&lt;ul>
&lt;li>Kubeleté€šè¿‡UnixåŸŸå¥—æ¥å­—ç›´æ¥å‘CSIé©±åŠ¨ç¨‹åºå‘èµ·CSIè°ƒç”¨ï¼ˆä¾‹å¦‚&lt;code>NodeStageVolume&lt;/code>ï¼Œ&lt;code>NodePublishVolume&lt;/code>ç­‰ï¼‰ï¼Œä»¥æŒ‚è½½å’Œå¸è½½å·ã€‚&lt;/li>
&lt;li>Kubeleté€šè¿‡kubeletæ’ä»¶æ³¨å†Œæœºåˆ¶å‘ç°CSIé©±åŠ¨ç¨‹åºï¼ˆä»¥åŠç”¨äºä¸CSIé©±åŠ¨ç¨‹åºè¿›è¡Œäº¤äº’çš„UnixåŸŸå¥—æ¥å­—ï¼‰ã€‚&lt;/li>
&lt;li>å› æ­¤ï¼Œéƒ¨ç½²åœ¨Kubernetesä¸Šçš„æ‰€æœ‰CSIé©±åŠ¨ç¨‹åº&lt;strong>å¿…é¡»&lt;/strong>åœ¨æ¯ä¸ªå—æ”¯æŒçš„èŠ‚ç‚¹ä¸Šä½¿ç”¨kubeletæ’ä»¶æ³¨å†Œæœºåˆ¶è¿›è¡Œæ³¨å†Œã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Masteråˆ°CSIé©±åŠ¨ç¨‹åºçš„é€šä¿¡
&lt;ul>
&lt;li>Kubernetes masterç»„ä»¶ä¸ä¼šç›´æ¥ï¼ˆé€šè¿‡UnixåŸŸå¥—æ¥å­—æˆ–å…¶ä»–æ–¹å¼ï¼‰ä¸CSIé©±åŠ¨ç¨‹åºé€šä¿¡ã€‚&lt;/li>
&lt;li>Kubernetes masterç»„ä»¶ä»…ä¸Kubernetes APIäº¤äº’ã€‚&lt;/li>
&lt;li>å› æ­¤ï¼Œéœ€è¦ä¾èµ–äºKubernetes APIçš„æ“ä½œçš„CSIé©±åŠ¨ç¨‹åºï¼ˆä¾‹å¦‚å·åˆ›å»ºï¼Œå·attachï¼Œå·å¿«ç…§ç­‰ï¼‰å¿…é¡»ç›‘å¬Kubernetes APIå¹¶é’ˆå¯¹å®ƒè§¦å‘é€‚å½“çš„CSIæ“ä½œï¼ˆä¾‹å¦‚ä¸‹é¢çš„ä¸€ç³»åˆ—çš„externalç»„ä»¶ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2>ç»„ä»¶&lt;span class="hx-absolute -hx-mt-20" id="ç»„ä»¶">&lt;/span>
&lt;a href="#%e7%bb%84%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;img src="https://silenceper.oss-cn-beijing.aliyuncs.com/images/1*bkMOGMuyCYXH8ZyR5Tngig.png" alt="CSIè°ƒç”¨è¯´æ˜" loading="lazy" />&lt;/p>
&lt;p>CSIå®ç°ä¸­çš„ç»„ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>ç”±k8så®˜æ–¹ç»´æŠ¤çš„ä¸€ç³»åˆ—externalç»„ä»¶è´Ÿè´£æ³¨å†ŒCSI driver æˆ–ç›‘å¬k8så¯¹è±¡èµ„æºï¼Œä»è€Œå‘èµ·csi driverè°ƒç”¨ï¼Œæ¯”å¦‚ï¼ˆnode-driver-registrarï¼Œexternal-attacherï¼Œexternal-provisionerï¼Œexternal-resizerï¼Œexternal-snapshotterï¼Œlivenessprobeï¼‰&lt;/li>
&lt;li>å„äº‘å‚å•†orå¼€å‘è€…è‡ªè¡Œå¼€å‘çš„ç»„ä»¶ï¼ˆéœ€è¦å®ç°CSI Identityï¼ŒCSI Controllerï¼ŒCSI Node æ¥å£ï¼‰&lt;/li>
&lt;/ul>
&lt;h3>RPCæ¥å£(å¼€å‘å•†å®ç°)&lt;span class="hx-absolute -hx-mt-20" id="rpcæ¥å£å¼€å‘å•†å®ç°">&lt;/span>
&lt;a href="#rpc%e6%8e%a5%e5%8f%a3%e5%bc%80%e5%8f%91%e5%95%86%e5%ae%9e%e7%8e%b0" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>&lt;strong>Identity Service&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">service&lt;/span> &lt;span class="nx">Identity&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿”å›driverçš„ä¿¡æ¯ï¼Œæ¯”å¦‚åå­—ï¼Œç‰ˆæœ¬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">GetPluginInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">GetPluginInfoRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">GetPluginInfoResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿”å›driveræä¾›çš„èƒ½åŠ›ï¼Œæ¯”å¦‚æ˜¯å¦æä¾›Controller Service,volume è®¿é—®èƒ½èƒ½åŠ›&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">GetPluginCapabilities&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">GetPluginCapabilitiesRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">GetPluginCapabilitiesResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ¢é’ˆ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">Probe&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ProbeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ProbeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>Controller service&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">service&lt;/span> &lt;span class="nx">Controller&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ›å»ºå·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">CreateVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">CreateVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">CreateVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ é™¤å·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">DeleteVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">DeleteVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">DeleteVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//attach å·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">ControllerPublishVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerPublishVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerPublishVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//unattachå·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">ControllerUnpublishVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerUnpublishVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerUnpublishVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿”å›å­˜å‚¨å·çš„åŠŸèƒ½ç‚¹ï¼Œå¦‚æ˜¯å¦æ”¯æŒæŒ‚è½½åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ˜¯å¦æ”¯æŒå¤šä¸ªèŠ‚ç‚¹åŒæ—¶è¯»å†™&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">ValidateVolumeCapabilities&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ValidateVolumeCapabilitiesRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ValidateVolumeCapabilitiesResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ—å‡ºæ‰€æœ‰å·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">ListVolumes&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ListVolumesRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ListVolumesResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿”å›å­˜å‚¨èµ„æºæ± çš„å¯ç”¨ç©ºé—´å¤§å°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">GetCapacity&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">GetCapacityRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">GetCapacityResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿”å›controlleræ’ä»¶çš„åŠŸèƒ½ç‚¹ï¼Œå¦‚æ˜¯å¦æ”¯æŒGetCapacityæ¥å£ï¼Œæ˜¯å¦æ”¯æŒsnapshotåŠŸèƒ½ç­‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">ControllerGetCapabilities&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerGetCapabilitiesRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerGetCapabilitiesResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ›å»ºå¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">CreateSnapshot&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">CreateSnapshotRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">CreateSnapshotResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ é™¤å¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">DeleteSnapshot&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">DeleteSnapshotRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">DeleteSnapshotResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ—å‡ºå¿«ç…§&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">ListSnapshots&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ListSnapshotsRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ListSnapshotsResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ‰©å®¹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">ControllerExpandVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerExpandVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerExpandVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è·å¾—å·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">ControllerGetVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerGetVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ControllerGetVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">option&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">alpha_method&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>Node Service&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">service&lt;/span> &lt;span class="nx">Node&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¦‚æœå­˜å‚¨å·æ²¡æœ‰æ ¼å¼åŒ–ï¼Œé¦–å…ˆè¦æ ¼å¼åŒ–ã€‚ç„¶åæŠŠå­˜å‚¨å·mountåˆ°ä¸€ä¸ªä¸´æ—¶çš„ç›®å½•ï¼ˆè¿™ä¸ªç›®å½•é€šå¸¸æ˜¯èŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªå…¨å±€ç›®å½•ï¼‰ã€‚å†é€šè¿‡NodePublishVolumeå°†å­˜å‚¨å·mountåˆ°podçš„ç›®å½•ä¸­ã€‚mountè¿‡ç¨‹åˆ†ä¸º2æ­¥ï¼ŒåŸå› æ˜¯ä¸ºäº†æ”¯æŒå¤šä¸ªpodå…±äº«åŒä¸€ä¸ªvolumeï¼ˆå¦‚NFSï¼‰ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">NodeStageVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeStageVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeStageVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//NodeStageVolumeçš„é€†æ“ä½œï¼Œå°†ä¸€ä¸ªå­˜å‚¨å·ä»ä¸´æ—¶ç›®å½•umountæ‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">NodeUnstageVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeUnstageVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeUnstageVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å°†å­˜å‚¨å·ä»ä¸´æ—¶ç›®å½•mountåˆ°ç›®æ ‡ç›®å½•ï¼ˆpodç›®å½•ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">NodePublishVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodePublishVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodePublishVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å°†å­˜å‚¨å·ä»podç›®å½•umountæ‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">NodeUnpublishVolume&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeUnpublishVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeUnpublishVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿”å›å¯ç”¨äºè¯¥å·çš„å·å®¹é‡ç»Ÿè®¡ä¿¡æ¯ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">NodeGetVolumeStats&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeGetVolumeStatsRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeGetVolumeStatsResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//noeä¸Šæ‰§è¡Œå·æ‰©å®¹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">NodeExpandVolume&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">NodeExpandVolumeRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeExpandVolumeResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿”å›Nodeæ’ä»¶çš„åŠŸèƒ½ç‚¹ï¼Œå¦‚æ˜¯å¦æ”¯æŒstage/unstageåŠŸèƒ½&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">NodeGetCapabilities&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeGetCapabilitiesRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeGetCapabilitiesResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿”å›èŠ‚ç‚¹ä¿¡æ¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpc&lt;/span> &lt;span class="nf">NodeGetInfo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeGetInfoRequest&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NodeGetInfoResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>###External ç»„ä»¶ï¼ˆk8s Teamï¼‰&lt;/p>
&lt;p>è¿™éƒ¨åˆ†ç»„ä»¶æ˜¯ç”±k8så®˜æ–¹æä¾›çš„ï¼Œä½œä¸ºk8s apiè·Ÿcsi driverçš„æ¡¥æ¢ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>node-driver-registrar&lt;/strong>&lt;/p>
&lt;p>CSI node-driver-registraræ˜¯ä¸€ä¸ªsidecarå®¹å™¨ï¼Œå¯ä»CSI driverè·å–é©±åŠ¨ç¨‹åºä¿¡æ¯ï¼ˆä½¿ç”¨NodeGetInfoï¼‰ï¼Œå¹¶ä½¿ç”¨kubeletæ’ä»¶æ³¨å†Œæœºåˆ¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„kubeletä¸­å¯¹å…¶è¿›è¡Œæ³¨å†Œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>external-attacher&lt;/strong>&lt;/p>
&lt;p>å®ƒæ˜¯ä¸€ä¸ªsidecarå®¹å™¨ï¼Œç”¨äºç›‘è§†Kubernetes VolumeAttachmentå¯¹è±¡å¹¶é’ˆå¯¹é©±åŠ¨ç¨‹åºç«¯ç‚¹è§¦å‘CSI ControllerPublishå’ŒControllerUnpublishæ“ä½œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>external-provisioner&lt;/strong>&lt;/p>
&lt;p>å®ƒæ˜¯ä¸€ä¸ªsidecarå®¹å™¨ï¼Œç”¨äºç›‘è§†Kubernetes PersistentVolumeClaimå¯¹è±¡å¹¶é’ˆå¯¹é©±åŠ¨ç¨‹åºç«¯ç‚¹è§¦å‘CSI CreateVolumeå’ŒDeleteVolumeæ“ä½œã€‚
external-attacherè¿˜æ”¯æŒå¿«ç…§æ•°æ®æºã€‚ å¦‚æœå°†å¿«ç…§CRDèµ„æºæŒ‡å®šä¸ºPVCå¯¹è±¡ä¸Šçš„æ•°æ®æºï¼Œåˆ™æ­¤sidecarå®¹å™¨é€šè¿‡è·å–SnapshotContentå¯¹è±¡è·å–æœ‰å…³å¿«ç…§çš„ä¿¡æ¯ï¼Œå¹¶å¡«å……æ•°æ®æºå­—æ®µï¼Œè¯¥å­—æ®µå‘å­˜å‚¨ç³»ç»ŸæŒ‡ç¤ºåº”ä½¿ç”¨æŒ‡å®šçš„å¿«ç…§å¡«å……æ–°å· ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>external-resizer&lt;/strong>&lt;/p>
&lt;p>å®ƒæ˜¯ä¸€ä¸ªsidecarå®¹å™¨ï¼Œç”¨äºç›‘è§†Kubernetes APIæœåŠ¡å™¨ä¸Šçš„PersistentVolumeClaimå¯¹è±¡çš„æ”¹åŠ¨ï¼Œå¦‚æœç”¨æˆ·è¯·æ±‚åœ¨PersistentVolumeClaimå¯¹è±¡ä¸Šè¯·æ±‚æ›´å¤šå­˜å‚¨ï¼Œåˆ™ä¼šé’ˆå¯¹CSIç«¯ç‚¹è§¦å‘ControllerExpandVolumeæ“ä½œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>external-snapshotter&lt;/strong>&lt;/p>
&lt;p>å®ƒæ˜¯ä¸€ä¸ªsidecarå®¹å™¨ï¼Œç”¨äºç›‘è§†Kubernetes APIæœåŠ¡å™¨ä¸Šçš„VolumeSnapshotå’ŒVolumeSnapshotContent CRDå¯¹è±¡ã€‚åˆ›å»ºæ–°çš„VolumeSnapshotå¯¹è±¡ï¼ˆå¼•ç”¨ä¸æ­¤é©±åŠ¨ç¨‹åºå¯¹åº”çš„SnapshotClass CRDå¯¹è±¡ï¼‰å°†å¯¼è‡´sidecarå®¹å™¨æä¾›æ–°çš„å¿«ç…§ã€‚
è¯¥Sidecarä¾¦å¬æŒ‡ç¤ºæˆåŠŸåˆ›å»ºVolumeSnapshotçš„æœåŠ¡ï¼Œå¹¶ç«‹å³åˆ›å»ºVolumeSnapshotContentèµ„æºã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>livenessprobe&lt;/strong>&lt;/p>
&lt;p>å®ƒæ˜¯ä¸€ä¸ªsidecarå®¹å™¨ï¼Œç”¨äºç›‘è§†CSIé©±åŠ¨ç¨‹åºçš„è¿è¡ŒçŠ¶å†µï¼Œå¹¶é€šè¿‡&lt;a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" target="_blank" rel="noopener">Liveness Probeæœºåˆ¶&lt;/a>å°†å…¶æŠ¥å‘Šç»™Kubernetesã€‚ è¿™ä½¿Kubernetesèƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹é©±åŠ¨ç¨‹åºé—®é¢˜å¹¶é‡æ–°å¯åŠ¨Podä»¥å°è¯•è§£å†³é—®é¢˜ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2>å‚è€ƒ&lt;span class="hx-absolute -hx-mt-20" id="å‚è€ƒ">&lt;/span>
&lt;a href="#%e5%8f%82%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://kubernetes-csi.github.io/docs/introduction.html" target="_blank" rel="noopener">kubernetes-csi-introduction&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://draveness.me/kubernetes-volume/" target="_blank" rel="noopener">è¯¦è§£ Kubernetes Volume çš„å®ç°åŸç†&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.dazhuanlan.com/2020/01/31/5e33a33ba05d1/" target="_blank" rel="noopener">CSIå­˜å‚¨æ¥å£è§£é‡Š&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>æºç å‰–æï¼šKEDAæ˜¯å¦‚ä½•å·¥ä½œçš„?</title><link>/blog/202011/how-does-keda-work/</link><pubDate>Sun, 08 Nov 2020 11:20:59 +0800</pubDate><guid>/blog/202011/how-does-keda-work/</guid><description>
&lt;blockquote>
&lt;p>æ–‡ç« ä¸­æºç æ˜¯åŸºäºKEDA 2.0( &lt;a href="https://github.com/kedacore/keda/commit/50bec808f8b4656922797e4bcb7c2b61fabd6d0e" target="_blank" rel="noopener">50bec80
&lt;/a>)æ¥è¿›è¡Œåˆ†æ&lt;/p>
&lt;p>keda 2.0 è¦æ±‚k8sé›†ç¾¤ç‰ˆæœ¬ &amp;gt;=1.16&lt;/p>
&lt;/blockquote>
&lt;p>KEDA åœ¨&lt;a href="https://keda.sh/blog/keda-2.0-release/" target="_blank" rel="noopener">2020å¹´11æœˆ4å·releaseäº†2.0ç‰ˆæœ¬&lt;/a>ï¼ŒåŒ…å«äº†ä¸€äº›æ–°çš„æ¯”è¾ƒæœ‰ç”¨çš„ç‰¹æ€§ï¼Œæ¯”å¦‚&lt;code>ScaledObject/ScaledJob&lt;/code>ä¸­æ”¯æŒå¤šè§¦å‘å™¨ã€æ”¯æŒHPAåŸå§‹çš„CPUã€Memory scalerç­‰ã€‚&lt;/p>
&lt;p>å…·ä½“çš„å®‰è£…ä½¿ç”¨è¯·å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« &lt;a href="https://silenceper.com/blog/202009/how-to-use-keda/" target="_blank" rel="noopener">ä½¿ç”¨kedaå®ŒæˆåŸºäºäº‹ä»¶çš„å¼¹æ€§ä¼¸ç¼©&lt;/a>ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ·±å…¥çš„çœ‹ä¸‹KEDAå†…éƒ¨æœºåˆ¶ä»¥åŠæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;p>&lt;strong>æˆ‘ä»¬å…ˆæå‡ºå‡ ä¸ªé—®é¢˜ï¼Œå¸¦ç€é—®é¢˜å»çœ‹ä»£ç ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç†è§£æ•´ä¸ªæœºåˆ¶ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>KEDAæ˜¯å¦‚ä½•è·å–åˆ°å¤šç§äº‹ä»¶çš„æŒ‡æ ‡ï¼Œä»¥åŠå¦‚ä½•åˆ¤æ–­æ‰©ç¼©å®¹çš„ï¼Ÿ&lt;/li>
&lt;li>KEDAæ˜¯å¦‚ä½•åšåˆ°å°†åº”ç”¨çš„å‰¯æœ¬æ•°ç¼©å®¹0ï¼Œä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/li>
&lt;/ul>
&lt;h2>ä»£ç ç»“æ„&lt;span class="hx-absolute -hx-mt-20" id="ä»£ç ç»“æ„">&lt;/span>
&lt;a href="#%e4%bb%a3%e7%a0%81%e7%bb%93%e6%9e%84" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å¯¹ä¸€äº›ä¸»è¦ç›®å½•è¯´æ˜ï¼Œå…¶ä»–ä¸€äº›MDæ–‡ä»¶ä¸»è¦æ˜¯æ–‡å­—è¯´æ˜ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>â”œâ”€â”€ BRANDING.md
â”œâ”€â”€ BUILD.md //å¦‚ä½•åœ¨æœ¬åœ°ç¼–è¯‘å’Œè¿è¡Œ
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ CONTRIBUTING.md //å¦‚ä½•å‚ä¸è´¡çŒ®æ¬¡é¡¹ç›®
â”œâ”€â”€ CREATE-NEW-SCALER.md
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Dockerfile.adapter
â”œâ”€â”€ GOVERNANCE.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ MAINTAINERS.md
â”œâ”€â”€ Makefile // æ„å»ºç¼–è¯‘ç›¸å…³å‘½ä»¤
â”œâ”€â”€ PROJECT
â”œâ”€â”€ README.md
â”œâ”€â”€ RELEASE-PROCESS.MD
â”œâ”€â”€ adapter // keda-metrics-apiserver ç»„ä»¶å…¥å£
â”œâ”€â”€ api // è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼Œä¾‹å¦‚ScaledObjectçš„å®šä¹‰
â”œâ”€â”€ bin
â”œâ”€â”€ config //ç»„ä»¶yamlèµ„æºï¼Œé€šè¿‡kustomizationå·¥å…·ç”Ÿæˆ
â”œâ”€â”€ controllers //kubebuilder ä¸­controller ä»£ç æ§åˆ¶crdèµ„æº
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ hack
â”œâ”€â”€ images
â”œâ”€â”€ main.go //keda-operator controllerå…¥å£
â”œâ”€â”€ pkg //åŒ…å«ç»„ä»¶æ ¸å¿ƒä»£ç å®ç°
â”œâ”€â”€ tests //e2eæµ‹è¯•
â”œâ”€â”€ tools
â”œâ”€â”€ vendor
â””â”€â”€ version&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>kedaä¸­ä¸»è¦æ˜¯ä¸¤ä¸ªç»„ä»¶&lt;code>keda-operator&lt;/code>ä»¥åŠ&lt;code>keda-metrics-apiserver&lt;/code>ã€‚&lt;/p>
&lt;ul>
&lt;li>keda-operator ï¼š è´Ÿè´£åˆ›å»º/æ›´æ–°HPAä»¥åŠé€šè¿‡Loopæ§åˆ¶åº”ç”¨å‰¯æœ¬æ•°&lt;/li>
&lt;li>keda-metrics-apiserverï¼šå®ç°external-metricsæ¥å£ï¼Œä»¥å¯¹æ¥ç»™HPAçš„externalç±»å‹çš„æŒ‡æ ‡æŸ¥è¯¢ï¼ˆæ¯”å¦‚å„ç§prometheusæŒ‡æ ‡ï¼Œmysqlç­‰ï¼‰&lt;/li>
&lt;/ul>
&lt;h2>keda-operator&lt;span class="hx-absolute -hx-mt-20" id="keda-operator">&lt;/span>
&lt;a href="#keda-operator" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>é¡¹ç›®ä¸­ç”¨åˆ°äº†&lt;a href="https://github.com/kubernetes-sigs/kubebuilder" target="_blank" rel="noopener">kubebuilder&lt;/a> SDKï¼Œç”¨æ¥å®Œæˆè¿™ä¸ªOperatorçš„ç¼–å†™ã€‚&lt;/p>
&lt;p>å¯¹äºk8sä¸­çš„è‡ªå®šä¹‰controllerä¸äº†è§£çš„å¯ä»¥çœ‹çœ‹è¿™è¾¹æ–‡ç« ï¼š&lt;a href="/blog/202005/custom-resources-and-controllers/" >å¦‚ä½•åœ¨Kubernetesä¸­åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰Controller?&lt;/a>ã€‚&lt;/p>
&lt;p>keda controllerçš„ä¸»è¦æµç¨‹ï¼Œç”»äº†å¹…å›¾ï¼š
&lt;img src="/img/20201111/keda-controller-analyze.png" alt="keda-controller åˆ†ææµç¨‹" loading="lazy" />&lt;/p>
&lt;p>ç»„ä»¶å¯åŠ¨å…¥å£åœ¨äº&lt;code>main.go&lt;/code>æ–‡ä»¶ä¸­ï¼š&lt;/p>
&lt;p>é€šè¿‡&lt;code>controller-runtime&lt;/code>ç»„ä»¶å¯åŠ¨ä¸¤ä¸ªè‡ªå®šä¹‰controllerï¼š&lt;code>ScaledObjectReconciler&lt;/code>,&lt;code>ScaledJobReconciler&lt;/code>:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">mgr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewManager&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetConfigOrDie&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Scheme&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">scheme&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MetricsBindAddress&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metricsAddr&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">HealthProbeBindAddress&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;:8081&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Port&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">9443&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaderElection&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">enableLeaderElection&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaderElectionID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;operator.keda.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Add readiness probe &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddReadyzCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ready-ping&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">healthz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ping&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Add liveness probe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddHealthzCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;health-ping&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">healthz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ping&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ³¨å†Œ ScaledObject å¤„ç†çš„controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">controllers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScaledObjectReconciler&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetClient&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Log&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;controllers&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">WithName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ScaledObject&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Scheme&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetScheme&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}).&lt;/span>&lt;span class="nf">SetupWithManager&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mgr&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setupLog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;unable to create controller&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;controller&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledObject&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">////æ³¨å†Œ ScaledJob å¤„ç†çš„controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">controllers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScaledJobReconciler&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetClient&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Log&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;controllers&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">WithName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ScaledJob&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Scheme&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetScheme&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}).&lt;/span>&lt;span class="nf">SetupWithManager&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mgr&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setupLog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;unable to create controller&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;controller&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledJob&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetupSignalHandler&lt;/span>&lt;span class="p">());&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setupLog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;problem running manager&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>ScaledObjectReconciler å¤„ç†&lt;span class="hx-absolute -hx-mt-20" id="scaledobjectreconciler-å¤„ç†">&lt;/span>
&lt;a href="#scaledobjectreconciler-%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬ä¸»è¦å…³æ³¨&lt;a href="https://github.com/kedacore/keda/blob/main/controllers/scaledobject_controller.go#L100" target="_blank" rel="noopener">&lt;code>Reconcile&lt;/code>&lt;/a>æ–¹æ³•ï¼Œå½“&lt;code>ScaledObject&lt;/code>å‘ç”Ÿå˜åŒ–æ—¶å°†ä¼šè§¦å‘è¯¥æ–¹æ³•ï¼š
æ–¹æ³•å†…éƒ¨ä¸»è¦åŠŸèƒ½å®ç°ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¤„ç†åˆ é™¤ScaledObjectçš„æƒ…å†µ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetDeletionTimestamp&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿›å…¥åƒåœ¾å›æ”¶ï¼ˆæ¯”å¦‚åœæ­¢goroutineä¸­Loopï¼Œæ¢å¤åŸæœ‰å‰¯æœ¬æ•°ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">finalizeScaledObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç»™ScaledObjectèµ„æºåŠ ä¸ŠFinalizerï¼šfinalizer.keda.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ensureFinalizer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// çœŸæ­£å¤„ç†ScaledObjectèµ„æº&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">reconcileScaledObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è®¾ç½®Statuså­—æ®µè¯´æ˜&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">conditions&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conditions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DeepCopy&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">conditions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetReadyCondition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConditionFalse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledObjectCheckFailed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">conditions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetActiveCondition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConditionUnknown&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;UnkownState&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledObject check failed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">conditions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetReadyCondition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConditionTrue&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledObjectReady&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">kedacontrollerutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetStatusConditions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">conditions&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>r.reconcileScaledObjectæ–¹æ³•ï¼š&lt;/strong>&lt;/p>
&lt;p>è¿™ä¸ªæ–¹æ³•ä¸­ä¸»è¦ä¸¤ä¸ªåŠ¨ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>ensureHPAForScaledObjectExists&lt;/code>åˆ›å»ºHPAèµ„æº&lt;/li>
&lt;li>è¿›å…¥&lt;code>requestScaleLoop&lt;/code>ï¼ˆä¸æ–­çš„æ£€æµ‹scaler æ˜¯å¦activeï¼Œè¿›è¡Œå‰¯æœ¬æ•°çš„ä¿®æ”¹ï¼‰&lt;/li>
&lt;/ul>
&lt;h4>ensureHPAForScaledObjectExists&lt;span class="hx-absolute -hx-mt-20" id="ensurehpaforscaledobjectexists">&lt;/span>
&lt;a href="#ensurehpaforscaledobjectexists" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>é€šè¿‡è·Ÿè¸ªè¿›å…¥åˆ°&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/controllers/hpa.go#L43" target="_blank" rel="noopener">newHPAForScaledObject&lt;/a>æ–¹æ³•:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">scaledObjectMetricSpecs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">getScaledObjectMetricSpecs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>&lt;span class="nx">çœç•¥ä»£ç &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">hpa&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">autoscalingv2beta2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscaler&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Spec&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">autoscalingv2beta2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MinReplicas&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">getHPAMinReplicas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MaxReplicas&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">getHPAMaxReplicas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Metrics&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">scaledObjectMetricSpecs&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Behavior&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">behavior&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ScaleTargetRef&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">autoscalingv2beta2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CrossVersionObjectReference&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScaleTargetRef&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Kind&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gvkr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Kind&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">APIVersion&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gvkr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GroupVersion&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">getHPAName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Namespace&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Namespace&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Labels&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">labels&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">TypeMeta&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">APIVersion&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;v2beta2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥çœ‹åˆ°åˆ›å»ºScalerObjectå…¶å®æœ€ç»ˆä¹Ÿæ˜¯åˆ›å»ºäº†HPAï¼Œå…¶å®è¿˜æ˜¯é€šè¿‡HPAæœ¬èº«çš„ç‰¹æ€§æ¥æ§åˆ¶åº”ç”¨çš„å¼¹æ€§ä¼¸ç¼©ã€‚&lt;/p>
&lt;p>å…¶ä¸­&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/controllers/hpa.go#L135" target="_blank" rel="noopener">getScaledObjectMetricSpecs&lt;/a>æ–¹æ³•ä¸­å°±æ˜¯è·å–åˆ°&lt;code>triggers&lt;/code>ä¸­çš„metricsæŒ‡æ ‡ã€‚&lt;/p>
&lt;p>è¿™é‡Œæœ‰åŒºåˆ†ä¸€ä¸‹Externalçš„metricså’Œresource metricsï¼Œå› ä¸ºCPU/Memory scaleræ˜¯é€šè¿‡resource metrics æ¥è·å–çš„ã€‚&lt;/p>
&lt;h4>requestScaleLoop&lt;span class="hx-absolute -hx-mt-20" id="requestscaleloop">&lt;/span>
&lt;a href="#requestscaleloop" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/controllers/scaledobject_controller.go#L299" target="_blank" rel="noopener">requestScaleLoop&lt;/a>æ–¹æ³•ä¸­ç”¨æ¥å¾ªç¯check Scalerä¸­çš„IsActiveçŠ¶æ€å¹¶ä½œå‡ºå¯¹åº”çš„å¤„ç†ï¼Œæ¯”å¦‚ä¿®æ”¹å‰¯æœ¬æ•°ï¼Œç›´æ¥æ¥çœ‹æœ€ç»ˆçš„å¤„ç†å§ï¼š
è¿™é‡Œæœ‰ä¸¤ç§æ¨¡å‹æ¥è§¦å‘&lt;code>RequestScale&lt;/code>ï¼š&lt;/p>
&lt;ul>
&lt;li>Pullæ¨¡å‹ï¼šå³ä¸»åŠ¨çš„è°ƒç”¨scaler ä¸­çš„&lt;code>IsActive&lt;/code>æ–¹æ³•&lt;/li>
&lt;li>Pushæ¨¡å‹ï¼šç”±Scaleræ¥è§¦å‘ï¼Œ&lt;code>PushScaler&lt;/code>å¤šäº†ä¸€ä¸ªRunæ–¹æ³•ï¼Œé€šè¿‡channelä¼ å…¥activeçŠ¶æ€ã€‚&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>&lt;code>IsActive&lt;/code>æ˜¯ç”±Scalerå®ç°çš„ï¼Œæ¯”å¦‚å¯¹äºprometheusæ¥è¯´ï¼Œå¯èƒ½æŒ‡æ ‡ä¸º0åˆ™ä¸ºfalse&lt;/p>
&lt;/blockquote>
&lt;p>è¿™ä¸ªå…·ä½“çš„scalerå®ç°åç»­å†è®²ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹RequestScaleåšäº†ä»€ä¹ˆäº‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å½“å‰å‰¯æœ¬æ•°ä¸º0ï¼Œå¹¶æ˜¯æ‰€æœ‰scalerå±äºactiveçŠ¶æ€ï¼Œåˆ™ä¿®æ”¹å‰¯æœ¬æ•°ä¸ºMinReplicaCount æˆ– 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Replicas&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">isActive&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">scaleFromZero&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">isActive&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Replicas&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ‰€æœ‰scaleréƒ½å¤„ç†not activeçŠ¶æ€ï¼Œå¹¶ä¸”å½“å‰å‰¯æœ¬æ•°å¤§äº0ï¼Œä¸”MinReplicaCountè®¾å®šä¸º0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ™ç¼©å®¹å‰¯æœ¬æ•°ä¸º0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">scaleToZero&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">isActive&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Replicas&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ‰€æœ‰scaleréƒ½å¤„ç†not activeçŠ¶æ€ï¼Œå¹¶ä¸”å½“å‰å‰¯æœ¬æ•°å°äºMinReplicaCountï¼Œåˆ™ä¿®æ”¹ä¸ºMinReplicaCount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Replicas&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">updateScaleOnScaleTarget&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">isActive&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¤„ç†activeçŠ¶æ€ï¼Œå¹¶ä¸”å‰¯æœ¬æ•°å¤§äº0ï¼Œåˆ™æ›´æ–°LastActiveTime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">updateLastActiveTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸å¤„ç†&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ScaleTarget no change&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>ScaledJobReconciler å¤„ç†&lt;span class="hx-absolute -hx-mt-20" id="scaledjobreconciler-å¤„ç†">&lt;/span>
&lt;a href="#scaledjobreconciler-%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>&lt;code>ScaledJobReconciler&lt;/code>ç›¸æ¯”&lt;code>ScalerObject&lt;/code>å°‘äº†åˆ›å»ºHPAçš„æ­¥éª¤ï¼Œå…¶ä½™çš„æ­¥éª¤ä¸»è¦æ˜¯é€šè¿‡&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/pkg/scaling/scale_handler.go#L223" target="_blank" rel="noopener">checkScaledJobScalers&lt;/a>ï¼Œ&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/pkg/scaling/executor/scale_jobs.go#L24" target="_blank" rel="noopener">RequestJobScale&lt;/a>ä¸¤ä¸ªæ–¹æ³•æ¥åˆ¤æ–­Jobåˆ›å»ºï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>checkScaledJobScalers&lt;/code> æ–¹æ³•ï¼Œç”¨äºè®¡ç®—isActiveï¼ŒmaxValueçš„å€¼&lt;/li>
&lt;li>&lt;code>RequestJobScale&lt;/code> æ–¹æ³•ï¼Œç”¨äºè´Ÿè´£åˆ›å»ºJobï¼Œé‡Œé¢è¿˜æ¶‰åŠåˆ°ä¸‰ç§æ‰©å®¹ç­–ç•¥&lt;/li>
&lt;/ul>
&lt;p>è¿™é‡Œç›´æ¥çœ‹ä»£ç å§ï¼Œä¸è´´ä»£ç äº†ã€‚&lt;/p>
&lt;p>&lt;strong>å¦‚ä½•åœæ­¢Loop&lt;/strong>&lt;/p>
&lt;p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜å°±æ˜¯&lt;code>startPushScalers&lt;/code>å’Œ&lt;code>startScaleLoop&lt;/code>éƒ½æ˜¯åœ¨Goroutineä¸­å¤„ç†çš„ï¼Œæ‰€ä»¥å½“ScaleObject/ScalerJobè¢«åˆ é™¤çš„æ—¶å€™ï¼Œè¿™é‡Œéœ€è¦èƒ½å¤Ÿè¢«åˆ é™¤ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†&lt;code>context.Cancel&lt;/code>æ–¹æ³•ï¼Œåœ¨Goroutineå¯åŠ¨çš„æ—¶å€™å°±å°†ï¼Œcontextä¿å­˜åœ¨&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/pkg/scaling/scale_handler.go#L43" target="_blank" rel="noopener">scaleLoopContexts *sync.Map&lt;/a>ä¸­(å¦‚æœå·²ç»æœ‰äº†ï¼Œå°±å…ˆCancelä¸€æ¬¡)ï¼Œåœ¨åˆ é™¤èµ„æºçš„æ—¶å€™ï¼Œè¿›è¡Œåˆ é™¤:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">h&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">scaleHandler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">DeleteScalableObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scalableObject&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">withTriggers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">asDuckWithTriggers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scalableObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;error duck typing object into withTrigger&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">key&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">generateKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">withTriggers&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">scaleLoopContexts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cancel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CancelFunc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">scaleLoopContexts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ScaleObject was not found in controller cache&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ps: è¿™é‡Œçš„å¦™å•Šï¼Œå­¦åˆ°äº†&lt;/p>
&lt;h2>keda-metrics-apiserver&lt;span class="hx-absolute -hx-mt-20" id="keda-metrics-apiserver">&lt;/span>
&lt;a href="#keda-metrics-apiserver" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>keda-metrics-apiserverå®ç°äº†&lt;code>ExternalMetricsProvider&lt;/code>æ¥å£ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ExternalMetricsProvider&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetExternalMetric&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSelector&lt;/span> &lt;span class="nx">labels&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Selector&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">info&lt;/span> &lt;span class="nx">ExternalMetricInfo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">external_metrics&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExternalMetricValueList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">ListAllExternalMetrics&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">ExternalMetricInfo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>GetExternalMetric ç”¨äºè¿”å›Scalerçš„æŒ‡æ ‡ï¼Œè°ƒç”¨&lt;code>scaler.GetMetrics&lt;/code>æ–¹æ³•&lt;/li>
&lt;li>ListAllExternalMetrics è¿”å›æ‰€æœ‰æ”¯æŒçš„external metricsï¼Œä¾‹å¦‚prometheusï¼Œmysqlç­‰&lt;/li>
&lt;/ul>
&lt;p>å½“ä»£ç å†™å¥½ä¹‹åï¼Œå†é€šè¿‡apiserviceæ³¨å†Œåˆ°apiservierä¸Š(å½“ç„¶è¿˜æ¶‰åŠåˆ°é‰´æƒï¼Œè¿™é‡Œä¸å•°å—¦äº†)ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
labels:
app.kubernetes.io/name: v1beta1.external.metrics.k8s.io
app.kubernetes.io/version: latest
app.kubernetes.io/part-of: keda-operator
name: v1beta1.external.metrics.k8s.io
spec:
service:
name: keda-metrics-apiserver
namespace: keda
group: external.metrics.k8s.io
version: v1beta1
insecureSkipTLSVerify: true
groupPriorityMinimum: 100
versionPriority: 100&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>å®ç°ä¸€ä¸ªScaler&lt;span class="hx-absolute -hx-mt-20" id="å®ç°ä¸€ä¸ªscaler">&lt;/span>
&lt;a href="#%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aascaler" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å…¶å®æœ‰ä¸¤ç§Scalerï¼Œå³ä¸Šé¢å°†çš„ä¸€ä¸ªpullï¼Œä¸€ä¸ªpushçš„æ¨¡å‹ï¼ŒPushScalerå¤šäº†ä¸€ä¸ªRunæ–¹æ³•ï¼š&lt;/p>
&lt;p>å®ç°ä¸€ä¸ªScalerï¼Œä¸»è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Scaler interface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Scaler&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è¿”å›external_metrics.ExternalMetricValueå¯¹è±¡ï¼Œå…¶å®å°±æ˜¯ç”¨äº keda-metrics-apiserverä¸­è·å–åˆ°scalerçš„æŒ‡æ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetMetrics&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSelector&lt;/span> &lt;span class="nx">labels&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Selector&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="nx">external_metrics&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExternalMetricValue&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è¿”å›v2beta2.MetricSpec ç»“æ„ï¼Œä¸»è¦ç”¨äºScalerObjectæè¿°åˆ›å»ºHPAçš„ç±»å‹å’ŒTargetæŒ‡æ ‡ç­‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetMetricSpecForScaling&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v2beta2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricSpec&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è¿”å›è¯¥Scaleræ˜¯å¦Activeï¼Œå¯èƒ½ä¼šå½±å“Loopä¸­ç›´æ¥ä¿®æ”¹å‰¯æœ¬æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">IsActive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è°ƒç”¨å®Œä¸€æ¬¡ä¸Šé¢çš„æ–¹æ³•å°±ä¼šè°ƒç”¨ä¸€æ¬¡Close &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// PushScaler interface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">PushScaler&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Scaler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€šè¿‡scalerå®ç°Runæ–¹æ³•ï¼Œå¾€active channelä¸­ï¼Œå†™å…¥å€¼ï¼Œè€Œéä¸Šé¢çš„ç›´æ¥è°ƒç”¨IsActiveæ”¾å›&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">active&lt;/span> &lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å›è¿‡å¤´æ¥æˆ‘ä»¬è§£ç­”ä¸‹åœ¨å¼€å¤´ç•™ä¸‹çš„é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>KEDAæ˜¯å¦‚ä½•è·å–åˆ°å¤šç§äº‹ä»¶çš„æŒ‡æ ‡ï¼Œä»¥åŠå¦‚ä½•åˆ¤æ–­æ‰©ç¼©å®¹çš„ï¼Ÿ&lt;/p>
&lt;p>ç­”ï¼škeda controlerä¸­ç”Ÿæˆäº†external ç±»å‹çš„hpaï¼Œå¹¶ä¸”å®ç°äº†external metrics çš„api&lt;/p>
&lt;/li>
&lt;li>
&lt;p>KEDAæ˜¯å¦‚ä½•åšåˆ°å°†åº”ç”¨çš„å‰¯æœ¬æ•°ç¼©å®¹0ï¼Œä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;p>ç­”ï¼š keda å†…éƒ¨æœ‰ä¸ªloopï¼Œä¸æ–­çš„check isActiveçŠ¶æ€ï¼Œä¼šä¸»åŠ¨çš„ä¿®æ”¹åº”ç”¨å‰¯æœ¬&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>KEDA - ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨çš„ä¼¸ç¼©æ§åˆ¶å™¨</title><link>/kubernetes-book/keda/</link><pubDate>Wed, 04 Nov 2020 15:40:59 +0800</pubDate><guid>/kubernetes-book/keda/</guid><description>
&lt;p>kedaæ˜¯ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨çš„ä¼¸ç¼©æ§åˆ¶å™¨ï¼Œå¯ä»¥å®ç°åº”ç”¨ç¼©å®¹è‡³0ï¼Œä»¥åŠä»0å¼€å§‹æ‰©å®¹ã€‚ç›®å‰å·²æ”¯æŒåƒCPU/Memroyã€Mysqlã€Prometheusã€Redisç­‰20å¤šç§äº‹ä»¶æ¥æº(Scaler)ã€‚&lt;/p>
&lt;p>ç›®å‰ä¹Ÿæ˜¯CNCFä¸‹çš„sandboxé¡¹ç›®ï¼Œæœ€åˆä¸»è¦ç”±å¾®è½¯ã€redhatä»¥åŠç¤¾åŒºçš„äººå‘˜å‚ä¸è´¡çŒ®ã€‚&lt;/p>
&lt;p>&lt;strong>ç½‘ç«™&lt;/strong>ï¼šhttps://keda.sh/&lt;/p>
&lt;p>&lt;strong>é¡¹ç›®åœ°å€&lt;/strong>ï¼šhttps://github.com/kedacore/keda&lt;/p>
&lt;p>&lt;strong>KEDAæ¶æ„å›¾&lt;/strong>ï¼š&lt;/p>
&lt;img src="https://silenceper.oss-cn-beijing.aliyuncs.com/images/keda-arch.png" alt="kedaæ¶æ„å›¾" style="zoom: 50%;" />
&lt;h2>å®‰è£…&lt;span class="hx-absolute -hx-mt-20" id="å®‰è£…">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>keda 2.0ç‰ˆæœ¬è¦æ±‚k8sé›†ç¾¤&amp;gt;=1.16&lt;/p>
&lt;/blockquote>
&lt;p>æ”¯æŒå¤šç§å®‰è£…æ–¹å¼ï¼Œå¯ä»¥æŸ¥çœ‹kedaæ–‡æ¡£ï¼šhttps://keda.sh/docs/2.0/deploy/#install&lt;/p>
&lt;p>æ¯”å¦‚ç›´æ¥ä½¿ç”¨YAMLæ–‡ä»¶å®‰è£…ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">kubectl apply -f https://github.com/kedacore/keda/releases/download/v2.0.0/keda-2.0.0.yaml&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ£€æŸ¥é›†ç¾¤ä¸­æ˜¯å¦å®‰è£…æˆåŠŸï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&amp;gt;kubectl get pod -n keda
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">keda-metrics-apiserver-5bffbfbd68-s7pbn 1/1 Running &lt;span class="m">10&lt;/span> 2d23h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">keda-operator-7b98595dc7-tvgr9 1/1 Running &lt;span class="m">19&lt;/span> 2d23h&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åŸºæœ¬ä½¿ç”¨&lt;span class="hx-absolute -hx-mt-20" id="åŸºæœ¬ä½¿ç”¨">&lt;/span>
&lt;a href="#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>KEDA 2.0æœ‰ä¸¤ç§æ§åˆ¶å¯¹è±¡ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://keda.sh/docs/2.0/concepts/scaling-deployments/" target="_blank" rel="noopener">ScaledObject&lt;/a>ï¼šåŸºäºHPAï¼Œæ ¹æ®äº‹ä»¶è§¦å‘å™¨(scaler)æ§åˆ¶åº”ç”¨(Deployments, StatefulSets &amp;amp; Custom Resources)çš„æ°´å¹³ä¼¸ç¼©&lt;/li>
&lt;li>&lt;a href="https://keda.sh/docs/2.0/concepts/scaling-jobs/" target="_blank" rel="noopener">ScaledJob&lt;/a>ï¼šæ ¹æ®äº‹ä»¶è§¦å‘å™¨(scaler)ï¼Œç”Ÿæˆjob&lt;/li>
&lt;/ul>
&lt;p>###ScaledObjecté…ç½®&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">keda.sh/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ScaledObject&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="l">scaled-object-name}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">scaleTargetRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="nt">api-version-of-target-resource} # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="nt">kind-of-target-resource} # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="l">name-of-target-resource} &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Mandatory. Must be in the same namespace as the ScaledObject&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">envSourceContainerName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="nt">container-name} # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.spec.template.spec.containers[0]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pollingInterval: 30 # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">seconds&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cooldownPeriod: 300 # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">300&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">seconds&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">minReplicaCount: 0 # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">maxReplicaCount: 100 # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">advanced&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Optional. Section to specify advanced options&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">restoreToOriginalReplicaCount: true/false # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">horizontalPodAutoscalerConfig&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Optional. Section to specify HPA related options&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">behavior&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Optional. Use to modify HPA&amp;#39;s scaling behavior&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">scaleDown&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stabilizationWindowSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">300&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">policies&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Percent&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">value&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">periodSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">15&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">triggers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># {list of triggers to activate scaling of the target resource}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>å‚æ•°è¯´æ˜ï¼š&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å‚æ•°&lt;/th>
&lt;th style="text-align: left">è¯´æ˜&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>spec.scaleTargetRef&lt;/td>
&lt;td style="text-align: left">éœ€è¦æ‰©ç¼©å®¹çš„å¯¹è±¡èµ„æº&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.pollingInterval&lt;/td>
&lt;td style="text-align: left">å®šæ—¶è·å–è§¦å‘å™¨(scaler)çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤30s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.cooldownPeriod&lt;/td>
&lt;td style="text-align: left">ä¸Šæ¬¡activeè‡³ç¼©å®¹ä¸º0éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œé»˜è®¤300s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.minReplicaCount&lt;/td>
&lt;td style="text-align: left">åº”ç”¨æœ€å°å€¼&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.maxReplicaCount&lt;/td>
&lt;td style="text-align: left">åº”ç”¨æœ€å¤§å€¼&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.advanced.restoreToOriginalReplicaCount&lt;/td>
&lt;td style="text-align: left">åœ¨åˆ é™¤ScaledObjectä¹‹åï¼Œæ˜¯å¦å°†åº”ç”¨æ¢å¤ä¸ºåŸå€¼&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.advanced.horizontalPodAutoscalerConfig&lt;/td>
&lt;td style="text-align: left">HPAå¯¹åº”çš„é…ç½®&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.triggers&lt;/td>
&lt;td style="text-align: left">scaleråˆ—è¡¨&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æ¯”å¦‚åˆ›å»ºä¸€ä¸ªåŸºäºprometheusçš„æ•°æ®ä½œä¸ºè§¦å‘å™¨çš„&lt;code>scaledobject&lt;/code>:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">keda.k8s.io/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ScaledObject&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">prometheus-scaledobject&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">scaleTargetRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">deploymentName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http-demo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">minReplicaCount&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">triggers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">prometheus&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">serverAddress&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http://192.168.99.100:31046/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">metricName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gin_requests_total&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">threshold&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;2&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">query&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sum(rate(gin_requests_total{app=&amp;#34;http-demo&amp;#34;,code=&amp;#34;200&amp;#34;}[2m]))&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>###Scaling Jobsé…ç½®&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">keda.sh/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ScaledJob&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="l">scaled-job-name}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">jobTargetRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">parallelism&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># [max number of desired pods](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/#controlling-parallelism)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">completions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># [desired number of successfully finished pods](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/#controlling-parallelism)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">activeDeadlineSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">600&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Specifies the duration in seconds relative to the startTime that the job may be active before the system tries to terminate it; value must be positive integer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">backoffLimit&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">6&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Specifies the number of retries before marking this job failed. Defaults to 6&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># describes the [job template](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pollingInterval: 30 # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">30&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">seconds&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">successfulJobsHistoryLimit: 5 # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">100&lt;/span>&lt;span class="l">. How many completed jobs should be kept.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">failedJobsHistoryLimit: 5 # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">100&lt;/span>&lt;span class="l">. How many failed jobs should be kept.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">envSourceContainerName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{&lt;span class="nt">container-name} # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">.spec.JobTargetRef.template.spec.containers[0]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">maxReplicaCount: 100 # Optional. Default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">100&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">scalingStrategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">strategy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;custom&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Optional. Default: default. Which Scaling Strategy to use. &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">customScalingQueueLengthDeduction&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Optional. A parameter to optimize custom ScalingStrategy.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">customScalingRunningJobPercentage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0.5&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Optional. A parameter to optimize custom ScalingStrategy.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">triggers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># {list of triggers to create jobs}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>å‚æ•°è¯´æ˜ï¼š&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å‚æ•°&lt;/th>
&lt;th>è¯´æ˜&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>spec.jobTargetRef&lt;/td>
&lt;td>ç”Ÿæˆçš„jobæè¿°ï¼Œ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.pollingInterval&lt;/td>
&lt;td>å®šæ—¶è·å–è§¦å‘å™¨(scaler)çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤30s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.successfulJobsHistoryLimit&lt;/td>
&lt;td>ä¿ç•™çš„success jobæ•°é‡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.failedJobsHistoryLimit&lt;/td>
&lt;td>ä¿ç•™çš„failed jobæ•°é‡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.envSourceContainerName&lt;/td>
&lt;td>é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®å‚æ•°çš„å®¹å™¨ï¼Œæ¯”å¦‚â€œiam.amazonaws.com/roleâ€å‚æ•°ç­‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.maxReplicaCount&lt;/td>
&lt;td>jobæœ€å¤§æ•°é‡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.scalingStrategy&lt;/td>
&lt;td>jobç”Ÿæˆç­–ç•¥&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>spec.triggers&lt;/td>
&lt;td>scaleråˆ—è¡¨&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3>Scaler&lt;span class="hx-absolute -hx-mt-20" id="scaler">&lt;/span>
&lt;a href="#scaler" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æ”¯æŒçš„Scalerå¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ActiveMQ Artemis&lt;/li>
&lt;li>Apache Kafka&lt;/li>
&lt;li>AWS CloudWatch&lt;/li>
&lt;li>AWS Kinesis Stream&lt;/li>
&lt;li>AWS SQS Queue&lt;/li>
&lt;li>Azure Blob Storage&lt;/li>
&lt;li>Azure Event Hubs&lt;/li>
&lt;li>Azure Log Analytics&lt;/li>
&lt;li>Azure Monitor&lt;/li>
&lt;li>Azure Service Bus&lt;/li>
&lt;li>Azure Storage Queue&lt;/li>
&lt;li>CPU&lt;/li>
&lt;li>Cron&lt;/li>
&lt;li>External&lt;/li>
&lt;li>External Push&lt;/li>
&lt;li>Google Cloud Platformâ€ Pub/Sub&lt;/li>
&lt;li>Huawei Cloudeye&lt;/li>
&lt;li>IBM MQ&lt;/li>
&lt;li>Liiklus Topic&lt;/li>
&lt;li>Memory&lt;/li>
&lt;li>Metrics API&lt;/li>
&lt;li>MySQL&lt;/li>
&lt;li>NATS Streaming&lt;/li>
&lt;li>PostgreSQL&lt;/li>
&lt;li>Prometheus&lt;/li>
&lt;li>RabbitMQ Queue&lt;/li>
&lt;li>Redis Lists&lt;/li>
&lt;li>Redis Streams&lt;/li>
&lt;/ul></description></item><item><title>æºç åˆ†æï¼šKEDAæ˜¯å¦‚ä½•å·¥ä½œçš„?</title><link>/kubernetes-book/keda/source.html</link><pubDate>Wed, 04 Nov 2020 15:40:59 +0800</pubDate><guid>/kubernetes-book/keda/source.html</guid><description>
&lt;blockquote>
&lt;p>æ–‡ç« ä¸­æºç æ˜¯åŸºäºKEDA 2.0( &lt;a href="https://github.com/kedacore/keda/commit/50bec808f8b4656922797e4bcb7c2b61fabd6d0e" target="_blank" rel="noopener">50bec80&lt;/a>)æ¥è¿›è¡Œåˆ†æ&lt;/p>
&lt;p>keda 2.0 è¦æ±‚k8sé›†ç¾¤ç‰ˆæœ¬ &amp;gt;=1.16&lt;/p>
&lt;/blockquote>
&lt;p>KEDA åœ¨&lt;a href="https://keda.sh/blog/keda-2.0-release/" target="_blank" rel="noopener">2020å¹´11æœˆ4å·releaseäº†2.0ç‰ˆæœ¬&lt;/a>ï¼ŒåŒ…å«äº†ä¸€äº›æ–°çš„æ¯”è¾ƒæœ‰ç”¨çš„ç‰¹æ€§ï¼Œæ¯”å¦‚&lt;code>ScaledObject/ScaledJob&lt;/code>ä¸­æ”¯æŒå¤šè§¦å‘å™¨ã€æ”¯æŒHPAåŸå§‹çš„CPUã€Memory scalerç­‰ã€‚&lt;/p>
&lt;p>å…·ä½“çš„å®‰è£…ä½¿ç”¨è¯·å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« &lt;a href="./introduction.md" >ä½¿ç”¨kedaå®ŒæˆåŸºäºäº‹ä»¶çš„å¼¹æ€§ä¼¸ç¼©&lt;/a>ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ·±å…¥çš„çœ‹ä¸‹KEDAå†…éƒ¨æœºåˆ¶ä»¥åŠæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;p>&lt;strong>æˆ‘ä»¬å…ˆæå‡ºå‡ ä¸ªé—®é¢˜ï¼Œå¸¦ç€é—®é¢˜å»çœ‹ä»£ç ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç†è§£æ•´ä¸ªæœºåˆ¶ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>KEDAæ˜¯å¦‚ä½•è·å–åˆ°å¤šç§äº‹ä»¶çš„æŒ‡æ ‡ï¼Œä»¥åŠå¦‚ä½•åˆ¤æ–­æ‰©ç¼©å®¹çš„ï¼Ÿ&lt;/li>
&lt;li>KEDAæ˜¯å¦‚ä½•åšåˆ°å°†åº”ç”¨çš„å‰¯æœ¬æ•°ç¼©å®¹0ï¼Œä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/li>
&lt;/ul>
&lt;h2>ä»£ç ç»“æ„&lt;span class="hx-absolute -hx-mt-20" id="ä»£ç ç»“æ„">&lt;/span>
&lt;a href="#%e4%bb%a3%e7%a0%81%e7%bb%93%e6%9e%84" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å¯¹ä¸€äº›ä¸»è¦ç›®å½•è¯´æ˜ï¼Œå…¶ä»–ä¸€äº›MDæ–‡ä»¶ä¸»è¦æ˜¯æ–‡å­—è¯´æ˜ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>â”œâ”€â”€ BRANDING.md
â”œâ”€â”€ BUILD.md //å¦‚ä½•åœ¨æœ¬åœ°ç¼–è¯‘å’Œè¿è¡Œ
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ CONTRIBUTING.md //å¦‚ä½•å‚ä¸è´¡çŒ®æ¬¡é¡¹ç›®
â”œâ”€â”€ CREATE-NEW-SCALER.md
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Dockerfile.adapter
â”œâ”€â”€ GOVERNANCE.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ MAINTAINERS.md
â”œâ”€â”€ Makefile // æ„å»ºç¼–è¯‘ç›¸å…³å‘½ä»¤
â”œâ”€â”€ PROJECT
â”œâ”€â”€ README.md
â”œâ”€â”€ RELEASE-PROCESS.MD
â”œâ”€â”€ adapter // keda-metrics-apiserver ç»„ä»¶å…¥å£
â”œâ”€â”€ api // è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼Œä¾‹å¦‚ScaledObjectçš„å®šä¹‰
â”œâ”€â”€ bin
â”œâ”€â”€ config //ç»„ä»¶yamlèµ„æºï¼Œé€šè¿‡kustomizationå·¥å…·ç”Ÿæˆ
â”œâ”€â”€ controllers //kubebuilder ä¸­controller ä»£ç æ§åˆ¶crdèµ„æº
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ hack
â”œâ”€â”€ images
â”œâ”€â”€ main.go //keda-operator controllerå…¥å£
â”œâ”€â”€ pkg //åŒ…å«ç»„ä»¶æ ¸å¿ƒä»£ç å®ç°
â”œâ”€â”€ tests //e2eæµ‹è¯•
â”œâ”€â”€ tools
â”œâ”€â”€ vendor
â””â”€â”€ version&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>kedaä¸­ä¸»è¦æ˜¯ä¸¤ä¸ªç»„ä»¶&lt;code>keda-operator&lt;/code>ä»¥åŠ&lt;code>keda-metrics-apiserver&lt;/code>ã€‚&lt;/p>
&lt;ul>
&lt;li>keda-operator ï¼š è´Ÿè´£åˆ›å»º/æ›´æ–°HPAä»¥åŠé€šè¿‡Loopæ§åˆ¶åº”ç”¨å‰¯æœ¬æ•°&lt;/li>
&lt;li>keda-metrics-apiserverï¼šå®ç°external-metricsæ¥å£ï¼Œä»¥å¯¹æ¥ç»™HPAçš„externalç±»å‹çš„æŒ‡æ ‡æŸ¥è¯¢ï¼ˆæ¯”å¦‚å„ç§prometheusæŒ‡æ ‡ï¼Œmysqlç­‰ï¼‰&lt;/li>
&lt;/ul>
&lt;h2>keda-operator&lt;span class="hx-absolute -hx-mt-20" id="keda-operator">&lt;/span>
&lt;a href="#keda-operator" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>é¡¹ç›®ä¸­ç”¨åˆ°äº†&lt;a href="https://github.com/kubernetes-sigs/kubebuilder" target="_blank" rel="noopener">kubebuilder&lt;/a> SDKï¼Œç”¨æ¥å®Œæˆè¿™ä¸ªOperatorçš„ç¼–å†™ã€‚&lt;/p>
&lt;p>å¯¹äºk8sä¸­çš„è‡ªå®šä¹‰controllerä¸äº†è§£çš„å¯ä»¥çœ‹çœ‹è¿™è¾¹æ–‡ç« ï¼š&lt;a href="/blog/202005/custom-resources-and-controllers/" >å¦‚ä½•åœ¨Kubernetesä¸­åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰Controller?&lt;/a>ã€‚&lt;/p>
&lt;p>keda controllerçš„ä¸»è¦æµç¨‹ï¼Œç”»äº†å¹…å›¾ï¼š
&lt;img src="https://silenceper.oss-cn-beijing.aliyuncs.com/images/keda-controller-analyze.png" alt="keda-controller åˆ†ææµç¨‹" loading="lazy" />&lt;/p>
&lt;p>ç»„ä»¶å¯åŠ¨å…¥å£åœ¨äº&lt;code>main.go&lt;/code>æ–‡ä»¶ä¸­ï¼š&lt;/p>
&lt;p>é€šè¿‡&lt;code>controller-runtime&lt;/code>ç»„ä»¶å¯åŠ¨ä¸¤ä¸ªè‡ªå®šä¹‰controllerï¼š&lt;code>ScaledObjectReconciler&lt;/code>,&lt;code>ScaledJobReconciler&lt;/code>:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">mgr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewManager&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetConfigOrDie&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Scheme&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">scheme&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MetricsBindAddress&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metricsAddr&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">HealthProbeBindAddress&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;:8081&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Port&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">9443&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaderElection&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">enableLeaderElection&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaderElectionID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;operator.keda.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Add readiness probe &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddReadyzCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ready-ping&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">healthz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ping&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Add liveness probe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddHealthzCheck&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;health-ping&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">healthz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ping&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ³¨å†Œ ScaledObject å¤„ç†çš„controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">controllers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScaledObjectReconciler&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetClient&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Log&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;controllers&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">WithName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ScaledObject&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Scheme&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetScheme&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}).&lt;/span>&lt;span class="nf">SetupWithManager&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mgr&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setupLog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;unable to create controller&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;controller&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledObject&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">////æ³¨å†Œ ScaledJob å¤„ç†çš„controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">controllers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScaledJobReconciler&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetClient&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Log&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;controllers&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">WithName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ScaledJob&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Scheme&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetScheme&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}).&lt;/span>&lt;span class="nf">SetupWithManager&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mgr&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setupLog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;unable to create controller&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;controller&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledJob&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mgr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetupSignalHandler&lt;/span>&lt;span class="p">());&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">setupLog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;problem running manager&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>ScaledObjectReconciler å¤„ç†&lt;span class="hx-absolute -hx-mt-20" id="scaledobjectreconciler-å¤„ç†">&lt;/span>
&lt;a href="#scaledobjectreconciler-%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬ä¸»è¦å…³æ³¨&lt;a href="https://github.com/kedacore/keda/blob/main/controllers/scaledobject_controller.go#L100" target="_blank" rel="noopener">&lt;code>Reconcile&lt;/code>&lt;/a>æ–¹æ³•ï¼Œå½“&lt;code>ScaledObject&lt;/code>å‘ç”Ÿå˜åŒ–æ—¶å°†ä¼šè§¦å‘è¯¥æ–¹æ³•ï¼š
æ–¹æ³•å†…éƒ¨ä¸»è¦åŠŸèƒ½å®ç°ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¤„ç†åˆ é™¤ScaledObjectçš„æƒ…å†µ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetDeletionTimestamp&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿›å…¥åƒåœ¾å›æ”¶ï¼ˆæ¯”å¦‚åœæ­¢goroutineä¸­Loopï¼Œæ¢å¤åŸæœ‰å‰¯æœ¬æ•°ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">finalizeScaledObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç»™ScaledObjectèµ„æºåŠ ä¸ŠFinalizerï¼šfinalizer.keda.sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ensureFinalizer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// çœŸæ­£å¤„ç†ScaledObjectèµ„æº&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">reconcileScaledObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è®¾ç½®Statuså­—æ®µè¯´æ˜&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">conditions&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Status&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conditions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DeepCopy&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">conditions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetReadyCondition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConditionFalse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledObjectCheckFailed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">conditions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetActiveCondition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConditionUnknown&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;UnkownState&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledObject check failed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">conditions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetReadyCondition&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConditionTrue&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;ScaledObjectReady&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">msg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">kedacontrollerutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetStatusConditions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reqLogger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">conditions&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="nx">ctrl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>r.reconcileScaledObjectæ–¹æ³•ï¼š&lt;/strong>&lt;/p>
&lt;p>è¿™ä¸ªæ–¹æ³•ä¸­ä¸»è¦ä¸¤ä¸ªåŠ¨ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>ensureHPAForScaledObjectExists&lt;/code>åˆ›å»ºHPAèµ„æº&lt;/li>
&lt;li>è¿›å…¥&lt;code>requestScaleLoop&lt;/code>ï¼ˆä¸æ–­çš„æ£€æµ‹scaler æ˜¯å¦activeï¼Œè¿›è¡Œå‰¯æœ¬æ•°çš„ä¿®æ”¹ï¼‰&lt;/li>
&lt;/ul>
&lt;h4>ensureHPAForScaledObjectExists&lt;span class="hx-absolute -hx-mt-20" id="ensurehpaforscaledobjectexists">&lt;/span>
&lt;a href="#ensurehpaforscaledobjectexists" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>é€šè¿‡è·Ÿè¸ªè¿›å…¥åˆ°&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/controllers/hpa.go#L43" target="_blank" rel="noopener">newHPAForScaledObject&lt;/a>æ–¹æ³•:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">scaledObjectMetricSpecs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">getScaledObjectMetricSpecs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>&lt;span class="nx">çœç•¥ä»£ç &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">hpa&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">autoscalingv2beta2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscaler&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Spec&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">autoscalingv2beta2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HorizontalPodAutoscalerSpec&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MinReplicas&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">getHPAMinReplicas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MaxReplicas&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">getHPAMaxReplicas&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Metrics&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">scaledObjectMetricSpecs&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Behavior&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">behavior&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ScaleTargetRef&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">autoscalingv2beta2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CrossVersionObjectReference&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ScaleTargetRef&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Kind&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gvkr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Kind&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">APIVersion&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">gvkr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GroupVersion&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">getHPAName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Namespace&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Namespace&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Labels&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">labels&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">TypeMeta&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">APIVersion&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;v2beta2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥çœ‹åˆ°åˆ›å»ºScalerObjectå…¶å®æœ€ç»ˆä¹Ÿæ˜¯åˆ›å»ºäº†HPAï¼Œå…¶å®è¿˜æ˜¯é€šè¿‡HPAæœ¬èº«çš„ç‰¹æ€§æ¥æ§åˆ¶åº”ç”¨çš„å¼¹æ€§ä¼¸ç¼©ã€‚&lt;/p>
&lt;p>å…¶ä¸­&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/controllers/hpa.go#L135" target="_blank" rel="noopener">getScaledObjectMetricSpecs&lt;/a>æ–¹æ³•ä¸­å°±æ˜¯è·å–åˆ°&lt;code>triggers&lt;/code>ä¸­çš„metricsæŒ‡æ ‡ã€‚&lt;/p>
&lt;p>è¿™é‡Œæœ‰åŒºåˆ†ä¸€ä¸‹Externalçš„metricså’Œresource metricsï¼Œå› ä¸ºCPU/Memory scaleræ˜¯é€šè¿‡resource metrics æ¥è·å–çš„ã€‚&lt;/p>
&lt;h4>requestScaleLoop&lt;span class="hx-absolute -hx-mt-20" id="requestscaleloop">&lt;/span>
&lt;a href="#requestscaleloop" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/controllers/scaledobject_controller.go#L299" target="_blank" rel="noopener">requestScaleLoop&lt;/a>æ–¹æ³•ä¸­ç”¨æ¥å¾ªç¯check Scalerä¸­çš„IsActiveçŠ¶æ€å¹¶ä½œå‡ºå¯¹åº”çš„å¤„ç†ï¼Œæ¯”å¦‚ä¿®æ”¹å‰¯æœ¬æ•°ï¼Œç›´æ¥æ¥çœ‹æœ€ç»ˆçš„å¤„ç†å§ï¼š
è¿™é‡Œæœ‰ä¸¤ç§æ¨¡å‹æ¥è§¦å‘&lt;code>RequestScale&lt;/code>ï¼š&lt;/p>
&lt;ul>
&lt;li>Pullæ¨¡å‹ï¼šå³ä¸»åŠ¨çš„è°ƒç”¨scaler ä¸­çš„&lt;code>IsActive&lt;/code>æ–¹æ³•&lt;/li>
&lt;li>Pushæ¨¡å‹ï¼šç”±Scaleræ¥è§¦å‘ï¼Œ&lt;code>PushScaler&lt;/code>å¤šäº†ä¸€ä¸ªRunæ–¹æ³•ï¼Œé€šè¿‡channelä¼ å…¥activeçŠ¶æ€ã€‚&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>&lt;code>IsActive&lt;/code>æ˜¯ç”±Scalerå®ç°çš„ï¼Œæ¯”å¦‚å¯¹äºprometheusæ¥è¯´ï¼Œå¯èƒ½æŒ‡æ ‡ä¸º0åˆ™ä¸ºfalse&lt;/p>
&lt;/blockquote>
&lt;p>è¿™ä¸ªå…·ä½“çš„scalerå®ç°åç»­å†è®²ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹RequestScaleåšäº†ä»€ä¹ˆäº‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å½“å‰å‰¯æœ¬æ•°ä¸º0ï¼Œå¹¶æ˜¯æ‰€æœ‰scalerå±äºactiveçŠ¶æ€ï¼Œåˆ™ä¿®æ”¹å‰¯æœ¬æ•°ä¸ºMinReplicaCount æˆ– 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Replicas&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">isActive&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">scaleFromZero&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">isActive&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Replicas&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ‰€æœ‰scaleréƒ½å¤„ç†not activeçŠ¶æ€ï¼Œå¹¶ä¸”å½“å‰å‰¯æœ¬æ•°å¤§äº0ï¼Œä¸”MinReplicaCountè®¾å®šä¸º0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ™ç¼©å®¹å‰¯æœ¬æ•°ä¸º0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">scaleToZero&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">isActive&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Replicas&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ‰€æœ‰scaleréƒ½å¤„ç†not activeçŠ¶æ€ï¼Œå¹¶ä¸”å½“å‰å‰¯æœ¬æ•°å°äºMinReplicaCountï¼Œåˆ™ä¿®æ”¹ä¸ºMinReplicaCount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Replicas&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Spec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MinReplicaCount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">updateScaleOnScaleTarget&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">currentScale&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">isActive&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¤„ç†activeçŠ¶æ€ï¼Œå¹¶ä¸”å‰¯æœ¬æ•°å¤§äº0ï¼Œåˆ™æ›´æ–°LastActiveTime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">updateLastActiveTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">scaledObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸å¤„ç†&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ScaleTarget no change&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>ScaledJobReconciler å¤„ç†&lt;span class="hx-absolute -hx-mt-20" id="scaledjobreconciler-å¤„ç†">&lt;/span>
&lt;a href="#scaledjobreconciler-%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>&lt;code>ScaledJobReconciler&lt;/code>ç›¸æ¯”&lt;code>ScalerObject&lt;/code>å°‘äº†åˆ›å»ºHPAçš„æ­¥éª¤ï¼Œå…¶ä½™çš„æ­¥éª¤ä¸»è¦æ˜¯é€šè¿‡&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/pkg/scaling/scale_handler.go#L223" target="_blank" rel="noopener">checkScaledJobScalers&lt;/a>ï¼Œ&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/pkg/scaling/executor/scale_jobs.go#L24" target="_blank" rel="noopener">RequestJobScale&lt;/a>ä¸¤ä¸ªæ–¹æ³•æ¥åˆ¤æ–­Jobåˆ›å»ºï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>checkScaledJobScalers&lt;/code> æ–¹æ³•ï¼Œç”¨äºè®¡ç®—isActiveï¼ŒmaxValueçš„å€¼&lt;/li>
&lt;li>&lt;code>RequestJobScale&lt;/code> æ–¹æ³•ï¼Œç”¨äºè´Ÿè´£åˆ›å»ºJobï¼Œé‡Œé¢è¿˜æ¶‰åŠåˆ°ä¸‰ç§æ‰©å®¹ç­–ç•¥&lt;/li>
&lt;/ul>
&lt;p>è¿™é‡Œç›´æ¥çœ‹ä»£ç å§ï¼Œä¸è´´ä»£ç äº†ã€‚&lt;/p>
&lt;p>&lt;strong>å¦‚ä½•åœæ­¢Loop&lt;/strong>&lt;/p>
&lt;p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜å°±æ˜¯&lt;code>startPushScalers&lt;/code>å’Œ&lt;code>startScaleLoop&lt;/code>éƒ½æ˜¯åœ¨Goroutineä¸­å¤„ç†çš„ï¼Œæ‰€ä»¥å½“ScaleObject/ScalerJobè¢«åˆ é™¤çš„æ—¶å€™ï¼Œè¿™é‡Œéœ€è¦èƒ½å¤Ÿè¢«åˆ é™¤ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†&lt;code>context.Cancel&lt;/code>æ–¹æ³•ï¼Œåœ¨Goroutineå¯åŠ¨çš„æ—¶å€™å°±å°†ï¼Œcontextä¿å­˜åœ¨&lt;a href="https://github.com/kedacore/keda/blob/50bec808f8b4656922797e4bcb7c2b61fabd6d0e/pkg/scaling/scale_handler.go#L43" target="_blank" rel="noopener">scaleLoopContexts *sync.Map&lt;/a>ä¸­(å¦‚æœå·²ç»æœ‰äº†ï¼Œå°±å…ˆCancelä¸€æ¬¡)ï¼Œåœ¨åˆ é™¤èµ„æºçš„æ—¶å€™ï¼Œè¿›è¡Œåˆ é™¤:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">h&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">scaleHandler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">DeleteScalableObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scalableObject&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">withTriggers&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">asDuckWithTriggers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scalableObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;error duck typing object into withTrigger&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">key&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">generateKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">withTriggers&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">scaleLoopContexts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cancel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CancelFunc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">scaleLoopContexts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ScaleObject was not found in controller cache&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ps: è¿™é‡Œçš„å¦™å•Šï¼Œå­¦åˆ°äº†&lt;/p>
&lt;h2>keda-metrics-apiserver&lt;span class="hx-absolute -hx-mt-20" id="keda-metrics-apiserver">&lt;/span>
&lt;a href="#keda-metrics-apiserver" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>keda-metrics-apiserverå®ç°äº†&lt;code>ExternalMetricsProvider&lt;/code>æ¥å£ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ExternalMetricsProvider&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetExternalMetric&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">namespace&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSelector&lt;/span> &lt;span class="nx">labels&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Selector&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">info&lt;/span> &lt;span class="nx">ExternalMetricInfo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">external_metrics&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExternalMetricValueList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">ListAllExternalMetrics&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">ExternalMetricInfo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>GetExternalMetric ç”¨äºè¿”å›Scalerçš„æŒ‡æ ‡ï¼Œè°ƒç”¨&lt;code>scaler.GetMetrics&lt;/code>æ–¹æ³•&lt;/li>
&lt;li>ListAllExternalMetrics è¿”å›æ‰€æœ‰æ”¯æŒçš„external metricsï¼Œä¾‹å¦‚prometheusï¼Œmysqlç­‰&lt;/li>
&lt;/ul>
&lt;p>å½“ä»£ç å†™å¥½ä¹‹åï¼Œå†é€šè¿‡apiserviceæ³¨å†Œåˆ°apiservierä¸Š(å½“ç„¶è¿˜æ¶‰åŠåˆ°é‰´æƒï¼Œè¿™é‡Œä¸å•°å—¦äº†)ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
labels:
app.kubernetes.io/name: v1beta1.external.metrics.k8s.io
app.kubernetes.io/version: latest
app.kubernetes.io/part-of: keda-operator
name: v1beta1.external.metrics.k8s.io
spec:
service:
name: keda-metrics-apiserver
namespace: keda
group: external.metrics.k8s.io
version: v1beta1
insecureSkipTLSVerify: true
groupPriorityMinimum: 100
versionPriority: 100&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>å®ç°ä¸€ä¸ªScaler&lt;span class="hx-absolute -hx-mt-20" id="å®ç°ä¸€ä¸ªscaler">&lt;/span>
&lt;a href="#%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aascaler" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å…¶å®æœ‰ä¸¤ç§Scalerï¼Œå³ä¸Šé¢å°†çš„ä¸€ä¸ªpullï¼Œä¸€ä¸ªpushçš„æ¨¡å‹ï¼ŒPushScalerå¤šäº†ä¸€ä¸ªRunæ–¹æ³•ï¼š&lt;/p>
&lt;p>å®ç°ä¸€ä¸ªScalerï¼Œä¸»è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Scaler interface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Scaler&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è¿”å›external_metrics.ExternalMetricValueå¯¹è±¡ï¼Œå…¶å®å°±æ˜¯ç”¨äº keda-metrics-apiserverä¸­è·å–åˆ°scalerçš„æŒ‡æ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetMetrics&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">metricSelector&lt;/span> &lt;span class="nx">labels&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Selector&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="nx">external_metrics&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ExternalMetricValue&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è¿”å›v2beta2.MetricSpec ç»“æ„ï¼Œä¸»è¦ç”¨äºScalerObjectæè¿°åˆ›å»ºHPAçš„ç±»å‹å’ŒTargetæŒ‡æ ‡ç­‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetMetricSpecForScaling&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">v2beta2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MetricSpec&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è¿”å›è¯¥Scaleræ˜¯å¦Activeï¼Œå¯èƒ½ä¼šå½±å“Loopä¸­ç›´æ¥ä¿®æ”¹å‰¯æœ¬æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">IsActive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è°ƒç”¨å®Œä¸€æ¬¡ä¸Šé¢çš„æ–¹æ³•å°±ä¼šè°ƒç”¨ä¸€æ¬¡Close &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// PushScaler interface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">PushScaler&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Scaler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€šè¿‡scalerå®ç°Runæ–¹æ³•ï¼Œå¾€active channelä¸­ï¼Œå†™å…¥å€¼ï¼Œè€Œéä¸Šé¢çš„ç›´æ¥è°ƒç”¨IsActiveæ”¾å›&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">active&lt;/span> &lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å›è¿‡å¤´æ¥æˆ‘ä»¬è§£ç­”ä¸‹åœ¨å¼€å¤´ç•™ä¸‹çš„é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>KEDAæ˜¯å¦‚ä½•è·å–åˆ°å¤šç§äº‹ä»¶çš„æŒ‡æ ‡ï¼Œä»¥åŠå¦‚ä½•åˆ¤æ–­æ‰©ç¼©å®¹çš„ï¼Ÿ&lt;/p>
&lt;p>ç­”ï¼škeda controlerä¸­ç”Ÿæˆäº†external ç±»å‹çš„hpaï¼Œå¹¶ä¸”å®ç°äº†external metrics çš„api&lt;/p>
&lt;/li>
&lt;li>
&lt;p>KEDAæ˜¯å¦‚ä½•åšåˆ°å°†åº”ç”¨çš„å‰¯æœ¬æ•°ç¼©å®¹0ï¼Œä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;p>ç­”ï¼š keda å†…éƒ¨æœ‰ä¸ªloopï¼Œä¸æ–­çš„check isActiveçŠ¶æ€ï¼Œä¼šä¸»åŠ¨çš„ä¿®æ”¹åº”ç”¨å‰¯æœ¬&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>ä½¿ç”¨kedaå®ŒæˆåŸºäºäº‹ä»¶çš„å¼¹æ€§ä¼¸ç¼©</title><link>/blog/202009/how-to-use-keda/</link><pubDate>Mon, 14 Sep 2020 11:20:59 +0800</pubDate><guid>/blog/202009/how-to-use-keda/</guid><description>
&lt;blockquote>
&lt;p>æ–‡ç« ä¸­ä½¿ç”¨çš„æ˜¯keda 1.5ç‰ˆæœ¬ï¼Œ2.0è¿˜æœªrelease
1.5ç‰ˆæœ¬æ”¯æŒdeploymentï¼Œjobä¸¤ç§èµ„æºã€‚è€Œåœ¨2.0å¢åŠ äº†StatefulSetä»¥åŠè‡ªå®šä¹‰èµ„æº&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://keda.sh/" target="_blank" rel="noopener">keda&lt;/a> æ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§äº‹ä»¶æºæ¥å¯¹åº”ç”¨è¿›è¡Œå¼¹æ€§ä¼¸ç¼©çš„æ§åˆ¶å™¨ã€‚
æˆ‘è§‰å¾—kedaå¯ä»¥è®¤ä¸ºæ˜¯åŸºäºHPAçš„external metricsçš„ä¸€ç§æ‰©å±•ï¼Œå› ä¸ºå®ƒåˆ©ç”¨äº†hpaä¸­external metricsçš„èƒ½åŠ›ï¼Œå…è®¸ç›´æ¥é…ç½®å¤šä¸ªäº‹ä»¶æºï¼š
&lt;img src="/img/20200914/keda-scalers.png" alt="æ”¯æŒçš„äº‹ä»¶æº" loading="lazy" />&lt;/p>
&lt;h1>å®‰è£…keda&lt;/h1>&lt;p>ä» &lt;a href="https://github.com/kedacore/keda/releases" target="_blank" rel="noopener">https://github.com/kedacore/keda/releases&lt;/a> ä¸‹è½½1.5ç‰ˆæœ¬çš„zipåŒ…ï¼ŒåŒ…å«äº†yamlå’Œcrd:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>â”œâ”€â”€ 00-namespace.yaml
â”œâ”€â”€ 01-service_account.yaml
â”œâ”€â”€ 10-cluster_role.yaml
â”œâ”€â”€ 11-role_binding.yaml
â”œâ”€â”€ 12-operator.yaml
â”œâ”€â”€ 20-metrics-cluster_role.yaml
â”œâ”€â”€ 21-metrics-role_binding.yaml
â”œâ”€â”€ 22-metrics-deployment.yaml
â”œâ”€â”€ 23-metrics-service.yaml
â”œâ”€â”€ 24-metrics-api_service.yaml
â””â”€â”€ crds
â”œâ”€â”€ keda.k8s.io_scaledobjects_crd.yaml
â””â”€â”€ keda.k8s.io_triggerauthentications_crd.yaml&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å®‰è£…ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>kubectl apply -f ./crds/
kubectl apply -f .&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä»¥prometheus å’Œcronä¸¤ä¸ªäº‹ä»¶æºçœ‹ä¸‹å¦‚ä½•ä½¿ç”¨&lt;/p>
&lt;h2>é…ç½® ScaledObject&lt;span class="hx-absolute -hx-mt-20" id="é…ç½®-scaledobject">&lt;/span>
&lt;a href="#%e9%85%8d%e7%bd%ae-scaledobject" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ä»¥Deploymentä¸ºä¾‹ï¼Œçœ‹ä¸‹ScaledObjectæ”¯æŒå“ªäº›å˜é‡&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>apiVersion: keda.k8s.io/v1alpha1
kind: ScaledObject
metadata:
name: {scaled-object-name}
spec:
scaleTargetRef:
deploymentName: {deployment-name} # must be in the same namespace as the ScaledObject
containerName: {container-name} #Optional. Default: deployment.spec.template.spec.containers[0]
pollingInterval: 30 # Optional. Default: 30 seconds
cooldownPeriod: 300 # Optional. Default: 300 seconds
minReplicaCount: 0 # Optional. Default: 0
maxReplicaCount: 100 # Optional. Default: 100
triggers:
# {list of triggers to activate the deployment}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åŸºäºprometheusæŒ‡æ ‡è¿›è¡Œä¼¸ç¼©&lt;span class="hx-absolute -hx-mt-20" id="åŸºäºprometheusæŒ‡æ ‡è¿›è¡Œä¼¸ç¼©">&lt;/span>
&lt;a href="#%e5%9f%ba%e4%ba%8eprometheus%e6%8c%87%e6%a0%87%e8%bf%9b%e8%a1%8c%e4%bc%b8%e7%bc%a9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æˆ‘è¿™é‡Œæœ‰ä¸ª&lt;a href="https://github.com/silenceper/http-demo" target="_blank" rel="noopener">http demo&lt;/a>çš„åº”ç”¨ï¼Œä¸ŠæŠ¥äº†&lt;code>gin_requests_total&lt;/code>æŒ‡æ ‡åˆ°prometheusï¼Œé€šè¿‡abè¯·æ±‚httpæ¥å£æ¨¡æ‹Ÿå‹åŠ›ä¸Šå‡çš„æƒ…å†µï¼š&lt;/p>
&lt;p>è¿™é‡Œæˆ‘å°†&lt;code>minReplicaCount&lt;/code>è®¾ç½®ä¸º2ï¼Œå› ä¸ºåœ¨æ²¡æœ‰æµé‡çš„æ—¶å€™å‰¯æœ¬æ•°å°†ä¼šè¢«kedaè®¾ç½®ä¸º0ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>apiVersion: keda.k8s.io/v1alpha1
kind: ScaledObject
metadata:
name: prometheus-scaledobject
namespace: default
spec:
scaleTargetRef:
deploymentName: http-demo
minReplicaCount: 2
triggers:
- type: prometheus
metadata:
serverAddress: http://192.168.99.100:31046/
metricName: gin_requests_total
threshold: &amp;#39;2&amp;#39;
query: sum(rate(gin_requests_total{app=&amp;#34;http-demo&amp;#34;,code=&amp;#34;200&amp;#34;}[2m]))&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å½“åˆ›å»ºè¯¥&lt;code>ScaledObject &lt;/code>ï¼Œæˆ‘ä»¬çœ‹åˆ°åŒæ—¶åˆ›å»ºäº†ä¸€ä¸ªhpaèµ„æºï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>âœ example kubectl get hpa
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
keda-hpa-http-demo Deployment/http-demo 0/2 (avg) 2 100 2 70m&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>é€šè¿‡å‹æµ‹è§‚å¯Ÿhpaèµ„æºå˜åŒ–ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;gt; ab -c 10 -n 1000 http://127.0.0.1:8080/&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>Every 1.0s: kubectl get hpa anymore.local: Mon Sep 14 14:23:59 2020
NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE
keda-hpa-http-demo Deployment/http-demo 8/2 (avg) 2 100 4 73m&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥çœ‹å¾—åˆ°éšç€æµé‡ä¸Šå‡ï¼Œç”±hpaæ§åˆ¶çš„å‰¯æœ¬æ•°åœ¨ä¸Šå‡ï¼Œè¿™å°±è¾¾åˆ°äº†æˆ‘ä»¬æ ¹æ®æµé‡æ‰©å®¹çš„ç›®çš„ï¼Œå½“æµé‡é™ä¸‹æ¥ä¹‹åï¼Œå‰¯æœ¬æ•°ä¹Ÿå‡å°‘ã€‚&lt;/p>
&lt;h1>ç»„ä»¶ç»„æˆ&lt;/h1>&lt;p>kedaç”±ä¸¤ä¸ªç»„ä»¶ç»„æˆï¼š&lt;/p>
&lt;ul>
&lt;li>keda operatorï¼š è´Ÿè´£åˆ›å»ºç»´æŠ¤hpaå¯¹è±¡èµ„æºï¼ŒåŒæ—¶æ¿€æ´»å’Œåœæ­¢hpaä¼¸ç¼©ã€‚åœ¨æ— äº‹ä»¶çš„æ—¶å€™å°†å‰¯æœ¬æ•°é™ä½ä¸º0(å¦‚æœæœªè®¾ç½®minReplicaCountçš„è¯)&lt;/li>
&lt;li>metrics server: å®ç°äº†hpaä¸­external metricsï¼Œæ ¹æ®äº‹ä»¶æºé…ç½®è¿”å›è®¡ç®—ç»“æœã€‚
&lt;img src="/img/20200914/keda-arch.png" alt="kedaæ¶æ„å›¾" loading="lazy" />&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥çœ‹å¾—åˆ°HPAæ§åˆ¶äº†å‰¯æœ¬1-&amp;gt;Nå’ŒN-&amp;gt;1çš„å˜åŒ–ã€‚
kedaæ§åˆ¶äº†å‰¯æœ¬0-&amp;gt;1å’Œ1-&amp;gt;0çš„å˜åŒ–ï¼ˆèµ·åˆ°äº†æ¿€æ´»å’Œåœæ­¢çš„ä½œç”¨ï¼Œå¯¹äºä¸€äº›æ¶ˆè´¹å‹çš„ä»»åŠ¡å‰¯æœ¬æ¯”è¾ƒæœ‰ç”¨ï¼Œæ¯”å¦‚åœ¨å‡Œæ™¨å¯åŠ¨ä»»åŠ¡è¿›è¡Œæ¶ˆè´¹ï¼‰&lt;/p>
&lt;h1>æ‰©å±•äº‹ä»¶æº(external-scalers)&lt;/h1>&lt;p>å¯¹äºåœ¨kedaä¸æ”¯æŒçš„ä¸€äº›äº‹ä»¶æºï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨kedaæä¾›çš„æ‰©å±•æœºåˆ¶æ¥æ‰©å……è‡ªå·±çš„äº‹ä»¶æºã€‚
&lt;a href="https://keda.sh/docs/1.5/concepts/external-scalers/" target="_blank" rel="noopener">https://keda.sh/docs/1.5/concepts/external-scalers/&lt;/a>
ä¸»è¦æ˜¯é€šè¿‡grpcå®ç°ä¸€ä¸‹æ¥å£å®ç°ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>type Scaler interface {
GetMetrics(ctx context.Context, metricName string, metricSelector labels.Selector) ([]external_metrics.ExternalMetricValue, error)
GetMetricSpecForScaling() []v2beta2.MetricSpec
IsActive(ctx context.Context) (bool, error)
Close() error
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>IsActive åœ¨ScaledObject / ScaledJob CRDä¸­å®šä¹‰çš„pollingIntervalä¸Šï¼Œæ¯éš”pollingIntervalæ—¶é—´ï¼Œè°ƒç”¨IsActiveï¼Œå¦‚æœè¿”å›trueï¼Œåˆ™å°†æ¯”ä¾‹ç¼©æ”¾ä¸º1(é»˜è®¤1)&lt;/li>
&lt;li>Closeè°ƒç”¨Closeå¯ä»¥ä½¿ç¼©æ”¾å™¨æ¸…é™¤è¿æ¥æˆ–å…¶ä»–èµ„æºã€‚&lt;/li>
&lt;li>GetMetricSpec è¿”å›ç¼©æ”¾å™¨çš„HPAå®šä¹‰çš„ç›®æ ‡å€¼ã€‚&lt;/li>
&lt;li>GetMetrics è¿”å›ä»GetMetricSpecå¼•ç”¨çš„æŒ‡æ ‡çš„å€¼ã€‚&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>åœ¨2.0ä¸­è¿˜å¤šæ”¯æŒä¸€ç§&lt;code>PushScaler&lt;/code>å½¢å¼çš„æ‰©å±•ï¼Œå…è®¸ç”¨æˆ·ä¸»åŠ¨pushæ¥æ˜¯å¦å¼€å¯/åœæ­¢åŸºäºäº‹ä»¶ä¼¸ç¼©&lt;/p>
&lt;/blockquote>
&lt;h1>æ€»ç»“&lt;/h1>&lt;p>ä¹‹å‰ç”¨è¿‡k8s-prometheus-adapteré¡¹ç›®æ¥è¿›è¡Œåº”ç”¨çš„è‡ªå®šä¹‰æŒ‡æ ‡è¿›è¡Œæ‰©å±•ï¼Œå¯¹æ¯”kedaæ„Ÿè§‰kedaæ“ä½œæ›´ç®€å•ï¼Œé…ç½®æ›´åŠ åŠ¨æ€åŒ–ï¼Œå› ä¸ºæŠ½è±¡äº†hpaï¼Œç”¨æˆ·ç›´æ¥æ“ä½œ&lt;code>ScaledObject&lt;/code>å³å¯ï¼Œä¸éœ€è¦å…³æ³¨hpaå¦‚ä½•è¿›è¡Œé…ç½®ã€‚è€Œä¸”æ”¯æŒå°†å‰¯æœ¬æ•°è®¾ç½®ä¸º0ï¼ŒåŒæ—¶åˆæ‹¥æœ‰ç±»ä¼¼cronhpa(å®šæ—¶ä¼¸ç¼©)çš„åŠŸèƒ½ï¼Œæ‰©å±•èƒ½åŠ›æ¯”è¾ƒå¼ºã€‚&lt;/p>
&lt;blockquote>
&lt;p>é˜…è¯»åŸæ–‡ä½“éªŒæ›´åŠ ï¼Œæ–‡ä¸­é“¾æ¥æ”¯æŒè·³è½¬&lt;/p>
&lt;/blockquote></description></item><item><title>å°†é•œåƒtaråŒ…é€šè¿‡APIç›´æ¥pushåˆ°registryä»“åº“</title><link>/blog/202007/docker-tar-push/</link><pubDate>Fri, 10 Jul 2020 14:20:59 +0800</pubDate><guid>/blog/202007/docker-tar-push/</guid><description>
&lt;p>ä¸ºäº†å®ç°docker taråŒ…èƒ½å¤Ÿç›´æ¥é€šè¿‡é¡µé¢ä¸Šä¼ ï¼Œè°ƒç ”äº†ä¸€ä¸‹registryçš„apiï¼Œä»¥åŠå¦‚ä½•è§£ætaråŒ…ï¼ˆå…¶å®å°±æ˜¯docker daemonç¨‹åºå®ç°çš„éƒ¨åˆ†ï¼‰ã€‚&lt;/p>
&lt;p>è¦æƒ³å®ç°ï¼Œé¦–å…ˆè¦äº†è§£docker taråŒ…ä¸­ç»“æ„ç»„æˆï¼š&lt;/p>
&lt;h2>taråŒ…ç»“æ„&lt;span class="hx-absolute -hx-mt-20" id="taråŒ…ç»“æ„">&lt;/span>
&lt;a href="#tar%e5%8c%85%e7%bb%93%e6%9e%84" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æ‹¿äº†ä¸€ä¸ªåŒ…å«ä¸€ä¸ªé•œåƒçš„taråŒ…è¿›è¡Œè§£å‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>.
â”œâ”€â”€ 1ecf8bc84a7c3d60c0a6bbdd294f12a6b0e17a8269616fc9bdbedd926f74f50c
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ 6f4ec1f3d7ea33646d491a705f94442f5a706e9ac9acbca22fa9b117094eb720.json
â”œâ”€â”€ aaac5bde2c2bcb6cc28b1e6d3f29fe13efce6d6b669300cc2c6bfab96b942af4
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ b63363f0d2ac8b3dca6f903bb5a7301bf497b1e5be8dc4f57a14e4dc649ef9bb
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ c453224a84b8318b0a09a83052314dd876899d3a1a1cf2379e74bba410415059
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ dd8ef1d42fbcccc87927eee94e57519c401b84437b98fcf35505fb6b7267a375
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ manifest.json
â””â”€â”€ repositories&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ–‡ä»¶è¯´æ˜ï¼š&lt;/p>
&lt;p>&lt;strong>manifest.jsonæ–‡ä»¶&lt;/strong>ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[
{
&amp;#34;Config&amp;#34;:&amp;#34;6f4ec1f3d7ea33646d491a705f94442f5a706e9ac9acbca22fa9b117094eb720.json&amp;#34;,
&amp;#34;RepoTags&amp;#34;:[
&amp;#34;alpine:filebeat-6.8.7-arm64&amp;#34;
],
&amp;#34;Layers&amp;#34;:[
&amp;#34;aaac5bde2c2bcb6cc28b1e6d3f29fe13efce6d6b669300cc2c6bfab96b942af4/layer.tar&amp;#34;,
&amp;#34;dd8ef1d42fbcccc87927eee94e57519c401b84437b98fcf35505fb6b7267a375/layer.tar&amp;#34;,
&amp;#34;c453224a84b8318b0a09a83052314dd876899d3a1a1cf2379e74bba410415059/layer.tar&amp;#34;,
&amp;#34;b63363f0d2ac8b3dca6f903bb5a7301bf497b1e5be8dc4f57a14e4dc649ef9bb/layer.tar&amp;#34;,
&amp;#34;1ecf8bc84a7c3d60c0a6bbdd294f12a6b0e17a8269616fc9bdbedd926f74f50c/layer.tar&amp;#34;
]
}
]&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>manifest.json åŒ…å«äº†å¯¹è¿™ä¸ªtaråŒ…çš„æè¿°ä¿¡æ¯ï¼Œæ¯”å¦‚image configæ–‡ä»¶åœ°å€ï¼Œtagsè¯´æ˜ï¼Œé•œåƒlayerä¿¡æ¯ï¼Œåœ¨è§£æçš„æ—¶å€™ä¹Ÿæ˜¯æ ¹æ®è¿™ä¸ªæ–‡ä»¶å»è·å–å…³è”çš„æ–‡ä»¶ã€‚&lt;/p>
&lt;p>&lt;strong>image configæ–‡ä»¶&lt;/strong>&lt;/p>
&lt;p>æ¯”å¦‚ï¼š&lt;code>6f4ec1f3d7ea33646d491a705f94442f5a706e9ac9acbca22fa9b117094eb720.json&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å†…å®¹å¤ªå¤šå°±ä¸è´´äº†
è¿™é‡ŒåŒ…å«äº†é•œåƒè¿è¡Œçš„ä¿¡æ¯ï¼Œæ¯”å¦‚envï¼Œæ‰§è¡Œå‚æ•°ï¼Œä»¥åŠé•œåƒå†å²ç­‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>layerå±‚æ–‡ä»¶ï¼šlayer.tar&lt;/strong>&lt;/p>
&lt;p>é•œåƒçš„æ¯ä¸€å±‚çš„æ–‡ä»¶ä¿¡æ¯éƒ½æ‰“åŒ…åœ¨äº†ä¸€ä¸ªå•ç‹¬çš„&lt;code>layer.tar&lt;/code>åŒ…ä¸­ï¼Œä¹Ÿæ˜¯åœ¨ä¸Šä¼ çš„æ—¶å€™éœ€è¦ç”¨åˆ°çš„ã€‚&lt;/p>
&lt;h2>registry api&lt;span class="hx-absolute -hx-mt-20" id="registry-api">&lt;/span>
&lt;a href="#registry-api" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;strong>æµç¨‹ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>1ã€è·å–é‰´æƒä¿¡æ¯&lt;/li>
&lt;li>2ã€æ£€æŸ¥layer.taræ˜¯å¦å·²ç»å­˜åœ¨&lt;/li>
&lt;li>3ã€ä¸Šä¼ layer.tar&lt;/li>
&lt;li>4ã€ä¸Šä¼ image config&lt;/li>
&lt;li>5ã€ä¸Šä¼ manifestï¼ˆéåŒ…ä¸­çš„&lt;code>manifest.json&lt;/code>è€Œæ˜¯&lt;a href="https://github.com/docker/distribution/blob/master/manifest/schema2/manifest.go#L63" target="_blank" rel="noopener">Manifest struct&lt;/a>ï¼‰&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>è¿™é‡Œåªåˆ—å‡ºäº†åœ¨ä¸Šä¼ çš„æ—¶å€™éœ€è¦ç”¨çš„api&lt;/p>
&lt;/blockquote>
&lt;p>1ã€è·å–é‰´æƒä¿¡æ¯&lt;/p>
&lt;p>è¿™é‡Œè·Ÿregistryä»“åº“é€‰æ‹©çš„é‰´æƒæ–¹å¼æœ‰å…³ï¼Œå¯é€‰basic authæˆ–è€…tokené‰´æƒã€‚
è¿™é‡Œæˆ‘æ˜¯ä»¥æœ€åŸºæœ¬çš„basic authä¸ºä¾‹å­ï¼Œå¦‚æœæ˜¯tokené‰´æƒçš„æ–¹å¼å‚è€ƒè¿™é‡Œï¼š
&lt;a href="https://docs.docker.com/registry/spec/auth/jwt/" target="_blank" rel="noopener">https://docs.docker.com/registry/spec/auth/jwt/&lt;/a>&lt;/p>
&lt;p>2ã€æ£€æŸ¥ä¸Šä¼ &lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>HEAD /v2/image/blobs/&amp;lt;digest&amp;gt;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è‹¥è¿”å›200 OK åˆ™è¡¨ç¤ºå­˜åœ¨ï¼Œä¸ç”¨ä¸Šä¼ &lt;/p>
&lt;p>3ã€å¼€å§‹ä¸Šä¼ æœåŠ¡
æˆ‘è¿™é‡Œæ˜¯ä»¥åˆ†å—ä¸Šä¼ çš„æ–¹å¼è¿›è¡Œ&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>POST /v2/image/blobs/uploads/&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¦‚æœpostè¯·æ±‚è¿”å›202 acceptedï¼Œä¸€ä¸ªurlä¼šåœ¨locationå­—æ®µè¿”å›.&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code> 202 Accepted
Location: /v2/\&amp;lt;image&amp;gt;/blobs/uploads/\&amp;lt;uuid&amp;gt;
Range: bytes=0-&amp;lt;offset&amp;gt;
Content-Length: 0
Docker-Upload-UUID: &amp;lt;uuid&amp;gt; # å¯ä»¥ç”¨æ¥æŸ¥çœ‹ä¸Šä¼ çŠ¶æ€å’Œå®ç°æ–­ç‚¹ç»­ä¼ &lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>4ã€åˆ†å—ä¸Šä¼ 
æ ¹æ®ä¸Šä¸€æ­¥è·å–çš„urlï¼Œä»¥&lt;code>PATCH&lt;/code>çš„æ–¹å¼æäº¤åˆ†å—æ•°æ®ã€‚
å¦‚æœæ˜¯æœ€åä¸€å—æ•°æ®ä¸Šä¼ ï¼Œåˆ™ä»¥PUTçš„æ–¹å¼æäº¤ï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code> &amp;gt; PUT /v2/&amp;lt;name&amp;gt;/blob/uploads/&amp;lt;uuid&amp;gt;?digest=&amp;lt;digest&amp;gt;
&amp;gt; Content-Length: &amp;lt;size of chunk&amp;gt;
&amp;gt; Content-Range: &amp;lt;start of range&amp;gt;-&amp;lt;end of range&amp;gt;
&amp;gt; Content-Type: application/octet-stream
&amp;lt;Last Layer Chunk Binary Data&amp;gt;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä¸Šä¼ layerï¼Œimage configï¼Œmanifestsä¿¡æ¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æˆ‘æš‚æ—¶åªç”¨åˆ°äº†ä»¥ä¸Šapiï¼Œæ›´å¤šçš„apiå‚è€ƒï¼šhttps://docs.docker.com/registry/spec/api/&lt;/p>
&lt;/blockquote>
&lt;h2>å®ç°&lt;span class="hx-absolute -hx-mt-20" id="å®ç°">&lt;/span>
&lt;a href="#%e5%ae%9e%e7%8e%b0" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ä¸Šé¢è¯´APIæ²¡å•¥æ„Ÿè§‰ï¼Œè¿˜æ˜¯çœ‹ä»£ç æ¯”è¾ƒæ˜ç™½ï¼Œæ‰€ä»¥å®ç°äº†è¿™ä¹ˆä¸€ä¸ªå·¥å…·ï¼š&lt;a href="https://github.com/silenceper/docker-tar-push" target="_blank" rel="noopener">https://github.com/silenceper/docker-tar-push
&lt;/a>&lt;/p>
&lt;p>&lt;strong>Usage:&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>push your docker tar archive image without docker.
Usage:
docker-tar-push [flags]
Flags:
-h, --help help for docker-tar-push
--log-level int log-level, 0:Fatal,1:Error,2:Warn,3:Info,4:Debug (default 3)
--password string registry auth password
--registry string registry url
--skip-ssl-verify skip ssl verify
--username string registry auth username&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>Example:&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>docker-tar-push alpine:latest --registry=http://localhost:5000&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>å‚è€ƒ&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.jianshu.com/p/6a7b80122602" target="_blank" rel="noopener">https://www.jianshu.com/p/6a7b80122602&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/Razikus/dockerregistrypusher" target="_blank" rel="noopener">https://github.com/Razikus/dockerregistrypusher&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.docker.com/registry/spec/auth/jwt/" target="_blank" rel="noopener">https://docs.docker.com/registry/spec/auth/jwt/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/docker/distribution/" target="_blank" rel="noopener">https://github.com/docker/distribution/&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>åœ¨x86_64æœºå™¨ä¸Šæ„å»ºarm64é•œåƒ</title><link>/blog/202006/build-arm-image-on-x86_84/</link><pubDate>Fri, 05 Jun 2020 14:20:59 +0800</pubDate><guid>/blog/202006/build-arm-image-on-x86_84/</guid><description>
&lt;p>æœ‰å‡ ç§åŠæ³•å¯ä»¥æ‰“åŒ…å‡ºarm64çš„é•œåƒ&lt;/p>
&lt;ul>
&lt;li>ç›´æ¥åœ¨armæœºå™¨ä¸Šæ‰§è¡Œç¼–è¯‘å’Œæ‰“åŒ…&lt;/li>
&lt;li>é€šè¿‡qemuæ¨¡æ‹Ÿarmç¯å¢ƒ&lt;/li>
&lt;li>åˆ©ç”¨dockeræä¾›çš„buildxï¼ˆéœ€è¦å¯ç”¨è¯•éªŒæ€§ç‰¹æ€§ï¼‰&lt;/li>
&lt;/ul>
&lt;p>æˆ‘æ²¡æœ‰armçš„æœºå™¨~ï¼Œæ‰€ä»¥æˆ‘ä¸»è¦è¯•äº†ä¸€ä¸‹ä¸‹é¢ä¸¤ç§æ–¹å¼ã€‚&lt;/p>
&lt;h3>å€ŸåŠ©qemu-user-staticé•œåƒæ‰“åŒ…&lt;span class="hx-absolute -hx-mt-20" id="å€ŸåŠ©qemu-user-staticé•œåƒæ‰“åŒ…">&lt;/span>
&lt;a href="#%e5%80%9f%e5%8a%a9qemu-user-static%e9%95%9c%e5%83%8f%e6%89%93%e5%8c%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æ–‡æ¡£ï¼šhttps://github.com/multiarch/qemu-user-static&lt;/p>
&lt;p>å¼€å¯armå¹³å°æ”¯æŒï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">$ docker run --rm --privileged multiarch/qemu-user-static:register --reset
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ docker build --rm -t &lt;span class="s2">&amp;#34;test/integration/ubuntu&amp;#34;&lt;/span> -&lt;span class="s">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">FROM multiarch/qemu-user-static:x86_64-aarch64 as qemu
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">FROM arm64v8/ubuntu
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">COPY --from=qemu /usr/bin/qemu-aarch64-static /usr/bin
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ docker run --rm -t &lt;span class="s2">&amp;#34;test/integration/ubuntu&amp;#34;&lt;/span> uname -m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">aarch64&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨è¿è¡Œ&lt;code>qemu-user-static:register&lt;/code>é•œåƒçš„æ—¶å€™ï¼Œå°±é€šè¿‡å†…æ ¸ä¸­çš„binfmt_miscæœºåˆ¶æ³¨å…¥äº†å“ªäº›å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥è¢«è¯†åˆ«ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼šéœ€è¦å°†&lt;code>qemu-aarch64-static&lt;/code>æ–‡ä»¶ copy åˆ°&lt;code>/usr/bin&lt;/code>ç›®å½•ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>binfmt_misc&lt;/code>æ˜¯Linuxå†…æ ¸è¯´æä¾›çš„ä¸€ç§æ‰©å±•æœºåˆ¶, ä½¿å¾—æ›´å¤šç±»å‹çš„æ–‡ä»¶å¾—ä»¥æˆä¸ºï¼‚å¯æ‰§è¡Œï¼‚æ–‡ä»¶ï¼Linuxå†…æ ¸æœ¬èº«æ”¯æŒELFã€a.outã€è„šæœ¬ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢æ‰€è¯´çš„ç¬¬ä¸€è¡Œ#!æŒ‡å®šè§£é‡Šå™¨çš„æ–¹å¼ï¼‰è¿™é›†ä¸­ï¼‚å¯æ‰§è¡Œæ–‡ä»¶ï¼‚ï¼ä½†å®ƒè¿˜æä¾›äº†ä¸€ä¸ªç§°ä¸º&lt;code>binfmt_misc&lt;/code>çš„å†…æ ¸æ¨¡å—, é€šè¿‡è¿™ä¸ªæ¨¡å—å¯ä»¥åŠ¨æ€æ³¨å†Œä¸€äº›ï¼‚å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼‚,æ³¨å†Œä¹‹åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ï¼‚æ‰§è¡Œï¼‚è¿™ä¸ªç¨‹åºæ–‡ä»¶äº†ï¼&lt;/p>
&lt;/blockquote>
&lt;h3>é€šè¿‡buildxæ‰“åŒ…æ”¯æŒå¤šæ¶æ„çš„é•œåƒ&lt;span class="hx-absolute -hx-mt-20" id="é€šè¿‡buildxæ‰“åŒ…æ”¯æŒå¤šæ¶æ„çš„é•œåƒ">&lt;/span>
&lt;a href="#%e9%80%9a%e8%bf%87buildx%e6%89%93%e5%8c%85%e6%94%af%e6%8c%81%e5%a4%9a%e6%9e%b6%e6%9e%84%e7%9a%84%e9%95%9c%e5%83%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æ–‡æ¡£ï¼š&lt;a href="https://docs.docker.com/buildx/working-with-buildx/" target="_blank" rel="noopener">https://docs.docker.com/buildx/working-with-buildx/&lt;/a>&lt;/p>
&lt;p>é¦–å…ˆéœ€è¦å¼€å¯è¿™ä¸ªå®éªŒæ€§çš„åŠŸèƒ½ï¼Œæ€ä¹ˆå¼€å¯çœ‹è¿™é‡Œï¼š&lt;a href="https://github.com/docker/cli/blob/master/experimental/README.md" target="_blank" rel="noopener">https://github.com/docker/cli/blob/master/experimental/README.md&lt;/a>&lt;/p>
&lt;ul>
&lt;li>docker cloent: åœ¨&lt;code>~/.docker/config.json åŠ å…¥``å†™å…¥&amp;quot;experimental&amp;quot;:&amp;quot;enabled&amp;quot;&lt;/code>&lt;/li>
&lt;li>dcoker daemon: å¯åŠ¨å‚æ•°ä¸ŠåŠ ä¸Š&amp;ndash;experimentalæˆ–è€…&lt;code>/etc/docker/daemon.json&lt;/code>å†™å…¥&lt;code> &amp;quot;experimental&amp;quot;: true&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>è¿›è¡Œåˆå§‹åŒ–ï¼š&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">docker buildx create --name builderx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker buildx use builderx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker buildx inspect --bootstrap &lt;span class="c1">#è¿™ä¸€æ­¥ä¼šä»å¤–ç½‘æ‹‰å–`moby/buildkit`é•œåƒï¼Œè²Œä¼¼è¿˜æ”¹ä¸äº†&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>æ¥ä¸‹æ¥ä½ å°±å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å»æ„å»ºå¤šç§æ¶æ„çš„é•œåƒï¼š&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">docker buildx build --platform linux/amd64,linux/arm64 -f Dockerfile -t silenceper/reverse-proxy . --push&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>--push&lt;/code>å‚æ•°è¡¨ç¤ºæ„å»ºå®Œæˆä¹‹åï¼Œå¹¶pushåˆ°é•œåƒä»“åº“å½“ä¸­ã€‚&lt;/p>
&lt;p>å› ä¸ºé•œåƒä»“åº“æ”¯æŒä¸€ä¸ªä»“åº“ä¸Šä¼ å¤šç§æ¶æ„ï¼Œå¹¶ä¸”ä¼šæ ¹æ®æ„å»ºå¹³å°pullç›¸åŒ¹é…æ¶æ„çš„é•œåƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªDockerfileï¼Œå¹¶ä¸”é€šè¿‡ä¸€ä¸ªå‘½ä»¤æ‰“åŒ…é•œåƒå¹¶pushã€‚&lt;/p>
&lt;p>è¿™é‡Œç”¨åˆ°çš„Dockerfileåœ¨è¿™é‡Œï¼š&lt;a href="https://github.com/silenceper/reverse-proxy/blob/master/Dockerfile" target="_blank" rel="noopener">https://github.com/silenceper/reverse-proxy/blob/master/Dockerfile&lt;/a>&lt;/p>
&lt;p>&lt;strong>é€šè¿‡dockerçš„å¤šé˜¶æ®µæ„å»ºå°†ç¼–è¯‘å’Œæ‰“åŒ…æ”¾åœ¨ä¸€èµ·äº†ï¼Œéš”ç¦»äº†ç¯å¢ƒçš„å·®å¼‚ã€‚&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">FROM&lt;/span> &lt;span class="nx">golang&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nx">alpine&lt;/span> &lt;span class="nx">as&lt;/span> &lt;span class="nx">builder&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">ADD&lt;/span> &lt;span class="p">.&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">go&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">src&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">silenceper&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">reverse&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">proxy&lt;/span>&lt;span class="o">/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">RUN&lt;/span> &lt;span class="nx">cd&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">go&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">src&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">silenceper&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">reverse&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">proxy&lt;/span>&lt;span class="o">/&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">go&lt;/span> &lt;span class="nx">get&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="nx">v&lt;/span> \
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">CGO_ENABLED&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="nx">GOOS&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nx">linux&lt;/span> &lt;span class="k">go&lt;/span> &lt;span class="nx">build&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="nx">installsuffix&lt;/span> &lt;span class="nx">cgo&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="nx">o&lt;/span> &lt;span class="nx">app&lt;/span> &lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">FROM&lt;/span> &lt;span class="nx">alpine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">MAINTAINER&lt;/span> &lt;span class="nx">silenceper&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nx">silenceper&lt;/span>&lt;span class="err">@&lt;/span>&lt;span class="nx">gmail&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">com&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">COPY&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="nx">from&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nx">builder&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">go&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">src&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">silenceper&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">reverse&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">proxy&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">app&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">app&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">ENTRYPOINT&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;/bin/app&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">EXPOSE&lt;/span> &lt;span class="mi">80&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æœ€æ–¹ä¾¿çš„è‚¯å®šæ˜¯ç›´æ¥é€šè¿‡buildxè¿›è¡Œæ‰“åŒ…å’Œç¼–è¯‘ï¼Œä½†æ˜¯æˆ‘çš„ç¯å¢ƒæ²¡æ³•è®¿é—®å¤–ç½‘ï¼Œåˆæ²¡æ³•æ‹‰å–å¤–ç½‘çš„é•œåƒï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©ä½¿ç”¨&lt;code>qemu-user-static&lt;/code>æ‰“åŒ…å‡ºæ¥äº†ã€‚&lt;/p>
&lt;h3>å‚è€ƒ&lt;span class="hx-absolute -hx-mt-20" id="å‚è€ƒ">&lt;/span>
&lt;a href="#%e5%8f%82%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>&lt;a href="https://blog.fleeto.us/post/buildx-and-osx/" target="_blank" rel="noopener">https://blog.fleeto.us/post/buildx-and-osx/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://juejin.im/post/5af86fb15188251b8015c102" target="_blank" rel="noopener">https://juejin.im/post/5af86fb15188251b8015c102&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cnblogs.com/bamanzi/p/run-x86-linux-progs-with-qemu-user-on-arm.html" target="_blank" rel="noopener">https://www.cnblogs.com/bamanzi/p/run-x86-linux-progs-with-qemu-user-on-arm.html&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>å¦‚ä½•åœ¨Kubernetesä¸­åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰Controller?</title><link>/blog/202005/custom-resources-and-controllers/</link><pubDate>Mon, 18 May 2020 18:20:59 +0800</pubDate><guid>/blog/202005/custom-resources-and-controllers/</guid><description>
&lt;h2>ç›®çš„&lt;span class="hx-absolute -hx-mt-20" id="ç›®çš„">&lt;/span>
&lt;a href="#%e7%9b%ae%e7%9a%84" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Custom Resourceæ˜¯æ‰©å±•Kubernetesçš„ä¸€ç§æ–¹å¼ï¼ˆå¦å¤–ä¸€ç§å°±æ˜¯é€šè¿‡èšåˆå±‚API apiserver-aggregationï¼‰ï¼Œè€Œcontrollerå¯¹æŒ‡å®šçš„resourceè¿›è¡Œç›‘å¬å’Œæ‰§è¡Œå¯¹åº”çš„åŠ¨ä½œ(watch,diff,action)ã€‚&lt;br />
&lt;br />&lt;strong>Operatorä¸ControlleråŒºåˆ«&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>æ‰€æœ‰çš„Operatoréƒ½æ˜¯ç”¨äº†Controlleræ¨¡å¼ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰Controlleréƒ½æ˜¯Operatorã€‚åªæœ‰å½“å®ƒæ»¡è¶³: controlleræ¨¡å¼ + APIæ‰©å±• + ä¸“æ³¨äºæŸä¸ªApp/ä¸­é—´ä»¶æ—¶ï¼Œæ‰æ˜¯ä¸€ä¸ªOperatorã€‚&lt;/li>
&lt;li>Operatorå°±æ˜¯ä½¿ç”¨CRDå®ç°çš„å®šåˆ¶åŒ–çš„Controller. å®ƒä¸å†…ç½®K8S Controlleréµå¾ªåŒæ ·çš„è¿è¡Œæ¨¡å¼(æ¯”å¦‚ watch, diff, action)&lt;/li>
&lt;li>Operatoræ˜¯ç‰¹å®šé¢†åŸŸçš„Controllerå®ç°&lt;/li>
&lt;/ul>
&lt;p>è®¨è®ºä¸¤è€…åŒºåˆ«ï¼š&lt;a href="https://github.com/kubeflow/tf-operator/issues/300" target="_blank" rel="noopener">https://github.com/kubeflow/tf-operator/issues/300&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>æ‰€ä»¥å…ˆå­¦ä¹ å¦‚ä½•æ„å»ºå‡ºä¸€äº›è‡ªå®šä¹‰çš„Controllerè‚¯å®šæ˜¯ä¹‹åå®ç°Operatorçš„åŸºç¡€ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„Controllerç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šCRDå’ŒControlleré€»è¾‘ä»£ç &lt;br />è¿™é‡Œä»¥sample-controllerçš„ä»£ç ä¸ºä¾‹ï¼ŒåŒæ—¶æˆ‘ä»¬è‡ªå·±å†™çš„Controllerä¹Ÿå¯ä»¥å‚è€ƒè¿™ä¸ªä»£ç ç»“æ„ã€‚
&lt;a name="duygD">&lt;/a>&lt;/p>
&lt;h2>CRDèµ„æºå®šä¹‰&lt;span class="hx-absolute -hx-mt-20" id="crdèµ„æºå®šä¹‰">&lt;/span>
&lt;a href="#crd%e8%b5%84%e6%ba%90%e5%ae%9a%e4%b9%89" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ä»¥sample-controlerä¸­çš„ä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºçš„ä¸€ä¸ª &lt;code>Foo&lt;/code>Â å¦‚ä¸‹&lt;a href="https://github.com/kubernetes/sample-controller/blob/master/artifacts/examples/example-foo.yaml" target="_blank" rel="noopener">example-foo.yaml&lt;/a>ï¼š&lt;br />åˆ›å»ºè¯¥ &lt;code>Foo&lt;/code>Â è‡ªå®šä¹‰èµ„æºåï¼ŒæœŸæœ›åˆ›å»ºå‡ºä¸€ä¸ªåç§°ä¸º &lt;code>example-foo&lt;/code>Â ï¼Œå‰¯æœ¬æ•°ä¸º &lt;code>1&lt;/code>Â çš„deploymentã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">samplecontroller.k8s.io/v1alpha1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Foo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example-foo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">deploymentName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example-foo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å®ƒçš„CRDå®šä¹‰å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apiextensions.k8s.io/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">CustomResourceDefinition&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">foos.samplecontroller.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">samplecontroller.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1alpha1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c">#ç‰ˆæœ¬&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">names&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Foo&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># kindç±»å‹&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">plural&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">foos&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># APIä¸­ä½¿ç”¨çš„åç§°ï¼š/apis/&amp;lt;group&amp;gt;/&amp;lt;version&amp;gt;/&amp;lt;plural&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">scope&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Namespaced&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Namespaced/Clusterï¼Œè¡¨ç¤ºè¯¥CRDæ˜¯å‘½ä»¤ç©ºé—´å±æ€§è¿˜æ˜¯é›†ç¾¤å±æ€§&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">validation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># å¯¹å‚æ•°è¿›è¡ŒéªŒè¯ï¼Œåº”ç”¨openAPIV3Schemaè§„åˆ™&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">openAPIV3Schema&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># å®šä¹‰äº†ä¸€ä¸ª replicas å­—æ®µï¼Œç±»å‹ä¸ºinteger ï¼Œå¹¶ä¸”åœ¨1-10çš„èŒƒå›´å†…&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">integer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">minimum&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">maximum&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">10&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ›´å¤šå…³äºcrdå®šä¹‰è§„åˆ™å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š&lt;br />&lt;a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/&lt;/a>&lt;br />
&lt;br />å½“æŠŠè¿™ä¸ªcrdèµ„æºapplyåˆ°é›†ç¾¤ä¸­åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>kubectl get apiservice v1alpha1.samplecontroller.k8s.io -o yaml&lt;/code>Â å‘½ä»¤çœ‹åˆ°æ³¨å†Œè¿™ä¸ª &lt;code>apiservice&lt;/code>Â &lt;br />&lt;/p>
&lt;p>&lt;a name="h4Pwy">&lt;/a>&lt;/p>
&lt;h2>ä»£ç ç¼–å†™&lt;span class="hx-absolute -hx-mt-20" id="ä»£ç ç¼–å†™">&lt;/span>
&lt;a href="#%e4%bb%a3%e7%a0%81%e7%bc%96%e5%86%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åªéœ€è¦å°†æˆ‘ä»¬ &lt;code>Foo&lt;/code>Â resourceç›¸å…³çš„structï¼Œå…¶ä½™çš„ç±»ä¼¼è‡ªå®šä¹‰èµ„æºçš„ &lt;code>informers&lt;/code>Â , &lt;code>listers&lt;/code>Â , &lt;code>clientset&lt;/code>Â ä»¥åŠ &lt;code>deepcopy&lt;/code>Â çš„ä»£ç éƒ½å¯ä»¥é€šè¿‡å·¥å…·&lt;a href="https://github.com/kubernetes/code-generator" target="_blank" rel="noopener">code-generator&lt;/a>è‡ªåŠ¨ç”Ÿæˆã€‚&lt;br />ä»¥åŠç¼–å†™æˆ‘ä»¬è‡ªå®šä¹‰Controllerçš„ä¸šåŠ¡é€»è¾‘ä»£ç å°±å¥½äº†
&lt;a name="c9VL7">&lt;/a>&lt;/p>
&lt;h3>structèµ„æºå®šä¹‰&lt;span class="hx-absolute -hx-mt-20" id="structèµ„æºå®šä¹‰">&lt;/span>
&lt;a href="#struct%e8%b5%84%e6%ba%90%e5%ae%9a%e4%b9%89" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>&lt;a href="https://github.com/kubernetes/sample-controller/blob/master/pkg/apis/samplecontroller/v1alpha1/types.go" target="_blank" rel="noopener">type.go&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">v1alpha1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span> &lt;span class="s">&amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +genclient &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Foo is a specification for a Foo resource&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Foo&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span> &lt;span class="s">`json:&amp;#34;,inline&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span> &lt;span class="s">`json:&amp;#34;metadata,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Spec&lt;/span> &lt;span class="nx">FooSpec&lt;/span> &lt;span class="s">`json:&amp;#34;spec&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Status&lt;/span> &lt;span class="nx">FooStatus&lt;/span> &lt;span class="s">`json:&amp;#34;status&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// FooSpec is the spec for a Foo resource&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// FooSpec å®šä¹‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">FooSpec&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">DeploymentName&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;deploymentName&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Replicas&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int32&lt;/span> &lt;span class="s">`json:&amp;#34;replicas&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// FooStatus is the status for a Foo resource&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">FooStatus&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AvailableReplicas&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="s">`json:&amp;#34;availableReplicas&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// FooList is a list of Foo resources&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">FooList&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TypeMeta&lt;/span> &lt;span class="s">`json:&amp;#34;,inline&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListMeta&lt;/span> &lt;span class="s">`json:&amp;#34;metadata&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Items&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Foo&lt;/span> &lt;span class="s">`json:&amp;#34;items&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­ç±»ä¼¼ &lt;code>+k8s:&lt;/code>Â çš„æ³¨é‡Šæ˜¯ä»£ç ç”Ÿæˆæ¥è¯†åˆ«çš„ã€‚&lt;br />
&lt;br />&lt;a href="https://github.com/kubernetes/sample-controller/blob/master/pkg/apis/samplecontroller/v1alpha1/register.go" target="_blank" rel="noopener">register.go&lt;/a>Â ä¸­å°† &lt;code>Foo&lt;/code>Â , &lt;code>FooList&lt;/code>Â æ³¨å†Œè¿›å…¥ &lt;code>scheme&lt;/code>Â ä¸­ã€‚
&lt;a name="BQ8w2">&lt;/a>&lt;/p>
&lt;h3>ä»£ç ç”Ÿæˆ&lt;span class="hx-absolute -hx-mt-20" id="ä»£ç ç”Ÿæˆ">&lt;/span>
&lt;a href="#%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>ä»£ç ç”Ÿæˆèƒ½å¸®æˆ‘å¤„ç†å¤§éƒ¨åˆ†é‡å¤ä»£ç ï¼Œä¸»è¦é€šè¿‡ &lt;code>https://github.com/kubernetes/code-generator&lt;/code> è¿™ä¸ªåŒ…è¿›è¡Œè§£ætagå¹¶ç”Ÿæˆã€‚
&lt;a name="WOqAo">&lt;/a>&lt;/p>
&lt;h4>å…¨å±€tag&lt;span class="hx-absolute -hx-mt-20" id="å…¨å±€tag">&lt;/span>
&lt;a href="#%e5%85%a8%e5%b1%80tag" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>å¿…é¡»åœ¨ç›®æ ‡åŒ…çš„doc.goæ–‡ä»¶ä¸­å£°æ˜ï¼Œå…¸å‹è·¯å¾„æ˜¯ pkg/apis/&lt;apigroup>/&lt;version>/doc.goã€‚&lt;br />å†…å®¹ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸ºåŒ…ä¸­ä»»ä½•ç±»å‹ç”Ÿæˆæ·±æ‹·è´æ–¹æ³•ï¼Œå¯ä»¥åœ¨å±€éƒ¨tagè¦†ç›–æ­¤é»˜è®¤è¡Œä¸º&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +groupName=example.com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +k8s:deepcopy-gen=package&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// +groupName=samplecontroller.k8s.io // groupNameæŒ‡å®šAPIç»„çš„å…¨é™å®šå&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Package v1alpha1 is the v1alpha1 version of the API.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">v1alpha1&lt;/span> &lt;span class="c1">// import &amp;#34;k8s.io/sample-controller/pkg/apis/samplecontroller/v1alpha1&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;a name="UUUVg">&lt;/a>&lt;/p>
&lt;h4>å±€éƒ¨tag&lt;span class="hx-absolute -hx-mt-20" id="å±€éƒ¨tag">&lt;/span>
&lt;a href="#%e5%b1%80%e9%83%a8tag" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;ul>
&lt;li>&lt;strong>+genclient&lt;/strong>: ä¸ºè¿™ä¸ª package åˆ›å»º clientã€‚&lt;/li>
&lt;li>&lt;strong>+genclient:noStatus&lt;/strong>: å½“åˆ›å»º client æ—¶ï¼Œä¸å­˜å‚¨ statusã€‚&lt;/li>
&lt;li>&lt;strong>+k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object&lt;/strong>: ä¸ºç»“æ„ä½“ç”Ÿæˆ deepcopy çš„ä»£ç ï¼Œå®ç°äº† runtime.Object çš„ Interfaceã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ä»£ç ç”Ÿæˆï¼š&lt;/strong>&lt;/p>
&lt;p>é€šè¿‡./hack/&lt;a href="https://github.com/kubernetes/sample-controller/blob/master/hack/update-codegen.sh" target="_blank" rel="noopener">update-codegen.sh&lt;/a>æ–¹æ³•å¯ä»¥ç”Ÿæˆï¼Œclientä»¥åŠdeepcopyä»£ç ã€‚&lt;br />åŒ…å«ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sample-controller/pkg/apis/samplecontroller/v1alpha1/zz_generated.deepcopy.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sample-controller/pkg/generated/clientset
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sample-controller/pkg/generated/informers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sample-controller/pkg/generated/informers&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>_å‰æï¼šcode-generator å·²ç»åœ¨vendorä¸­ï¼Œæ‰§è¡Œ &lt;code>go mod vendor&lt;/code>Â _&lt;br />&lt;/p>
&lt;p>&lt;br />&lt;a href="https://github.com/kubernetes/sample-controller/blob/master/hack/update-codegen.sh" target="_blank" rel="noopener">update-codegen.sh&lt;/a>å†…å®¹å¦‚ä¸‹&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">bash &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">CODEGEN_PKG&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>/generate-groups.sh &lt;span class="s2">&amp;#34;deepcopy,client,informer,lister&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> k8s.io/sample-controller/pkg/generated k8s.io/sample-controller/pkg/apis &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> samplecontroller:v1alpha1 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --output-base &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>dirname &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">BASH_SOURCE&lt;/span>&lt;span class="p">[0]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">/../../..&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --go-header-file &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">SCRIPT_ROOT&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>/hack/boilerplate.go.txt&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å®Œæ•´ä½¿ç”¨è¯´æ˜ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Usage: generate-groups.sh &amp;lt;generators&amp;gt; &amp;lt;output-package&amp;gt; &amp;lt;apis-package&amp;gt; &amp;lt;groups-versions&amp;gt; ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;generators&amp;gt; the generators comma separated to run &lt;span class="o">(&lt;/span>deepcopy,defaulter,client,lister,informer&lt;span class="o">)&lt;/span> or &lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;output-package&amp;gt; the output package name &lt;span class="o">(&lt;/span>e.g. github.com/example/project/pkg/generated&lt;span class="o">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;apis-package&amp;gt; the external types dir &lt;span class="o">(&lt;/span>e.g. github.com/example/api or github.com/example/project/pkg/apis&lt;span class="o">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;groups-versions&amp;gt; the groups and their versions in the format &lt;span class="s2">&amp;#34;groupA:v1,v2 groupB:v1 groupC:v2&amp;#34;&lt;/span>, relative
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> to &amp;lt;api-package&amp;gt;.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ... arbitrary flags passed to all generator binaries.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Examples:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> generate-groups.sh all github.com/example/project/pkg/client github.com/example/project/pkg/apis &lt;span class="s2">&amp;#34;foo:v1 bar:v1alpha1,v1beta1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> generate-groups.sh deepcopy,client github.com/example/project/pkg/client github.com/example/project/pkg/apis &lt;span class="s2">&amp;#34;foo:v1 bar:v1alpha1,v1beta1&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;a name="mIgAJ">&lt;/a>&lt;/p>
&lt;h4>interface{}å¤„ç†&lt;span class="hx-absolute -hx-mt-20" id="interfaceå¤„ç†">&lt;/span>
&lt;a href="#interface%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h4>&lt;p>åœºæ™¯ï¼šå¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé€šç”¨çš„ç±»å‹çš„objectï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">validation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">openAPIV3Schema&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fields&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">object&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æˆ‘ä»¬åœ¨specé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªfieldså­—æ®µï¼Œç±»å‹æ˜¯objectï¼ˆå³key ,valueçš„å½¢å¼ï¼‰ï¼Œvalueçš„å€¼å¯èƒ½æ˜¯intä¹Ÿå¯èƒ½æ˜¯stringæˆ–è€…bool&lt;br />åœ¨typeå®šä¹‰çš„æ—¶å€™æˆ‘æ˜¯è¿™ä¹ˆå†™çš„ï¼Œå®šä¹‰ä¸ºmap[string]interface{}&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">// FooSpec is the spec for a Foo resource&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">type FooSpec struct {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">Fields map[string]interface{} `json:&amp;#34;fields&amp;#34;`&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å½“åœ¨ä»£ç ç”Ÿæˆçš„æ—¶å€™ï¼Œå‘ç°ä¼šæŠ¥é”™ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">Generating deepcopy funcs&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">F0518 17:53:33.568567 39986 deepcopy.go:750] DeepCopy of &amp;#34;interface{}&amp;#34; is unsupported. Instead, use named interfaces with DeepCopy&amp;lt;named-interface&amp;gt; as one of the methods.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">goroutine 1 [running]&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">k8s.io/klog/v2.stacks(0xc000132001, 0xc0002e9000, 0xad, 0xfd)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">/Users/silenceper/workspace/golang/pkg/mod/k8s.io/klog/v2@v2.0.0/klog.go:972 +0xb8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">......&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>é‡åˆ°è¿™ç§é—®é¢˜ï¼Œéœ€è¦è‡ªå·±å®ç°æ·±æ‹·è´ï¼Œä¾‹å¦‚è¿™ç§ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">type HelmReleaseSpec struct {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">HelmValues `json:&amp;#34;,inline&amp;#34;`&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">// +k8s:deepcopy-gen=false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">type HelmValues struct {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">helm.Values `json:&amp;#34;values,omitempty&amp;#34;`&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">// helm.Valueså®šä¹‰ï¼š&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">type Values map[string]interface{}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">// è‡ªå·±å®ç°æ·±æ‹·è´&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">func (in *HelmValues) DeepCopyInto(out *HelmValues) {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">if in == nil {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">return&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">b, err := yaml.Marshal(in.Values)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">if err != nil {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">return&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">var values helm.Values&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">err = yaml.Unmarshal(b, &amp;amp;values)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">if err != nil {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">return&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">out.Values = values&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>}&lt;span class="w"> &lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;a name="Qu2Ju">&lt;/a>&lt;/p>
&lt;h3>Controllerç¼–å†™&lt;span class="hx-absolute -hx-mt-20" id="controllerç¼–å†™">&lt;/span>
&lt;a href="#controller%e7%bc%96%e5%86%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨ç¼–å†™Controllerä¹‹å‰éœ€è¦äº†è§£client-goä¸­çš„informeræœºåˆ¶ï¼š&lt;br />&lt;img src="https://silenceper.oss-cn-beijing.aliyuncs.com/blog/202005/informer.png" alt="informer" loading="lazy" />&lt;/p>
&lt;blockquote>
&lt;p>é»„è‰²çš„éƒ¨åˆ†æ˜¯controllerç›¸å…³çš„æ¡†æ¶ï¼ŒåŒ…æ‹¬workqueueã€‚è“è‰²éƒ¨åˆ†æ˜¯client-goçš„ç›¸å…³å†…å®¹ï¼ŒåŒ…æ‹¬informer, reflector(å…¶å®å°±æ˜¯informerçš„å°è£…), indexerã€‚ä»æµç¨‹ä¸Šçœ‹ï¼Œreflectorä»apiserverä¸­é€šè¿‡list&amp;amp;watchæœºåˆ¶æ¥æ”¶äº‹ä»¶å˜åŒ–ï¼Œè¿›å…¥Delta FIFOé˜Ÿåˆ—ä¸­ï¼Œç”±informerè¿›è¡Œå¤„ç†ã€‚informerä¼šå°†delta FIFOé˜Ÿåˆ—ä¸­çš„äº‹ä»¶äº¤ç»™indexerç»„ä»¶ï¼Œindexerç»„ä»¶ä¼šå°†äº‹ä»¶æŒä¹…åŒ–å­˜å‚¨åœ¨æœ¬åœ°çš„ç¼“å­˜ä¸­ã€‚ä¹‹åï¼Œç”±äºç”¨æˆ·äº‹å…ˆå°†ä¸ºinformeræ³¨å†Œå„ç§äº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œè¿™äº›å›è°ƒå‡½æ•°å°†é’ˆå¯¹ä¸åŒçš„ç»„ä»¶åšä¸åŒçš„å¤„ç†ã€‚ä¾‹å¦‚åœ¨controllerä¸­ï¼Œå°†æŠŠobjectæ”¾å…¥workqueueä¸­ï¼Œä¹‹åç”±controllerçš„ä¸šåŠ¡é€»è¾‘ä¸­è¿›è¡Œå¤„ç†ã€‚å¤„ç†çš„æ—¶å€™å°†ä»ç¼“å­˜ä¸­è·å–objectçš„å¼•ç”¨ã€‚å³å„ç»„ä»¶å¯¹èµ„æºçš„å¤„ç†ä»…é™äºæœ¬åœ°ç¼“å­˜ä¸­ï¼Œç›´åˆ°updateèµ„æºçš„æ—¶å€™æ‰ä¸apiserveräº¤äº’ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;br />ç®€å•æ¥è®²é€šè¿‡list/watchæœºå™¨æä¾›äº†æœ¬åœ°ç¼“å­˜é¿å…æ¯æ¬¡å»è¯·æ±‚apiserverã€‚&lt;br />å¹¶ä¸”æä¾›äº†Event Handleræ–¹æ³•ï¼Œåœ¨å°†æ•°æ®ä¿å­˜è¿›å…¥cacheæ—¶ï¼Œé€šè¿‡è°ƒç”¨è‡ªå®šä¹‰handleræ–¹æ³•ï¼Œå¢åŠ è‡ªå®šä¹‰å¤„ç†ã€‚&lt;br />æ‰€ä»¥Controller çš„ä»£ç ç»“æ„ï¼Œå°±æ˜¯å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewController&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">kubeclientset&lt;/span> &lt;span class="nx">kubernetes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sampleclientset&lt;/span> &lt;span class="nx">clientset&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">deploymentInformer&lt;/span> &lt;span class="nx">appsinformers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeploymentInformer&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fooInformer&lt;/span> &lt;span class="nx">informers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FooInformer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Controller&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fooInformer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Informer&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">AddEventHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResourceEventHandlerFuncs&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AddFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">controller&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">enqueueFoo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">UpdateFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">old&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">new&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">controller&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">enqueueFoo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">new&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Controller&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">threadiness&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Launch two workers to process Foo resources&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">threadiness&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Until&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">runWorker&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Controller&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">runWorker&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">processNextWorkItem&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Controller&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">processNextWorkItem&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">shutdown&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">workqueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Run the syncHandler, passing it the namespace/name string of the&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Foo resource to be synced.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">syncHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Put the item back on the workqueue to handle any transient errors.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">workqueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddRateLimited&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error syncing &amp;#39;%s&amp;#39;: %s, requeuing&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}(&lt;/span>&lt;span class="nx">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Controller&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">syncHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Convert the namespace/name string into a distinct namespace and name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">namespace&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SplitMetaNamespaceKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;invalid resource key: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//TODO å¤„ç†é€»è¾‘&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Controller&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">enqueueFoo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">obj&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">workqueue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>åœ¨NewControllerä¸­é€šè¿‡fooInformeræ·»åŠ  &lt;code>AddEventHandler&lt;/code>Â ï¼Œæ‰§è¡Œ &lt;code>enqueueFoo&lt;/code>Â &lt;/li>
&lt;li>enqueueFoo ä¸­å°†è·å–çš„å˜æ›´æ”¾å…¥é˜Ÿåˆ—&lt;/li>
&lt;li>å¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªworkä»é˜Ÿåˆ—ä¸­å–æ•°æ®ï¼Œæœ€ç»ˆé€šè¿‡syncHandlerè¿›è¡Œä¸šåŠ¡åˆ¤æ–­&lt;/li>
&lt;li>åœ¨sample-controllerä¸­åŒæ—¶è¿˜ç›‘å¬äº†deploymentï¼Œåœ¨ &lt;code>handleObject&lt;/code>Â åˆ¤æ–­æ˜¯å¦å½’å± &lt;code>Foo&lt;/code>Â Kind ï¼ŒåŒæ—¶æ‰§è¡Œ &lt;code>enqueueFoo&lt;/code>Â  å…¥é˜Ÿã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;br />å…·ä½“ä»£ç åˆ¤æ–­å‚è€ƒ&lt;a href="https://github.com/kubernetes/sample-controller/blob/master/controller.go" target="_blank" rel="noopener">controller.go&lt;/a>&lt;br />
&lt;br />åœ¨&lt;a href="https://github.com/kubernetes/sample-controller/blob/master/main.go" target="_blank" rel="noopener">main.go&lt;/a>æ–¹æ³•ä¸­è°ƒç”¨å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">exampleClient&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">clientset&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewForConfig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Error building example clientset: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">kubeInformerFactory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">kubeinformers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewSharedInformerFactory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeClient&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">exampleInformerFactory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">informers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewSharedInformerFactory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">exampleClient&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">controller&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewController&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeClient&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">exampleClient&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">kubeInformerFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Apps&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">V1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Deployments&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">exampleInformerFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Samplecontroller&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">V1alpha1&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Foos&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// notice that there is no need to run Start methods in a separate goroutine. (i.e. go kubeInformerFactory.Start(stopCh)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Start method is non-blocking and runs all registered informers in a dedicated goroutine.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">kubeInformerFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">exampleInformerFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stopCh&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//å¯åŠ¨informer&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å°±æ˜¯è°ƒç”¨é€šè¿‡coge-genç”Ÿæˆä»£ç åˆ›å»ºinformerå¹¶å¯åŠ¨ï¼Œåˆ›å»ºclientã€‚&lt;br />
&lt;br />**æ€è€ƒï¼šä¸ºä»€ä¹ˆè¦é€šè¿‡é˜Ÿåˆ—æ¥æ§åˆ¶æ•°æ®çš„å˜åŒ–ï¼ŸÂ **&lt;br />æˆ‘è§‰å¾—ç”¨é˜Ÿåˆ—ä¸€æ–¹é¢æ˜¯è§£è€¦ï¼Œå› ä¸ºå¾€å¾€ä¸€ä¸ªControlleré‡Œé¢å¯èƒ½è¦é€šè¿‡informerç›‘å¬å„ç±»èµ„æºå¯¹è±¡ï¼Œé€šè¿‡é˜Ÿåˆ—å€ŸåŠ©äº†å„ä¸ªinformerçš„ä¾èµ–ã€‚å¦ä¸€æ–¹ä¾¿å¯ä»¥é€šè¿‡ä¸åŒç±»å‹çš„é˜Ÿåˆ—æ¯”å¦‚é™é€Ÿé˜Ÿåˆ—ï¼Œå»¶è¿Ÿé˜Ÿåˆ—è¾¾åˆ°ä¸åŒçš„å¹¶å‘æ§åˆ¶ã€‚&lt;br />&lt;/p>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>å…ˆå®šä¹‰crdï¼Œå†å®ç°Controlleré€»è¾‘&lt;/li>
&lt;li>å¯ä»¥é€šè¿‡code-generatorç”Ÿæˆinformerï¼Œclientï¼Œlistersä»£ç &lt;/li>
&lt;li>æ³¨æ„é’ˆå¯¹interface{}ç±»å‹éœ€è¦è‡ªå·±å®ç°deepCopyæ–¹æ³•&lt;/li>
&lt;li>å®ç°ä¸€ä¸ªOperatorï¼Œé›†æˆæ›´å¤šæ›´å¤æ‚çš„Controllerçš„è¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨Operatoræ¡†æ¶ï¼Œæ¯”å¦‚kubebuilder&lt;/li>
&lt;/ul>
&lt;h3>å‚è€ƒ&lt;span class="hx-absolute -hx-mt-20" id="å‚è€ƒ">&lt;/span>
&lt;a href="#%e5%8f%82%e8%80%83" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;ul>
&lt;li>&lt;a href="https://juejin.im/post/5de097bbf265da05d849ab53" target="_blank" rel="noopener">https://juejin.im/post/5de097bbf265da05d849ab53&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.fatedier.com/2019/04/02/k8s-custom-controller/" target="_blank" rel="noopener">https://blog.fatedier.com/2019/04/02/k8s-custom-controller/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.gmem.cc/crd" target="_blank" rel="noopener">https://blog.gmem.cc/crd&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>ç”¨vimä¿å­˜æ–‡ä»¶å’Œechoå‘½ä»¤åˆ°åº•æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</title><link>/blog/202005/difference-vim-and-echo/</link><pubDate>Wed, 13 May 2020 20:20:59 +0800</pubDate><guid>/blog/202005/difference-vim-and-echo/</guid><description>
&lt;h2>ç°è±¡&lt;span class="hx-absolute -hx-mt-20" id="ç°è±¡">&lt;/span>
&lt;a href="#%e7%8e%b0%e8%b1%a1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æœ€è¿‘åœ¨è°ƒè¯•ä¸€ä¸ªfilebeatç¨‹åºæ—¶éœ€è¦åˆ¶é€ ä¸€äº›logï¼Œæˆ‘æ˜¯ç›´æ¥ä½¿ç”¨vimç›´æ¥å¯¹æ–‡ä»¶æ‰“å¼€ç„¶åç›´æ¥ä¿å­˜çš„ã€‚&lt;/p>
&lt;p>ä½†æ˜¯æœ‰ä¸ª&lt;strong>å¥‡æ€ªçš„ç°è±¡&lt;/strong>ï¼šæ¯æ¬¡å†™å…¥ä¸€è¡Œæ–°çš„æ—¥å¿—ï¼Œfilebeatéƒ½ä¼šå°†æ•´ä¸ªæ–‡ä»¶çš„å†…å®¹åˆé‡æ–°è¿›è¡Œä¸ŠæŠ¥ä¸€éå¯¼è‡´æ—¥å¿—ä¸Šä¼ é‡å¤ï¼ŒåŒæ—¶è§‚å¯Ÿåˆ°filebeatçš„æ–‡ä»¶é‡‡é›†çŠ¶æ€æ–‡ä»¶&lt;code>registry&lt;/code>éƒ½ä¼šè¿›è¡Œå¢åŠ ä¸€ä¸ªé‡å¤çš„æ–‡ä»¶(sourceç›¸åŒï¼Œinodeä¸åŒ)ã€‚&lt;/p>
&lt;p>æ“ä½œä¸€ç•ªåä»¥ä¸ºæ˜¯ç¨‹åºçš„é—®é¢˜ï¼Œæœ€åæ‰ååº”è¿‡æ¥ï¼ˆä¸€å¼€å§‹æ²¡æ³¨æ„åˆ°inodeä¸åŒ :&amp;lt;ï¼‰ï¼Œæœ€ç»ˆä½¿ç”¨&lt;code>echo &amp;quot;test some log&amp;quot;&amp;gt;&amp;gt;test.log&lt;/code>è¿½åŠ çš„æ–¹å¼å‘ç°ä¸ä¼šæœ‰æ­¤é—®é¢˜ã€‚&lt;/p>
&lt;p>åŒæ—¶çœ‹äº†ä¸‹ä¸¤è€…çš„&lt;code>inode&lt;/code>ä¿¡æ¯ï¼Œç¡®è®¤äº†æ˜¯å› ä¸º&lt;code>vim&lt;/code>ä¼šæ”¹å˜æ–‡ä»¶çš„inode(ä¸€ä¸ªæ–°çš„æ–‡ä»¶)ï¼Œechoåˆ™ä¸ä¼šï¼š&lt;/p>
&lt;blockquote>
&lt;p>2020-05-14æ›´æ–°ï¼šä¹Ÿè·Ÿæ–‡ä»¶æƒé™æœ‰å…³ï¼Œå¦‚æœæ–‡ä»¶æ²¡æœ‰oæ²¡æœ‰wæƒé™ï¼Œåˆ™inodeä¿¡æ¯ä¼šæ”¹å˜ï¼Œå¦‚æœ&lt;code>chmod o+w test.log&lt;/code>åˆ™inodeä¿¡æ¯ä¸ä¼šå˜&lt;/p>
&lt;p>åŒæ—¶vimä¹Ÿæ˜¯å¼€äº†å¤‡ä»½æ–‡ä»¶&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>1ã€æŸ¥çœ‹æ–‡ä»¶inodeä¸º908488&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost work&lt;span class="o">]&lt;/span>&lt;span class="c1"># stat test.log&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> æ–‡ä»¶ï¼š&lt;span class="s2">&amp;#34;test.log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> å¤§å°ï¼š0 å—ï¼š0 IO å—ï¼š4096 æ™®é€šç©ºæ–‡ä»¶
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">è®¾å¤‡ï¼šfd00h/64768d Inodeï¼š908488 ç¡¬é“¾æ¥ï¼š1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æƒé™ï¼š&lt;span class="o">(&lt;/span>0644/-rw-r--r--&lt;span class="o">)&lt;/span> Uidï¼š&lt;span class="o">(&lt;/span> 0/ root&lt;span class="o">)&lt;/span> Gidï¼š&lt;span class="o">(&lt;/span> 0/ root&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ç¯å¢ƒï¼šunconfined_u:object_r:admin_home_t:s0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æœ€è¿‘è®¿é—®ï¼š2020-05-10 04:38:39.399791808 -0400
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æœ€è¿‘æ›´æ”¹ï¼š2020-05-10 04:38:39.399791808 -0400
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æœ€è¿‘æ”¹åŠ¨ï¼š2020-05-10 04:38:39.399791808 -0400
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">åˆ›å»ºæ—¶é—´ï¼š-&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>2ã€å½“æˆ‘ç”¨vim/viå·¥å…·è¿›è¡Œç¼–è¾‘ä¿å­˜ä¹‹åï¼Œå˜ä¸ºäº†ï¼š908490&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost work]# vi test.log
[root@localhost work]# stat test.log
æ–‡ä»¶ï¼š&amp;#34;test.log&amp;#34;
å¤§å°ï¼š7 å—ï¼š8 IO å—ï¼š4096 æ™®é€šæ–‡ä»¶
è®¾å¤‡ï¼šfd00h/64768d Inodeï¼š908490 ç¡¬é“¾æ¥ï¼š1
æƒé™ï¼š(0644/-rw-r--r--) Uidï¼š( 0/ root) Gidï¼š( 0/ root)
ç¯å¢ƒï¼šunconfined_u:object_r:admin_home_t:s0
æœ€è¿‘è®¿é—®ï¼š2020-05-10 04:39:01.950055784 -0400
æœ€è¿‘æ›´æ”¹ï¼š2020-05-10 04:39:01.950055784 -0400
æœ€è¿‘æ”¹åŠ¨ï¼š2020-05-10 04:39:01.953305882 -0400
åˆ›å»ºæ—¶é—´ï¼š-&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>3ã€è€Œç”¨echoå‘½ä»¤ä¿®æ”¹çœ‹åˆ°inodeä¿¡æ¯å¹¶æ²¡æœ‰æ”¹å˜, 908490&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost work]# echo &amp;#34;test some log&amp;#34;&amp;gt;&amp;gt;test.log
[root@localhost work]# stat test.log
æ–‡ä»¶ï¼š&amp;#34;test.log&amp;#34;
å¤§å°ï¼š21 å—ï¼š8 IO å—ï¼š4096 æ™®é€šæ–‡ä»¶
è®¾å¤‡ï¼šfd00h/64768d Inodeï¼š908490 ç¡¬é“¾æ¥ï¼š1
æƒé™ï¼š(0644/-rw-r--r--) Uidï¼š( 0/ root) Gidï¼š( 0/ root)
ç¯å¢ƒï¼šunconfined_u:object_r:admin_home_t:s0
æœ€è¿‘è®¿é—®ï¼š2020-05-10 04:39:01.950055784 -0400
æœ€è¿‘æ›´æ”¹ï¼š2020-05-10 04:41:16.794459151 -0400
æœ€è¿‘æ”¹åŠ¨ï¼š2020-05-10 04:41:16.794459151 -0400
åˆ›å»ºæ—¶é—´ï¼š-&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>éªŒè¯&lt;span class="hx-absolute -hx-mt-20" id="éªŒè¯">&lt;/span>
&lt;a href="#%e9%aa%8c%e8%af%81" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å…¶å®é€šè¿‡inodeçš„æ”¹å˜ä»¥åŠå¯ä»¥çŒœæµ‹å‡ºåœ¨ä½¿ç”¨vi/vimè¿›è¡Œç¼–è¾‘çš„æ—¶å€™ï¼Œæ–‡ä»¶ä»¥åŠå˜ä¸ºäº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä¸»è¦é€šè¿‡&lt;code>inotifywait&lt;/code>æ¥çœ‹ä¸€ä¸‹ï¼Œåœ¨è¿›è¡Œvimç¼–è¾‘çš„æ—¶å€™ï¼Œæ–‡ä»¶ä¼šäº§ç”Ÿä»€ä¹ˆæ—¶é—´&lt;/p>
&lt;blockquote>
&lt;p>ä¸€å¼€å§‹æœ¬æ¥æ‰“ç®—ä½¿ç”¨golangä¸­&lt;code>github.com/fsnotify/fsnotify&lt;/code>å»çœ‹çš„ï¼Œä½†æ˜¯å‘ç°åŒ…ä¸­å¯¹eventè¿›è¡Œäº†åˆå¹¶ï¼Œä¸å¤ŸåŸå§‹ã€‚æ‰€ä»¥æ‰ç›´æ¥ä½¿ç”¨&lt;code>inotifywait &lt;/code>æ¥çœ‹&lt;/p>
&lt;/blockquote>
&lt;p>inotifywaitå‘½ä»¤ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>inotifywait -rm test.log&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ–‡ä»¶æƒé™ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>-rw-r--r--. 1 root root 49 5æœˆ 14 05:40 test.log&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>1ã€ä½¿ç”¨vimè¿›è¡Œç¼–è¾‘çš„ç»“æœï¼š&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost work]# inotifywait -rm test.log
Setting up watches. Beware: since -r was given, this may take a while!
Watches established.
test.log OPEN
test.log ACCESS
test.log CLOSE_NOWRITE,CLOSE
test.log MOVE_SELF
test.log ATTRIB
test.log DELETE_SELF&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥çœ‹åˆ°å¯¹æ–‡ä»¶è¿›è¡Œäº†&lt;code>DELETE_SELF&lt;/code>&lt;/p>
&lt;p>&lt;strong>æ³¨æ„å½“å†æ¬¡è¿›è¡Œç¼–è¾‘çš„æ—¶å€™ï¼Œå·²ç»æ— æ³•ç›‘å¬åˆ°äº†ï¼Œå› ä¸ºåŸæœ‰æ–‡ä»¶å·²ç»è¢«åˆ é™¤ï¼Œéœ€è¦é‡æ–°ç›‘å¬&lt;/strong>&lt;/p>
&lt;p>&lt;strong>2ã€ä½¿ç”¨echoè¿›è¡Œè¿½åŠ å†™å…¥çš„ç»“æœ&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost work]# inotifywait -rm test.log
Setting up watches. Beware: since -r was given, this may take a while!
Watches established.
test.log OPEN
test.log MODIFY
test.log CLOSE_WRITE,CLOSE&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>3ã€ç›‘å¬æ•´ä¸ªç›®å½•ï¼Œå¯ä»¥çœ‹åˆ°æ›´å¤šä¿¡æ¯&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost work]# inotifywait -rm ./dir/
Setting up watches. Beware: since -r was given, this may take a while!
Watches established.
# å½“è¿›è¡Œæ–‡ä»¶å†™å…¥æ—¶
./dir/ OPEN test.log
./dir/ CREATE .test.log.swp
./dir/ OPEN .test.log.swp
./dir/ CREATE .test.log.swx
./dir/ OPEN .test.log.swx
./dir/ CLOSE_WRITE,CLOSE .test.log.swx
./dir/ DELETE .test.log.swx
./dir/ CLOSE_WRITE,CLOSE .test.log.swp
./dir/ DELETE .test.log.swp
./dir/ CREATE .test.log.swp
./dir/ OPEN .test.log.swp
./dir/ MODIFY .test.log.swp
./dir/ ATTRIB .test.log.swp
./dir/ ACCESS test.log
./dir/ CLOSE_NOWRITE,CLOSE test.log
./dir/ MODIFY .test.log.swp
# å½“è¿›è¡Œæ–‡ä»¶ä¿å­˜æ˜¯
./dir/ CREATE 4913
./dir/ OPEN 4913
./dir/ ATTRIB 4913
./dir/ CLOSE_WRITE,CLOSE 4913
./dir/ DELETE 4913
./dir/ MOVED_FROM test.log
./dir/ MOVED_TO test.log~
./dir/ CREATE test.log
./dir/ OPEN test.log
./dir/ MODIFY test.log
./dir/ CLOSE_WRITE,CLOSE test.log
./dir/ ATTRIB test.log
./dir/ MODIFY .test.log.swp
./dir/ DELETE test.log~
./dir/ CLOSE_WRITE,CLOSE .test.log.swp
./dir/ DELETE .test.log.swp&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥çœ‹åˆ°åœ¨è¿›è¡Œæ–‡ä»¶ä¿å­˜æ—¶ï¼Œå°†åŸæœ‰test.log ç§»åŠ¨ä¸ºtest.log~ï¼Œå¹¶æ–°åˆ›å»ºä¸€ä¸ªæ–‡ä»¶test.logï¼Œæœ€åå¯¹test.log~å¤‡ä»½æ–‡ä»¶å’Œ.test.log.swpç¼“å†²åŒºæ–‡ä»¶è¿›è¡Œåˆ é™¤&lt;/p>
&lt;p>&lt;strong>4ã€å½“è¿›è¡Œ&lt;code>chmod o+w test.log&lt;/code>æ—¶ï¼Œçœ‹åˆ°çš„ä¿¡æ¯å¦‚ä¸‹ï¼š&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>./dir/ CREATE 4913
./dir/ OPEN 4913
./dir/ ATTRIB 4913
./dir/ CLOSE_WRITE,CLOSE 4913
./dir/ DELETE 4913
./dir/ OPEN test.log
./dir/ CREATE test.log~
./dir/ OPEN test.log~
./dir/ ATTRIB test.log~
./dir/ ACCESS test.log
./dir/ MODIFY test.log~
./dir/ CLOSE_WRITE,CLOSE test.log~
./dir/ ATTRIB test.log~
./dir/ CLOSE_NOWRITE,CLOSE test.log
./dir/ MODIFY test.log
./dir/ OPEN test.log
./dir/ MODIFY test.log
./dir/ CLOSE_WRITE,CLOSE test.log
./dir/ ATTRIB test.log
./dir/ MODIFY .test.log.swp
./dir/ DELETE test.log~
./dir/ CLOSE_WRITE,CLOSE .test.log.swp
./dir/ DELETE .test.log.swp&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯¹æ¯”3ä¸­çš„ç»“æœæ²¡æœ‰å°†test.log move to test.log~çš„æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥å¯¹test.logæ–‡ä»¶è¿›è¡Œæ›´æ”¹ï¼Œæ‰€ä»¥æ­¤æ—¶inodeä¿¡æ¯å¹¶æ²¡æœ‰æ”¹å˜&lt;/p>
&lt;p>&lt;strong>5ã€å¦‚æœå…³é—­vimå¤‡ä»½&lt;/strong>&lt;/p>
&lt;p>é€šè¿‡è®¾ç½®vimå‚æ•°&lt;code>set nobackup nowritebackup&lt;/code>å…³é—­vimçš„å¤‡ä»½ï¼Œåˆ™åœ¨ä¿å­˜çš„æ—¶å€™ä¸ä¼šç”Ÿæˆ&lt;code>test.log~&lt;/code>æ–‡ä»¶ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œinodeä¿¡æ¯ä¹Ÿæ˜¯ä¸ä¼šæ”¹å˜çš„&lt;/p>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>vimç¼–è¾‘æ˜¯äº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œæ‰€ä»¥çœ‹åˆ°inodeä¿¡æ¯å˜åŒ–äº†ï¼Œè€Œechoä»…ä»…åªæ˜¯å¯¹æ–‡ä»¶è¿›è¡Œå†™å…¥ã€‚&lt;/li>
&lt;li>åœ¨vimç¼–è¾‘è¿‡ç¨‹ä¸­ï¼Œä¼šç”Ÿæˆswpç¼“å†²åŒºæ–‡ä»¶ï¼Œåœ¨è¿›è¡Œvimç¼–è¾‘æ—¶æ—¶åˆ»å°†å†…å®¹ä¿å­˜è¿›å…¥swpï¼Œé˜²æ­¢ç¨‹åºé€€å‡ºæœªä¿å­˜&lt;/li>
&lt;li>äº§ç”Ÿåç¼€å¸¦ ~ çš„å¤‡ä»½æ–‡ä»¶ï¼Œè¿™ä¸ªæ˜¯åœ¨å¯¹æ–‡ä»¶è¿›è¡Œä¿å­˜æ—¶äº§ç”Ÿï¼Œå¦‚æœæ–‡ä»¶è¢«æ­£å¸¸ä¿å­˜åˆ™è¯¥æ–‡ä»¶ä¼šè¢«ç«‹å³åˆ é™¤ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯çœ‹ä¸åˆ°è¿™ä¸ªæ–‡ä»¶&lt;/li>
&lt;li>å¦‚æœæ–‡ä»¶otheræœ‰writeæƒé™ï¼ˆ&lt;code>chmod o+w xxx&lt;/code>ï¼‰ï¼Œåˆ™å½“è¿›è¡Œviå†™å…¥å†…å®¹çš„æ—¶å€™æ–‡ä»¶inodeä¸ä¼šæ”¹å˜ã€‚&lt;/li>
&lt;li>å¦‚æœå…³é—­vimå¤‡ä»½ï¼Œåˆ™inodeä¿¡æ¯ä¹Ÿä¸ä¼šæ”¹å˜&lt;/li>
&lt;/ul></description></item><item><title>postgreså…¥é—¨</title><link>/blog/202005/getting-started-with-postgres/</link><pubDate>Mon, 04 May 2020 23:20:59 +0800</pubDate><guid>/blog/202005/getting-started-with-postgres/</guid><description>
&lt;p>æœ€è¿‘éœ€è¦å°†mysqlæ•°æ®åº“åˆ‡æ¢åˆ°pgæ•°æ®åº“ï¼ˆå…¬å¸è¦æ±‚æ–°ä¸Šçš„åº”ç”¨DBé¦–é€‰postgresï¼‰ï¼Œæ‰€ä»¥å¯¹pgè¿›è¡ŒåŸºæœ¬å­¦ä¹ äº†ä¸‹ï¼Œæ€»ä½“æ„Ÿè§‰ç›¸å·®ä¸å¤§ï¼Œåœ¨ä¸€äº›ç»†èŠ‚ä»¥åŠéœ€è¦ä¸Šå¯èƒ½éœ€è¦æ³¨æ„ã€‚&lt;/p>
&lt;h2>å®‰è£…&lt;span class="hx-absolute -hx-mt-20" id="å®‰è£…">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æˆ‘è¿™é‡Œæ˜¯ä»¥dockerçš„æ–¹å¼æ¥è¿›è¡Œå®‰è£…çš„ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¿™ç§å®‰è£…æ–¹å¼åªèƒ½ä½œä¸ºä½œä¸ºæœ¬åœ°å¼€å‘è°ƒè¯•ç”¨&lt;/p>
&lt;/blockquote>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">docker run --name postgres -v /Users/silenceper/workspace/postgres/data:/var/lib/postgresql/data -e &lt;span class="nv">POSTGRES_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123&lt;/span> -p 5432:5432 -d postgres:10.3&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>æŒ‡å®šæ•°æ®å­˜å‚¨ç›®å½•æ˜ å°„åˆ°å®¿ä¸»æœºæœ¬åœ°ï¼Œé¿å…å®¹å™¨é”€æ¯åæ•°æ®ä¸¢å¤±&lt;/li>
&lt;li>æŒ‡å®šå¯†ç postgresç”¨æˆ·çš„å¯†ç ä¸º123&lt;/li>
&lt;li>æŒ‡å®šä½¿ç”¨postgres:10.3é•œåƒ&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥é€‰æ‹©pgAdmin4ä½œä¸ºå®¢æˆ·ç«¯ï¼Œæœ‰å›¾å½¢åŒ–UIç•Œé¢ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨psqlå‘½ä»¤ã€‚&lt;/p>
&lt;h2>åŸºæœ¬æ“ä½œ&lt;span class="hx-absolute -hx-mt-20" id="åŸºæœ¬æ“ä½œ">&lt;/span>
&lt;a href="#%e5%9f%ba%e6%9c%ac%e6%93%8d%e4%bd%9c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ç™»å½•æ•°æ®åº“ï¼ˆä½¿ç”¨psqlå‘½ä»¤ï¼‰ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code># è¿›å…¥å®¹å™¨æ‰èƒ½ä½¿ç”¨psqlå‘½ä»¤
docker exec -it postgres bash
# ä»¥postgresè§’è‰²ç™»å½•
psql -U postgres&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥é€šè¿‡ &lt;code>\?&lt;/code>æŸ¥çœ‹ä¸€äº›å¸¸ç”¨çš„æ“ä½œã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>\hï¼šæŸ¥çœ‹SQLå‘½ä»¤çš„è§£é‡Šï¼Œæ¯”å¦‚\h selectã€‚
\?ï¼šæŸ¥çœ‹psqlå‘½ä»¤åˆ—è¡¨ã€‚
\lï¼šåˆ—å‡ºæ‰€æœ‰æ•°æ®åº“ã€‚
\c [database_name]ï¼šè¿æ¥å…¶ä»–æ•°æ®åº“ã€‚
\dï¼šåˆ—å‡ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰è¡¨æ ¼ã€‚
\d [table_name]ï¼šåˆ—å‡ºæŸä¸€å¼ è¡¨æ ¼çš„ç»“æ„ã€‚
\duï¼šåˆ—å‡ºæ‰€æœ‰ç”¨æˆ·ã€‚
\eï¼šæ‰“å¼€æ–‡æœ¬ç¼–è¾‘å™¨ã€‚
\conninfoï¼šåˆ—å‡ºå½“å‰æ•°æ®åº“å’Œè¿æ¥çš„ä¿¡æ¯ã€‚&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>åˆ›å»ºç”¨æˆ·ä»¥åŠDB&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»ºç”¨æˆ·ä»¥åŠdb">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%ba%e7%94%a8%e6%88%b7%e4%bb%a5%e5%8f%8adb" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åˆ›å»ºç”¨æˆ·&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>CREATE USER dbuser WITH PASSWORD &amp;#39;password&amp;#39;;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åˆ›å»ºç”¨æˆ·æ•°æ®åº“ï¼Œè¿™é‡Œä¸ºexampledbï¼Œå¹¶æŒ‡å®šæ‰€æœ‰è€…ä¸ºdbuser&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>CREATE DATABASE exampledb OWNER dbuser;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å°†exampledbæ•°æ®åº“çš„æ‰€æœ‰æƒé™éƒ½èµ‹äºˆdbuserï¼Œå¦åˆ™dbuseråªèƒ½ç™»å½•æ§åˆ¶å°ï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®åº“æ“ä½œæƒé™ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>GRANT ALL PRIVILEGES ON DATABASE exampledb to dbuser;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æœ€åï¼Œä½¿ç”¨\qå‘½ä»¤é€€å‡ºæ§åˆ¶å°ï¼ˆä¹Ÿå¯ä»¥ç›´æ¥æŒ‰ctrl+Dï¼‰ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>\q&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>æ•°æ®åº“æ“ä½œ&lt;span class="hx-absolute -hx-mt-20" id="æ•°æ®åº“æ“ä½œ">&lt;/span>
&lt;a href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e6%93%8d%e4%bd%9c" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code># åˆ›å»ºæ–°è¡¨
CREATE TABLE user_tbl(name VARCHAR(20), signup_date DATE);
# æ’å…¥æ•°æ®
INSERT INTO user_tbl(name, signup_date) VALUES(&amp;#39;å¼ ä¸‰&amp;#39;, &amp;#39;2013-12-22&amp;#39;);
# é€‰æ‹©è®°å½•
SELECT * FROM user_tbl;
# æ›´æ–°æ•°æ®
UPDATE user_tbl set name = &amp;#39;æå››&amp;#39; WHERE name = &amp;#39;å¼ ä¸‰&amp;#39;;
# åˆ é™¤è®°å½•
DELETE FROM user_tbl WHERE name = &amp;#39;æå››&amp;#39; ;
# æ·»åŠ æ ä½
ALTER TABLE user_tbl ADD email VARCHAR(40);
# æ›´æ–°ç»“æ„
ALTER TABLE user_tbl ALTER COLUMN signup_date SET NOT NULL;
# æ›´åæ ä½
ALTER TABLE user_tbl RENAME COLUMN signup_date TO signup;
# åˆ é™¤æ ä½
ALTER TABLE user_tbl DROP COLUMN email;
# è¡¨æ ¼æ›´å
ALTER TABLE user_tbl RENAME TO backup_tbl;
# åˆ é™¤è¡¨æ ¼
DROP TABLE IF EXISTS backup_tbl;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>ä¸mysqlå¯¹æ¯”&lt;span class="hx-absolute -hx-mt-20" id="ä¸mysqlå¯¹æ¯”">&lt;/span>
&lt;a href="#%e4%b8%8emysql%e5%af%b9%e6%af%94" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>åŸå…ˆåœ¨mysqlä¸­ä¼šæ¯”è¾ƒå»ºè®®ç”¨åå¼•å·(`)æ¥å¯¹å­—æ®µè¿›è¡Œè½¬ä¹‰ï¼Œåœ¨postgresä¸­å°±ä¸è¡Œäº†&lt;/li>
&lt;/ul>
&lt;p>MySQL å¯ä»¥ä½¿ç”¨å•å¼•å·ï¼ˆâ€™ï¼‰æˆ–è€…åŒå¼•å·ï¼ˆ&amp;quot;ï¼‰è¡¨ç¤ºå€¼ï¼Œä½†æ˜¯ PG åªèƒ½ç”¨å•å¼•å·ï¼ˆâ€™ï¼‰è¡¨ç¤ºå€¼ï¼ŒPG çš„åŒå¼•å·ï¼ˆ&amp;quot;ï¼‰æ˜¯è¡¨ç¤ºç³»ç»Ÿæ ‡è¯†ç¬¦çš„ï¼Œæ¯”å¦‚è¡¨åæˆ–è€…å­—æ®µåã€‚MySQLå¯ä»¥ä½¿ç”¨åå•å¼•å·ï¼ˆ`ï¼‰è¡¨ç¤ºç³»ç»Ÿæ ‡è¯†ç¬¦ï¼Œæ¯”å¦‚è¡¨åã€å­—æ®µåï¼ŒPG ä¹Ÿæ˜¯ä¸æ”¯æŒçš„&lt;/p>
&lt;ul>
&lt;li>æ—¶é—´ç±»å‹ï¼špostgresä¸­æ—¶é—´ç±»å‹å¸¦ä¸Š&lt;code>with time zone&lt;/code>æ—¶åŒº&lt;/li>
&lt;/ul>
&lt;p>è¿™ä¸ªåœ¨ç”¨çš„æ—¶å€™æŒºæ–¹ä¾¿çš„ï¼Œé¿å…æ—¶åŒºä¸å¯¹ã€‚&lt;/p>
&lt;p>åŸå…ˆä¸€ç›´ç”¨&lt;a href="https://github.com/silenceper/gogen" target="_blank" rel="noopener">https://github.com/silenceper/gogen&lt;/a>(ä¸€ä¸ªè‡ªåŠ¨åŒ–ormç”Ÿæˆå·¥å…·)æ¥ç”Ÿæˆdbç›¸å…³çš„æ“ä½œä¸€å¼€å§‹åªæ”¯æŒmysqlï¼Œåé¢åŠ å…¥äº†postgresçš„æ”¯æŒå°±å±è”½äº†å¯¹åº•å±‚dbçš„é€‰æ‹©ï¼Œæ–¹ä¾¿ã€‚&lt;/p>
&lt;p>ä¸è¿‡å¯¹äºgoå¼€å‘æ¥è¯´ï¼Œåªè¦ä¸æ˜¯æ‰‹å†™sqlå–æ‰§è¡Œï¼Œè€Œæ˜¯åˆ©ç”¨ä¸€äº›ormå·¥å…·ï¼Œåº•å±‚éƒ½å°è£…äº†å¯¹å¤šç§æ•°æ®åº“çš„æ”¯æŒï¼Œåˆ‡æ¢å°±å˜å¾—æ›´ç®€å•ã€‚&lt;/p>
&lt;p>&lt;strong>è¿™é‡Œå¼•å…¥ä¸€ä¸ªè¯é¢˜ï¼šgolangå¼€å‘è€…åˆ°åº•è¯¥ä¸è¯¥ç”¨ormï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>æˆ‘è‡ªå·±è§‰å¾—ï¼Œæœ‰ä¸ªå–èˆï¼Œå¦‚æœéœ€è¦å†™çš„sqlæ¯”è¾ƒå¤æ‚ï¼Œå…³è”å…³ç³»åˆå¤ªå¤šï¼Œè™½ç„¶ormå·¥å…·ä¹Ÿæä¾›äº†è¿™ç§å…³ç³»çš„å¯¹åº”ï¼Œä½†æ˜¯ç”¨çš„è¯è¿˜ä¸å¦‚è‡ªå·±æ¥å†™sqlç®€å•ï¼Œè€Œä¸”ä¹Ÿæ˜“è¯»ã€‚&lt;/p>
&lt;p>å¦‚æœæ˜¯ä¸šåŠ¡ç³»ç»Ÿæ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œå·²ç»è¢«æ‹†åˆ†çš„å¤Ÿç®€å•ï¼Œæˆ‘åŸºæœ¬ä¸Šéƒ½ä¼šä½¿ç”¨ormå·¥å…·ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å‚è€ƒæ–‡æ¡£ï¼šhttps://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html&lt;/p>
&lt;/blockquote></description></item><item><title>è®°ä¸€æ¬¡é—®é¢˜æ’æŸ¥ï¼šä¸ºä»€ä¹ˆåœ¨PODæ— æ³•é€šè¿‡Serviceè®¿é—®è‡ªå·±ï¼Ÿ</title><link>/blog/202004/bridge-hairpin-mod/</link><pubDate>Thu, 30 Apr 2020 11:26:59 +0800</pubDate><guid>/blog/202004/bridge-hairpin-mod/</guid><description>
&lt;h2>é—®é¢˜ç°è±¡&lt;span class="hx-absolute -hx-mt-20" id="é—®é¢˜ç°è±¡">&lt;/span>
&lt;a href="#%e9%97%ae%e9%a2%98%e7%8e%b0%e8%b1%a1" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åˆ›å»ºä¸€ä¸ªnginx podï¼Œå¹¶é…ç½®äº†serviceè®¿é—®ï¼Œserviceåç«¯æŒ‡å‘podã€‚&lt;/p>
&lt;p>è¿›å…¥podä¸­ä½¿ç”¨service ip æˆ–è€…service åŸŸåï¼Œæ— æ³•è®¿é—®ã€‚&lt;/p>
&lt;p>ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ç¯å¢ƒé…ç½®æˆ–è€…k8sç‰ˆæœ¬ï¼ˆ1.9ï¼‰çš„é—®é¢˜ï¼Œåœ¨å…¶ä»–1.13çš„kubernetesç¯å¢ƒä¸‹ä¹Ÿè¯•äº†ï¼Œè¿˜æ˜¯åŒæ ·çš„é—®é¢˜ã€‚&lt;/p>
&lt;h2>ç¯å¢ƒé…ç½®&lt;span class="hx-absolute -hx-mt-20" id="ç¯å¢ƒé…ç½®">&lt;/span>
&lt;a href="#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ä½¿ç”¨çš„cniæ’ä»¶æ˜¯flannelï¼Œä½†ä¸æ˜¯å®¹å™¨åŒ–å®‰è£…ï¼Œä¹Ÿä¸æ˜¯æ ‡å‡†åŒ–çš„é€šè¿‡kubeletæŒ‡å®šcni pluginï¼ˆ&amp;ndash;cni-bin-dir,&amp;ndash;cni-conf-dirå‚æ•°ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡dockerd æä¾›çš„&lt;code>-bip&lt;/code>å‚æ•°æŒ‡å®šå®¹å™¨çš„å­ç½‘ï¼Œè€Œè¿™ä¸ªå€¼æ˜¯ä»&lt;code>/run/flannel/subnet.env&lt;/code>(flannelä¼šå°†è·å–åˆ°çš„å­ç½‘å†™å…¥åˆ°è¯¥æ–‡ä»¶)&lt;/p>
&lt;h2>æ’æŸ¥è¿‡ç¨‹&lt;span class="hx-absolute -hx-mt-20" id="æ’æŸ¥è¿‡ç¨‹">&lt;/span>
&lt;a href="#%e6%8e%92%e6%9f%a5%e8%bf%87%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;strong>1ã€é¦–å…ˆå°è¯•é€šè¿‡pod ipå°è¯•æ˜¯å¦å¯è®¿é—®ï¼Œå·²éªŒè¯æ˜¯å¯é€šçš„ã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;strong>2ã€å°è¯•å¯¹docker0ç½‘æ¡¥è¿›è¡ŒæŠ“åŒ…&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>tcpdump -i docker0&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ç¥å¥‡çš„åœ¨è¿™é‡Œï¼Œå†æ¬¡å°è¯•é€šè¿‡service è®¿é—®æ˜¯å±…ç„¶å¯ä»¥é€šï¼Œå‘ç°åªè¦tcpdumpæ–­å¼€å°±ä¸è¡Œäº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>åˆ°è¿™é‡Œçš„æ—¶å€™æœ‰ç‚¹è§‰å¾—è¯¡å¼‚äº†&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨podå†…é€šè¿‡serviceè®¿é—®çš„æ—¶å€™ç½‘ç»œçš„æµå‘åº”è¯¥æ˜¯&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>podå†…éƒ¨è®¿é—®service-&amp;gt;docker0ç½‘æ¡¥-&amp;gt;å®¿ä¸»æœºçš„iptablesè§„åˆ™-&amp;gt;docker0ç½‘æ¡¥-&amp;gt;podå†…éƒ¨&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æŸ¥é˜…äº†ç›¸å…³èµ„æ–™åï¼Œçœ‹åˆ°kubeletæœ‰ä¸ª&lt;code>--hairpin-mod&lt;/code>å‚æ•°ï¼š&lt;/p>
&lt;p>æ–‡æ¡£è¯´æ˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å¦‚æœç½‘ç»œæ²¡æœ‰ä¸ºâ€œå‘å¤¹æ¨¡å¼â€æµé‡ç”Ÿæˆæ­£ç¡®é…ç½®ï¼Œé€šå¸¸å½“ kube-proxy ä»¥ iptables æ¨¡å¼è¿è¡Œï¼Œå¹¶ä¸” Pod ä¸æ¡¥æ¥ç½‘ç»œè¿æ¥æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚Kubelet å…¬å¼€äº†ä¸€ä¸ª hairpin-mode æ ‡å¿—ï¼Œå¦‚æœ pod è¯•å›¾è®¿é—®å®ƒä»¬è‡ªå·±çš„ Service VIPï¼Œå°±å¯ä»¥è®© Service çš„ç«¯ç‚¹é‡æ–°è´Ÿè½½åˆ°ä»–ä»¬è‡ªå·±èº«ä¸Šã€‚hairpin-mode æ ‡å¿—å¿…é¡»è®¾ç½®ä¸º hairpin-veth æˆ–è€… promiscuous-bridgeã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å¯æ˜¯æˆ‘è®¾ç½®ä¹‹åè¿˜æ˜¯æ²¡æœ‰è¿˜æ˜¯ä¸è¡Œï¼Œç¿»äº†ä¸€ä¸‹kubeleté‡Œé¢çš„ä»£ç ï¼Œå‘ç°cniç»„ä»¶å¹¶æ²¡æœ‰å–è¿™ä¸ªå€¼åšä»»ä½•æ‰åšï¼ˆåœ¨kubnetä¸­æœ‰ï¼‰&lt;/p>
&lt;p>æŸ¥çœ‹è¿™ä¸ªè®¨è®ºï¼š
&lt;a href="https://github.com/kubernetes/kubernetes/issues/45790" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/issues/45790&lt;/a>&lt;/p>
&lt;p>&lt;strong>å¤§è‡´ç»“è®ºæ˜¯ï¼Œåº”è¯¥ç”±cniæ’ä»¶æ¥æ ¹æ®è¿™ä¸ªå€¼æ¥åšå¯¹åº”çš„æ“ä½œã€‚&lt;/strong>&lt;/p>
&lt;p>è¿˜æ˜¯æ²¡è§£å†³æˆ‘çš„é—®é¢˜ï¼Ÿ&lt;/p>
&lt;p>ä¸è¿‡æˆ‘çœ‹åˆ°hairpinå¼€å¯çš„æ ‡å¿—ä½æ˜¯é€šè¿‡&lt;code>/sys/devices/virtual/net/docker0/brif/veth-xxx/hairpin_mod&lt;/code> å†…å®¹è®¾ç½®ä¸º1å¼€å¯çš„ã€‚&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘å°†æ‰€æœ‰vethè¯¥æ–‡ä»¶å†…å®¹è®¾ç½®&lt;code>1&lt;/code>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>for intf in /sys/devices/virtual/net/docker0/brif/*; do echo 1&amp;gt; $intf/hairpin_mod; done&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥è®¿é—®äº†ã€‚ğŸ˜º&lt;/p>
&lt;h2>è§£ç–‘ï¼špromiscuous-bridge ä¸ hairpin-veth&lt;span class="hx-absolute -hx-mt-20" id="è§£ç–‘promiscuous-bridge-ä¸-hairpin-veth">&lt;/span>
&lt;a href="#%e8%a7%a3%e7%96%91promiscuous-bridge-%e4%b8%8e-hairpin-veth" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>&lt;strong>ä¸ºä»€ä¹ˆæˆ‘æ— æ³•è®¿é—®&lt;/strong>&lt;/p>
&lt;p>bridgeä¸å…è®¸åŒ…ä»æ”¶åˆ°åŒ…çš„ç«¯å£å‘å‡ºï¼Œæ¯”å¦‚è¿™ç§æƒ…å†µï¼Œåœ¨podå†…é€šè¿‡docker0è®¿é—®serviceï¼Œåç»­åˆé€šè¿‡docker0ç½‘æ¡¥è¿›æ¥ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯&lt;code>hairpin_mod&lt;/code>&lt;/p>
&lt;p>&lt;strong>ä¸ºä»€ä¹ˆä½¿ç”¨tcpdump å¯ä»¥è®©è®¿é—®å¯é€šï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>å› ä¸ºtcpdumpè¦æŠ“å–æ‰€æœ‰ç»è¿‡è¯¥ç½‘å¡ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯æ··æ‚æ¨¡å¼ã€‚å¯ä»¥åœ¨/var/log/messageçœ‹åˆ°&lt;code>device docker0 entered promiscuous mode&lt;/code>çš„logã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ··æ‚æ¨¡å¼ï¼ˆè‹±èªï¼špromiscuous modeï¼‰æ˜¯ç”µè„‘ç½‘ç»œä¸­çš„æœ¯è¯­ã€‚ æ˜¯æŒ‡ä¸€å°æœºå™¨çš„ç½‘å¡èƒ½å¤Ÿæ¥æ”¶æ‰€æœ‰ç»è¿‡å®ƒçš„æ•°æ®æµï¼Œè€Œä¸è®ºå…¶ç›®çš„åœ°å€æ˜¯å¦æ˜¯å®ƒã€‚ ä¸€èˆ¬è®¡ç®—æœºç½‘å¡éƒ½å·¥ä½œåœ¨éæ··æ‚æ¨¡å¼ä¸‹ï¼Œæ­¤æ—¶ç½‘å¡åªæ¥å—æ¥è‡ªç½‘ç»œç«¯å£çš„ç›®çš„åœ°å€æŒ‡å‘è‡ªå·±çš„æ•°æ®ã€‚ å½“ç½‘å¡å·¥ä½œåœ¨æ··æ‚æ¨¡å¼ä¸‹æ—¶ï¼Œç½‘å¡å°†æ¥è‡ªæ¥å£çš„æ‰€æœ‰æ•°æ®éƒ½æ•è·å¹¶äº¤ç»™ç›¸åº”çš„é©±åŠ¨ç¨‹åºã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ‰‹åŠ¨å¼€å…³å‘½ä»¤ï¼š
&lt;code>ifconfig docker0 promisc on/off&lt;/code>&lt;/p>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å…¶å®æˆ‘ä»¬é›†ç¾¤é€šè¿‡è¿™ç§æ¯”è¾ƒå¦ç±»çš„æ–¹å¼æ¥åˆ†é…POD IPä¹Ÿç”¨äº†äº†å¾ˆä¹…äº†ï¼Œä¹‹æ‰€ä»¥æ²¡å‡ºé—®é¢˜ï¼Œåº”è¯¥æ˜¯ä¸šåŠ¡åŸºæœ¬æ²¡é‡åˆ°è¿™ç§podå†…é€šè¿‡serviceè®¿é—®è‡ªå·±çš„æƒ…å†µã€‚&lt;/p>
&lt;p>æ‰€ä»¥è¿˜æ˜¯è¦è·Ÿç€æ ‡å‡†çš„k8sæ–¹å¼æ¥å®‰è£…cniï¼Œé¿å…å…¥å‘ï¼Œæ¯”å¦‚flannelå°±å·²ç»æä¾›ç»™äº†&lt;code>hairpinMode &lt;/code>å‚æ•°æ¥è¿›è¡Œé…ç½®å¼€å¯ã€‚&lt;/p></description></item><item><title>singleflightåŒ…åŸç†è§£æ</title><link>/blog/202003/singleflight/</link><pubDate>Sun, 08 Mar 2020 19:26:59 +0800</pubDate><guid>/blog/202003/singleflight/</guid><description>
&lt;p>&lt;code>singleflight&lt;/code>Â åŒ…ä¸»è¦æ˜¯ç”¨æ¥åšå¹¶å‘æ§åˆ¶ï¼Œå¸¸è§çš„æ¯”å¦‚é˜²æ­¢ &lt;code>ç¼“å­˜å‡»ç©¿&lt;/code>Â ï¼Œæˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹è¿™ç§åœºæ™¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>ç¼“å­˜å‡»ç©¿ï¼šç¼“å­˜åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡æœŸçš„æ—¶å€™ï¼Œæ°å¥½åœ¨è¿™ä¸ªæ—¶é—´ç‚¹å¯¹è¿™ä¸ªKeyæœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚è¿‡æ¥ï¼Œè¿™äº›è¯·æ±‚å‘ç°ç¼“å­˜è¿‡æœŸä¸€èˆ¬éƒ½ä¼šä»åç«¯DBåŠ è½½æ•°æ®å¹¶å›è®¾åˆ°ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™å¤§å¹¶å‘çš„è¯·æ±‚å¯èƒ½ä¼šç¬é—´æŠŠåç«¯DBå‹å®ã€‚Â &lt;/p>
&lt;/blockquote>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;errors&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;golang.org/x/sync/singleflight&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">errorNotExist&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;not exist&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ¨¡æ‹Ÿ10ä¸ªå¹¶å‘&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;key&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//è·å–æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">getData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getDataFromCache&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">errorNotExist&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ¨¡æ‹Ÿä»dbä¸­è·å–æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">getDataFromDB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//TOOD: set cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ¨¡æ‹Ÿä»cacheä¸­è·å–å€¼ï¼Œcacheä¸­æ— è¯¥å€¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">getDataFromCache&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errorNotExist&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ¨¡æ‹Ÿä»æ•°æ®åº“ä¸­è·å–å€¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">getDataFromDB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;get %s from database&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;data&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­é€šè¿‡ &lt;code>getData(key)&lt;/code>æ–¹æ³•è·å–æ•°æ®ï¼Œé€»è¾‘æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>å…ˆå°è¯•ä»cacheä¸­è·å–&lt;/li>
&lt;li>å¦‚æœcacheä¸­ä¸å­˜åœ¨å°±ä»dbä¸­è·å–&lt;/li>
&lt;/ol>
&lt;p>æˆ‘ä»¬æ¨¡æ‹Ÿäº†10ä¸ªå¹¶å‘è¯·æ±‚ï¼Œæ¥åŒæ—¶è°ƒç”¨ &lt;code>getData&lt;/code>Â å‡½æ•°ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:13:11 data&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥çœ‹å¾—åˆ°10ä¸ªè¯·æ±‚éƒ½æ˜¯èµ°çš„dbï¼Œå› ä¸ºcacheä¸­ä¸å­˜åœ¨è¯¥å€¼ï¼Œå½“æˆ‘ä»¬åˆ©ç”¨ä¸Š &lt;code>singlefligth&lt;/code>Â åŒ…ï¼Œ &lt;code>getData&lt;/code>Â æ”¹åŠ¨ä¸€ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;golang.org/x/sync/singleflight&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">g&lt;/span> &lt;span class="nx">singleflight&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Group&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//è·å–æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">getData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getDataFromCache&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">errorNotExist&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ¨¡æ‹Ÿä»dbä¸­è·å–æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">getDataFromDB&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//set cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//TOOD: set cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">data&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å¾—åˆ°åªæœ‰ä¸€ä¸ªè¯·æ±‚è¿›å…¥çš„dbï¼Œå…¶ä»–çš„è¯·æ±‚ä¹Ÿæ­£å¸¸è¿”å›äº†å€¼ï¼Œä»è€Œä¿æŠ¤äº†åç«¯DBã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 get key from database
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020/03/08 17:18:16 data&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>åŸç†è§£æ&lt;/h1>&lt;p>&lt;code>singleflight&lt;/code>Â åœ¨ &lt;code>golang.org/x/sync/singleflight&lt;/code>Â é¡¹ç›®ä¸‹ï¼Œå¯¹å¤–æä¾›äº†ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//Doæ–¹æ³•ï¼Œä¼ å…¥keyï¼Œä»¥åŠå›è°ƒå‡½æ•°ï¼Œå¦‚æœkeyç›¸åŒï¼Œfnæ–¹æ³•åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼ŒåŒæ­¥ç­‰å¾…&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//è¿”å›å€¼v:è¡¨ç¤ºfnæ‰§è¡Œç»“æœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//è¿”å›å€¼err:è¡¨ç¤ºfnçš„è¿”å›çš„err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//ç¬¬ä¸‰ä¸ªè¿”å›å€¼sharedï¼šè¡¨ç¤ºæ˜¯å¦æ˜¯çœŸå®fnè¿”å›çš„è¿˜æ˜¯ä»ä¿å­˜çš„map[key]è¿”å›çš„ï¼Œä¹Ÿå°±æ˜¯å…±äº«çš„&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Group&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">shared&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//DoChanæ–¹æ³•ç±»ä¼¼Doæ–¹æ³•ï¼Œåªæ˜¯è¿”å›çš„æ˜¯ä¸€ä¸ªchan&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Group&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">DoChan&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">Result&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æš‚æ—¶æœªç”¨åˆ°ï¼šè®¾è®¡Forget æ§åˆ¶keyå…³è”çš„å€¼æ˜¯å¦å¤±æ•ˆï¼Œé»˜è®¤ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•åªè¦fnæ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œå†…éƒ¨ç»´æŠ¤çš„fnçš„å€¼ä¹Ÿåˆ é™¤ï¼ˆå³å¹¶å‘ç»“æŸåå°±å¤±æ•ˆäº†ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Group&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Forget&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬æ‰“å¼€ä¸Šçœ‹ä¸‹ï¼Œæˆªå–äº†éƒ¨åˆ†ï¼š
&lt;a href="https://github.com/golang/sync/blob/master/singleflight/singleflight.go" target="_blank" rel="noopener">singleflight/singleflight.go&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">singleflight&lt;/span> &lt;span class="c1">// import &amp;#34;golang.org/x/sync/singleflight&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// call is an in-flight or completed singleflight.Do call&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">call&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// These fields are written once before the WaitGroup is done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// and are only read after the WaitGroup is done.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//valå’Œerrç”¨æ¥è®°å½•fnå‘æ”¾æ‰§è¡Œçš„è¿”å›å€¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">val&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// forgotten indicates whether Forget was called with this call&amp;#39;s key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// while the call was still in flight.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç”¨æ¥æ ‡è¯†fnæ–¹æ³•æ‰§è¡Œå®Œæˆä¹‹åç»“æœæ˜¯å¦ç«‹é©¬åˆ é™¤è¿˜æ˜¯ä¿ç•™åœ¨singleflightä¸­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">forgotten&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// These fields are read and written with the singleflight&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// mutex held before the WaitGroup is done, and are read but&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// not written after the WaitGroup is done.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//dups ç”¨æ¥è®°å½•fnæ–¹æ³•æ‰§è¡Œçš„æ¬¡æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dups&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ç”¨æ¥è®°å½•DoChanä¸­è°ƒç”¨æ¬¡æ•°ä»¥åŠéœ€è¦è¿”å›çš„æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">chans&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">Result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Group represents a class of work and forms a namespace in&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// which units of work can be executed with duplicate suppression.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Group&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">// protects m&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">m&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">call&lt;/span> &lt;span class="c1">// lazily initialized&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Do executes and returns the results of the given function, making&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// sure that only one execution is in-flight for a given key at a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// time. If a duplicate comes in, the duplicate caller waits for the&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// original to complete and receives the same results.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// The return value shared indicates whether v was given to multiple callers.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Group&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">shared&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//check mapæ˜¯å¦å·²ç»å­˜åœ¨å€¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dups&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">doCall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dups&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//æ‰§è¡Œfnæ–¹æ³•ï¼Œå¹¶ä¸”wg.Done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// doCall handles the single call for a key.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Group&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">doCall&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">call&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">val&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">fn&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨Doæ–¹æ³•ä¸­ä¸»è¦æ˜¯é€šè¿‡waitgroupæ¥æ§åˆ¶çš„ï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>åœ¨Groupä¸­è®¾ç½®äº†ä¸€ä¸ªmapï¼Œå¦‚æœkeyä¸å­˜åœ¨ï¼Œåˆ™å®ä¾‹åŒ–call(ç”¨æ¥ä¿å­˜å€¼ä¿¡æ¯)ï¼Œå¹¶å°†key=&amp;gt;callçš„å¯¹åº”å…³ç³»å­˜å…¥mapä¸­ï¼ˆé€šè¿‡mutexä¿è¯äº†å¹¶å‘å®‰å…¨ï¼‰&lt;/li>
&lt;li>å¦‚æœå·²ç»åœ¨è°ƒç”¨ä¸­åˆ™keyå·²ç»å­˜åœ¨mapï¼Œåˆ™wg.Wait&lt;/li>
&lt;li>åœ¨fnæ‰§è¡Œç»“æŸä¹‹åï¼ˆåœ¨doCallæ–¹æ³•ä¸­æ‰§è¡Œï¼‰æ‰§è¡Œwg.Done&lt;/li>
&lt;li>å¡åœ¨ç¬¬2æ­¥çš„æ–¹æ³•å¾—åˆ°æ‰§è¡Œï¼Œè¿”å›ç»“æœ&lt;/li>
&lt;/ol>
&lt;p>å…¶ä»–çš„DoChanæ–¹æ³•ä¹Ÿæ˜¯ç±»ä¼¼çš„é€»è¾‘ï¼Œåªæ˜¯è¿”å›çš„æ˜¯ä¸€ä¸ªchanã€‚&lt;/p>
&lt;p>&lt;strong>æ–‡ä¸­ç”¨åˆ°çš„å®ä¾‹ä»£ç æ”¾åœ¨githubä¸Šï¼š&lt;/strong>
&lt;a href="https://github.com/go-demo/singleflight-demo" target="_blank" rel="noopener">https://github.com/go-demo/singleflight-demo&lt;/a>&lt;/p></description></item><item><title>åˆ†ækubernetesä¸­çš„äº‹ä»¶æœºåˆ¶</title><link>/blog/202003/kubernetes-event/</link><pubDate>Tue, 03 Mar 2020 12:40:59 +0800</pubDate><guid>/blog/202003/kubernetes-event/</guid><description>
&lt;p>æˆ‘ä»¬é€šè¿‡ &lt;code>kubectl describe [èµ„æº]&lt;/code>Â å‘½ä»¤ï¼Œå¯ä»¥åœ¨çœ‹åˆ°Eventè¾“å‡ºï¼Œå¹¶ä¸”ç»å¸¸ä¾èµ–eventè¿›è¡Œé—®é¢˜å®šä½ï¼Œä»eventä¸­å¯ä»¥åˆ†ææ•´ä¸ªPODçš„è¿è¡Œè½¨è¿¹ï¼Œä¸ºæœåŠ¡çš„å®¢è§‚æµ‹æ€§æä¾›æ•°æ®æ¥æºï¼Œç”±æ­¤å¯è§ï¼Œeventåœ¨Kubernetesä¸­èµ·ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨ã€‚&lt;/p>
&lt;p>&lt;img src="/img/20200303/event.png" alt="eventå±•ç¤º" loading="lazy" />&lt;/p>
&lt;p>eventå¹¶ä¸åªæ˜¯kubeletä¸­éƒ½æœ‰çš„ï¼Œå…³äºeventçš„æ“ä½œè¢«å°è£…åœ¨&lt;a href="https://github.com/kubernetes/kubernetes/tree/v1.17.3/staging/src/k8s.io/client-go/tools/record" target="_blank" rel="noopener">client-go/tools/record&lt;/a>åŒ…ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨å†™å…¥è‡ªå®šä¹‰çš„eventã€‚&lt;/p>
&lt;p>ç°åœ¨è®©æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥æ­å¼€eventçš„é¢çº±ã€‚
&lt;a name="EBJdC">&lt;/a>&lt;/p>
&lt;h2>Eventå®šä¹‰&lt;span class="hx-absolute -hx-mt-20" id="eventå®šä¹‰">&lt;/span>
&lt;a href="#event%e5%ae%9a%e4%b9%89" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å…¶å®eventä¹Ÿæ˜¯ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå¹¶ä¸”é€šè¿‡apiserverå°†eventå­˜å‚¨åœ¨etcdä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ &lt;code>kubectl get event&lt;/code> å‘½ä»¤æŸ¥çœ‹å¯¹åº”çš„eventå¯¹è±¡ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªeventçš„yamlæ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">apiVersion&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">eventTime&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">null&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">firstTimestamp&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;2020-03-02T13:08:22Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">involvedObject&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">apiVersion&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">kind&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">Pod&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">example&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">foo&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">d75d8587c&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">xsf64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">namespace&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="k">default&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resourceVersion&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;429837&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">uid&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">ce611c62&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="nx">c1a&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="nx">bd8&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">9029&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">136&lt;/span>&lt;span class="nx">a1adf7de4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">kind&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">Event&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">lastTimestamp&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;2020-03-02T13:08:22Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">Pod&lt;/span> &lt;span class="nx">sandbox&lt;/span> &lt;span class="nx">changed&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">it&lt;/span> &lt;span class="nx">will&lt;/span> &lt;span class="nx">be&lt;/span> &lt;span class="nx">killed&lt;/span> &lt;span class="nx">and&lt;/span> &lt;span class="nx">re&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">created&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">metadata&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;2020-03-02T13:08:30Z&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">example&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">foo&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">d75d8587c&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">xsf64&lt;/span>&lt;span class="mf">.15&lt;/span>&lt;span class="nx">f87ea1df862b64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">namespace&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="k">default&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resourceVersion&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;479466&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">selfLink&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">api&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">namespaces&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="k">default&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">events&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">example&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">foo&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">d75d8587c&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">xsf64&lt;/span>&lt;span class="mf">.15&lt;/span>&lt;span class="nx">f87ea1df862b64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">uid&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="nx">fe6f72a&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">341&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="nx">c49&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">960&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">e185982d331a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">reason&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">SandboxChanged&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">reportingComponent&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">reportingInstance&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">source&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">component&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">kubelet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">host&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">minikube&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">Normal&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>**&lt;br />&lt;strong>ä¸»è¦å­—æ®µè¯´æ˜ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>involvedObjectï¼š è§¦å‘eventçš„èµ„æºç±»å‹&lt;/li>
&lt;li>lastTimestampï¼šæœ€åä¸€æ¬¡è§¦å‘çš„æ—¶é—´&lt;/li>
&lt;li>messageï¼šäº‹ä»¶è¯´æ˜&lt;/li>
&lt;li>metadata :eventçš„å…ƒä¿¡æ¯ï¼Œnameï¼Œnamespaceç­‰&lt;/li>
&lt;li>reasonï¼ševentçš„åŸå› &lt;/li>
&lt;li>sourceï¼šä¸ŠæŠ¥äº‹ä»¶çš„æ¥æºï¼Œæ¯”å¦‚kubeletä¸­çš„æŸä¸ªèŠ‚ç‚¹&lt;/li>
&lt;li>type:äº‹ä»¶ç±»å‹ï¼ŒNormalæˆ–Warning&lt;/li>
&lt;/ul>
&lt;p>eventå­—æ®µå®šä¹‰å¯ä»¥çœ‹è¿™é‡Œï¼š&lt;a href="https://github.com/kubernetes/kubernetes/blob/v1.17.3/staging/src/k8s.io/api/core/v1/types.go#L5078" target="_blank" rel="noopener">types.go#L5078&lt;/a>&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œæ•´ä¸ªeventæ˜¯å¦‚ä½•ä¸‹å…¥çš„ã€‚&lt;/p>
&lt;p>&lt;a name="MUouw">&lt;/a>&lt;/p>
&lt;h2>å†™å…¥äº‹ä»¶&lt;span class="hx-absolute -hx-mt-20" id="å†™å…¥äº‹ä»¶">&lt;/span>
&lt;a href="#%e5%86%99%e5%85%a5%e4%ba%8b%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>1ã€è¿™é‡Œä»¥kubeletä¸ºä¾‹ï¼Œçœ‹çœ‹æ˜¯å¦‚ä½•è¿›è¡Œäº‹ä»¶å†™å…¥çš„&lt;/p>
&lt;p>2ã€æ–‡ä¸­ä»£ç ä»¥Kubernetes 1.17.3ä¸ºä¾‹è¿›è¡Œåˆ†æ&lt;/p>
&lt;/blockquote>
&lt;p>å…ˆä»¥ä¸€å¹…å›¾æ¥çœ‹ä¸‹æ•´ä¸ªçš„å¤„ç†æµç¨‹
&lt;img src="/img/20200303/kubernetes-event.png" alt="eventå¤„ç†è¿‡ç¨‹" loading="lazy" />&lt;/p>
&lt;p>åˆ›å»ºæ“ä½œäº‹ä»¶çš„å®¢æˆ·ç«¯ï¼š&lt;br />&lt;a href="https://github.com/kubernetes/kubernetes/blob/v1.17.3/cmd/kubelet/app/server.go#L461" target="_blank" rel="noopener">kubelet/app/server.go#L461&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// makeEventRecorder sets up kubeDeps.Recorder if it&amp;#39;s nil. It&amp;#39;s a no-op otherwise.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">makeEventRecorder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeDeps&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">kubelet&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Dependencies&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">nodeName&lt;/span> &lt;span class="nx">types&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NodeName&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">kubeDeps&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Recorder&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//äº‹ä»¶å¹¿æ’­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eventBroadcaster&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewBroadcaster&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ›å»ºEventRecorder&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">kubeDeps&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Recorder&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">eventBroadcaster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewRecorder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">legacyscheme&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Scheme&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventSource&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Component&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">componentKubelet&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Host&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nodeName&lt;/span>&lt;span class="p">)})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å‘é€eventè‡³logè¾“å‡º&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eventBroadcaster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartLogging&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">Infof&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">kubeDeps&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventClient&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Sending events to api server.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å‘é€eventè‡³apiserver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eventBroadcaster&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartRecordingToSink&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">v1core&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventSinkImpl&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Interface&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">kubeDeps&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventClient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Events&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Warning&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;No api server defined - no events will be sent to API server.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>é€šè¿‡ &lt;code>makeEventRecorder&lt;/code>Â åˆ›å»ºäº† &lt;code>EventRecorder&lt;/code>Â å®ä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ªäº‹ä»¶å¹¿æ’­å™¨ï¼Œé€šè¿‡å®ƒæä¾›äº†StartLoggingå’ŒStartRecordingToSinkä¸¤ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œåˆ†åˆ«å°†eventå‘é€ç»™logå’Œapiserverã€‚&lt;br />&lt;code>NewRecorder&lt;/code>åˆ›å»ºäº† &lt;code>EventRecorder&lt;/code>Â çš„å®ä¾‹ï¼Œå®ƒæä¾›äº† &lt;code>Event&lt;/code>Â ï¼Œ&lt;code>Eventf&lt;/code>Â ç­‰æ–¹æ³•ä¾›äº‹ä»¶è®°å½•ã€‚&lt;/p>
&lt;p>&lt;a name="3klAc">&lt;/a>&lt;/p>
&lt;h3>EventBroadcaster&lt;span class="hx-absolute -hx-mt-20" id="eventbroadcaster">&lt;/span>
&lt;a href="#eventbroadcaster" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸‹EventBroadcasteræ¥å£å®šä¹‰ï¼š&lt;a href="https://github.com/kubernetes/kubernetes/blob/v1.17.3/staging/src/k8s.io/client-go/tools/record/event.go#L113" target="_blank" rel="noopener">event.go#L113&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// EventBroadcaster knows how to receive events and send them to any EventSink, watcher, or log.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">EventBroadcaster&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">StartEventWatcher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">eventHandler&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="nx">watch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">StartRecordingToSink&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sink&lt;/span> &lt;span class="nx">EventSink&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">watch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">StartLogging&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">logf&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">format&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}))&lt;/span> &lt;span class="nx">watch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">NewRecorder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">scheme&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Scheme&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">source&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EventSource&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">EventRecorder&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Shutdown&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…·ä½“å®ç°æ˜¯é€šè¿‡Â &lt;a href="https://github.com/kubernetes/kubernetes/blob/v1.17.3/staging/src/k8s.io/client-go/tools/record/event.go#L155" target="_blank" rel="noopener">eventBroadcasterImpl&lt;/a>Â  structæ¥å®ç°äº†å„ä¸ªæ–¹æ³•ã€‚&lt;/p>
&lt;p>å…¶ä¸­StartLogging å’Œ StartRecordingToSink å…¶å®å°±æ˜¯å®Œæˆäº†å¯¹äº‹ä»¶çš„æ¶ˆè´¹ï¼ŒEventRecorderå®ç°å¯¹äº‹ä»¶çš„å†™å…¥ï¼Œä¸­é—´é€šè¿‡channelå®ç°äº†ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€‚
&lt;a name="uX4b1">&lt;/a>&lt;/p>
&lt;h3>&lt;code>EventRecorder&lt;/code>&lt;span class="hx-absolute -hx-mt-20" id="eventrecorder">&lt;/span>
&lt;a href="#eventrecorder" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹&lt;code>EventRecorder&lt;/code>Â æ¥å£å®šä¹‰ï¼š&lt;a href="https://github.com/kubernetes/kubernetes/blob/v1.17.3/staging/src/k8s.io/client-go/tools/record/event.go#L88" target="_blank" rel="noopener">event.go#L88&lt;/a>ï¼Œæä¾›äº†ä¸€ä¸‹4ä¸ªæ–¹æ³•&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// EventRecorder knows how to record events on behalf of an EventSource.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">EventRecorder&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Event constructs an event from the given information and puts it in the queue for sending.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// &amp;#39;object&amp;#39; is the object this event is about. Event will make a reference-- or you may also&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// pass a reference to the object directly.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// &amp;#39;type&amp;#39; of this event, and can be one of Normal, Warning. New types could be added in future&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// &amp;#39;reason&amp;#39; is the reason this event is generated. &amp;#39;reason&amp;#39; should be short and unique; it&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// should be in UpperCamelCase format (starting with a capital letter). &amp;#34;reason&amp;#34; will be used&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// to automate handling of events, so imagine people writing switch statements to handle them.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// You want to make that easy.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// &amp;#39;message&amp;#39; is intended to be human readable.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// The resulting event will be created in the same namespace as the reference object.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Event&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">object&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reason&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">message&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Eventf is just like Event, but with Sprintf for the message field.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">Eventf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">object&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reason&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">messageFmt&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// PastEventf is just like Eventf, but with an option to specify the event&amp;#39;s &amp;#39;timestamp&amp;#39; field.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">PastEventf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">object&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timestamp&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reason&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">messageFmt&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// AnnotatedEventf is just like eventf, but with annotations attached&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">AnnotatedEventf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">object&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">annotations&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reason&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">messageFmt&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä¸»è¦å‚æ•°è¯´æ˜ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>object&lt;/code>Â å¯¹åº”eventèµ„æºå®šä¹‰ä¸­çš„ &lt;code>involvedObject&lt;/code>&lt;/li>
&lt;li>&lt;code>eventtype&lt;/code>Â å¯¹åº”eventèµ„æºå®šä¹‰ä¸­çš„typeï¼Œå¯é€‰Normalï¼ŒWarning.&lt;/li>
&lt;li>&lt;code>reason&lt;/code>Â ï¼šäº‹ä»¶åŸå› &lt;/li>
&lt;li>&lt;code>message&lt;/code>Â ï¼šäº‹ä»¶æ¶ˆæ¯&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸‹å½“æˆ‘ä»¬è°ƒç”¨ &lt;code>Event(object runtime.Object, eventtype, reason, message string)&lt;/code>Â çš„æ•´ä¸ªè¿‡ç¨‹ã€‚&lt;br />å‘ç°æœ€ç»ˆéƒ½è°ƒç”¨åˆ°äº† &lt;code>generateEvent&lt;/code>Â æ–¹æ³•ï¼š&lt;a href="https://github.com/kubernetes/kubernetes/blob/v1.17.3/staging/src/k8s.io/client-go/tools/record/event.go#L316" target="_blank" rel="noopener">event.go#L316&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">recorder&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">recorderImpl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">generateEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">object&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">annotations&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">timestamp&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reason&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">message&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>&lt;span class="p">..&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">event&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">recorder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">makeEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ref&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">annotations&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reason&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Source&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">recorder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">source&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// NOTE: events should be a non-blocking operation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">recorder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">watch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Added&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">event&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æœ€ç»ˆäº‹ä»¶åœ¨ä¸€ä¸ª &lt;code>goroutine&lt;/code>Â ä¸­é€šè¿‡è°ƒç”¨ &lt;code>recorder.Action&lt;/code>Â è¿›å…¥å¤„ç†ï¼Œè¿™é‡Œä¿è¯äº†æ¯æ¬¡è°ƒç”¨eventæ–¹æ³•éƒ½æ˜¯éé˜»å¡çš„ã€‚&lt;br />å…¶ä¸­ &lt;code>makeEvent&lt;/code>Â çš„ä½œç”¨ä¸»è¦æ˜¯æ„é€ äº†ä¸€ä¸ªeventå¯¹è±¡ï¼Œäº‹ä»¶nameæ ¹æ®InvolvedObjectä¸­çš„nameåŠ ä¸Šæ—¶é—´æˆ³ç”Ÿæˆï¼š&lt;/p>
&lt;blockquote>
&lt;p>æ³¨æ„çœ‹ï¼šå¯¹äºä¸€äº›énamespaceèµ„æºäº§ç”Ÿçš„eventï¼Œeventçš„namespaceæ˜¯default&lt;/p>
&lt;/blockquote>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">recorder&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">recorderImpl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">makeEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ref&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectReference&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">annotations&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">reason&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">message&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">recorder&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">()}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">namespace&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ref&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Namespace&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">namespace&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">namespace&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NamespaceDefault&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%v.%x&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ref&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">UnixNano&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Namespace&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">namespace&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Annotations&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">annotations&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">InvolvedObject&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ref&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Reason&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">reason&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">FirstTimestamp&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LastTimestamp&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">eventtype&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è¿›ä¸€æ­¥è·Ÿè¸ª&lt;code>Action&lt;/code>æ–¹æ³•ï¼Œ&lt;a href="https://github.com/kubernetes/apimachinery/blob/master/pkg/watch/mux.go#L188:23" target="_blank" rel="noopener">apimachinery/blob/master/pkg/watch/mux.go#L188:23&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Action distributes the given event among all watchers.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Broadcaster&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">action&lt;/span> &lt;span class="nx">EventType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">incoming&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">Event&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">action&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å°†eventå†™å…¥åˆ°äº†ä¸€ä¸ªchannelé‡Œé¢ã€‚&lt;br />&lt;strong>æ³¨æ„ï¼š&lt;/strong>&lt;br />è¿™ä¸ªActionæ–¹å¼æ˜¯&lt;a href="https://github.com/kubernetes/apimachinery/blob/master/pkg/watch/mux.go#L188:23" target="_blank" rel="noopener">apimachinery&lt;/a>åŒ…ä¸­çš„æ–¹æ³•ï¼Œå› ä¸ºå®ç°çš„sturtÂ &lt;code>recorderImpl&lt;/code>&lt;br />å°† &lt;code>*watch.Broadcaster&lt;/code>Â ä½œä¸ºä¸€ä¸ªåŒ¿åstructï¼Œå¹¶ä¸”åœ¨ &lt;code>NewRecorder&lt;/code>Â è¿›è¡Œ &lt;code>Broadcaster&lt;/code>Â èµ‹å€¼ï¼Œè¿™ä¸ª&lt;code>Broadcaster&lt;/code>å…¶å®å°±æ˜¯ &lt;code>eventBroadcasterImpl&lt;/code>Â ä¸­çš„&lt;code>Broadcaster&lt;/code>ã€‚&lt;/p>
&lt;p>åˆ°æ­¤ï¼ŒåŸºæœ¬æ¸…æ¥šäº†eventæœ€ç»ˆè¢«å†™å…¥åˆ°äº† &lt;code>Broadcaster&lt;/code>Â ä¸­çš„ &lt;code>incoming&lt;/code>Â channelä¸­ï¼Œä¸‹é¢çœ‹ä¸‹æ˜¯æ€ä¹ˆè¿›è¡Œæ¶ˆè´¹çš„ã€‚&lt;/p>
&lt;p>&lt;a name="Mwa4D">&lt;/a>&lt;/p>
&lt;h2>æ¶ˆè´¹äº‹ä»¶&lt;span class="hx-absolute -hx-mt-20" id="æ¶ˆè´¹äº‹ä»¶">&lt;/span>
&lt;a href="#%e6%b6%88%e8%b4%b9%e4%ba%8b%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åœ¨ &lt;code>makeEventRecorder&lt;/code>Â è°ƒç”¨çš„ &lt;code>StartLogging&lt;/code>Â å’Œ &lt;code>StartRecordingToSink&lt;/code>Â å…¶å®å°±æ˜¯å®Œæˆäº†å¯¹äº‹ä»¶çš„æ¶ˆè´¹ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>StartLogging&lt;/code>ç›´æ¥å°†eventè¾“å‡ºåˆ°æ—¥å¿—&lt;/li>
&lt;li>&lt;code>StartRecordingToSink&lt;/code>å°†äº‹ä»¶å†™å…¥åˆ°apiserver&lt;/li>
&lt;/ul>
&lt;p>ä¸¤ä¸ªæ–¹æ³•å†…éƒ¨éƒ½è°ƒç”¨äº† &lt;code>StartEventWatcher&lt;/code>Â æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥ä¸€ä¸ª &lt;code>eventHandler&lt;/code>Â æ–¹æ³•å¯¹eventè¿›è¡Œå¤„ç†&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">eventBroadcasterImpl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">StartEventWatcher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">eventHandler&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="nx">watch&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">watcher&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Watch&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">watchEvent&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">watcher&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ResultChan&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">event&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">watchEvent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Object&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// This is all local, so there&amp;#39;s no reason this should&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ever happen.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">eventHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">watcher&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­ &lt;code>watcher.ResultChan&lt;/code>Â æ–¹æ³•å°±æ‹¿åˆ°äº†äº‹ä»¶ï¼Œè¿™é‡Œæ˜¯åœ¨ä¸€ä¸ªgoroutineä¸­é€šè¿‡&lt;a href="https://github.com/kubernetes/apimachinery/blob/master/pkg/watch/mux.go#L204" target="_blank" rel="noopener">func (m *Broadcaster) loop() &lt;/a>==&amp;gt;&lt;a href="https://github.com/kubernetes/apimachinery/blob/master/pkg/watch/mux.go#L219" target="_blank" rel="noopener">func (m *Broadcaster) distribute(event Event)&lt;/a>Â æ–¹æ³•è°ƒç”¨å°†eventåˆå†™å…¥äº†&lt;a href="https://github.com/kubernetes/apimachinery/blob/master/pkg/watch/mux.go#L242" target="_blank" rel="noopener">broadcasterWatcher.result&lt;/a>&lt;/p>
&lt;p>ä¸»è¦çœ‹ä¸‹ &lt;code>StartRecordingToSink&lt;/code>Â æä¾›çš„çš„&lt;code>eventHandler&lt;/code>ï¼Œ &lt;code>recordToSink&lt;/code>Â æ–¹æ³•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">recordToSink&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sink&lt;/span> &lt;span class="nx">EventSink&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">event&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventCorrelator&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">EventCorrelator&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sleepDuration&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Make a copy before modification, because there could be multiple listeners.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Events are safe to copy like this.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eventCopy&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">event&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">event&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">eventCopy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">eventCorrelator&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">EventCorrelate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">event&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">utilruntime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Skip&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tries&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nf">recordEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sink&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Patch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventCorrelator&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tries&lt;/span>&lt;span class="o">++&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">tries&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="nx">maxTriesPerEvent&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Unable to write event &amp;#39;%#v&amp;#39; (retry limit exceeded!)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">event&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Randomize the first sleep so that various clients won&amp;#39;t all be&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// synced up if the master goes down.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç¬¬ä¸€æ¬¡é‡è¯•å¢åŠ éšæœºæ€§ï¼Œé˜²æ­¢ apiserver é‡å¯çš„æ—¶å€™æ‰€æœ‰çš„äº‹ä»¶éƒ½åœ¨åŒä¸€æ—¶é—´å‘é€äº‹ä»¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">tries&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sleepDuration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Float64&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sleepDuration&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­eventè¢«ç»è¿‡äº†ä¸€ä¸ª &lt;code>eventCorrelator.EventCorrelate(event)&lt;/code>Â æ–¹æ³•åšé¢„å¤„ç†ï¼Œä¸»è¦æ˜¯èšåˆç›¸åŒçš„äº‹ä»¶ï¼ˆé¿å…äº§ç”Ÿçš„äº‹ä»¶è¿‡å¤šï¼Œå¢åŠ  etcd å’Œ apiserver çš„å‹åŠ›ï¼Œä¹Ÿä¼šå¯¼è‡´æŸ¥çœ‹ pod äº‹ä»¶å¾ˆä¸æ¸…æ™°ï¼‰&lt;/p>
&lt;p>ä¸‹é¢ä¸€ä¸ªforå¾ªç¯å°±æ˜¯åœ¨è¿›è¡Œé‡è¯•ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°æ˜¯12æ¬¡ï¼Œè°ƒç”¨ &lt;code>recordEvent&lt;/code>Â  æ–¹æ³•æ‰çœŸæ­£å°†eventå†™å…¥åˆ°äº†apiserverã€‚&lt;/p>
&lt;p>&lt;a name="QwCYz">&lt;/a>&lt;/p>
&lt;h3>äº‹ä»¶å¤„ç†&lt;span class="hx-absolute -hx-mt-20" id="äº‹ä»¶å¤„ç†">&lt;/span>
&lt;a href="#%e4%ba%8b%e4%bb%b6%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>æˆ‘ä»¬æ¥çœ‹ä¸‹&lt;code>EventCorrelate&lt;/code>æ–¹æ³•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// EventCorrelate filters, aggregates, counts, and de-duplicates all incoming events&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">EventCorrelator&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">EventCorrelate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newEvent&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">EventCorrelateResult&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">newEvent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;event is nil&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">aggregateEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ckey&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">aggregator&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">EventAggregate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newEvent&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">observedEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">patch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">eventObserve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">aggregateEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ckey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">filterFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">observedEvent&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">EventCorrelateResult&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Skip&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">EventCorrelateResult&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">observedEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Patch&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">patch&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åˆ†åˆ«è°ƒç”¨äº† &lt;code>aggregator.EventAggregate&lt;/code>Â ï¼Œ&lt;code> logger.eventObserve&lt;/code>Â ï¼Œ &lt;code>filterFunc&lt;/code>Â ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ä½œç”¨æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>&lt;code>aggregator.EventAggregate&lt;/code>&lt;/strong>ï¼šèšåˆeventï¼Œå¦‚æœåœ¨æœ€è¿‘ 10 åˆ†é’Ÿå‡ºç°è¿‡ 10 ä¸ªç›¸ä¼¼çš„äº‹ä»¶ï¼ˆé™¤äº† message å’Œæ—¶é—´æˆ³ä¹‹å¤–å…¶ä»–å…³é”®å­—æ®µéƒ½ç›¸åŒçš„äº‹ä»¶ï¼‰ï¼Œaggregator ä¼šæŠŠå®ƒä»¬çš„ message è®¾ç½®ä¸ºÂ &lt;code>(combined from similar events)+event.Message&lt;/code>&lt;/li>
&lt;li>Â &lt;strong>&lt;code>logger.eventObserve&lt;/code>&lt;/strong>ï¼šå®ƒä¼šæŠŠç›¸åŒçš„äº‹ä»¶ä»¥åŠåŒ…å« &lt;code>aggregator&lt;/code>Â è¢«èšåˆäº†çš„ç›¸ä¼¼çš„äº‹ä»¶ï¼Œé€šè¿‡å¢åŠ  &lt;code>Count&lt;/code>Â å­—æ®µæ¥è®°å½•äº‹ä»¶å‘ç”Ÿäº†å¤šå°‘æ¬¡ã€‚&lt;/li>
&lt;li>&lt;strong>&lt;code>filterFunc&lt;/code>&lt;/strong>: è¿™é‡Œå®ç°äº†ä¸€ä¸ªåŸºäº&lt;strong>ä»¤ç‰Œæ¡¶çš„é™æµç®—æ³•&lt;/strong>ï¼Œå¦‚æœè¶…è¿‡è®¾å®šçš„é€Ÿç‡åˆ™ä¸¢å¼ƒï¼Œä¿è¯äº†apiserverçš„å®‰å…¨ã€‚&lt;/li>
&lt;/ol>
&lt;p>æˆ‘ä»¬ä¸»è¦æ¥çœ‹ä¸‹&lt;code>aggregator.EventAggregate&lt;/code>æ–¹æ³•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">EventAggregator&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">EventAggregate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newEvent&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">now&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">record&lt;/span> &lt;span class="nx">aggregateRecord&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// eventKey is the full cache key for this event&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//eventKey æ˜¯å°†é™¤äº†æ—¶é—´æˆ³å¤–æ‰€æœ‰å­—æ®µç»“åˆåœ¨ä¸€èµ·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eventKey&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getEventKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newEvent&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// aggregateKey is for the aggregate event, if one is needed.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//aggregateKey æ˜¯é™¤äº†messageå’Œæ—¶é—´æˆ³å¤–çš„å­—æ®µç»“åˆåœ¨ä¸€èµ·ï¼ŒlocalKey æ˜¯message&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">aggregateKey&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">localKey&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">keyFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newEvent&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Do we have a record of similar events in our cache?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ä»cacheä¸­æ ¹æ®aggregateKeyæŸ¥è¯¢æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ˜¯ç›¸åŒæˆ–è€…ç›¸ç±»ä¼¼çš„äº‹ä»¶ä¼šè¢«æ”¾å…¥cacheä¸­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">found&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">aggregateKey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">found&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">record&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">aggregateRecord&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ¤æ–­ä¸Šæ¬¡äº‹ä»¶äº§ç”Ÿçš„æ—¶é—´æ˜¯å¦è¶…è¿‡10åˆ†é’Ÿï¼Œå¦‚ä½•æ“ä½œåˆ™é‡æ–°ç”Ÿæˆä¸€ä¸ªlocalKeysé›†åˆï¼ˆé›†åˆä¸­å­˜æ”¾messageï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">maxInterval&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">maxIntervalInSeconds&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">interval&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lastTimestamp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">interval&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nx">maxInterval&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">record&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">aggregateRecord&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">localKeys&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">sets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewString&lt;/span>&lt;span class="p">()}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Write the new event into the aggregation record and put it on the cache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å°†locakKeyä¹Ÿå°±æ˜¯messageæ”¾å…¥é›†åˆä¸­ï¼Œå¦‚æœmessageç›¸åŒå°±æ˜¯è¦†ç›–äº†&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">localKeys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">localKey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lastTimestamp&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">now&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">aggregateKey&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">record&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// If we are not yet over the threshold for unique events, don&amp;#39;t correlate them&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ¤æ–­localKeysé›†åˆä¸­å­˜æ”¾çš„ç±»ä¼¼äº‹ä»¶æ˜¯å¦è¶…è¿‡10ä¸ªï¼Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">uint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">localKeys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Len&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">maxEvents&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">newEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">eventKey&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// do not grow our local key set any larger than max&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">record&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">localKeys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">PopAny&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// create a new aggregate event, and return the aggregateKey as the cache key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// (so that it can be overwritten.)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">eventCopy&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">v1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Event&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%v.%x&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">newEvent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InvolvedObject&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">UnixNano&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Namespace&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">newEvent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Namespace&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Count&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">FirstTimestamp&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">InvolvedObject&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">newEvent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InvolvedObject&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LastTimestamp&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿™é‡Œä¼šå¯¹messageåŠ ä¸ªå‰ç¼€ï¼š(combined from similar events):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Message&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">messageFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newEvent&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">newEvent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Type&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Reason&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">newEvent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Reason&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Source&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">newEvent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Source&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">eventCopy&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">aggregateKey&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>aggregator.EventAggregate&lt;/code>æ–¹æ³•ä¸­å…¶å®å°±æ˜¯åˆ¤æ–­äº†é€šè¿‡cacheå’ŒlocalKeysåˆ¤æ–­äº‹ä»¶æ˜¯å¦ç›¸ä¼¼ï¼Œå¦‚æœæœ€è¿‘ 10 åˆ†é’Ÿå‡ºç°è¿‡ 10 ä¸ªç›¸ä¼¼çš„äº‹ä»¶å°±åˆå¹¶å¹¶åŠ ä¸Šå‰ç¼€ï¼Œåç»­é€šè¿‡&lt;code>logger.eventObserve&lt;/code>æ–¹æ³•è¿›è¡Œcountç´¯åŠ ï¼Œå¦‚æœmessageä¹Ÿç›¸åŒï¼Œè‚¯å®šå°±æ˜¯ç›´æ¥count++ã€‚&lt;/p>
&lt;p>&lt;a name="yEk1J">&lt;/a>&lt;/p>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å¥½äº†ï¼Œeventå¤„ç†çš„æ•´ä¸ªæµç¨‹åŸºæœ¬å°±æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æ¦‚æ‹¬ä¸€ä¸‹ï¼Œå¯ä»¥ç»“åˆæ–‡ä¸­çš„å›¾å¯¹æ¯”ä¸€èµ·çœ‹ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>åˆ›å»º &lt;code>EventRecorder&lt;/code>Â å¯¹è±¡ï¼Œé€šè¿‡å…¶æä¾›çš„ &lt;code>Event&lt;/code>Â ç­‰æ–¹æ³•ï¼Œåˆ›å»ºå¥½eventå¯¹è±¡&lt;/li>
&lt;li>å°†åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡å‘é€ç»™ &lt;code>EventBroadcaster&lt;/code>Â ä¸­çš„channelä¸­&lt;/li>
&lt;li>&lt;code>EventBroadcaster&lt;/code>Â é€šè¿‡åå°è¿è¡Œçš„goroutineï¼Œä»ç®¡é“ä¸­å–å‡ºäº‹ä»¶ï¼Œå¹¶å¹¿æ’­ç»™æå‰æ³¨å†Œå¥½çš„handlerå¤„ç†&lt;/li>
&lt;li>å½“è¾“å‡ºlogçš„handleræ”¶åˆ°äº‹ä»¶å°±ç›´æ¥æ‰“å°äº‹ä»¶&lt;/li>
&lt;li>å½“ &lt;code>EventSink&lt;/code>Â handleræ”¶åˆ°å¤„ç†äº‹ä»¶å°±é€šè¿‡é¢„å¤„ç†ä¹‹åå°†äº‹ä»¶å‘é€ç»™apiserver&lt;/li>
&lt;li>å…¶ä¸­é¢„å¤„ç†åŒ…å«ä¸‰ä¸ªåŠ¨ä½œï¼Œ1ã€é™æµ 2ã€èšåˆ 3ã€è®¡æ•°&lt;/li>
&lt;li>apiserveræ”¶åˆ°äº‹ä»¶å¤„ç†ä¹‹åå°±å­˜å‚¨åœ¨etcdä¸­&lt;/li>
&lt;/ol>
&lt;p>å›é¡¾eventçš„æ•´ä¸ªæµç¨‹ï¼Œå¯ä»¥çœ‹åˆ°eventå¹¶ä¸æ˜¯ä¿è¯100%äº‹ä»¶å†™å…¥ï¼ˆä»é¢„å¤„ç†çš„è¿‡ç¨‹æ¥çœ‹ï¼‰ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†åç«¯æœåŠ¡etcdçš„å¯ç”¨æ€§ï¼Œå› ä¸ºeventäº‹ä»¶åœ¨æ•´ä¸ªé›†ç¾¤ä¸­äº§ç”Ÿæ˜¯éå¸¸é¢‘ç¹çš„ï¼Œå°¤å…¶åœ¨æœåŠ¡ä¸ç¨³å®šçš„æ—¶å€™ï¼Œè€Œç›¸æ¯”Deployment,Podç­‰å…¶ä»–èµ„æºï¼Œåˆæ²¡é‚£ä¹ˆçš„é‡è¦ã€‚æ‰€ä»¥è¿™é‡Œåšäº†ä¸ªå–èˆã€‚&lt;/p>
&lt;p>&lt;strong>å‚è€ƒæ–‡æ¡£ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://cizixs.com/2017/06/22/kubelet-source-code-analysis-part4-event/" target="_blank" rel="noopener">https://cizixs.com/2017/06/22/kubelet-source-code-analysis-part4-event/&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>åˆ©ç”¨Kubernetesä¸­çš„leaderelectionå®ç°ç»„ä»¶é«˜å¯ç”¨</title><link>/blog/202002/kubernetes-leaderelection/</link><pubDate>Sat, 15 Feb 2020 00:00:00 +0000</pubDate><guid>/blog/202002/kubernetes-leaderelection/</guid><description>
&lt;p>åœ¨Kubernetesä¸­ï¼Œé€šå¸¸kube-schdulerå’Œkube-controller-manageréƒ½æ˜¯å¤šå‰¯æœ¬è¿›è¡Œéƒ¨ç½²çš„æ¥ä¿è¯é«˜å¯ç”¨ï¼Œè€ŒçœŸæ­£åœ¨å·¥ä½œçš„å®ä¾‹å…¶å®åªæœ‰ä¸€ä¸ªã€‚è¿™é‡Œå°±åˆ©ç”¨åˆ° &lt;code>leaderelection&lt;/code>Â çš„é€‰ä¸»æœºåˆ¶ï¼Œä¿è¯leaderæ˜¯å¤„äºå·¥ä½œçŠ¶æ€ï¼Œå¹¶ä¸”åœ¨leaderæŒ‚æ‰ä¹‹åï¼Œä»å…¶ä»–èŠ‚ç‚¹é€‰å–æ–°çš„leaderä¿è¯ç»„ä»¶æ­£å¸¸å·¥ä½œã€‚&lt;/p>
&lt;p>ä¸å•å•åªæ˜¯k8sä¸­çš„è¿™ä¸¤ä¸ªç»„ä»¶ç”¨åˆ°ï¼Œåœ¨å…¶ä»–æœåŠ¡ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™ä¸ªåŒ…çš„ä½¿ç”¨ï¼Œæ¯”å¦‚&lt;a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/" target="_blank" rel="noopener">cluster-autoscaler&lt;/a>ç­‰éƒ½èƒ½çœ‹å¾—åˆ°è¿™ä¸ªåŒ…çš„ï¼Œä»Šå¤©å°±æ¥çœ‹çœ‹è¿™ä¸ªåŒ…çš„ä½¿ç”¨ä»¥åŠå®ƒå†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚&lt;/p>
&lt;h2>ä½¿ç”¨&lt;span class="hx-absolute -hx-mt-20" id="ä½¿ç”¨">&lt;/span>
&lt;a href="#%e4%bd%bf%e7%94%a8" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•ä½¿ç”¨çš„ä¾‹å­ï¼Œç¼–è¯‘å®Œæˆä¹‹ååŒæ—¶å¯åŠ¨å¤šä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨å·¥ä½œï¼Œå½“æŠŠleaderè¿›ç¨‹killæ‰ä¹‹åï¼Œä¼šé‡æ–°é€‰ä¸¾å‡ºä¸€ä¸ªleaderè¿›è¡Œå·¥ä½œï¼Œå³æ‰§è¡Œå…¶ä¸­çš„ &lt;code>run&lt;/code>Â æ–¹æ³•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">ä¾‹å­æ¥æºäºclient-goä¸­çš„exampleåŒ…ä¸­
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;os/signal&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;syscall&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;github.com/google/uuid&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">metav1&lt;/span> &lt;span class="s">&amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">clientset&lt;/span> &lt;span class="s">&amp;#34;k8s.io/client-go/kubernetes&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;k8s.io/client-go/rest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;k8s.io/client-go/tools/clientcmd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;k8s.io/client-go/tools/leaderelection&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;k8s.io/client-go/tools/leaderelection/resourcelock&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;k8s.io/klog&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">buildConfig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeconfig&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">rest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">kubeconfig&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">clientcmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BuildConfigFromFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">kubeconfig&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rest&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">InClusterConfig&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">InitFlags&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">kubeconfig&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">leaseLockName&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">leaseLockNamespace&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">id&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringVar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">kubeconfig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;kubeconfig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;absolute path to the kubeconfig file&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringVar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">uuid&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">&amp;#34;the holder identity name&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringVar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">leaseLockName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;lease-lock-name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;the lease lock resource name&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringVar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">leaseLockNamespace&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;lease-lock-namespace&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;the lease lock resource namespace&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">leaseLockName&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unable to get lease lock resource name (missing lease-lock-name flag).&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">leaseLockNamespace&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unable to get lease lock resource namespace (missing lease-lock-namespace flag).&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// leader election uses the Kubernetes API by writing to a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// lock object, which can be a LeaseLock object (preferred),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// a ConfigMap, or an Endpoints (deprecated) object.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Conflicting writes are detected and each client handles those actions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// independently.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">config&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">buildConfig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">kubeconfig&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">client&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">clientset&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewForConfigOrDie&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">run&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// complete your controller loop here&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Controller loop...&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">select&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// use a Go context so we can tell the leaderelection code when we&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// want to step down&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cancel&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithCancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nf">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// listen for interrupts or the Linux SIGTERM signal and cancel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// our context, which the leader election code will observe and&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// step down&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ch&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Signal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">signal&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Notify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interrupt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGTERM&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">ch&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Received termination, signaling shutdown&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// we use the Lease lock type since edits to Leases are less common&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// and fewer objects in the cluster watch &amp;#34;all Leases&amp;#34;.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æŒ‡å®šé”çš„èµ„æºå¯¹è±¡ï¼Œè¿™é‡Œä½¿ç”¨äº†Leaseèµ„æºï¼Œè¿˜æ”¯æŒconfigmapï¼Œendpointï¼Œæˆ–è€…multilock(å³å¤šç§é…åˆä½¿ç”¨)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">lock&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">resourcelock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaseLock&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaseMeta&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ObjectMeta&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">leaseLockName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Namespace&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">leaseLockNamespace&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">CoordinationV1&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LockConfig&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">resourcelock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResourceLockConfig&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Identity&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// start the leader election code loop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">leaderelection&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RunOrDie&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">leaderelection&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaderElectionConfig&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Lock&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">lock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// IMPORTANT: you MUST ensure that any code you have that&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// is protected by the lease must terminate **before**&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// you call cancel. Otherwise, you could have a background&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// loop still running and another process could&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// get elected before your background loop finished, violating&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// the stated goal of the lease.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReleaseOnCancel&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaseDuration&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">60&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="c1">//ç§Ÿçº¦æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">RenewDeadline&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">15&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="c1">//æ›´æ–°ç§Ÿçº¦çš„&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">RetryPeriod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="c1">//éleaderèŠ‚ç‚¹é‡è¯•æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Callbacks&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">leaderelection&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaderCallbacks&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">OnStartedLeading&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å˜ä¸ºleaderæ‰§è¡Œçš„ä¸šåŠ¡ä»£ç &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// we&amp;#39;re notified when we start - this is where you would&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// usually put your code&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">OnStoppedLeading&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è¿›ç¨‹é€€å‡º&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// we can do cleanup here&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;leader lost: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">OnNewLeader&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">identity&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å½“äº§ç”Ÿæ–°çš„leaderåæ‰§è¡Œçš„æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// we&amp;#39;re notified when new leader elected&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">identity&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">id&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// I just got the lock&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;new leader elected: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">identity&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…³é”®å¯åŠ¨å‚æ•°è¯´æ˜ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">kubeconfig: æŒ‡å®škubeconfigæ–‡ä»¶åœ°å€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lease-lock-nameï¼šæŒ‡å®šlockçš„åç§°
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lease-lock-namespaceï¼šæŒ‡å®šlockå­˜å‚¨çš„namespace
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">id: ä¾‹å­ä¸­æä¾›çš„åŒºåˆ«å‚æ•°ï¼Œç”¨äºåŒºåˆ†å®ä¾‹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">logtostderrï¼šklogæä¾›çš„å‚æ•°ï¼ŒæŒ‡å®šlogè¾“å‡ºåˆ°æ§åˆ¶å°
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">v: æŒ‡å®šæ—¥å¿—è¾“å‡ºçº§åˆ«&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>åŒæ—¶å¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹ï¼š&lt;/strong>&lt;br />&lt;strong>å¯åŠ¨è¿›ç¨‹1&lt;/strong>ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">go run main.go -kubeconfig&lt;span class="o">=&lt;/span>/Users/silenceper/.kube/config -logtostderr&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span> -lease-lock-name&lt;span class="o">=&lt;/span>example -lease-lock-namespace&lt;span class="o">=&lt;/span>default -id&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> -v&lt;span class="o">=&lt;/span>&lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:56:37.049658 &lt;span class="m">48045&lt;/span> leaderelection.go:242&lt;span class="o">]&lt;/span> attempting to acquire leader lease default/example...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:56:37.080368 &lt;span class="m">48045&lt;/span> leaderelection.go:252&lt;span class="o">]&lt;/span> successfully acquired lease default/example
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:56:37.080437 &lt;span class="m">48045&lt;/span> main.go:87&lt;span class="o">]&lt;/span> Controller loop...&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>å¯åŠ¨è¿›ç¨‹2ï¼š&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">âœ leaderelection git:&lt;span class="o">(&lt;/span>master&lt;span class="o">)&lt;/span> âœ— go run main.go -kubeconfig&lt;span class="o">=&lt;/span>/Users/silenceper/.kube/config -logtostderr&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span> -lease-lock-name&lt;span class="o">=&lt;/span>example -lease-lock-namespace&lt;span class="o">=&lt;/span>default -id&lt;span class="o">=&lt;/span>&lt;span class="m">2&lt;/span> -v&lt;span class="o">=&lt;/span>&lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:57:35.870051 &lt;span class="m">48791&lt;/span> leaderelection.go:242&lt;span class="o">]&lt;/span> attempting to acquire leader lease default/example...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:57:35.894735 &lt;span class="m">48791&lt;/span> leaderelection.go:352&lt;span class="o">]&lt;/span> lock is held by &lt;span class="m">1&lt;/span> and has not yet expired
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:57:35.894769 &lt;span class="m">48791&lt;/span> leaderelection.go:247&lt;span class="o">]&lt;/span> failed to acquire lease default/example
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:57:35.894790 &lt;span class="m">48791&lt;/span> main.go:151&lt;span class="o">]&lt;/span> new leader elected: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:57:44.532991 &lt;span class="m">48791&lt;/span> leaderelection.go:352&lt;span class="o">]&lt;/span> lock is held by &lt;span class="m">1&lt;/span> and has not yet expired
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 19:57:44.533028 &lt;span class="m">48791&lt;/span> leaderelection.go:247&lt;span class="o">]&lt;/span> failed to acquire lease default/example&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥id=1çš„è¿›ç¨‹æŒæœ‰é”ï¼Œå¹¶ä¸”è¿è¡Œçš„ç¨‹åºï¼Œè€Œid=2çš„è¿›ç¨‹è¡¨ç¤ºæ— æ³•è·å–åˆ°é”ï¼Œåœ¨ä¸æ–­çš„è¿›ç¨‹å°è¯•ã€‚&lt;/p>
&lt;p>ç°åœ¨killæ‰id=1è¿›ç¨‹ï¼Œåœ¨ç­‰å¾…locké‡Šæ”¾ä¹‹åï¼ˆæœ‰ä¸ªLeaseDurationæ—¶é—´ï¼‰ï¼Œleaderå˜ä¸ºid=2çš„è¿›ç¨‹æ‰§è¡Œå·¥ä½œ&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">I0215 20:01:41.489300 &lt;span class="m">48791&lt;/span> leaderelection.go:252&lt;span class="o">]&lt;/span> successfully acquired lease default/example
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I0215 20:01:41.489577 &lt;span class="m">48791&lt;/span> main.go:87&lt;span class="o">]&lt;/span> Controller loop...&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;a name="LypZI">&lt;/a>&lt;/p>
&lt;h2>æ·±å…¥ç†è§£&lt;span class="hx-absolute -hx-mt-20" id="æ·±å…¥ç†è§£">&lt;/span>
&lt;a href="#%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åŸºæœ¬åŸç†å…¶å®å°±æ˜¯åˆ©ç”¨é€šè¿‡Kubernetesä¸­ &lt;code>configmap&lt;/code>Â ï¼ŒÂ &lt;code>endpoints&lt;/code>Â æˆ–è€… &lt;code>lease&lt;/code>Â èµ„æºå®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼ŒæŠ¢(acqure)åˆ°é”çš„èŠ‚ç‚¹æˆä¸ºleaderï¼Œå¹¶ä¸”å®šæœŸæ›´æ–°ï¼ˆrenewï¼‰ã€‚å…¶ä»–è¿›ç¨‹ä¹Ÿåœ¨ä¸æ–­çš„å°è¯•è¿›è¡ŒæŠ¢å ï¼ŒæŠ¢å ä¸åˆ°åˆ™ç»§ç»­ç­‰å¾…ä¸‹æ¬¡å¾ªç¯ã€‚å½“leaderèŠ‚ç‚¹æŒ‚æ‰ä¹‹åï¼Œç§Ÿçº¦åˆ°æœŸï¼Œå…¶ä»–èŠ‚ç‚¹å°±æˆä¸ºæ–°çš„leaderã€‚&lt;/p>
&lt;p>&lt;a name="iQapE">&lt;/a>&lt;/p>
&lt;h3>å…¥å£&lt;span class="hx-absolute -hx-mt-20" id="å…¥å£">&lt;/span>
&lt;a href="#%e5%85%a5%e5%8f%a3" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>é€šè¿‡ &lt;code>leaderelection.RunOrDie&lt;/code>Â å¯åŠ¨ï¼Œ&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">RunOrDie&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">lec&lt;/span> &lt;span class="nx">LeaderElectionConfig&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewLeaderElector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">lec&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">lec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WatchDog&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">lec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WatchDog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetLeaderElection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">le&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä¼ å…¥å‚æ•° &lt;code>LeaderElectionConfig&lt;/code>Â ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">LeaderElectionConfig&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Lock çš„ç±»å‹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Lock&lt;/span> &lt;span class="nx">rl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Interface&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æŒæœ‰é”çš„æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaseDuration&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åœ¨æ›´æ–°ç§Ÿçº¦çš„è¶…æ—¶æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">RenewDeadline&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ç«äº‰è·å–é”çš„æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">RetryPeriod&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//çŠ¶æ€å˜åŒ–æ—¶æ‰§è¡Œçš„å‡½æ•°ï¼Œæ”¯æŒä¸‰ç§ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//1ã€OnStartedLeading å¯åŠ¨æ˜¯æ‰§è¡Œçš„ä¸šåŠ¡ä»£ç &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//2ã€OnStoppedLeading leaderåœæ­¢æ‰§è¡Œçš„æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//3ã€OnNewLeader å½“äº§ç”Ÿæ–°çš„leaderåæ‰§è¡Œçš„æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Callbacks&lt;/span> &lt;span class="nx">LeaderCallbacks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿›è¡Œç›‘æ§æ£€æŸ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// WatchDog is the associated health checker&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// WatchDog may be null if its not needed/configured.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">WatchDog&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HealthzAdaptor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//leaderé€€å‡ºæ—¶ï¼Œæ˜¯å¦æ‰§è¡Œreleaseæ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ReleaseOnCancel&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Name is the name of the resource lock for debugging&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>LeaderElectionConfig.lock&lt;/code>Â &lt;strong>æ”¯æŒä¿å­˜åœ¨ä»¥ä¸‹ä¸‰ç§èµ„æºä¸­ï¼š&lt;/strong>&lt;br />&lt;code>configmap&lt;/code>Â &lt;br />&lt;code>endpoint&lt;/code>Â &lt;br />&lt;code>lease&lt;/code>Â &lt;br />åŒ…ä¸­è¿˜æä¾›äº†ä¸€ä¸ª &lt;code>multilock&lt;/code>Â ï¼Œå³å¯ä»¥è¿›è¡Œé€‰æ‹©ä¸¤ç§ï¼Œå½“å…¶ä¸­ä¸€ç§ä¿å­˜å¤±è´¥æ—¶ï¼Œé€‰æ‹©ç¬¬äºŒå¼ &lt;br />å¯ä»¥åœ¨&lt;a href="https://github.com/kubernetes/client-go/blob/master/tools/leaderelection/resourcelock/interface.go#L121" target="_blank" rel="noopener">interface.go&lt;/a>ä¸­çœ‹åˆ°ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">switch&lt;/span> &lt;span class="nx">lockType&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nx">EndpointsResourceLock&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="c1">//ä¿å­˜åœ¨endpoints&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">endpointsLock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nx">ConfigMapsResourceLock&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="c1">//ä¿å­˜åœ¨configmaps&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">configmapLock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nx">LeasesResourceLock&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="c1">//ä¿å­˜åœ¨leases&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">leaseLock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nx">EndpointsLeasesResourceLock&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="c1">//ä¼˜å…ˆå°è¯•ä¿å­˜åœ¨endpointå¤±è´¥æ—¶ä¿å­˜åœ¨lease&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">MultiLock&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Primary&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">endpointsLock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Secondary&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">leaseLock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nx">ConfigMapsLeasesResourceLock&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="c1">//ä¼˜å…ˆå°è¯•ä¿å­˜åœ¨configmapï¼Œå¤±è´¥æ—¶ä¿å­˜åœ¨lease&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">MultiLock&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Primary&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">configmapLock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Secondary&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">leaseLock&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Invalid lock-type %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">lockType&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä»¥leaseèµ„æºå¯¹è±¡ä¸ºä¾‹ï¼Œå¯ä»¥åœ¨æŸ¥çœ‹åˆ°ä¿å­˜çš„å†…å®¹:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">âœ ~ kubectl get lease example -n default -o yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">coordination.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Lease&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">creationTimestamp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2020-02-15T11:56:37Z&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resourceVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;210675&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">selfLink&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/apis/coordination.k8s.io/v1/namespaces/default/leases/example&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uid&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">a3470a06-6fc3-42dc-8242-9d6cebdf5315&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">acquireTime&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2020-02-15T12:01:41.476971Z&amp;#34;&lt;/span>&lt;span class="l">//è·å¾—é”æ—¶é—´&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">holderIdentity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="l">//æŒæœ‰é”è¿›ç¨‹çš„æ ‡è¯†&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">leaseDurationSeconds&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">60&lt;/span>&lt;span class="l">//leaseç§Ÿçº¦&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">leaseTransitions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="l">//leaderæ›´æ¢æ¬¡æ•°&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">renewTime&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2020-02-15T12:05:37.134655Z&amp;#34;&lt;/span>&lt;span class="l">//æ›´æ–°ç§Ÿçº¦çš„æ—¶é—´&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…³æ³¨å…¶specä¸­çš„å­—æ®µï¼Œåˆ†åˆ«è¿›è¡Œæ ‡æ³¨,å¯¹åº”ç»“æ„ä½“å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">LeaderElectionRecord&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">HolderIdentity&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;holderIdentity&amp;#34;`&lt;/span>&lt;span class="c1">//æŒæœ‰é”è¿›ç¨‹çš„æ ‡è¯†ï¼Œä¸€èˆ¬å¯ä»¥åˆ©ç”¨ä¸»æœºå&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaseDurationSeconds&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;leaseDurationSeconds&amp;#34;`&lt;/span>&lt;span class="c1">// lockçš„ç§Ÿçº¦&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AcquireTime&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span> &lt;span class="s">`json:&amp;#34;acquireTime&amp;#34;`&lt;/span>&lt;span class="c1">//æŒæœ‰é”çš„æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">RenewTime&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span> &lt;span class="s">`json:&amp;#34;renewTime&amp;#34;`&lt;/span>&lt;span class="c1">//æ›´æ–°æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaderTransitions&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;leaderTransitions&amp;#34;`&lt;/span>&lt;span class="c1">//leaderæ›´æ¢çš„æ¬¡æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;a name="cGTSG">&lt;/a>&lt;/p>
&lt;h3>è·å–çš„é”ä»¥åŠæ›´æ–°é”&lt;span class="hx-absolute -hx-mt-20" id="è·å–çš„é”ä»¥åŠæ›´æ–°é”">&lt;/span>
&lt;a href="#%e8%8e%b7%e5%8f%96%e7%9a%84%e9%94%81%e4%bb%a5%e5%8f%8a%e6%9b%b4%e6%96%b0%e9%94%81" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>Runæ–¹æ³•ä¸­åŒ…å«äº†è·å–é”ä»¥åŠæ›´æ–°é”çš„å…¥å£&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Run starts the leader election loop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">le&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">LeaderElector&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿›è¡Œé€€å‡ºæ‰§è¡Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleCrash&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åœæ­¢æ—¶æ‰§è¡Œå›è°ƒæ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Callbacks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OnStoppedLeading&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ä¸æ–­çš„è¿›è¡Œè·å¾—é”ï¼Œå¦‚æœè·å¾—é”æˆåŠŸåˆ™æ‰§è¡Œåé¢çš„æ–¹æ³•ï¼Œå¦åˆ™ä¸æ–­çš„è¿›è¡Œé‡è¯•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">acquire&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="c1">// ctx signalled done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cancel&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithCancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nf">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è·å–é”æˆåŠŸï¼Œå½“å‰è¿›ç¨‹å˜ä¸ºleaderï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°ä¸­çš„ä¸šåŠ¡ä»£ç &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Callbacks&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">OnStartedLeading&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ä¸æ–­çš„å¾ªç¯è¿›è¡Œè¿›è¡Œç§Ÿçº¦çš„æ›´æ–°ï¼Œä¿è¯é”ä¸€ç›´è¢«å½“å‰è¿›è¡ŒæŒæœ‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">renew&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>&lt;code>le.acquire&lt;/code> å’Œ &lt;code>le.renew&lt;/code> å†…éƒ¨éƒ½æ˜¯è°ƒç”¨äº† &lt;code>le.tryAcquireOrRenew&lt;/code> å‡½æ•°ï¼Œåªæ˜¯å¯¹äºè¿”å›ç»“æœçš„å¤„ç†ä¸ä¸€æ ·ã€‚&lt;/strong>&lt;/p>
&lt;p>&lt;code>le.acquire&lt;/code> å¯¹äº &lt;code>le.tryAcquireOrRenew&lt;/code> è¿”å›æˆåŠŸåˆ™é€€å‡ºï¼Œå¤±è´¥åˆ™ç»§ç»­ã€‚&lt;/p>
&lt;p>&lt;code>le.renew&lt;/code> åˆ™ç›¸åï¼ŒæˆåŠŸåˆ™ç»§ç»­ï¼Œå¤±è´¥åˆ™é€€å‡ºã€‚&lt;/p>
&lt;p>æˆ‘ä»¬æ¥çœ‹çœ‹ &lt;code>tryAcquireOrRenew&lt;/code>Â æ–¹æ³•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">le&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">LeaderElector&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">tryAcquireOrRenew&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">now&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">metav1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//é”èµ„æºå¯¹è±¡å†…å®¹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">leaderElectionRecord&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaderElectionRecord&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">HolderIdentity&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Identity&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="c1">//å”¯ä¸€æ ‡è¯†&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">LeaseDurationSeconds&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaseDuration&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">RenewTime&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AcquireTime&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 1. obtain or create the ElectionRecord&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç¬¬ä¸€æ­¥ï¼šä»k8sèµ„æºä¸­è·å–åŸæœ‰çš„é”&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">oldLeaderElectionRecord&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">oldLeaderElectionRawRecord&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotFound&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error retrieving resource lock %v: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Describe&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//èµ„æºå¯¹è±¡ä¸å­˜åœ¨ï¼Œè¿›è¡Œé”èµ„æºåˆ›å»º&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">leaderElectionRecord&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error initially creating leader election record: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedRecord&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">leaderElectionRecord&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedTime&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 2. Record obtained, check the Identity &amp;amp; Time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç¬¬äºŒæ­¥ï¼Œå¯¹æ¯”å­˜å‚¨åœ¨k8sä¸­çš„é”èµ„æºä¸ä¸Šä¸€æ¬¡è·å–çš„é”èµ„æºæ˜¯å¦ä¸€è‡´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedRawRecord&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">oldLeaderElectionRawRecord&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedRecord&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">oldLeaderElectionRecord&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedRawRecord&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">oldLeaderElectionRawRecord&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedTime&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åˆ¤æ–­æŒæœ‰çš„é”æ˜¯å¦åˆ°æœŸä»¥åŠæ˜¯å¦è¢«è‡ªå·±æŒæœ‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">oldLeaderElectionRecord&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HolderIdentity&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedTime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaseDuration&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">After&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">!&lt;/span>&lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsLeader&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">V&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Infof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;lock is held by %v and has not yet expired&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">oldLeaderElectionRecord&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HolderIdentity&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 3. We&amp;#39;re going to try to update. The leaderElectionRecord is set to it&amp;#39;s default&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// here. Let&amp;#39;s correct it before updating.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ç¬¬ä¸‰æ­¥ï¼šè‡ªå·±ç°åœ¨æ˜¯leaderï¼Œä½†æ˜¯åˆ†ä¸¤ç»„æƒ…å†µï¼Œä¸Šä¸€æ¬¡ä¹Ÿæ˜¯leaderå’Œé¦–æ¬¡å˜ä¸ºleader&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsLeader&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è‡ªå·±æœ¬èº«å°±æ˜¯leaderåˆ™ä¸éœ€è¦æ›´æ–°AcquireTimeå’ŒLeaderTransitions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">leaderElectionRecord&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AcquireTime&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">oldLeaderElectionRecord&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AcquireTime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">leaderElectionRecord&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaderTransitions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">oldLeaderElectionRecord&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaderTransitions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//é¦–æ¬¡è‡ªå·±å˜ä¸ºleaderåˆ™æ›´æ–°leaderçš„æ›´æ¢æ¬¡æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">leaderElectionRecord&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaderTransitions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">oldLeaderElectionRecord&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">LeaderTransitions&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ›´æ–°é”èµ„æºï¼Œè¿™é‡Œå¦‚æœåœ¨ Get å’Œ Update ä¹‹é—´æœ‰å˜åŒ–ï¼Œå°†ä¼šæ›´æ–°å¤±è´¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// update the lock itself&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Update&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">leaderElectionRecord&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">klog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to update lock: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedRecord&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">leaderElectionRecord&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">observedTime&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">le&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">clock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>åœ¨è¿™ä¸€æ­¥å¦‚æœå‘ç”Ÿå¹¶å‘æ“ä½œæ€ä¹ˆæ ·ï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>è¿™é‡Œå¾ˆé‡è¦ä¸€ç‚¹å°±æ˜¯åˆ©ç”¨åˆ°äº†k8s apiæ“ä½œçš„åŸå­æ€§ï¼š&lt;/p>
&lt;p>åœ¨ &lt;code>le.config.Lock.Get()&lt;/code> ä¸­ä¼šè·å–åˆ°é”çš„å¯¹è±¡ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª &lt;code>resourceVersion&lt;/code> å­—æ®µç”¨äºæ ‡è¯†ä¸€ä¸ªèµ„æºå¯¹è±¡çš„å†…éƒ¨ç‰ˆæœ¬ï¼Œæ¯æ¬¡æ›´æ–°æ“ä½œéƒ½ä¼šæ›´æ–°å…¶å€¼ã€‚å¦‚æœä¸€ä¸ªæ›´æ–°æ“ä½œé™„åŠ ä¸Šäº† &lt;code>resourceVersion&lt;/code> å­—æ®µï¼Œé‚£ä¹ˆ apiserver å°±ä¼šé€šè¿‡éªŒè¯å½“å‰ &lt;code>resourceVersion&lt;/code> çš„å€¼ä¸æŒ‡å®šçš„å€¼æ˜¯å¦ç›¸åŒ¹é…æ¥ç¡®ä¿åœ¨æ­¤æ¬¡æ›´æ–°æ“ä½œå‘¨æœŸå†…æ²¡æœ‰å…¶ä»–çš„æ›´æ–°æ“ä½œï¼Œä»è€Œä¿è¯äº†æ›´æ–°æ“ä½œçš„åŸå­æ€§ã€‚&lt;/p>
&lt;h2>æ€»ç»“&lt;span class="hx-absolute -hx-mt-20" id="æ€»ç»“">&lt;/span>
&lt;a href="#%e6%80%bb%e7%bb%93" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>leaderelection ä¸»è¦æ˜¯åˆ©ç”¨äº†k8s APIæ“ä½œçš„åŸå­æ€§å®ç°äº†ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼Œåœ¨ä¸æ–­çš„ç«äº‰ä¸­è¿›è¡Œé€‰ä¸¾ã€‚é€‰ä¸­ä¸ºleaderçš„è¿›è¡Œæ‰ä¼šæ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡ä»£ç ï¼Œè¿™åœ¨k8sä¸­éå¸¸çš„å¸¸è§ï¼Œè€Œä¸”æˆ‘ä»¬å¾ˆæ–¹ä¾¿çš„åˆ©ç”¨è¿™ä¸ªåŒ…å®Œæˆç»„ä»¶çš„ç¼–å†™ï¼Œä»è€Œå®ç°ç»„ä»¶çš„é«˜å¯ç”¨ï¼Œæ¯”å¦‚éƒ¨ç½²ä¸ºä¸€ä¸ªå¤šå‰¯æœ¬çš„Deploymentï¼Œå½“leaderçš„podé€€å‡ºåä¼šé‡æ–°å¯åŠ¨ï¼Œå¯èƒ½é”å°±è¢«å…¶ä»–podè·å–ç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;p>å®Œæ•´ä»£ç ï¼š&lt;a href="https://github.com/go-demo/leaderelection" target="_blank" rel="noopener">https://github.com/go-demo/leaderelection&lt;/a>&lt;/p></description></item><item><title>å¦‚ä½•åœ¨Goé¡¹ç›®ä¸­è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ï¼Ÿ</title><link>/blog/202001/go-import-version/</link><pubDate>Fri, 10 Jan 2020 00:00:00 +0000</pubDate><guid>/blog/202001/go-import-version/</guid><description>
&lt;p>æˆ‘ä»¬ç»å¸¸åœ¨ä½¿ç”¨CLIå·¥å…·çš„æ—¶å€™ï¼Œéƒ½ä¼šæœ‰è¿™æ ·çš„å‚æ•°è¾“å‡ºï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>âœ ~ docker version
Client: Docker Engine - Community
Version: 18.09.2
API version: 1.39
Go version: go1.10.8
Git commit: 6247962
Built: Sun Feb 10 04:12:39 2019
OS/Arch: darwin/amd64
Experimental: false
âœ ~&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯ä»¥æ‰“å°å‡ºæ„å»ºæ—¶å¯¹åº”çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚ Versionï¼ŒGo Versionï¼ŒGit Commitç­‰ï¼Œè¿™ä¸ªæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ&lt;/p>
&lt;h1>å®ç°&lt;/h1>&lt;p>ä¸»è¦æ˜¯é€šè¿‡&lt;code>ldflags&lt;/code>å‚æ•°æ¥å®ç°åœ¨æ„å»ºçš„æ—¶å€™å¯¹å˜é‡è¿›è¡Œèµ‹å€¼ã€‚&lt;/p>
&lt;p>æ¯”å¦‚ä¸‹é¢ä¸€æ®µä»£ç ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>package main
import (
&amp;#34;flag&amp;#34;
&amp;#34;fmt&amp;#34;
&amp;#34;os&amp;#34;
)
//éœ€è¦èµ‹å€¼çš„å˜é‡
var version = &amp;#34;&amp;#34;
//é€šè¿‡flagåŒ…è®¾ç½®-versionå‚æ•°
var printVersion bool
func init() {
flag.BoolVar(&amp;amp;printVersion, &amp;#34;version&amp;#34;, false, &amp;#34;print program build version&amp;#34;)
flag.Parse()
}
func main() {
if printVersion {
println(version)
os.Exit(0)
}
fmt.Printf(&amp;#34;example for print version&amp;#34;)
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ„å»ºå‘½ä»¤ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>go build -ldflags &amp;#34;-X main.version=v0.1&amp;#34; -o example&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ç¨‹åºè¾“å‡ºï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>âœ ./example
version=v0.1&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>å‚æ•°è¯´æ˜&lt;/h1>&lt;p>1ã€-ldflags buildå‘½ä»¤ä¸­ç”¨äºè°ƒç”¨æ¥é“¾æ¥å™¨çš„å‚æ•°&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>-ldflags &amp;#39;[pattern=]arg list&amp;#39;
arguments to pass on each go tool link invocation.&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>2ã€-X é“¾æ¥å™¨å‚æ•°ï¼Œä¸»è¦ç”¨äºè®¾ç½®å˜é‡&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>-X importpath.name=value
Set the value of the string variable in importpath named name to value.
Note that before Go 1.5 this option took two separate arguments.
Now it takes one argument split on the first = sign.&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­&lt;/h1>&lt;p>è¿™é‡Œå°†versionåŒ…å•ç‹¬åšäº†ä¸€ä¸ªåŒ…å­˜æ”¾ï¼Œåªéœ€è¦å¼•å…¥å³å¯ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>package main
import (
&amp;#34;flag&amp;#34;
&amp;#34;github.com/go-demo/version&amp;#34;
)
//é€šè¿‡flagåŒ…è®¾ç½®-versionå‚æ•°
var printVersion bool
func init() {
flag.BoolVar(&amp;amp;printVersion, &amp;#34;version&amp;#34;, false, &amp;#34;print program build version&amp;#34;)
flag.Parse()
}
func main() {
if printVersion {
version.PrintVersion()
}
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ„å»ºçš„shellå¦‚ä¸‹(ä¹Ÿå¯ä»¥æ”¾åœ¨Makefileä¸­)ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>#!/bin/sh
version=&amp;#34;v0.1&amp;#34;
path=&amp;#34;github.com/go-demo/version&amp;#34;
flags=&amp;#34;-X $path.Version=$version -X &amp;#39;$path.GoVersion=$(go version)&amp;#39; -X &amp;#39;$path.BuildTime=`date &amp;#43;&amp;#34;%Y-%m-%d %H:%m:%S&amp;#34;`&amp;#39; -X $path.GitCommit=`git rev-parse HEAD`&amp;#34;
go build -ldflags &amp;#34;$flags&amp;#34; -o example example-version.go&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>TIPS: å¦‚æœå€¼å†…å®¹ä¸­å«æœ‰ç©ºæ ¼ï¼Œå¯ä»¥ç”¨å•å¼•å·&lt;/p>
&lt;p>æœ€ç»ˆç‰ˆæœ¬è¾“å‡º:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>âœ sh build.sh
âœ ./example -version
Version: v0.1
Go Version: go version go1.13.1 darwin/amd64
Git Commit: a775ecd27c5e78437b605c438905e9cc888fbc1c
Build Time: 2020-01-09 19:01:51&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å®Œæ•´ä»£ç ï¼š&lt;a href="https://github.com/go-demo/version" target="_blank" rel="noopener">https://github.com/go-demo/version&lt;/a>&lt;/p></description></item><item><title>Kuberneteså®¹å™¨æ—¥å¿—æ”¶é›†æ–¹æ¡ˆ</title><link>/blog/201910/kubernetes-log/</link><pubDate>Tue, 22 Oct 2019 00:00:00 +0000</pubDate><guid>/blog/201910/kubernetes-log/</guid><description>
&lt;p>æ”¶é›†PODä¸­containeræ—¥å¿—ï¼Œæ—¥å¿—è¿˜åˆ†ä¸ºä¸¤ç§ä¸€ç§æ˜¯å®¹å™¨æ ‡å‡†è¾“å‡ºæ—¥å¿—å’Œå®¹å™¨å†…æ—¥å¿—ã€‚&lt;/p>
&lt;h1>æ–¹æ¡ˆ&lt;/h1>&lt;p>ä»æ—¥å¿—çš„é‡‡é›†æ–¹å¼ä¸Šï¼Œåœ¨æˆ‘çœ‹æ¥æ–¹æ¡ˆå¤§è‡´ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼š&lt;/p>
&lt;p>&lt;strong>ï¼ˆ1ï¼‰POD é‡Œé¢å®‰è£…logging agent&lt;/strong>&lt;/p>
&lt;p>æ¯ä¸ªpodé‡Œé¢éƒ½è¦å®‰è£…ä¸€ä¸ªagentï¼Œæ— è®ºæ˜¯ä»¥æ”¾åœ¨æœ¬containerè¿˜æ˜¯ä»¥sidecarçš„æ–¹å¼éƒ¨ç½²ï¼Œå¾ˆæ˜æ˜¾ä¼šå ç”¨å¾ˆå¤šèµ„æºï¼ŒåŸºæœ¬ä¸æ¨è&lt;/p>
&lt;p>&lt;strong>ï¼ˆ2ï¼‰åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…logging agentï¼ˆæ¨èï¼‰&lt;/strong>&lt;/p>
&lt;p>å…¶å®å®¹å™¨stdout,stderrçš„æ—¥å¿—æœ€ç»ˆä¹Ÿæ˜¯è½åœ¨å®¿ä¸»æœºä¸Šï¼Œè€Œå®¹å™¨å†…çš„è·¯å¾„å¯ä»¥é€šè¿‡é…ç½®volumeMount åœ¨å®¿ä¸»æœºä¸Šé…ç½®æ˜ å°„å³å¯ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼è¿˜æ˜¯æœ€å¯è¡Œçš„&lt;/p>
&lt;blockquote>
&lt;p>å½“ç„¶åº”ç”¨è¿˜å¯ä»¥è‡ªå·±é€šè¿‡ä»£ç ç›´æ¥ä¸ŠæŠ¥ç»™æ—¥å¿—æœåŠ¡ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¸å¤Ÿé€šç”¨ï¼Œè¿˜å¢åŠ äº†ä¸šåŠ¡ä»£ç çš„å¤æ‚æ€§&lt;/p>
&lt;/blockquote>
&lt;h1>log-pilot ä»£ç åˆ†æ&lt;/h1>&lt;p>è¿™é‡Œä»¥log-pilotä¸ºä¾‹ï¼Œæ¥åˆ†æä¸‹&lt;/p>
&lt;p>ä»£ç åœ°å€ï¼š &lt;a href="https://github.com/AliyunContainerService/log-pilot" target="_blank" rel="noopener">https://github.com/AliyunContainerService/log-pilot&lt;/a>&lt;/p>
&lt;p>&lt;strong>åŸºæœ¬æµç¨‹:&lt;/strong>&lt;/p>
&lt;p>ç›‘å¬docker-serviceçš„äº‹ä»¶ï¼ˆstartï¼Œrestartï¼Œdestoryï¼‰ï¼Œä»containerä¿¡æ¯ä¸­æå–pod_name,namespaceä¿¡æ¯ï¼ˆå¯é€šè¿‡docker inspect [container ID]æŸ¥çœ‹åˆ°ï¼‰ï¼Œå¹¶å†™å…¥filebeatä¸­çš„prospector.dä¸­çš„é…ç½®æ–‡ä»¶ã€‚&lt;/p>
&lt;p>&lt;strong>äº‹ä»¶ç›‘å¬ï¼š&lt;/strong>
&lt;a href="https://github.com/AliyunContainerService/log-pilot/blob/0948b2c1feca97f849bd3a4eeda7bd40a907efca/pilot/pilot.go#L134" target="_blank" rel="noopener">pilot/pilot.go#L134&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code> msgs, errs := p.client.Events(ctx, options)chenqz1987, 1 year ago: â€¢ fix issue #40 and update log-pilot capabilityâ€¦
go func() {
defer func() {
log.Warn(&amp;#34;finish to watch event&amp;#34;)
p.stopChan &amp;lt;- true
}()
log.Info(&amp;#34;begin to watch event&amp;#34;)
for {
select {
case msg := &amp;lt;-msgs:
if err := p.processEvent(msg); err != nil {
log.Errorf(&amp;#34;fail to process event: %v, %v&amp;#34;, msg, err)
}
case err := &amp;lt;-errs:
log.Warnf(&amp;#34;error: %v&amp;#34;, err)
if err == io.EOF || err == io.ErrUnexpectedEOF {
return
}
msgs, errs = p.client.Events(ctx, options)
}
}
}()&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>å¯¹æ¥ä¸åŒæ”¶é›†å™¨&lt;/strong>&lt;/p>
&lt;p>log-pilotæ”¯æŒ&lt;code>filebeat&lt;/code>å’Œ&lt;code>fluentd&lt;/code>ä¸¤ç§æ—¥å¿—æ”¶é›†å™¨ï¼Œç›®çš„ä¸»è¦æ˜¯åˆ·æ–°å¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚ä¸»è¦æ˜¯å®ç°äº†&lt;code>Piloter&lt;/code>æ¥å£ï¼š&lt;/p>
&lt;p>&lt;a href="https://github.com/AliyunContainerService/log-pilot/blob/0948b2c1feca97f849bd3a4eeda7bd40a907efca/pilot/piloter.go#L17" target="_blank" rel="noopener">pilot/piloter.go#L17&lt;/a>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>// Piloter interface for piloter
type Piloter interface {
Name() string
Start() error
Reload() error
Stop() error
GetBaseConf() string
GetConfHome() string
GetConfPath(container string) string
OnDestroyEvent(container string) error
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>è‡³äºåœ¨å¯åŠ¨log-piloté€‰æ‹©å“ªç§é‡‡é›†å™¨è¿›è¡Œé‡‡é›†ï¼Œæ˜¯é€šè¿‡åœ¨å®¹å™¨çš„&lt;a href="https://github.com/AliyunContainerService/log-pilot/blob/master/assets/entrypoint" target="_blank" rel="noopener">entrypoint&lt;/a>æ–‡ä»¶ä¸­é€šè¿‡åˆ¶å®šç¯å¢ƒå˜é‡&lt;code>PILOT_TYPE&lt;/code>çš„æ–¹å¼è¿›è¡Œé€‰æ‹©æ€§æ¸²æŸ“çš„ã€‚&lt;/p>
&lt;p>&lt;strong>å®Œå–„&lt;/strong>&lt;/p>
&lt;p>å½“å‰æœ€æ–°ç‰ˆæœ¬[0.9.7]&lt;/p>
&lt;p>1ã€ç›®å‰log-pilotè¿˜æ˜¯åªèƒ½é€šè¿‡ç›‘å¬docker-servierçš„eventè¿›è¡Œï¼Œå¯¹äºcontainerdï¼Œcri-oè¿˜æ²¡åŠæ³•é€‚é…ã€‚&lt;/p>
&lt;blockquote>
&lt;p>containerdç›®å‰æ²¡æä¾›ç›¸åº”çš„eventæ¥å£ï¼Œå¯ä»¥é€‰æ‹©ä»k8s api é€šè¿‡List-Watchä¸­è·å–&lt;/p>
&lt;/blockquote>
&lt;p>2ã€filebeatå‡çº§&lt;/p>
&lt;blockquote>
&lt;p>filebeat ç›®å‰ç”¨çš„ç‰ˆæœ¬æ˜¯6.1.1 ï¼Œfilebeatæœ¬èº«å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒåƒèµ„æºçš„è¿›ç¨‹ï¼Œfilebeatæœ‰äº›issueæ˜¯&lt;a href="https://github.com/elastic/beats/pull/7820" target="_blank" rel="noopener">7820&lt;/a>bugï¼Œå¯ä»¥å°†filebeatå‡çº§åˆ°ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>3ã€èµ„æºé™åˆ¶&lt;/p>
&lt;blockquote>
&lt;p>åœ¨k8sä¸­é€šè¿‡åˆ¶å®šlimitï¼Œé™åˆ¶log-pilotçš„èµ„æºå ç”¨ï¼ˆä¸»è¦è¿˜æ˜¯æ—¥å¿—é‡‡é›†å™¨ï¼‰&lt;/p>
&lt;/blockquote></description></item><item><title>Cluster Autoscaler:é›†ç¾¤è‡ªåŠ¨æ‰©ç¼©å®¹</title><link>/blog/201907/cluster-autoscaler-usage/</link><pubDate>Tue, 02 Jul 2019 00:00:00 +0000</pubDate><guid>/blog/201907/cluster-autoscaler-usage/</guid><description>
&lt;p>Cluster AutoScaler æ˜¯ä¸€ä¸ªè‡ªåŠ¨æ‰©å±•å’Œæ”¶ç¼© Kubernetes é›†ç¾¤ Node çš„æ‰©å±•ã€‚å½“é›†ç¾¤å®¹é‡ä¸è¶³æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å» Cloud Provider ï¼ˆæ”¯æŒ GCEã€GKE å’Œ AWSï¼‰åˆ›å»ºæ–°çš„ Nodeï¼Œè€Œåœ¨ Node é•¿æ—¶é—´èµ„æºåˆ©ç”¨ç‡å¾ˆä½æ—¶è‡ªåŠ¨å°†å…¶åˆ é™¤ä»¥èŠ‚çœå¼€æ”¯ã€‚&lt;/p>
&lt;p>åœ¨Kubernetesä¸­å…³äºå¼¹æ€§ä¼¸ç¼©ä¸»è¦æœ‰ä¸‰ç§æ ¼å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>HPA&lt;/strong>ï¼šHorizontal Pod Autoscalingå¯ä»¥æ ¹æ®CPUåˆ©ç”¨ç‡è‡ªåŠ¨ä¼¸ç¼©ä¸€ä¸ªReplication Controllerã€Deployment æˆ–è€…Replica Setä¸­çš„Podæ•°é‡&lt;/li>
&lt;li>&lt;strong>VPA&lt;/strong>ï¼šVertical Pod Autoscalerï¼ˆVPAï¼‰ä½¿ç”¨æˆ·æ— éœ€ä¸ºå…¶podsä¸­çš„å®¹å™¨è®¾ç½®æœ€æ–°çš„èµ„æºrequestã€‚é…ç½®åï¼Œå®ƒå°†æ ¹æ®ä½¿ç”¨æƒ…å†µè‡ªåŠ¨è®¾ç½®requestï¼Œä»è€Œå…è®¸åœ¨èŠ‚ç‚¹ä¸Šè¿›è¡Œé€‚å½“çš„è°ƒåº¦ï¼Œä»¥ä¾¿ä¸ºæ¯ä¸ªpodæä¾›é€‚å½“çš„èµ„æºé‡ã€‚&lt;/li>
&lt;li>&lt;strong>CA&lt;/strong>ï¼šè‡ªåŠ¨ä¼¸ç¼©NODEèŠ‚ç‚¹&lt;/li>
&lt;/ul>
&lt;h2>éƒ¨ç½²&lt;span class="hx-absolute -hx-mt-20" id="éƒ¨ç½²">&lt;/span>
&lt;a href="#%e9%83%a8%e7%bd%b2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>Cluster Autoscalerä»£ç åœ°å€ï¼š&lt;a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler" target="_blank" rel="noopener">https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler&lt;/a>&lt;/p>
&lt;p>CA æä¾›äº†&lt;a href="https://github.com/kubernetes/autoscaler/blob/7cfa98b4ca308fbede1a2f1054ef3f00daf560dd/cluster-autoscaler/cloudprovider/cloud_provider.go#L31" target="_blank" rel="noopener">Cloud Provider&lt;/a>æ¥å£ä¾›å„ä¸ªäº‘å‚å•†æ¥å…¥ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å‚å•†è‡ªå·±çš„APIï¼Œåº”å¯¹èŠ‚ç‚¹æ·»åŠ ä»¥åŠåˆ é™¤çš„è¯·æ±‚ã€‚&lt;/p>
&lt;p>ç›®å‰äº‘å‚å•†çš„ECSäº§å“éƒ½ä¼šæœ‰æ‰©ç¼©å®¹çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚é˜¿é‡Œäº‘ESSï¼Œå°±æ˜¯CAä¸­ä¼¸ç¼©ç»„çš„æ¦‚å¿µï¼‰ï¼ŒCAå°±å¯ä»¥ç»“åˆESSå®Œæˆé›†ç¾¤çš„æ‰©ç¼©å®¹åŠŸèƒ½ã€‚&lt;/p>
&lt;p>å„å¤§å‚å•†èŠ‚ç‚¹æ‰©ç¼©å®¹å®‰è£…ï¼š&lt;/p>
&lt;ul>
&lt;li>GCE: &lt;a href="https://kubernetes.io/docs/concepts/cluster-administration/cluster-management/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/cluster-administration/cluster-management/&lt;/a>&lt;/li>
&lt;li>GKE: &lt;a href="https://cloud.google.com/container-engine/docs/cluster-autoscaler" target="_blank" rel="noopener">https://cloud.google.com/container-engine/docs/cluster-autoscaler&lt;/a>&lt;/li>
&lt;li>AWS: &lt;a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md" target="_blank" rel="noopener">https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md&lt;/a>&lt;/li>
&lt;li>Azure: &lt;a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider/azure" target="_blank" rel="noopener">https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider/azure&lt;/a>&lt;/li>
&lt;li>alicloudï¼š&lt;a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/alicloud/README.md" target="_blank" rel="noopener">https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/alicloud/README.md&lt;/a>&lt;/li>
&lt;li>baiducloudï¼š&lt;a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/baiducloud/README.md" target="_blank" rel="noopener">https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/baiducloud/README.md&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼Œå…·ä½“å®‰è£…å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š&lt;a href="https://yq.aliyun.com/articles/392170" target="_blank" rel="noopener">é˜¿é‡Œäº‘ä¸Šå¼¹æ€§ä¼¸ç¼©kubernetesé›†ç¾¤ - autoscaler
&lt;/a>&lt;/p>
&lt;p>å…¶ä¸­å…³é”®yamlæ–‡ä»¶å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
name: cluster-autoscaler
namespace: kube-system
labels:
app: cluster-autoscaler
spec:
replicas: 1
selector:
matchLabels:
app: cluster-autoscaler
template:
metadata:
labels:
app: cluster-autoscaler
spec:
serviceAccountName: admin
containers:
- image: registry.cn-hangzhou.aliyuncs.com/google-containers/cluster-autoscaler:v1.1.0
name: cluster-autoscaler
resources:
limits:
cpu: 100m
memory: 300Mi
requests:
cpu: 100m
memory: 300Mi
command:
- ./cluster-autoscaler
- --v=4
- --stderrthreshold=info
- --cloud-provider=alicloud
- --skip-nodes-with-local-storage=false
- --nodes=1:100:${AUTO_SCALER_GROUP}
env:
- name: ACCESS_KEY_ID
valueFrom:
secretKeyRef:
name: cloud-config
key: access-key-id
- name: ACCESS_KEY_SECRET
valueFrom:
secretKeyRef:
name: cloud-config
key: access-key-secret
imagePullPolicy: &amp;#34;Always&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­ &lt;code>--nodes=1:100:${AUTO_SCALER_GROUP}&lt;/code>å‚æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹æœ€å¤§100ä¸ªï¼Œç¼©å®¹æœ€å°1ä¸ªèŠ‚ç‚¹ï¼Œåé¢&lt;code>${AUTO_SCALER_GROUP}&lt;/code>è¡¨ç¤ºä¼¸ç¼©ç»„ID&lt;/p>
&lt;h2>å·¥ä½œåŸç†&lt;span class="hx-absolute -hx-mt-20" id="å·¥ä½œåŸç†">&lt;/span>
&lt;a href="#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;h3>æ‰©å®¹&lt;span class="hx-absolute -hx-mt-20" id="æ‰©å®¹">&lt;/span>
&lt;a href="#%e6%89%a9%e5%ae%b9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>CAä¼šå®šæœŸ(é»˜è®¤10s,é€šè¿‡å‚æ•°&lt;code>--scan-interval&lt;/code>è®¾ç½®)æ£€æµ‹å½“å‰é›†ç¾¤çŠ¶æ€ä¸‹æ˜¯å¦å­˜åœ¨pendingçš„podï¼Œç„¶åç»è¿‡è®¡ç®—ï¼Œåˆ¤æ–­éœ€è¦æ‰©å®¹å‡ ä¸ªèŠ‚ç‚¹ï¼Œæœ€ç»ˆä»node groupä¸­è¿›è¡ŒèŠ‚ç‚¹çš„æ‰©å®¹ï¼š&lt;/p>
&lt;p>Node Group å°±å¯¹åº”ä¼¸ç¼©ç»„çš„æ¦‚å¿µï¼Œå¯ä»¥æ”¯æŒé…ç½®æ”¯æŒå¤šä¸ªä¼¸ç¼©ç»„ï¼Œé€šè¿‡ç­–ç•¥æ¥è¿›è¡Œé€‰æ‹©ï¼Œç›®å‰æ”¯æŒçš„ç­–ç•¥ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>randomï¼šéšæœºé€‰æ‹©&lt;/li>
&lt;li>most-podsï¼šé€‰æ‹©èƒ½å¤Ÿåˆ›å»ºpodæœ€å¤šçš„Node Group&lt;/li>
&lt;li>least-wasteï¼šä»¥æœ€å°æµªè´¹åŸåˆ™é€‰æ‹©ï¼Œå³é€‰æ‹©æœ‰æœ€å°‘å¯ç”¨èµ„æºçš„ Node Group&lt;/li>
&lt;li>priceï¼šæ ¹æ®ä¸»æœºçš„ä»·æ ¼é€‰æ‹©ï¼Œé€‰æ‹©æœ€ä¾¿å®œçš„&lt;/li>
&lt;li>priorityï¼šæ ¹æ®ä¼˜å…ˆçº§è¿›è¡Œé€‰æ‹©ï¼Œé€šè¿‡é…ç½®&lt;code>cluster-autoscaler-priority-expander&lt;/code> configMapï¼Œå…·ä½“å‚è€ƒï¼š&lt;a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/expander/priority" target="_blank" rel="noopener">https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/expander/priority&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3>ç¼©å®¹&lt;span class="hx-absolute -hx-mt-20" id="ç¼©å®¹">&lt;/span>
&lt;a href="#%e7%bc%a9%e5%ae%b9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>é›†ç¾¤ç¼©å®¹å…¶å®æ˜¯ä¸€ä¸ªå¯é€‰çš„é€‰é¡¹ï¼Œé€šè¿‡å‚æ•°&lt;code>--scale-down-enabled&lt;/code>æ§åˆ¶æ˜¯å¦å¼€å¯ç¼©å®¹ã€‚&lt;/p>
&lt;p>CAå®šæœŸä¼šæ£€æµ‹é›†ç¾¤çŠ¶æ€ï¼Œåˆ¤æ–­å½“å‰é›†ç¾¤çŠ¶æ€ä¸‹ï¼Œå“ªäº›èŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡å°äº50%(é€šè¿‡å‚æ•°&lt;code>--scale-down-utilization-threshold&lt;/code>æ§åˆ¶)ã€‚&lt;/p>
&lt;p>èµ„æºåˆ©ç”¨ç‡è®¡ç®—æ˜¯é€šè¿‡åˆ¤æ–­é›†ç¾¤cpuï¼Œmem ä¸­requestå€¼å ç”¨ç‡è®¡ç®—çš„ï¼Œåªè¦æœ‰ä¸€ä¸ªæŒ‡æ ‡è¶…äº†å°±å¯èƒ½ä¼šå‡ºå‘ç¼©å®¹ï¼Œä¹‹æ‰€ä»¥è¯´æ˜¯å¯èƒ½ä¼šè§¦å‘æ‰©å®¹ï¼Œæ˜¯å› ä¸ºè¦ä¿è¯è¢«é©±é€èŠ‚ç‚¹ä¸Šçš„PODèƒ½å¤Ÿæ­£ç¡®è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚&lt;/p>
&lt;p>&lt;strong>å“ªäº›NODEä¸ä¼šç¼©å®¹ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>å½“æ‚¨è®¾ç½®äº†ä¸¥æ ¼çš„ PodDisruptionBudget çš„ Pod ä¸æ»¡è¶³ PDB æ—¶ï¼Œä¸ä¼šç¼©å®¹ã€‚&lt;/li>
&lt;li>Kube-system ä¸‹çš„ Podã€‚é€šè¿‡å‚æ•°&lt;code>--skip-nodes-with-system-pods&lt;/code>æ§åˆ¶&lt;/li>
&lt;li>èŠ‚ç‚¹ä¸Šæœ‰é deploymentï¼Œreplica setï¼Œjobï¼Œstateful set ç­‰æ§åˆ¶å™¨åˆ›å»ºçš„ Podã€‚&lt;/li>
&lt;li>Pod æœ‰æœ¬åœ°å­˜å‚¨ã€‚é€šè¿‡å‚æ•°&lt;code>--skip-nodes-with-local-storage&lt;/code>æ§åˆ¶&lt;/li>
&lt;li>Pod ä¸èƒ½è¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚ä¾‹å¦‚èµ„æºä¸æ»¡è¶³ç­‰&lt;/li>
&lt;/ul>
&lt;h2>å®ç°Cluster Provider&lt;span class="hx-absolute -hx-mt-20" id="å®ç°cluster-provider">&lt;/span>
&lt;a href="#%e5%ae%9e%e7%8e%b0cluster-provider" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å¦‚æœä½ ä½¿ç”¨çš„ä»¥ä¸Šä¸»æµçš„å‡ ä¸ªäº‘å‚å•†çš„ä¸»æœºèµ„æº/k8sé›†ç¾¤ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å®˜æ–¹çš„CAç‰ˆæœ¬ï¼Œåªéœ€è¦é€šè¿‡å‚æ•°&lt;code>--cloud-provider&lt;/code>æ§åˆ¶æ¥è‡ªå“ªä¸ªäº‘å‚å•†å°±å¯ä»¥ã€‚&lt;/p>
&lt;p>å¦‚æœæƒ³è¦å¯¹æ¥è‡ªå·±çš„IaaSå±‚ï¼Œåªéœ€è¦å®ç°å…¶ä¸­çš„æ¥å£å°±å¯ä»¥äº†ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>// CloudProvider contains configuration info and functions for interacting with
// cloud provider (GCE, AWS, etc).
type CloudProvider interface {Marcin Wielgus, 3 years ago: â€¢ Cluster-autoscaler: cloud provider interface
// Name returns name of the cloud provider.
Name() string
// NodeGroups returns all node groups configured for this cloud provider.
//è¿”å›æ‰€æœ‰ä¼¸ç¼©ç»„
NodeGroups() []NodeGroup
// NodeGroupForNode returns the node group for the given node, nil if the node
// should not be processed by cluster autoscaler, or non-nil error if such
// occurred. Must be implemented.
NodeGroupForNode(*apiv1.Node) (NodeGroup, error)
// Pricing returns pricing model for this cloud provider or error if not available.
// Implementation optional.
Pricing() (PricingModel, errors.AutoscalerError)
// GetAvailableMachineTypes get all machine types that can be requested from the cloud provider.
// Implementation optional.
GetAvailableMachineTypes() ([]string, error)
// NewNodeGroup builds a theoretical node group based on the node definition provided. The node group is not automatically
// created on the cloud provider side. The node group is not returned by NodeGroups() until it is created.
// Implementation optional.
NewNodeGroup(machineType string, labels map[string]string, systemLabels map[string]string,
taints []apiv1.Taint, extraResources map[string]resource.Quantity) (NodeGroup, error)
// GetResourceLimiter returns struct containing limits (max, min) for resources (cores, memory etc.).
GetResourceLimiter() (*ResourceLimiter, error)
// GPULabel returns the label added to nodes with GPU resource.
GPULabel() string
// GetAvailableGPUTypes return all available GPU types cloud provider supports.
GetAvailableGPUTypes() map[string]struct{}
// Cleanup cleans up open resources before the cloud provider is destroyed, i.e. go routines etc.
Cleanup() error
// Refresh is called before every main loop and can be used to dynamically update cloud provider state.
// In particular the list of node groups returned by NodeGroups can change as a result of CloudProvider.Refresh().
Refresh() error
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­NodeGroupæ¥å£å®šä¹‰ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>// NodeGroup contains configuration info and functions to control a set
// of nodes that have the same capacity and set of labels.
type NodeGroup interface {
// MaxSize returns maximum size of the node group.
MaxSize() int
// MinSize returns minimum size of the node group.
MinSize() int
// TargetSize returns the current target size of the node group. It is possible that the
// number of nodes in Kubernetes is different at the moment but should be equal
// to Size() once everything stabilizes (new nodes finish startup and registration or
// removed nodes are deleted completely). Implementation required.
TargetSize() (int, error)
// IncreaseSize increases the size of the node group. To delete a node you need
// to explicitly name it and use DeleteNode. This function should wait until
// node group size is updated. Implementation required.
//æ‰©å®¹ä¼¸ç¼©ç»„
IncreaseSize(delta int) error
// DeleteNodes deletes nodes from this node group. Error is returned either on
// failure or if the given node doesn&amp;#39;t belong to this node group. This function
// should wait until node group size is updated. Implementation required.
//ä»ä¼¸ç¼©ç»„ä¸­åˆ é™¤èŠ‚ç‚¹
DeleteNodes([]*apiv1.Node) error
// DecreaseTargetSize decreases the target size of the node group. This function
// doesn&amp;#39;t permit to delete any existing node and can be used only to reduce the
// request for new nodes that have not been yet fulfilled. Delta should be negative.
// It is assumed that cloud provider will not delete the existing nodes when there
// is an option to just decrease the target. Implementation required.
DecreaseTargetSize(delta int) error
// Id returns an unique identifier of the node group.
Id() string
// Debug returns a string containing all information regarding this node group.
Debug() string
// Nodes returns a list of all nodes that belong to this node group.
// It is required that Instance objects returned by this method have Id field set.
// Other fields are optional.
Nodes() ([]Instance, error)
// TemplateNodeInfo returns a schedulernodeinfo.NodeInfo structure of an empty
// (as if just started) node. This will be used in scale-up simulations to
// predict what would a new node look like if a node group was expanded. The returned
// NodeInfo is expected to have a fully populated Node object, with all of the labels,
// capacity and allocatable information as well as all pods that are started on
// the node by default, using manifest (most likely only kube-proxy). Implementation optional.
TemplateNodeInfo() (*schedulernodeinfo.NodeInfo, error)
// Exist checks if the node group really exists on the cloud provider side. Allows to tell the
// theoretical node group from the real one. Implementation required.
Exist() bool
// Create creates the node group on the cloud provider side. Implementation optional.
Create() (NodeGroup, error)
// Delete deletes the node group on the cloud provider side.
// This will be executed only for autoprovisioned node groups, once their size drops to 0.
// Implementation optional.
Delete() error
// Autoprovisioned returns true if the node group is autoprovisioned. An autoprovisioned group
// was created by CA and can be deleted when scaled to 0.
Autoprovisioned() bool
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­&lt;code>IncreaseSize&lt;/code>ï¼Œ&lt;code>IncreaseSize&lt;/code>æ‰æ˜¯å…³é”®çš„æ–¹æ³•ï¼Œåˆ†åˆ«å¯¹ç”¨æ‰©å®¹ä¼¸ç¼©ç»„å’Œå¢åŠ èŠ‚ç‚¹ã€‚&lt;/p>
&lt;p>åœ¨è°ƒç”¨&lt;code>IncreaseSize&lt;/code>æ¥å£åï¼Œéœ€è¦å®ŒæˆèŠ‚ç‚¹è‡ªåŠ¨æ·»åŠ è¿›é›†ç¾¤ã€‚å‚è€ƒé˜¿é‡Œäº‘æ˜¯é€šè¿‡é…ç½®shellè„šæœ¬åˆ°ä¼¸ç¼©ç»„ä¸­çš„ECSå¯åŠ¨è„šæœ¬ä¸­ï¼Œå½“ECSå¯åŠ¨ï¼Œè‡ªåŠ¨æ‰§è¡Œè¯¥è„šæœ¬ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰é€šè¿‡å…¶ä»–æ–¹å¼åŠ å…¥é›†ç¾¤ã€‚&lt;/p></description></item><item><title>k8sç½‘ç»œç»„ä»¶ï¼šcalico</title><link>/blog/201810/calico-in-k8s/</link><pubDate>Fri, 12 Oct 2018 00:00:00 +0000</pubDate><guid>/blog/201810/calico-in-k8s/</guid><description>
&lt;p>å‰æå·²ç»å®‰è£…å¥½k8sé›†ç¾¤&lt;/p>
&lt;h1>å®‰è£…&lt;/h1>&lt;p>calico å®‰è£…å…¶å®å¾ˆç®€å•ï¼Œå·²ç»é›†æˆåœ¨ä¸¤ä¸ªyamlæ–‡ä»¶ä¸­&lt;/p>
&lt;p>calico ç‰ˆæœ¬: v3.2.3&lt;/p>
&lt;h2>å®‰è£…å¿…çœ‹&lt;span class="hx-absolute -hx-mt-20" id="å®‰è£…å¿…çœ‹">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%85%e5%bf%85%e7%9c%8b" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>å¦‚æœå®‰è£…è¿‡&lt;code>flannel&lt;/code>ç»„ä»¶ï¼Œéœ€è¦å…ˆå»é™¤dockerå¯åŠ¨é¡¹ä¸­ &lt;code>$DOCKER_NETWORK_OPTIONS&lt;/code>å‚æ•°&lt;/li>
&lt;li>åˆ é™¤å·²æœ‰çš„&lt;code>/etc/cni/net.d&lt;/code>ï¼Œ&lt;code>/opt/cni/bin&lt;/code>æ–‡ä»¶&lt;/li>
&lt;li>&lt;code>kubelet&lt;/code>å’Œ&lt;code>kube-apiserver&lt;/code>å¯åŠ¨é¡¹ä¸­éœ€è¦åŠ ä¸Š&lt;code>--allow-privileged=true&lt;/code>ï¼Œä¿è¯&lt;code>calico-node&lt;/code>éœ€è¦ä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œ&lt;/li>
&lt;li>è¿™é‡Œcalicoæ–‡ä»¶é‡‡ç”¨äº†&lt;code>CrossSubnet&lt;/code>æ¨¡å¼&lt;/li>
&lt;/ul>
&lt;h2>æŒ‡å®šk8sä½¿ç”¨CNIæ’ä»¶&lt;span class="hx-absolute -hx-mt-20" id="æŒ‡å®šk8sä½¿ç”¨cniæ’ä»¶">&lt;/span>
&lt;a href="#%e6%8c%87%e5%ae%9ak8s%e4%bd%bf%e7%94%a8cni%e6%8f%92%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åœ¨kubeletå¯åŠ¨å‚æ•°ä¸­åŠ å…¥ä»¥ä¸‹å‚æ•°:&lt;/p>
&lt;ul>
&lt;li>&lt;code>--network-plugin=cni&lt;/code>: æŒ‡å®šä½¿ç”¨cniæ’ä»¶&lt;/li>
&lt;li>&lt;code>--cni-bin-dir=/opt/cni/bin&lt;/code>ï¼š å­˜æ”¾ç½‘ç»œé…ç½®çš„å¯æ‰§è¡Œæ–‡ä»¶&lt;/li>
&lt;li>&lt;code>--cni-conf-dir=/etc/cni/net.d&lt;/code>: å­˜æ”¾ç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œå¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œåˆ™åªä¼šé€‰æ‹©ä¸€ä¸ª(æ ¹æ®æ–‡ä»¶åæ’åº)&lt;/li>
&lt;/ul>
&lt;h2>éƒ¨ç½²&lt;span class="hx-absolute -hx-mt-20" id="éƒ¨ç½²">&lt;/span>
&lt;a href="#%e9%83%a8%e7%bd%b2" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å®‰è£…æ–‡ä»¶æ”¾åœ¨: &lt;a href="https://github.com/silenceper/k8s-install/tree/master/calico" target="_blank" rel="noopener">https://github.com/silenceper/k8s-install/tree/master/calico&lt;/a>&lt;/p>
&lt;p>ä¸»è¦åŒ…å«ä¸¤ä¸ªæ–‡ä»¶&lt;code>calico.yaml&lt;/code>ï¼Œ&lt;code>rbac.yaml&lt;/code>:&lt;/p>
&lt;p>éœ€è¦åšå¦‚ä¸‹å‚æ•°ä¿®æ”¹ï¼š&lt;/p>
&lt;p>å°†å…¶ä¸­çš„&lt;code>ETCD_LVS_HOST&lt;/code>ä¿®æ”¹ä¸ºé›†ç¾¤çš„etcdåœ°å€ï¼Œå¹¶ä¸”å°†&lt;code>TLS_ETCD_KEY&lt;/code>,&lt;code>TLS_ETCD_CERT &lt;/code>,&lt;code>TLS_ETCD_CA&lt;/code>æ›¿æ¢ä¸ºè¯ä¹¦çš„å†…å®¹çš„base64åçš„ç»“æœï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code># å…¶ä¸­è¯ä¹¦çš„è·¯å¾„æ ¹æ®è‡ªå·±ç¯å¢ƒæ›´æ”¹ä¸ºæ­£ç¡®çš„è·¯å¾„
TLS_ETCD_CA=$(cat /etc/kubernetes/ssl/ca.pem | base64 |tr -d &amp;#34;\n&amp;#34;)
TLS_ETCD_KEY=$(cat /etc/kubernetes/ssl/etcd-key.pem | base64 |tr -d &amp;#34;\n&amp;#34;)
TLS_ETCD_CERT=$(cat /etc/kubernetes/ssl/etcd.pem | base64 |tr -d &amp;#34;\n&amp;#34;)
# æ›¿æ¢å†…å®¹
sed -i &amp;#34;s#TLS_ETCD_CA#$TLS_ETCD_CA#g&amp;#34; calico.yaml
sed -i &amp;#34;s#TLS_ETCD_CERT#$TLS_ETCD_CERT#g&amp;#34; calico.yaml
sed -i &amp;#34;s#TLS_ETCD_KEY#$TLS_ETCD_KEY#g&amp;#34; calico.yaml
# æ›¿æ¢ETCD_LVS_HOSTåœ°å€ï¼Œæ›´æ¢ä¸ºè‡ªå·±çš„etcdåœ°å€
sed -i &amp;#34;s#ETCD_LVS_HOST#192.168.99.101#g&amp;#34; calico.yaml&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>éƒ¨ç½²&lt;/strong>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>kubectl apply -f calico.yaml
kubectl apply -f rbac.yaml&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>calicoctl å®‰è£…&lt;span class="hx-absolute -hx-mt-20" id="calicoctl-å®‰è£…">&lt;/span>
&lt;a href="#calicoctl-%e5%ae%89%e8%a3%85" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>calicoctl å·¥å…·ï¼Œä¸»è¦ç”¨æ¥é…ç½®calicoï¼Œä¾‹å¦‚é…ç½®calico ç½‘ç»œæ¨¡å¼ç­‰&lt;/p>
&lt;p>ä¸‹è½½åœ°å€ï¼š&lt;a href="https://github.com/projectcalico/calicoctl/releases" target="_blank" rel="noopener">https://github.com/projectcalico/calicoctl/releases&lt;/a>&lt;/p>
&lt;p>å°†ä¸‹è½½å’ŒäºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨&lt;code>/usr/local/bin&lt;/code>ç›®å½•ä¸‹&lt;/p>
&lt;p>&lt;strong>calicoctl é…ç½®æ–‡ä»¶&lt;/strong>&lt;/p>
&lt;p>å°†ä»¥ä¸‹å†…å®¹å†™å…¥æ–‡ä»¶&lt;code>/etc/calico/calicoctl.cfg&lt;/code>:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>apiVersion: projectcalico.org/v3
kind: CalicoAPIConfig
metadata:
spec:
etcdEndpoints: https://192.168.99.101:2379
etcdKeyFile: /etc/kubernetes/ssl/kubernetes-key.pem
etcdCertFile: /etc/kubernetes/ssl/kubernetes.pem
etcdCACertFile: /etc/kubernetes/ssl/ca.pem&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æµ‹è¯•æˆåŠŸï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@192-168-99-101 calico]# calicoctl get node -o wide
NAME ASN IPV4 IPV6
192-168-99-101 (unknown) 192.168.99.101/24
192-168-99-102 (unknown) 192.168.99.102/24&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>###ä¿®æ”¹ipipMode&lt;/p>
&lt;p>ipipModeæœ‰ä¸‰ç§ï¼š&lt;/p>
&lt;ul>
&lt;li>Neverï¼š bgpæ¨¡å¼&lt;/li>
&lt;li>Alwaysï¼šIPIPæ¨¡å¼&lt;/li>
&lt;li>CrossSubnetï¼šè‡ªåŠ¨é€‰æ‹©ï¼ŒåŒä¸€ç½‘æ®µé€‰æ‹©bgpæ¨¡å¼ï¼Œè·¨ç½‘æ®µIPIPæ¨¡å¼&lt;/li>
&lt;/ul>
&lt;p>é€šè¿‡&lt;code>calicoctl get ippool -o yaml&lt;/code>å‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°å½“å‰ä½¿ç”¨çš„ipipModeä¸º&lt;code>CrossSubnet&lt;/code>ï¼Œé€šè¿‡å¦‚ä¸‹æ–¹å¼å¯ä»¥ä¿®æ”¹ï¼š&lt;/p>
&lt;p>&lt;code>calictl apply -f ippool.yaml&lt;/code>&lt;/p>
&lt;p>å…¶ä¸­&lt;code>ippool.yaml&lt;/code>æ–‡ä»¶å†…å®¹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>apiVersion: projectcalico.org/v3
items:
- apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
name: default-ipv4-ippool
spec:
cidr: 172.23.0.0/16
ipipMode: Always
natOutgoing: true
kind: IPPoolList&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>k8sç½‘ç»œç»„ä»¶ï¼šflannel</title><link>/blog/201809/flannel-in-k8s/</link><pubDate>Wed, 26 Sep 2018 00:00:00 +0000</pubDate><guid>/blog/201809/flannel-in-k8s/</guid><description>
&lt;p>Flannelæ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºk8så®šåˆ¶çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œä¸»è¦è§£å†³PODè·¨ä¸»æœºé€šä¿¡é—®é¢˜ï¼Œè¿™é‡Œä¸»è¦è®²è¿°Flannelæ˜¯å¦‚ä½•å®ç°çš„ã€‚&lt;/p>
&lt;h1>å®‰è£…&lt;/h1>&lt;p>é›†æˆåœ¨k8sä¸Šæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯åˆ©ç”¨etcdå­˜å‚¨æ•´ä¸ªé›†ç¾¤çš„ç½‘ç»œé…ç½®ï¼Œå¦å¤–ä¸€ç§æ˜¯åˆ©ç”¨kubernetesçš„api è·å–ç½‘ç»œé…ç½®ä¿¡æ¯ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š&lt;/p>
&lt;h2>ETCD æ–¹å¼&lt;span class="hx-absolute -hx-mt-20" id="etcd-æ–¹å¼">&lt;/span>
&lt;a href="#etcd-%e6%96%b9%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è¿™ç§æ–¹å¼åœ¨å‰é¢çš„&lt;a href="http://silenceper.com/blog/201809/how-to-build-a-k8s-cluster/#%e5%ae%89%e8%a3%85flannel%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6" target="_blank" rel="noopener">k8sé›†ç¾¤å®‰è£…-å®‰è£…Flannelç½‘ç»œæ’ä»¶&lt;/a>å·²ç»ä»‹ç»è¿‡ï¼Œå°±æ˜¯åˆ©ç”¨etcdå­˜å‚¨ç½‘ç»œé…ç½®ä¿¡æ¯ï¼Œå¹¶ä¸”åˆ©ç”¨dockerdå¯åŠ¨å‚æ•°&lt;code>--bip&lt;/code>æ¥æŒ‡å®šæ¯ä¸ªèŠ‚ç‚¹çš„ç½‘æ®µä¿¡æ¯ï¼Œæˆ‘ä»¬æŒ‡å®švxlanä½œä¸ºæ•°æ®ä¼ è¾“çš„backendã€‚&lt;/p>
&lt;h2>CNIæ’ä»¶æ–¹å¼&lt;span class="hx-absolute -hx-mt-20" id="cniæ’ä»¶æ–¹å¼">&lt;/span>
&lt;a href="#cni%e6%8f%92%e4%bb%b6%e6%96%b9%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è¿™ç§æ–¹å¼æ˜¯åˆ©ç”¨cniæ’ä»¶ï¼Œå¹¶ä¸”å°†ç½‘ç»œé…ç½®ä¿¡æ¯å­˜å‚¨åœ¨kubernetes apiä¸­ï¼š&lt;/p>
&lt;h3>é…ç½®ç½‘æ®µ&lt;span class="hx-absolute -hx-mt-20" id="é…ç½®ç½‘æ®µ">&lt;/span>
&lt;a href="#%e9%85%8d%e7%bd%ae%e7%bd%91%e6%ae%b5" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨&lt;code>kube-controller-manager&lt;/code>å¯åŠ¨è„šæœ¬ä¸­åŠ å…¥&lt;code>--allocate-node-cidrs=true&lt;/code>ï¼Œ&lt;code>--cluster-cidr=10.244.0.0/16&lt;/code> å‚æ•°ã€‚&lt;/p>
&lt;p>&lt;code>10.244.0.0/16&lt;/code>ä¸ºæˆ‘ä»¬æŒ‡å®šçš„é›†ç¾¤çš„ç½‘æ®µï¼Œè¿™æ ·æ¯ä¸€ä¸ªdockerèŠ‚ç‚¹éƒ½ä¼šåˆ†åˆ«ä½¿ç”¨è‡ªç½‘æ®µ&lt;code>10.244.0.0/24&lt;/code>ï¼Œ&lt;code>10.244.1.0/24&lt;/code>ä½œä¸ºæ¯ä¸ªpodçš„ç½‘æ®µï¼Œå¯ä»¥é€šè¿‡&lt;code>kubectl get pod 192.168.99.101 -o yaml&lt;/code>å‘½ä»¤æŸ¥çœ‹&lt;code>spec.podCIDR&lt;/code>å­—æ®µã€‚&lt;/p>
&lt;p>å¦‚æœä¸é…ç½®è¯¥æ­¥éª¤å¯èƒ½ä¼šflannelå‡ºç°&lt;code>error registering network: failed to acquire lease: node &amp;quot;192.168.99.101&amp;quot; pod&lt;/code>çš„é”™è¯¯&lt;/p>
&lt;h3>æŒ‡å®škubletç½‘ç»œæ’ä»¶&lt;span class="hx-absolute -hx-mt-20" id="æŒ‡å®škubletç½‘ç»œæ’ä»¶">&lt;/span>
&lt;a href="#%e6%8c%87%e5%ae%9akublet%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>åœ¨kubeletä¸­æŒ‡å®šä¸‰ä¸ªå‚æ•°&lt;/p>
&lt;ul>
&lt;li>&lt;code>--network-plugin=cni&lt;/code> : ç½‘ç»œæ’ä»¶ä½¿ç”¨cni&lt;/li>
&lt;li>&lt;code>--cni-conf-dir=/etc/cni/net.d&lt;/code> cnié…ç½®æ–‡ä»¶ ï¼Œé»˜è®¤&lt;/li>
&lt;li>&lt;code>--cni-bin-dir=/opt/cni/bin&lt;/code> cniå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé»˜è®¤&lt;/li>
&lt;/ul>
&lt;p>è¿™æ ·åœ¨kubletå¯åŠ¨çš„æ—¶å€™ï¼Œå°±ä¼šå»&lt;code>/etc/cni/net.d&lt;/code>ç›®å½•æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼Œå¹¶è§£æï¼Œä½¿ç”¨ç›¸åº”çš„æ’ä»¶é…ç½®ç½‘ç»œ&lt;/p>
&lt;h3>ä¸‹è½½cniä¾èµ–æ’ä»¶&lt;span class="hx-absolute -hx-mt-20" id="ä¸‹è½½cniä¾èµ–æ’ä»¶">&lt;/span>
&lt;a href="#%e4%b8%8b%e8%bd%bdcni%e4%be%9d%e8%b5%96%e6%8f%92%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>ä¸‹è½½cniå®˜æ–¹æä¾›çš„ç»„ä»¶ï¼š&lt;a href="https://github.com/containernetworking/plugins/releases/download/v0.7.1/cni-plugins-amd64-v0.7.1.tgz" target="_blank" rel="noopener">cni-plugins-amd64-v0.7.1.tgz&lt;/a> ï¼Œå¹¶å°†å¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨&lt;code>/opt/cni/bin&lt;/code>ç›®å½•ã€‚&lt;/p>
&lt;p>è¿™é‡Œä¸å•å•åªä¼šç”¨åˆ°flannelæ–‡ä»¶ï¼Œä¹Ÿä¼šç”¨åˆ°brageç”¨æ¥åˆ›å»ºç½‘æ¡¥ä»¥åŠhost-localç”¨æ¥åˆ†é…ip&lt;/p>
&lt;h3>å®‰è£…flanneldç»„ä»¶&lt;span class="hx-absolute -hx-mt-20" id="å®‰è£…flanneldç»„ä»¶">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%85flanneld%e7%bb%84%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;p>flannelç»„ä»¶ç›´æ¥ä»¥&lt;code>daemonset&lt;/code>çš„æ–¹å¼å®‰è£…åœ¨k8sé›†ç¾¤ä¸­ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­&lt;code>kube-flannel-cfg&lt;/code>configmapä¸­çš„&lt;code>Network&lt;/code>å­—æ®µéœ€è¦ä¸&lt;code>--cluster-cidr&lt;/code>é…ç½®çš„ç½‘æ®µä¸€è‡´ã€‚&lt;/p>
&lt;p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯å®‰è£…äº†flanneldä»¥åŠå°†flannelé…ç½®æ–‡ä»¶å†™å…¥&lt;code>/etc/cni/net.d&lt;/code>ç›®å½•&lt;/p>
&lt;p>æŸ¥çœ‹&lt;code>kube-flannel.yml&lt;/code>ä¸­flanneldçš„å¯åŠ¨å‚æ•°ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>--ip-masq &lt;/code>: éœ€è¦ä¸ºå…¶é…ç½®SNAT&lt;/li>
&lt;li>&lt;code>--kube-subnet-mgr&lt;/code> : ä»£è¡¨å…¶ä½¿ç”¨kubeç±»å‹çš„subnet-managerã€‚è¯¥ç±»å‹æœ‰åˆ«äºä½¿ç”¨etcdçš„local-subnet-mgrç±»å‹ï¼Œä½¿ç”¨kubeç±»å‹åï¼Œflannelä¸Šå„Nodeçš„IPå­ç½‘åˆ†é…å‡åŸºäºK8S Nodeçš„spec.podCIDRå±æ€§&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>æˆ‘çš„æ˜¯å¤šç½‘å¡çš„æœºå™¨ï¼Œå‘ç°ç½‘ç»œä¸é€šï¼Œæ‰€ä»¥æˆ‘ç‰¹åˆ«æŒ‡å®šçš„flanneldç”¨æ¥å¯¹å¤–é€šä¿¡çš„ç½‘å¡
å¢åŠ &amp;ndash;iface å‚æ•°ï¼ŒæŒ‡å®šå¯ä»¥è¿›è¡Œå¤–éƒ¨é€šä¿¡çš„ç½‘å¡&lt;/p>
&lt;/blockquote>
&lt;h2>åŒºåˆ«&lt;span class="hx-absolute -hx-mt-20" id="åŒºåˆ«">&lt;/span>
&lt;a href="#%e5%8c%ba%e5%88%ab" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>flanneld å®¹å™¨åŒ–äº†&lt;/li>
&lt;li>flanneld ç½‘æ®µä¿¡æ¯æ¥æºäºkubernetes apiï¼Œè€Œä¸ä¾èµ–etcd&lt;/li>
&lt;/ul>
&lt;h1>åŸç†&lt;/h1>&lt;p>ä»¥ä¸Šä¸¤ç§æ–¹å¼çš„å¯¹æ¯”å¯ä»¥å‘ç°ï¼Œé€šè¿‡cniæ–¹å¼å®‰è£…çš„flannelä¼šå¤šä¸€ä¸ª&lt;code>cni0&lt;/code>çš„ç½‘æ¡¥ï¼Œå…¶å®è¿™ä¸ªä¸&lt;code>docker0&lt;/code>ç½‘æ¡¥çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œåˆ›å»ºäº†ä¸€å¯¹veth pair åˆ†åˆ«è”é€šå®¹å™¨å†…éƒ¨ä¸ä¸»æœºç½‘ç»œï¼Œå¹¶æŠŠå…¶ä¸­ä¸€ç«¯æ¥å…¥&lt;code>cni0&lt;/code>ç½‘æ¡¥ã€‚&lt;/p>
&lt;p>æ•´ä¸ªé€šä¿¡è¿‡ç¨‹å¦‚å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="https://ws1.sinaimg.cn/large/65209136gy1fvmsrceiq7j20oh0gv0ut.jpg" alt="" loading="lazy" />&lt;/p>
&lt;blockquote>
&lt;p>å›¾ä¸­çš„ipä¿¡æ¯ä¸æœ¬æœºä¸ä¸€è‡´ï¼Œä¸»è¦è¯´æ˜é€šä¿¡è¿‡ç¨‹&lt;/p>
&lt;/blockquote>
&lt;p>å®¹å™¨å†…éƒ¨-&amp;gt;docker0-&amp;gt;flanneld-&amp;gt;ç½‘ç»œä¼ è¾“-&amp;gt;å¯¹ç«¯flanneld-&amp;gt;å¯¹ç«¯docker0-&amp;gt;å¯¹ç«¯å®¹å™¨å†…&lt;/p>
&lt;p>å½“æ•°æ®åŒ…åˆ°å§flanneldåæ”¯æŒå¤šç§backendè¿›è¡Œè½¬å‘&lt;/p>
&lt;h2>Flannel backend&lt;span class="hx-absolute -hx-mt-20" id="flannel-backend">&lt;/span>
&lt;a href="#flannel-backend" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;ul>
&lt;li>Host-gw: åŒä¸€ç½‘æ®µç›´æ¥é€šä¿¡ï¼Œé€Ÿåº¦å¿«&lt;/li>
&lt;li>udpï¼š ç”¨æˆ·ç©ºé—´çš„udpå°è£…&lt;/li>
&lt;li>vxlan: åˆ©ç”¨å†…æ ¸vxlanåè®®è¿›è¡Œä¼ è¾“&lt;/li>
&lt;li>aws vpc: åˆ©ç”¨awså¹³å°å†…éƒ¨æä¾›çš„åŠŸèƒ½è¿›è¡Œä¼ è¾“&lt;/li>
&lt;/ul>
&lt;p>æ›´å¤šæ’ä»¶å‚è€ƒæ–‡æ¡£ï¼š&lt;a href="https://github.com/coreos/flannel/blob/master/Documentation/backends.md" target="_blank" rel="noopener">https://github.com/coreos/flannel/blob/master/Documentation/backends.md&lt;/a>&lt;/p>
&lt;p>&lt;strong>å¦‚ä½•é€‰æ‹©ï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>&lt;code>vxlan&lt;/code>åœ¨åŠŸèƒ½ä¸Šï¼Œå’Œæ€§èƒ½ä¸ŠåŸºæœ¬æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œå¯ä»¥ç›´æ¥è·¨ç½‘æ®µé—´é€šä¿¡ï¼ŒåŒæ—¶æ€§èƒ½ä¸Šåˆæ¯”udpçš„æ–¹å¼é«˜æ•ˆ&lt;/p></description></item><item><title>k8sæºç é˜…è¯»(ä¸€)ï¼šæºç ç»“æ„</title><link>/blog/201809/k8s-source-code-structure/</link><pubDate>Wed, 12 Sep 2018 11:45:59 +0800</pubDate><guid>/blog/201809/k8s-source-code-structure/</guid><description>
&lt;h1>ç¯å¢ƒ&lt;/h1>&lt;ul>
&lt;li>k8sä»£ç ç‰ˆæœ¬ï¼š&lt;a href="https://github.com/silenceper/kubernetes" target="_blank" rel="noopener">release-1.9&lt;/a>&lt;/li>
&lt;li>å·¥å…·ï¼švscode, dlv&lt;/li>
&lt;/ul>
&lt;p>ä¸‹è½½ä»£ç ï¼Œå¹¶æ”¾å…¥gopathä¸­ï¼Œæ–¹ä¾¿ç¼–è¯‘ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ mkdir -p $GOPATH/src/k8s.io &amp;amp;&amp;amp; cd $GOPATH/src/k8s.io
$ git clone https://github.com/kubernetes/kubernetes # æœ‰å¢™&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>ä»£ç ç»“æ„&lt;/h1>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>â”œâ”€â”€ Godeps godepä¾èµ–æ–‡ä»¶
â”œâ”€â”€ api swagger apiæ–‡æ¡£
â”œâ”€â”€ build æ„å»ºç”¨åˆ°çš„å‘½ä»¤
â”œâ”€â”€ cluster è‡ªåŠ¨æ„å»ºå’Œå¿«é€Ÿæ„å»ºk8sé›†ç¾¤çš„è„šæœ¬(è¿›å…¥ç»´æŠ¤é˜¶æ®µ)
â”œâ”€â”€ cmd æ ¸å¿ƒï¼šå‘½ä»¤å…¥å£
â”œâ”€â”€ docs æ–‡æ¡£
â”œâ”€â”€ examples ä¸€äº›éƒ¨ç½²æ ·ä¾‹yamlæ–‡ä»¶
â”œâ”€â”€ hack hackä»£ç 
â”œâ”€â”€ logo logoå›¾ç‰‡
â”œâ”€â”€ pkg æ ¸å¿ƒï¼šå…·ä½“å‘½ä»¤çš„é€»è¾‘ä»£ç 
â”œâ”€â”€ plugin ä¸»è¦æ˜¯kube-scheduler
â”œâ”€â”€ staging æš‚å­˜åŒºï¼Œç”¨äºåˆ†ç¦»ä»“åº“
â”œâ”€â”€ test test
â”œâ”€â”€ third_party ä¸€äº›ç¬¬ä¸‰æ–¹å·¥å…·
â”œâ”€â”€ translations å¤šè¯­è¨€æ–‡ä»¶
â””â”€â”€ vendor ä¾èµ–ä»£ç &lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ç»„ä»¶å…¥å£åŸºæœ¬éƒ½åœ¨&lt;code>/cmd/&lt;/code>ç›®å½•ä¸‹ï¼Œå¹¶ä¸”å¯ç›´æ¥é€šè¿‡&lt;code>go build&lt;/code>å•ç‹¬ç¼–è¯‘ï¼ˆé€šè¿‡&lt;code>make xxxx&lt;/code>ä¹Ÿè¡Œï¼Œ&lt;code>make help&lt;/code>æŸ¥çœ‹å…·ä½“æŒ‡ä»¤ï¼‰&lt;/p>
&lt;h1>DLVè°ƒè¯•é˜…è¯»&lt;/h1>&lt;p>æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥é€šè¿‡&lt;code>dlv&lt;/code>å‘½ä»¤è¿›è¡Œè°ƒè¯•ï¼Œæ¯”å¦‚è°ƒè¯•kubeletç»„ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ cd cmd/kubelet
$ dlv debug . -- --logtostderr=true --v=5 --address=192.168.99.102 --hostname-override=192.168.99.102 --allow-privileged=true --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --cert-dir=/etc/kubernetes/ssl --cluster-domain=cluster.local --hairpin-mode promiscuous-bridge --serialize-image-pulls=false&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>å…¶ä¸­&lt;code>--&lt;/code>åä¸ºç¨‹åºè¿è¡Œå‚æ•°&lt;/p>
&lt;/blockquote>
&lt;p>è¿›å…¥ä¹‹åä¸ºé€šè¿‡&lt;code>break&lt;/code>ï¼Œ&lt;code>n&lt;/code>,&lt;code>s&lt;/code>,&lt;code>p&lt;/code>ç­‰æŒ‡ä»¤æ“ä½œï¼Œè¿™ç§æ–¹å¼ä¸å¤ªæ–¹ä¾¿ï¼Œå°¤å…¶å¯¹äºk8sè¿™ç§å¤§å·¥ç¨‹ï¼Œæ¨èé…åˆå·¥å…·è¿›è¡Œï¼Œæ¯”å¦‚vscodeã€‚&lt;/p>
&lt;p>é€šè¿‡æˆ‘é…ç½®&lt;code>launch.json&lt;/code>æ–‡ä»¶çš„&lt;code>args&lt;/code>å‚æ•°ï¼Œè®©&lt;code>kubelet&lt;/code>è¿è¡Œèµ·æ¥ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>&amp;#34;args&amp;#34;: [
&amp;#34;--address=192.168.186.219&amp;#34;,
&amp;#34;--hostname-override=192.168.186.219&amp;#34;,
&amp;#34;--cluster-domain=cluster.local&amp;#34;,
&amp;#34;--root-dir=/Users/silenceper/workspace/golang/src/k8s.io/kubelet&amp;#34;,
&amp;#34;--bootstrap-kubeconfig=/Users/silenceper/workspace/golang/src/k8s.io/kubelet/kubernetes/bootstrap.kubeconfig&amp;#34;,
&amp;#34;--kubeconfig=/Users/silenceper/workspace/golang/src/k8s.io/kubelet/kubernetes/kubelet.kubeconfig&amp;#34;,
&amp;#34;--cert-dir=/Users/silenceper/workspace/golang/src/k8s.io/kubelet/kubernetes/ssl&amp;#34;,
],&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>é€šè¿‡è°ƒè¯•ï¼Œå¯ä»¥åšåˆ°è¾¹çœ‹ä»£ç ï¼Œå˜è¿½è¸ªkubeletçš„æ‰§è¡Œè¿‡ç¨‹&lt;/p>
&lt;blockquote>
&lt;p>å› ä¸ºosçš„åŸå› ï¼Œæ‰§è¡Œæµç¨‹å¯èƒ½ä¸ç›®æ ‡å¹³å°çš„æ‰§è¡Œç»“æœå¯èƒ½ä¸ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æ‰‹åŠ¨æ”¹ä»£ç è¾¾åˆ°é¢„æœŸç»“æœï¼Œæˆ–è€…ç›´æ¥åœ¨Linuxä¸‹è°ƒè¯•&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://ws1.sinaimg.cn/large/65209136gy1fv6z2jx1ajj21g20sc7b3.jpg" alt="11" loading="lazy" />&lt;/p></description></item><item><title>docker pull ç¿»å¢™ä¸‹è½½é•œåƒ</title><link>/blog/201809/over-the-wall-pull-docker-mirror/</link><pubDate>Sun, 09 Sep 2018 11:45:59 +0800</pubDate><guid>/blog/201809/over-the-wall-pull-docker-mirror/</guid><description>
&lt;p>æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡è®¾ç½®&lt;code>http_proxy&lt;/code>ç¯å¢ƒå˜é‡ï¼Œä½¿å¾—httpè¯·æ±‚ï¼Œå¯ä»¥èµ°æˆ‘ä»¬è®¾ç½®çš„proxyï¼Œï¼ˆä¸€äº›go geté•œåƒæ— æ³•ä¸‹è½½å¯ä»¥è¿™ä¹ˆç”¨ï¼‰ï¼Œä½†æ˜¯å¯¹äº&lt;code>docker pull&lt;/code>å‘½ä»¤æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼Œå› ä¸ºsystemdå¼•å¯¼å¯åŠ¨çš„serviceé»˜è®¤ä¸ä¼šè¯»å–è¿™äº›å˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨serviceæ–‡ä»¶ä¸­åŠ å…¥ç¯å¢ƒå˜é‡è§£å†³ï¼š&lt;/p>
&lt;h1>è®¾ç½®å˜é‡ http_proxy&lt;/h1>&lt;p>ä¸»è¦æ˜¯é€šè¿‡åœ¨dockerå¯åŠ¨çš„æ—¶å€™æŒ‡å®š&lt;code>HTTP_PROXY &lt;/code>ï¼Œ&lt;code>HTTPS_PROXY&lt;/code>ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[Service]
Environment=&amp;#34;HTTP_PROXY=http://proxy.example.com:80/&amp;#34; &amp;#34;HTTPS_PROXY=http://proxy.example.com:80/&amp;#34;&amp;#34;NO_PROXY=localhost,127.0.0.1,docker-registry.somecorporation.com&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­&lt;code>NO_PROXY&lt;/code>å˜é‡æŒ‡çš„æ˜¯é‚£äº›httpè¯·æ±‚ä¸èµ°ä»£ç†ã€‚&lt;/p>
&lt;p>ä¸‹é¢ä¸¤ç§éƒ½æ˜¯ä¸€æ ·çš„æ•ˆæœï¼Œæ¨èæ–¹å¼äºŒï¼Œå¯ä»¥é¿å…ç›´æ¥ä¿®æ”¹&lt;code>docker.service&lt;/code>æ–‡ä»¶ï¼Œé˜²æ­¢å‡çº§ä¹‹åæ–‡ä»¶è¦†ç›–ã€‚&lt;/p>
&lt;h2>æ–¹å¼ä¸€ï¼š ç›´æ¥ä¿®æ”¹docker.service æ–‡ä»¶&lt;span class="hx-absolute -hx-mt-20" id="æ–¹å¼ä¸€-ç›´æ¥ä¿®æ”¹dockerservice-æ–‡ä»¶">&lt;/span>
&lt;a href="#%e6%96%b9%e5%bc%8f%e4%b8%80-%e7%9b%b4%e6%8e%a5%e4%bf%ae%e6%94%b9dockerservice-%e6%96%87%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>docker serviceæ–‡ä»¶&lt;code>/usr/lib/systemd/system/docker.service&lt;/code>ï¼Œåœ¨Serviceæ®µé…ç½®ä¸­åŠ å…¥ã€‚&lt;/p>
&lt;h2>æ–¹å¼äºŒï¼šé€šè¿‡override.confæ–‡ä»¶(æ¨è)&lt;span class="hx-absolute -hx-mt-20" id="æ–¹å¼äºŒé€šè¿‡overrideconfæ–‡ä»¶æ¨è">&lt;/span>
&lt;a href="#%e6%96%b9%e5%bc%8f%e4%ba%8c%e9%80%9a%e8%bf%87overrideconf%e6%96%87%e4%bb%b6%e6%8e%a8%e8%8d%90" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>æ–‡ä»¶è·¯å¾„ï¼š
&lt;code>/etc/systemd/system/docker.service.d/override.conf&lt;/code>&lt;/p>
&lt;p>å¯ä»¥ç›´æ¥é€šè¿‡&lt;code>systemctl edit docker&lt;/code>æ‰“å¼€æ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼ŒåŠ å…¥ä¸Šè¿°é…ç½®ï¼Œé‡å¯ç”Ÿæ•ˆã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¿™ç§æ–¹å¼æ¥ä¹‹ &lt;a href="https://github.com/abcfy2" target="_blank" rel="noopener">@Feng_Yu&lt;/a>çš„æé†’ï¼ŒTHK&lt;/p>
&lt;/blockquote>
&lt;h2>é‡å¯docker&lt;span class="hx-absolute -hx-mt-20" id="é‡å¯docker">&lt;/span>
&lt;a href="#%e9%87%8d%e5%90%afdocker" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>systemctl daemon-reload
systemctl restart docker&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>TIPS: &lt;code>polipo&lt;/code> å¯ä»¥å°†&lt;code>socks5&lt;/code>åè®®è½¬æ¢æˆ&lt;code>http&lt;/code>ä»£ç†ã€‚&lt;/strong>&lt;/p>
&lt;h1>å‚è€ƒèµ„æ–™&lt;/h1>&lt;blockquote>
&lt;p>&lt;a href="https://docs.docker.com/config/daemon/systemd/#httphttps-proxy" target="_blank" rel="noopener">https://docs.docker.com/config/daemon/systemd/#httphttps-proxy&lt;/a>&lt;/p>
&lt;/blockquote></description></item><item><title>åœ¨CentOSä¸Šæ­å»ºKubernetesé›†ç¾¤</title><link>/blog/201809/how-to-build-a-k8s-cluster/</link><pubDate>Fri, 07 Sep 2018 11:45:59 +0800</pubDate><guid>/blog/201809/how-to-build-a-k8s-cluster/</guid><description>
&lt;p>ä»¥ä¸‹æ˜¯æˆ‘è‡ªå·±åœ¨éƒ¨ç½²k8sé›†ç¾¤ä¸Šåšçš„ä¸€äº›è®°å½•ï¼Œéƒ¨ç½²äº†ä¸€ä¸ªmasterï¼Œä¸€ä¸ªnodeèŠ‚ç‚¹ã€‚&lt;/p>
&lt;h1>ç¯å¢ƒå‡†å¤‡&lt;/h1>&lt;p>æˆ‘åœ¨VirtualBoxä¸­å»ºçš„ä¸¤ä¸ªCentOSå®¹å™¨ï¼Œå¹¶ä¸”äº’é€šï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>IP&lt;/th>
&lt;th>ç³»ç»Ÿ&lt;/th>
&lt;th>è§’è‰²&lt;/th>
&lt;th>é…ç½®&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>192.168.99.101&lt;/td>
&lt;td>CentOS 7.5.1804&lt;/td>
&lt;td>master&lt;/td>
&lt;td>1æ ¸2G&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>192.168.99.102&lt;/td>
&lt;td>CentOS 7.5.1804&lt;/td>
&lt;td>node&lt;/td>
&lt;td>1æ ¸2G&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å®‰è£…ç‰ˆæœ¬ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>ç»„ä»¶&lt;/th>
&lt;th>ç‰ˆæœ¬&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Kubernetes&lt;/td>
&lt;td>1.10.7&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Etcd&lt;/td>
&lt;td>3.1.10&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Docker&lt;/td>
&lt;td>17.12.1-ce&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h1>è¯ä¹¦å‡†å¤‡&lt;/h1>&lt;p>ä½¿ç”¨CFSSLå·¥å…·è¿›è¡Œè¯ä¹¦ç”Ÿæˆ&lt;/p>
&lt;p>CAè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ä¸»è¦ç”¨æ¥åšä¼ è¾“åŠ å¯†ç”¨çš„ï¼Œå°†ä¼šç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>ca-key.pem&lt;/li>
&lt;li>ca.pem&lt;/li>
&lt;li>kubernetes-key.pem&lt;/li>
&lt;li>kubernetes.pem&lt;/li>
&lt;li>kube-proxy.pem&lt;/li>
&lt;li>kube-proxy-key.pem&lt;/li>
&lt;li>admin.pem&lt;/li>
&lt;li>admin-key.pem&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨è¯ä¹¦çš„ç»„ä»¶å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>etcdï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼›&lt;/li>
&lt;li>kube-apiserverï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼›&lt;/li>
&lt;li>kubeletï¼šä½¿ç”¨ ca.pemï¼›&lt;/li>
&lt;li>kube-proxyï¼šä½¿ç”¨ ca.pemã€kube-proxy-key.pemã€kube-proxy.pemï¼›&lt;/li>
&lt;li>kubectlï¼šä½¿ç”¨ ca.pemã€admin-key.pemã€admin.pemï¼›&lt;/li>
&lt;li>kube-controller-managerï¼šä½¿ç”¨ ca-key.pemã€ca.pem&lt;/li>
&lt;/ul>
&lt;p>åœ¨masterèŠ‚ç‚¹ä¸Šè¿›è¡Œæ“ä½œï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
chmod &amp;#43;x cfssl_linux-amd64
mv cfssl_linux-amd64 /usr/local/bin/cfssl
wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
chmod &amp;#43;x cfssljson_linux-amd64
mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod &amp;#43;x cfssl-certinfo_linux-amd64
mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo
export PATH=/usr/local/bin:$PATH&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åˆ›å»ºcaè¯ä¹¦&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»ºcaè¯ä¹¦">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%baca%e8%af%81%e4%b9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åˆ›å»º &lt;code>ca-config.json&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>{
&amp;#34;signing&amp;#34;: {
&amp;#34;default&amp;#34;: {
&amp;#34;expiry&amp;#34;: &amp;#34;87600h&amp;#34;
},
&amp;#34;profiles&amp;#34;: {
&amp;#34;kubernetes&amp;#34;: {
&amp;#34;usages&amp;#34;: [
&amp;#34;signing&amp;#34;,
&amp;#34;key encipherment&amp;#34;,
&amp;#34;server auth&amp;#34;,
&amp;#34;client auth&amp;#34;
],
&amp;#34;expiry&amp;#34;: &amp;#34;87600h&amp;#34;
}
}
}
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åˆ›å»º &lt;code>ca-csr.json&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>{
&amp;#34;CN&amp;#34;: &amp;#34;kubernetes&amp;#34;,
&amp;#34;key&amp;#34;: {
&amp;#34;algo&amp;#34;: &amp;#34;rsa&amp;#34;,
&amp;#34;size&amp;#34;: 2048
},
&amp;#34;names&amp;#34;: [
{
&amp;#34;C&amp;#34;: &amp;#34;CN&amp;#34;,
&amp;#34;ST&amp;#34;: &amp;#34;BeiJing&amp;#34;,
&amp;#34;L&amp;#34;: &amp;#34;BeiJing&amp;#34;,
&amp;#34;O&amp;#34;: &amp;#34;k8s&amp;#34;,
&amp;#34;OU&amp;#34;: &amp;#34;System&amp;#34;
}
],
&amp;#34;ca&amp;#34;: {
&amp;#34;expiry&amp;#34;: &amp;#34;87600h&amp;#34;
}
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ç”Ÿæˆcaè¯ä¹¦å’Œç§é’¥&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>ç”Ÿæˆkubernetesè¯ä¹¦&lt;span class="hx-absolute -hx-mt-20" id="ç”Ÿæˆkubernetesè¯ä¹¦">&lt;/span>
&lt;a href="#%e7%94%9f%e6%88%90kubernetes%e8%af%81%e4%b9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åˆ›å»º&lt;code>kubernetes-csr.json&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>{
&amp;#34;CN&amp;#34;: &amp;#34;kubernetes&amp;#34;,
&amp;#34;hosts&amp;#34;: [
&amp;#34;127.0.0.1&amp;#34;,
&amp;#34;192.168.99.101&amp;#34;,
&amp;#34;192.168.99.102&amp;#34;,
&amp;#34;10.254.0.1&amp;#34;,
&amp;#34;kubernetes&amp;#34;,
&amp;#34;kubernetes.default&amp;#34;,
&amp;#34;kubernetes.default.svc&amp;#34;,
&amp;#34;kubernetes.default.svc.cluster&amp;#34;,
&amp;#34;kubernetes.default.svc.cluster.local&amp;#34;
],
&amp;#34;key&amp;#34;: {
&amp;#34;algo&amp;#34;: &amp;#34;rsa&amp;#34;,
&amp;#34;size&amp;#34;: 2048
},
&amp;#34;names&amp;#34;: [
{
&amp;#34;C&amp;#34;: &amp;#34;CN&amp;#34;,
&amp;#34;ST&amp;#34;: &amp;#34;BeiJing&amp;#34;,
&amp;#34;L&amp;#34;: &amp;#34;BeiJing&amp;#34;,
&amp;#34;O&amp;#34;: &amp;#34;k8s&amp;#34;,
&amp;#34;OU&amp;#34;: &amp;#34;System&amp;#34;
}
]
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å…¶ä¸­ipæ®µæ”¹ä¸ºè‡ªå·±çš„ipï¼ŒåŒ…æ‹¬etcdé›†ç¾¤IPï¼Œk8s masteré›†ç¾¤ipï¼Œk8sæœåŠ¡çš„æœåŠ¡ip(ä¸€èˆ¬æ˜¯ kube-apiserver æŒ‡å®šçš„ service-cluster-ip-range ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIPï¼Œå¦‚ 10.254.0.1)&lt;/p>
&lt;p>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åˆ›å»ºadminè¯ä¹¦&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»ºadminè¯ä¹¦">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%baadmin%e8%af%81%e4%b9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åˆ›å»º &lt;code>admin-csr.json&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>{
&amp;#34;CN&amp;#34;: &amp;#34;admin&amp;#34;,
&amp;#34;hosts&amp;#34;: [],
&amp;#34;key&amp;#34;: {
&amp;#34;algo&amp;#34;: &amp;#34;rsa&amp;#34;,
&amp;#34;size&amp;#34;: 2048
},
&amp;#34;names&amp;#34;: [
{
&amp;#34;C&amp;#34;: &amp;#34;CN&amp;#34;,
&amp;#34;ST&amp;#34;: &amp;#34;BeiJing&amp;#34;,
&amp;#34;L&amp;#34;: &amp;#34;BeiJing&amp;#34;,
&amp;#34;O&amp;#34;: &amp;#34;system:masters&amp;#34;,
&amp;#34;OU&amp;#34;: &amp;#34;System&amp;#34;
}
]
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ç”Ÿæˆè¯ä¹¦&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åˆ›å»ºkube-proxyè¯ä¹¦&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»ºkube-proxyè¯ä¹¦">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%bakube-proxy%e8%af%81%e4%b9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åˆ›å»ºkube-proxy-csr.jsonæ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>{
&amp;#34;CN&amp;#34;: &amp;#34;system:kube-proxy&amp;#34;,
&amp;#34;hosts&amp;#34;: [],
&amp;#34;key&amp;#34;: {
&amp;#34;algo&amp;#34;: &amp;#34;rsa&amp;#34;,
&amp;#34;size&amp;#34;: 2048
},
&amp;#34;names&amp;#34;: [
{
&amp;#34;C&amp;#34;: &amp;#34;CN&amp;#34;,
&amp;#34;ST&amp;#34;: &amp;#34;BeiJing&amp;#34;,
&amp;#34;L&amp;#34;: &amp;#34;BeiJing&amp;#34;,
&amp;#34;O&amp;#34;: &amp;#34;k8s&amp;#34;,
&amp;#34;OU&amp;#34;: &amp;#34;System&amp;#34;
}
]
}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ç”Ÿæˆå‘½ä»¤ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åˆ†å‘è¯ä¹¦&lt;span class="hx-absolute -hx-mt-20" id="åˆ†å‘è¯ä¹¦">&lt;/span>
&lt;a href="#%e5%88%86%e5%8f%91%e8%af%81%e4%b9%a6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼ˆåç¼€ä¸º&lt;code>.pem&lt;/code>ï¼‰æ‹·è´åˆ°æ‰€æœ‰æœºå™¨çš„&lt;code>/etc/kubernetes/ssl&lt;/code> ç›®å½•ä¸‹&lt;/p>
&lt;blockquote>
&lt;p>å‘½ä»¤ç•¥&lt;/p>
&lt;/blockquote>
&lt;h1>å®‰è£…kubectlæ–‡ä»¶&lt;/h1>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>wget -c https://dl.k8s.io/v1.10.7/kubernetes-client-darwin-386.tar.gz
tar -xzvf kubernetes-client-linux-amd64.tar.gz
cp kubernetes/client/bin/kube* /usr/bin/
chmod a&amp;#43;x /usr/bin/kube*&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åˆ›å»º kubectl kubeconfig æ–‡ä»¶&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»º-kubectl-kubeconfig-æ–‡ä»¶">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%ba-kubectl-kubeconfig-%e6%96%87%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>export KUBE_APISERVER=&amp;#34;https://192.168.99.101:6443&amp;#34;
# è®¾ç½®é›†ç¾¤å‚æ•°
kubectl config set-cluster kubernetes \
--certificate-authority=/etc/kubernetes/ssl/ca.pem \
--embed-certs=true \
--server=${KUBE_APISERVER}
# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°
kubectl config set-credentials admin \
--client-certificate=/etc/kubernetes/ssl/admin.pem \
--embed-certs=true \
--client-key=/etc/kubernetes/ssl/admin-key.pem
# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°
kubectl config set-context kubernetes \
--cluster=kubernetes \
--user=admin
# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡
kubectl config use-context kubernetes&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>admin è¯ä¹¦ä¸­è®¾å®šäº† &lt;code>group=system:masters&lt;/code>å³ï¼ˆO=system:mastersï¼‰
è¿™ä¸ªgroupä¸ckuster-admin ClusterRoleç»‘å®šï¼Œæ‰€ä»¥å…·æœ‰æ•´ä¸ªé›†ç¾¤çš„æƒé™
å¦‚æœéœ€è¦å•ç‹¬æŒ‡å®šæƒé™ï¼Œåˆ™å¯ä»¥è‡ªå·±è®¾å®šuserç»‘å®šClusterRole&lt;/p>
&lt;/blockquote>
&lt;h1>åˆ›å»º kubeconfig æ–‡ä»¶&lt;/h1>&lt;h2>åˆ›å»º TLS Bootstrapping Token&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»º-tls-bootstrapping-token">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%ba-tls-bootstrapping-token" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d &amp;#39; &amp;#39;)
$ cat &amp;gt; token.csv &amp;lt;&amp;lt;EOF
${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,&amp;#34;system:kubelet-bootstrap&amp;#34;
EOF
$ cp token.csv /etc/kubernetes/&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åˆ›å»º kubelet bootstrapping kubeconfig æ–‡ä»¶&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»º-kubelet-bootstrapping-kubeconfig-æ–‡ä»¶">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%ba-kubelet-bootstrapping-kubeconfig-%e6%96%87%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>cd /etc/kubernetes
export KUBE_APISERVER=&amp;#34;https://192.168.99.101:6443&amp;#34;
# è®¾ç½®é›†ç¾¤å‚æ•°
kubectl config set-cluster kubernetes \
--certificate-authority=/etc/kubernetes/ssl/ca.pem \
--embed-certs=true \
--server=${KUBE_APISERVER} \
--kubeconfig=bootstrap.kubeconfig
# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°
kubectl config set-credentials kubelet-bootstrap \
--token=${BOOTSTRAP_TOKEN} \
--kubeconfig=bootstrap.kubeconfig
# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°
kubectl config set-context default \
--cluster=kubernetes \
--user=kubelet-bootstrap \
--kubeconfig=bootstrap.kubeconfig
# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡
kubectl config use-context default --kubeconfig=bootstrap.kubeconfig&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åˆ›å»º kube-proxy kubeconfig æ–‡ä»¶&lt;span class="hx-absolute -hx-mt-20" id="åˆ›å»º-kube-proxy-kubeconfig-æ–‡ä»¶">&lt;/span>
&lt;a href="#%e5%88%9b%e5%bb%ba-kube-proxy-kubeconfig-%e6%96%87%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>export KUBE_APISERVER=&amp;#34;https://192.168.99.101:6443&amp;#34;
# è®¾ç½®é›†ç¾¤å‚æ•°
kubectl config set-cluster kubernetes \
--certificate-authority=/etc/kubernetes/ssl/ca.pem \
--embed-certs=true \
--server=${KUBE_APISERVER} \
--kubeconfig=kube-proxy.kubeconfig
# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°
kubectl config set-credentials kube-proxy \
--client-certificate=/etc/kubernetes/ssl/kube-proxy.pem \
--client-key=/etc/kubernetes/ssl/kube-proxy-key.pem \
--embed-certs=true \
--kubeconfig=kube-proxy.kubeconfig
# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°
kubectl config set-context default \
--cluster=kubernetes \
--user=kube-proxy \
--kubeconfig=kube-proxy.kubeconfig
# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡
kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>åˆ†å‘kubeconfigæ–‡ä»¶&lt;span class="hx-absolute -hx-mt-20" id="åˆ†å‘kubeconfigæ–‡ä»¶">&lt;/span>
&lt;a href="#%e5%88%86%e5%8f%91kubeconfig%e6%96%87%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å°†ä¸¤ä¸ª kubeconfig æ–‡ä»¶åˆ†å‘åˆ°æ‰€æœ‰ Node æœºå™¨çš„ /etc/kubernetes/ ç›®å½•&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>cp bootstrap.kubeconfig kube-proxy.kubeconfig /etc/kubernetes/&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>Etcdå®‰è£…&lt;/h1>&lt;p>æˆ‘è¿™é‡Œä¸ºäº†ç®€å•ï¼ŒETCDèŠ‚ç‚¹åªç”¨äº†ä¸€ä¸ªï¼Œå¹¶ä¸”å®‰è£…åœ¨äº†masterèŠ‚ç‚¹ä¸Šï¼Œå¤šä¸ªä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯åœ¨&lt;code>--initial-cluster&lt;/code>é€‰æ‹©ä¸­å°†å…¶ä»–èŠ‚ç‚¹ipå¡«å…¥è¿›å»ã€‚&lt;/p>
&lt;p>ä¸‹è½½ETCD:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ wget -c https://github.com/coreos/etcd/releases/download/v3.1.10/etcd-v3.1.10-linux-amd64.tar.gz
$ tar -zxvf etcd-v3.1.10-linux-amd64.tar.gz
$ mv etcd-v3.1.10-linux-amd64/etcd* /usr/local/bin&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åˆ›å»º etcd çš„ systemd unit æ–‡ä»¶&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>vim /usr/lib/systemd/system/etcd.service&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos
[Service]
Type=notify
WorkingDirectory=/var/lib/etcd/
EnvironmentFile=-/etc/etcd/etcd.conf
ExecStart=/usr/local/bin/etcd \
--name ${ETCD_NAME} \
--cert-file=/etc/kubernetes/ssl/kubernetes.pem \
--key-file=/etc/kubernetes/ssl/kubernetes-key.pem \
--peer-cert-file=/etc/kubernetes/ssl/kubernetes.pem \
--peer-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \
--trusted-ca-file=/etc/kubernetes/ssl/ca.pem \
--peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \
--initial-advertise-peer-urls ${ETCD_INITIAL_ADVERTISE_PEER_URLS} \
--listen-peer-urls ${ETCD_LISTEN_PEER_URLS} \
--listen-client-urls ${ETCD_LISTEN_CLIENT_URLS},http://127.0.0.1:2379 \
--advertise-client-urls ${ETCD_ADVERTISE_CLIENT_URLS} \
--initial-cluster-token ${ETCD_INITIAL_CLUSTER_TOKEN} \
--initial-cluster infra1=https://192.168.99.101:2380 \
--initial-cluster-state new \
--data-dir=${ETCD_DATA_DIR}
Restart=on-failure
RestartSec=5
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åˆ›å»º&lt;code>/etc/etcd/etcd.conf&lt;/code>æ–‡ä»¶:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code># [member]
ETCD_NAME=infra1
ETCD_DATA_DIR=&amp;#34;/var/lib/etcd&amp;#34;
ETCD_LISTEN_PEER_URLS=&amp;#34;https://192.168.99.101:2380&amp;#34;
ETCD_LISTEN_CLIENT_URLS=&amp;#34;https://192.168.99.101:2379&amp;#34;
#[cluster]
ETCD_INITIAL_ADVERTISE_PEER_URLS=&amp;#34;https://192.168.99.101:2380&amp;#34;
ETCD_INITIAL_CLUSTER_TOKEN=&amp;#34;etcd-cluster&amp;#34;
ETCD_ADVERTISE_CLIENT_URLS=&amp;#34;https://192.168.99.101:2379&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨æœåŠ¡ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>mv etcd.service /usr/lib/systemd/system/
mkdir /var/lib/etcd
systemctl daemon-reload
systemctl enable etcd
systemctl start etcd
systemctl status etcd&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>éªŒè¯æœåŠ¡ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>etcdctl --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/kubernetes/ssl/kubernetes.pem --key-file=/etc/kubernetes/ssl/kubernetes-key.pem cluster-health
2018-09-07 15:41:30.782777 I | warning: ignoring ServerName for user-provided CA for backwards compatibility is deprecated
2018-09-07 15:41:30.783295 I | warning: ignoring ServerName for user-provided CA for backwards compatibility is deprecated
member 171ef35542ebf92b is healthy: got healthy result from https://192.168.99.101:2379
cluster is healthy&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>cluster is healthy &lt;/code>è¡¨ç¤ºæˆåŠŸã€‚&lt;/p>
&lt;h1>MasterèŠ‚ç‚¹éƒ¨ç½²&lt;/h1>&lt;p>masterèŠ‚ç‚¹ä¸Šä¸»è¦æ˜¯ä¸‰ä¸ªç»„ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>kube-apiserver&lt;/li>
&lt;li>kube-scheduler&lt;/li>
&lt;li>kube-controller-manager&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>åŒäº‹åªèƒ½åˆä¸€ä¸ª&lt;code>kube-scheduler&lt;/code>,&lt;code>kube-controller-manager&lt;/code>è¿›ç¨‹å¤„äºå·¥ä½œçŠ¶æ€ï¼Œå¦‚æœè¿è¡Œå¤šä¸ªï¼Œåˆ™éœ€è¦é€šè¿‡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªleaderã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä¸‹è½½serveråŒ…ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>wget -c https://dl.k8s.io/v1.10.7/kubernetes-server-linux-amd64.tar.gz
tar -xzvf kubernetes-server-linux-amd64.tar.gz
cd kubernetes
tar -xzvf kubernetes-src.tar.gz&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å°†äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ°æŒ‡å®šè·¯å¾„&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>cp -r server/bin/{kube-apiserver,kube-controller-manager,kube-scheduler} /usr/local/bin/&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åŒæ—¶å°† &lt;code>server/bin/&lt;/code>ç›®å½•ä¸‹çš„&lt;code>kube-proxy&lt;/code>,&lt;code>kubelet&lt;/code> ä¸‰ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°nodeèŠ‚ç‚¹çš„ &lt;code>/usr/local/bin/&lt;/code> ç›®å½•&lt;/p>
&lt;h2>é…ç½®å’Œå¯åŠ¨ kube-apiserver&lt;span class="hx-absolute -hx-mt-20" id="é…ç½®å’Œå¯åŠ¨-kube-apiserver">&lt;/span>
&lt;a href="#%e9%85%8d%e7%bd%ae%e5%92%8c%e5%90%af%e5%8a%a8-kube-apiserver" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åˆ›å»º &lt;code>/etc/kubernetes/config&lt;/code>æ–‡ä»¶:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>###
# kubernetes system config
#
# The following values are used to configure various aspects of all
# kubernetes services, including
#
# kube-apiserver.service
# kube-controller-manager.service
# kube-scheduler.service
# kubelet.service
# kube-proxy.service
# logging to stderr means we get it in the systemd journal
KUBE_LOGTOSTDERR=&amp;#34;--logtostderr=true&amp;#34;
# journal message level, 0 is debug
KUBE_LOG_LEVEL=&amp;#34;--v=0&amp;#34;
# Should this cluster be allowed to run privileged docker containers
KUBE_ALLOW_PRIV=&amp;#34;--allow-privileged=true&amp;#34;
# How the controller-manager, scheduler, and proxy find the apiserver
KUBE_MASTER=&amp;#34;--master=http://192.168.99.101:8080&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åˆ›å»ºserviceæ–‡ä»¶&lt;code>/usr/lib/systemd/system/kube-apiserver.service&lt;/code>ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[Unit]
Description=Kubernetes API Service
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target
After=etcd.service
[Service]
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/apiserver
ExecStart=/usr/local/bin/kube-apiserver \
$KUBE_LOGTOSTDERR \
$KUBE_LOG_LEVEL \
$KUBE_ETCD_SERVERS \
$KUBE_API_ADDRESS \
$KUBE_API_PORT \
$KUBELET_PORT \
$KUBE_ALLOW_PRIV \
$KUBE_SERVICE_ADDRESSES \
$KUBE_ADMISSION_CONTROL \
$KUBE_API_ARGS
Restart=on-failure
Type=notify
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>apiserverçš„é…ç½®æ–‡ä»¶ &lt;code>/etc/kubernetes/apiserver&lt;/code>:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>###
## kubernetes system config
##
## The following values are used to configure the kube-apiserver
##
#
## The address on the local server to listen to.
KUBE_API_ADDRESS=&amp;#34;--advertise-address=192.168.99.101 --bind-address=192.168.99.101 --insecure-bind-address=192.168.99.101&amp;#34;
#
## The port on the local server to listen on.
#KUBE_API_PORT=&amp;#34;--port=8080&amp;#34;
#
## Port minions listen on
#KUBELET_PORT=&amp;#34;--kubelet-port=10250&amp;#34;
#
## Comma separated list of nodes in the etcd cluster
KUBE_ETCD_SERVERS=&amp;#34;--etcd-servers=https://192.168.99.101:2379&amp;#34;
#
## Address range to use for services
KUBE_SERVICE_ADDRESSES=&amp;#34;--service-cluster-ip-range=10.254.0.0/16&amp;#34;
#
## default admission control policies
KUBE_ADMISSION_CONTROL=&amp;#34;--admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota&amp;#34;
#
## Add your own!
KUBE_API_ARGS=&amp;#34;--authorization-mode=Node,RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --enable-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem --client-ca-file=/etc/kubernetes/ssl/ca.pem --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem --etcd-cafile=/etc/kubernetes/ssl/ca.pem --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem --enable-swagger-ui=true --apiserver-count=3 --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-path=/var/lib/audit.log --event-ttl=1h&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨kube-apiserver:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>systemctl daemon-reload
systemctl enable kube-apiserver
systemctl start kube-apiserver
systemctl status kube-apiserver&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>é…ç½®å’Œå¯åŠ¨ kube-controller-manager&lt;span class="hx-absolute -hx-mt-20" id="é…ç½®å’Œå¯åŠ¨-kube-controller-manager">&lt;/span>
&lt;a href="#%e9%85%8d%e7%bd%ae%e5%92%8c%e5%90%af%e5%8a%a8-kube-controller-manager" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åˆ›å»º &lt;code>/usr/lib/systemd/system/kube-controller-manager.service&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
[Service]
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/controller-manager
ExecStart=/usr/local/bin/kube-controller-manager \
$KUBE_LOGTOSTDERR \
$KUBE_LOG_LEVEL \
$KUBE_MASTER \
$KUBE_CONTROLLER_MANAGER_ARGS
Restart=on-failure
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>é…ç½®æ–‡ä»¶ï¼š&lt;code>/etc/kubernetes/controller-manager&lt;/code>&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>###
# The following values are used to configure the kubernetes controller-manager
# defaults from config and apiserver should be adequate
# Add your own!
KUBE_CONTROLLER_MANAGER_ARGS=&amp;#34;--address=127.0.0.1 --service-cluster-ip-range=10.254.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem --root-ca-file=/etc/kubernetes/ssl/ca.pem --leader-elect=true&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨ kube-controller-manager:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>systemctl daemon-reload
systemctl enable kube-controller-manager
systemctl start kube-controller-manager
systemctl status kube-controller-manager&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>é…ç½®å’Œå¯åŠ¨ kube-scheduler&lt;span class="hx-absolute -hx-mt-20" id="é…ç½®å’Œå¯åŠ¨-kube-scheduler">&lt;/span>
&lt;a href="#%e9%85%8d%e7%bd%ae%e5%92%8c%e5%90%af%e5%8a%a8-kube-scheduler" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>åˆ›å»º&lt;code>/usr/lib/systemd/system/kube-scheduler.service&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[Unit]
Description=Kubernetes Scheduler Plugin
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
[Service]
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/scheduler
ExecStart=/usr/local/bin/kube-scheduler \
$KUBE_LOGTOSTDERR \
$KUBE_LOG_LEVEL \
$KUBE_MASTER \
$KUBE_SCHEDULER_ARGS
Restart=on-failure
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>/etc/kubernetes/scheduler&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>###
# kubernetes scheduler config
# default config should be adequate
# Add your own!
KUBE_SCHEDULER_ARGS=&amp;#34;--leader-elect=true --address=127.0.0.1&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨ kube-scheduler:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>systemctl daemon-reload
systemctl enable kube-scheduler
systemctl start kube-scheduler
systemctl status kube-scheduler&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>éªŒè¯masterèŠ‚ç‚¹&lt;span class="hx-absolute -hx-mt-20" id="éªŒè¯masterèŠ‚ç‚¹">&lt;/span>
&lt;a href="#%e9%aa%8c%e8%af%81master%e8%8a%82%e7%82%b9" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost ~]# kubectl get componentstatuses
NAME STATUS MESSAGE ERROR
scheduler Healthy ok
controller-manager Healthy ok
etcd-0 Healthy {&amp;#34;health&amp;#34;: &amp;#34;true&amp;#34;}&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>å®‰è£…Flannelç½‘ç»œæ’ä»¶&lt;/h1>&lt;p>Flannelç½‘ç»œæ’ä»¶åªéœ€è¦å®‰è£…åœ¨nodeèŠ‚ç‚¹ä¸Šå°±å¥½äº†ï¼Œä»–ä¸»è¦ä½œç”¨æ˜¯å°†ä¸åŒnodeä¸Šçš„podç½‘ç»œè”é€šï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨102è¿™å°æœºå™¨ä¸Šæ“ä½œï¼š&lt;/p>
&lt;p>ä½¿ç”¨yumç›´æ¥å®‰è£…:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>yum install -y flannel&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åˆ›å»º &lt;code>/usr/lib/systemd/system/flanneld.service&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[Unit]
Description=Flanneld overlay address etcd agent
After=network.target
After=network-online.target
Wants=network-online.target
After=etcd.service
Before=docker.service
[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/flanneld
EnvironmentFile=-/etc/sysconfig/docker-network
ExecStart=/usr/bin/flanneld-start \
-etcd-endpoints=${FLANNEL_ETCD_ENDPOINTS} \
-etcd-prefix=${FLANNEL_ETCD_PREFIX} \
$FLANNEL_OPTIONS
ExecStartPost=/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker
Restart=on-failure
[Install]
WantedBy=multi-user.target
RequiredBy=docker.service&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>/etc/sysconfig/flanneld&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code># Flanneld configuration options
# etcd url location. Point this to the server where etcd runs
FLANNEL_ETCD_ENDPOINTS=&amp;#34;https://192.168.99.101:2379&amp;#34;
# etcd config key. This is the configuration key that flannel queries
# For address range assignment
FLANNEL_ETCD_PREFIX=&amp;#34;/kube-centos/network&amp;#34;
# Any additional options that you want to pass
FLANNEL_OPTIONS=&amp;#34;-etcd-cafile=/etc/kubernetes/ssl/ca.pem -etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem -etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨etcdä¸­åˆ›å»ºç½‘ç»œé…ç½®ï¼Œåœ¨masterèŠ‚ç‚¹ä¸Šæ“ä½œå°±å¥½äº†ï¼Œçœå¾—æŒ‡å®šendpoints:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>$ etcdctl --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/kubernetes/ssl/kubernetes.pem --key-file=/etc/kubernetes/ssl/kubernetes-key.pem mkdir /kube-centos/network
$ etcdctl --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/kubernetes/ssl/kubernetes.pem --key-file=/etc/kubernetes/ssl/kubernetes-key.pem mk /kube-centos/network/config &amp;#39;{&amp;#34;Network&amp;#34;:&amp;#34;172.30.0.0/16&amp;#34;,&amp;#34;SubnetLen&amp;#34;:24,&amp;#34;Backend&amp;#34;:{&amp;#34;Type&amp;#34;:&amp;#34;vxlan&amp;#34;}}&amp;#39;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨flannel&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>systemctl daemon-reload
systemctl enable flanneld
systemctl start flanneld
systemctl status flanneld&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>Dockerå®‰è£…&lt;/h1>&lt;p>ä¸‹è½½å¹¶å®‰è£…ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>wget -c https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-17.12.1.ce-1.el7.centos.x86_64.rpm
yum install docker-ce-17.12.1.ce-1.el7.centos.x86_64.rpm &lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨&lt;code>/usr/lib/systemd/system/docker.service&lt;/code>æ–‡ä»¶ä¸­å¢åŠ ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>EnvironmentFile=-/run/flannel/docker&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¹¶ä¸”å¯åŠ¨å‘½ä»¤ä¸ºï¼Œä¸»è¦æ˜¯å¢åŠ äº†ä¸€ä¸ª&lt;code>$DOCKER_NETWORK_OPTIONS&lt;/code>å‚æ•°æ˜¯flannelä¼ å…¥çš„ç”¨æ¥ä¿®æ”¹&lt;code>docker0&lt;/code>ç½‘æ¡¥IP&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS --log-driver=json-file --log-opt max-size=50m --log-opt max-file=5&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>systemctl daemon-reload
systemctl enable docker
systemctl start docker
systemctl status docker&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>NodeèŠ‚ç‚¹éƒ¨ç½²&lt;/h1>&lt;p>&lt;code>kube-proxy&lt;/code>ï¼Œ&lt;code>kubelet&lt;/code> æ–‡ä»¶åœ¨&lt;code>kubernetes-server-linux-amd64.tar.gz&lt;/code>ï¼Œå¤åˆ¶åˆ°&lt;code>/usr/local/bin&lt;/code>ç›®å½•&lt;/p>
&lt;h2>å®‰è£…é…ç½®kubelet&lt;span class="hx-absolute -hx-mt-20" id="å®‰è£…é…ç½®kubelet">&lt;/span>
&lt;a href="#%e5%ae%89%e8%a3%85%e9%85%8d%e7%bd%aekubelet" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;blockquote>
&lt;p>å‰æï¼šå…³é—­swapï¼Œå¦åˆ™æ— æ³•å¯åŠ¨
ä½¿ç”¨:&lt;code>swapoff -a&lt;/code>æˆ–è€…æ³¨é‡Šfstabä¸­swapé…ç½®&lt;/p>
&lt;/blockquote>
&lt;p>TIPS: ç°åœ¨masterèŠ‚ç‚¹ä¸Šï¼Œèµ‹äºˆkubelet-bootstrapç”¨æˆ·ï¼Œsystem:node-bootstrapper cluster è§’è‰²ï¼Œå¦åˆ™kubeletæ²¡æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚ã€‚&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>cd /etc/kubernetes
kubectl create clusterrolebinding kubelet-bootstrap \
--clusterrole=system:node-bootstrapper \
--user=kubelet-bootstrap&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ–‡ä»¶&lt;code>/usr/lib/systemd/system/kubelet.service&lt;/code>ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[Unit]
Description=Kubernetes Kubelet Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=docker.service
Requires=docker.service
[Service]
WorkingDirectory=/var/lib/kubelet
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/kubelet
ExecStart=/usr/local/bin/kubelet \
$KUBE_LOGTOSTDERR \
$KUBE_LOG_LEVEL \
$KUBELET_ADDRESS \
$KUBELET_HOSTNAME \
$KUBE_ALLOW_PRIV \
$KUBELET_ARGS
Restart=on-failure
[Install]
WantedBy=multi-user.target&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åŒæ—¶é…ç½®&lt;code>/etc/kubernetes/kubelet&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>###
## kubernetes kubelet (minion) config
#
## The address for the info server to serve on (set to 0.0.0.0 or &amp;#34;&amp;#34; for all interfaces)
KUBELET_ADDRESS=&amp;#34;--address=192.168.99.102&amp;#34;
#
## You may leave this blank to use the actual hostname
KUBELET_HOSTNAME=&amp;#34;--hostname-override=192.168.99.102&amp;#34;
KUBELET_ARGS=&amp;#34;--bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --cert-dir=/etc/kubernetes/ssl --cluster-domain=cluster.local --hairpin-mode promiscuous-bridge --serialize-image-pulls=false&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>mkdir /varlib/kubelet
systemctl daemon-reload
systemctl enable kubelet
systemctl start kubelet
systemctl status kubelet&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h3>é€šè¿‡kubletçš„TLSè¯ä¹¦è¯·æ±‚&lt;span class="hx-absolute -hx-mt-20" id="é€šè¿‡kubletçš„tlsè¯ä¹¦è¯·æ±‚">&lt;/span>
&lt;a href="#%e9%80%9a%e8%bf%87kublet%e7%9a%84tls%e8%af%81%e4%b9%a6%e8%af%b7%e6%b1%82" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h3>&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost kubernetes]# kubectl get csr
NAME AGE REQUESTOR CONDITION
node-csr-vtB-rALjRudPIp4IvIHwOTOggoJC-213GpvDoYVqQlA 18s kubelet-bootstrap Pending&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>é€šè¿‡ CSR è¯·æ±‚:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[root@localhost kubernetes]# kubectl certificate approve node-csr-vtB-rALjRudPIp4IvIHwOTOggoJC-213GpvDoYVqQlA
certificatesigningrequest.certificates.k8s.io &amp;#34;node-csr-vtB-rALjRudPIp4IvIHwOTOggoJC-213GpvDoYVqQlA&amp;#34; approved&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h2>é…ç½® kube-proxy&lt;span class="hx-absolute -hx-mt-20" id="é…ç½®-kube-proxy">&lt;/span>
&lt;a href="#%e9%85%8d%e7%bd%ae-kube-proxy" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å®‰è£…conntrackï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>yum install -y conntrack-tools&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ–‡ä»¶&lt;code>/usr/lib/systemd/system/kube-proxy.service&lt;/code>ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>[Unit]
Description=Kubernetes Kube-Proxy Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target
[Service]
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/proxy
ExecStart=/usr/local/bin/kube-proxy \
$KUBE_LOGTOSTDERR \
$KUBE_LOG_LEVEL \
$KUBE_MASTER \
$KUBE_PROXY_ARGS
Restart=on-failure
LimitNOFILE=65536
[Install]
WantedBy=multi-user.target&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>/etc/kubernetes/proxy&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>###
# kubernetes proxy config
# default config should be adequate
# Add your own!
KUBE_PROXY_ARGS=&amp;#34;--bind-address=192.168.99.102 --hostname-override=192.168.99.102 --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig --cluster-cidr=10.254.0.0/16&amp;#34;&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>å¯åŠ¨kube-proxy:&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code>systemctl daemon-reload
systemctl enable kube-proxy
systemctl start kube-proxy
systemctl status kube-proxy&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ”¯æŒé›†ç¾¤çš„åŸºæœ¬åŠŸèƒ½å·²ç»æœ‰äº†ï¼Œå¯ä»¥å»ºä¸€ä¸ªéƒ¨ç½²ä¸€ä¸ªnginxåº”ç”¨è¯•ä¸€ä¸‹çœ‹ä¸€ä¸‹ã€‚&lt;/p>
&lt;h1>å®‰è£…kubednsæ’ä»¶&lt;/h1>&lt;p>kubedns ä¸ºæˆ‘ä»¬æä¾›äº†æœåŠ¡å‘ç°çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>yamlæ–‡ä»¶é€šè¿‡è¿™é‡Œä¸‹è½½ï¼š&lt;/p>
&lt;p>&lt;a href="https://github.com/silenceper/k8s-install/tree/master/kube-dns" target="_blank" rel="noopener">https://github.com/silenceper/k8s-install/tree/master/kube-dns
&lt;/a>&lt;/p>
&lt;p>åœ¨masterä¸Šæ‰§è¡Œï¼š&lt;/p>
&lt;p>&lt;code>kubectl create -f .&lt;/code>&lt;/p>
&lt;p>è‡³æ­¤ï¼Œk8så°±æ­å»ºå®Œæˆäº†ï¼&lt;/p>
&lt;blockquote>
&lt;p>å‚è€ƒèµ„æ–™ï¼š&lt;/p>
&lt;p>&lt;a href="https://jimmysong.io/kubernetes-handbook/practice/install-kubernetes-on-centos.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/practice/install-kubernetes-on-centos.html&lt;/a>&lt;/p>
&lt;/blockquote></description></item><item><title>èŠèŠè¿æ¥æ± </title><link>/blog/201611/tcp_connection_pool/</link><pubDate>Sun, 20 Nov 2016 02:40:59 +0800</pubDate><guid>/blog/201611/tcp_connection_pool/</guid><description>
&lt;p>ä»¥ä¸‹ä¸»è¦ä½¿ç”¨Golangä½œä¸ºç¼–ç¨‹è¯­è¨€&lt;/p>
&lt;h1>ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± &lt;/h1>&lt;p>æˆ‘è§‰å¾—ä½¿ç”¨è¿æ¥æ± æœ€å¤§çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯&lt;strong>å‡å°‘è¿æ¥çš„åˆ›å»ºå’Œå…³é—­ï¼Œå¢åŠ ç³»ç»Ÿè´Ÿè½½èƒ½åŠ›&lt;/strong>ï¼Œ
ä¹‹å‰å°±æœ‰é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼š&lt;a href="http://silenceper.com/blog/201601/tcp-time_wait%E8%BF%9E%E6%8E%A5%E6%95%B0%E8%BF%87%E5%A4%9A%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E4%B8%8D%E5%8F%AF%E7%94%A8/" target="_blank" rel="noopener">TCP TIME_WAITè¿æ¥æ•°è¿‡å¤šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨&lt;/a>ï¼Œå› ä¸ºæœªå¼€å¯æ•°æ®åº“è¿æ¥æ± ï¼Œå†åŠ ä¸Šmysqlå¹¶å‘è¾ƒå¤§ï¼Œå¯¼è‡´éœ€è¦é¢‘ç¹çš„åˆ›å»ºé“¾æ¥ï¼Œæœ€ç»ˆäº§ç”Ÿäº†ä¸Šä¸‡çš„TIME_WAITçš„tcpé“¾æ¥ï¼Œå½±å“äº†ç³»ç»Ÿæ€§èƒ½ã€‚&lt;/p>
&lt;p>é“¾æ¥æ± ä¸­çš„çš„åŠŸèƒ½ä¸»è¦æ˜¯ç®¡ç†ä¸€å †çš„é“¾æ¥ï¼ŒåŒ…æ‹¬åˆ›å»ºå’Œå…³é—­ï¼Œæ‰€ä»¥è‡ªå·±åœ¨&lt;a href="fatih/pool" >fatih/pool&lt;/a>åŸºç¡€ä¸Šï¼Œæ”¹é€ äº†ä¸€ä¸‹ï¼š&lt;a href="https://github.com/silenceper/pool" target="_blank" rel="noopener">https://github.com/silenceper/pool&lt;/a> ï¼Œä½¿å¾—æ›´åŠ é€šç”¨ä¸€äº›ï¼Œå¢åŠ çš„ä¸€äº›åŠŸèƒ½ç‚¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>è¿æ¥å¯¹è±¡ä¸å•å•æ˜¯&lt;code>net.Conn&lt;/code>,å˜ä¸ºäº†&lt;code>interface{}&lt;/code>ï¼ˆæ± ä¸­å­˜å‚¨è‡ªå·±æƒ³è¦çš„æ ¼å¼ï¼‰&lt;/li>
&lt;li>å¢åŠ äº†é“¾æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼ˆä¿è¯äº†å½“è¿æ¥ç©ºé—²å¤ªä¹…ï¼Œé“¾æ¥å¤±æ•ˆçš„é—®é¢˜ï¼‰&lt;/li>
&lt;/ul>
&lt;p>ä¸»è¦æ˜¯ç”¨åˆ°äº†&lt;code>channel&lt;/code>æ¥ç®¡ç†è¿æ¥ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¾ˆå¥½çš„åˆ©ç”¨ç®¡é“çš„é¡ºåºæ€§ï¼Œå½“éœ€è¦ä½¿ç”¨çš„æ—¶å€™&lt;code>Get&lt;/code>ä¸€ä¸ªè¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•ä¹‹å&lt;code>Put&lt;/code>æ”¾å›&lt;code>channel&lt;/code>ä¸­ã€‚&lt;/p>
&lt;h1>è¿æ¥å¤±æ•ˆé—®é¢˜&lt;/h1>&lt;p>ä½¿ç”¨è¿æ¥æ± ä¹‹åå°±ä¸å†æ˜¯çŸ­è¿æ¥ï¼Œè€Œæ˜¯é•¿è¿æ¥äº†ï¼Œå°±å¼•å‘äº†ä¸€äº›é—®é¢˜ï¼š&lt;/p>
&lt;h2>1ã€é•¿æ—¶é—´ç©ºé—²ï¼Œè¿æ¥æ–­å¼€ï¼Ÿ&lt;span class="hx-absolute -hx-mt-20" id="1é•¿æ—¶é—´ç©ºé—²è¿æ¥æ–­å¼€">&lt;/span>
&lt;a href="#1%e9%95%bf%e6%97%b6%e9%97%b4%e7%a9%ba%e9%97%b2%e8%bf%9e%e6%8e%a5%e6%96%ad%e5%bc%80" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å› ä¸ºç½‘ç»œç¯å¢ƒæ˜¯å¤æ‚çš„ï¼Œä¸­é—´å¯èƒ½å› ä¸ºé˜²ç«å¢™ç­‰åŸå› ï¼Œå¯¼è‡´é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥ä¼šæ–­å¼€ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸¤ä¸ªæ–¹æ³•æ¥è§£å†³ï¼š&lt;/p>
&lt;ul>
&lt;li>å®¢æˆ·ç«¯å¢åŠ å¿ƒè·³ï¼Œå®šæ—¶çš„ç»™æœåŠ¡ç«¯å‘é€è¯·æ±‚&lt;/li>
&lt;li>ç»™è¿æ¥æ± ä¸­çš„è¿æ¥å¢åŠ æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œè¶…æ—¶çš„è¿æ¥ä¸å†ä½¿ç”¨&lt;/li>
&lt;/ul>
&lt;p>åœ¨&lt;a href="[https://github.com/silenceper/pool]" >https://github.com/silenceper/pool&lt;/a>å°±å¢åŠ äº†ä¸€ä¸ªè¿™æ ·æœ€å¤§ç©ºé—²æ—¶é—´çš„å‚æ•°ï¼Œåœ¨è¿æ¥åˆ›å»ºæˆ–è€…è¿æ¥è¢«é‡æ–°è¿”å›è¿æ¥æ± ä¸­æ—¶é‡ç½®ï¼Œç»™æ¯ä¸ªè¿æ¥éƒ½å¢åŠ äº†ä¸€ä¸ªè¿æ¥çš„åˆ›å»ºæ—¶é—´ï¼Œåœ¨å–å‡ºçš„æ—¶å€™å¯¹æ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼š&lt;a href="https://github.com/silenceper/pool/blob/master/channel.go#L85" target="_blank" rel="noopener">https://github.com/silenceper/pool/blob/master/channel.go#L85&lt;/a>&lt;/p>
&lt;h2>2ã€å½“æœåŠ¡ç«¯é‡å¯ä¹‹åï¼Œè¿æ¥å¤±æ•ˆï¼Ÿ&lt;span class="hx-absolute -hx-mt-20" id="2å½“æœåŠ¡ç«¯é‡å¯ä¹‹åè¿æ¥å¤±æ•ˆ">&lt;/span>
&lt;a href="#2%e5%bd%93%e6%9c%8d%e5%8a%a1%e7%ab%af%e9%87%8d%e5%90%af%e4%b9%8b%e5%90%8e%e8%bf%9e%e6%8e%a5%e5%a4%b1%e6%95%88" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è¿œç¨‹æœåŠ¡ç«¯å¾ˆæœ‰å¯èƒ½é‡å¯ï¼Œé‚£ä¹ˆä¹‹å‰åˆ›å»ºçš„é“¾æ¥å°±å¤±æ•ˆäº†ã€‚å®¢æˆ·ç«¯åœ¨ä½¿ç”¨çš„æ—¶å€™å°±éœ€è¦åˆ¤æ–­è¿™äº›å¤±æ•ˆçš„è¿æ¥å¹¶ä¸¢å¼ƒï¼Œåœ¨&lt;code>database/sql&lt;/code>ä¸­å°±åˆ¤æ–­äº†è¿™äº›å¤±æ•ˆçš„è¿æ¥ï¼Œä½¿ç”¨è¿™ç§é”™è¯¯è¡¨ç¤º&lt;code>var ErrBadConn = errors.New(&amp;quot;driver: bad connection&amp;quot;)&lt;/code>&lt;/p>
&lt;p>å¦å¤–å€¼å¾—ä¸€æçš„å°±æ˜¯åœ¨&lt;code>database/sql&lt;/code>å¯¹è¿™ç§&lt;code>ErrBadConn&lt;/code>é”™è¯¯è¿›è¡Œäº†é‡è¯•ï¼Œé»˜è®¤é‡è¯•æ¬¡æ•°æ˜¯ä¸¤æ¬¡ï¼Œæ‰€ä»¥èƒ½å¤Ÿä¿è¯å³ä¾¿æ˜¯é“¾æ¥å¤±æ•ˆæˆ–è€…æ–­å¼€äº†ï¼Œæœ¬æ¬¡çš„è¯·æ±‚èƒ½å¤Ÿæ­£å¸¸å“åº”ï¼ˆç»§ç»­å¾€ä¸‹çœ‹å°±æ˜¯åˆ†æäº†ï¼‰ã€‚&lt;/p>
&lt;p>&lt;strong>è¿æ¥å¤±æ•ˆçš„ç‰¹å¾&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>å¯¹è¿æ¥è¿›è¡Œreadè¯»æ“ä½œæ—¶ï¼Œè¿”å›&lt;code>EOF&lt;/code>é”™è¯¯&lt;/li>
&lt;li>å¯¹è¿æ¥è¿›è¡Œwriteæ“ä½œæ—¶ï¼Œè¿”å›&lt;code>write tcp 127.0.0.1:52089-&amp;gt;127.0.0.1:8002: write: broken pipe&lt;/code>é”™è¯¯&lt;/li>
&lt;/ul>
&lt;h1>database/sql ä¸­çš„è¿æ¥æ± &lt;/h1>&lt;p>åœ¨&lt;code>database/sql&lt;/code>ä¸­ä½¿ç”¨è¿æ¥è¿æ¥æ± å¾ˆç®€å•ï¼Œä¸»è¦æ¶‰åŠä¸‹é¢è¿™äº›é…ç½®ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetMaxIdleConns&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//è¿æ¥æ± ä¸­æœ€å¤§ç©ºé—²è¿æ¥æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetMaxOpenConns&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetConnMaxLifetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">300&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="c1">//è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´(å¯é€‰)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;blockquote>
&lt;p>æ³¨ï¼šå¦‚æœ&lt;code>MaxIdleConns&lt;/code>å¤§äº0å¹¶ä¸”&lt;code>MaxOpenConns&lt;/code>å°äº&lt;code>MaxIdleConns &lt;/code>,é‚£ä¹ˆä¼šå°†&lt;code>MaxIdleConns&lt;/code>ç½®ä¸º&lt;code>MaxOpenConns&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>æ¥çœ‹ä¸‹dbè¿™ä¸ªç»“æ„ï¼Œä»¥åŠå­—æ®µç›¸å…³è¯´æ˜ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">DB&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å…·ä½“çš„æ•°æ®åº“å®ç°çš„interface{},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ä¾‹å¦‚https://github.com/go-sql-driver/mysql å°±æ³¨å†Œå¹¶å¹¶å®ç°äº†driver.Openæ–¹æ³•ï¼Œä¸»è¦æ˜¯åœ¨é‡Œé¢å®ç°äº†ä¸€äº›é‰´æƒçš„æ“ä½œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">driver&lt;/span> &lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Driver&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//dsnè¿æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dsn&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åœ¨prepared statementä¸­ç”¨åˆ°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">numClosed&lt;/span> &lt;span class="kt">uint64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">// protects following fields&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¯ä½¿ç”¨çš„ç©ºé—²çš„é“¾æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">freeConn&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">driverConn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ç”¨æ¥ä¼ é€’è¿æ¥è¯·æ±‚çš„ç®¡é“&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">connRequests&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">connRequest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å½“å‰æ‰“å¼€çš„è¿æ¥æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">numOpen&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å½“éœ€è¦åˆ›å»ºæ–°çš„é“¾æ¥çš„æ—¶å€™ï¼Œå¾€è¿™ä¸ªç®¡é“ä¸­å‘é€ä¸€ä¸ªstructæ•°æ®ï¼Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å› ä¸ºåœ¨Openæ•°æ®åº“çš„å°±å¯ç”¨äº†ä¸€ä¸ªgoroutineæ‰§è¡ŒconnectionOpeneræ–¹æ³•è¯»å–ç®¡é“ä¸­çš„æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">openerCh&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ•°æ®åº“æ˜¯å¦å·²ç»è¢«å…³é—­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">closed&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ç”¨æ¥ä¿è¯é”è¢«æ­£ç¡®çš„å…³é—­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dep&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">finalCloser&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">depSet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//stacktrace of last conn&amp;#39;s put; debug only&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">lastPut&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">driverConn&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æœ€å¤§ç©ºé—²è¿æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">maxIdle&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æœ€å¤§æ‰“å¼€çš„è¿æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">maxOpen&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é—´&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">maxLifetime&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å®šæ—¶æ¸…ç†ç©ºé—²è¿æ¥çš„ç®¡é“&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">cleanerCh&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>çœ‹ä¸€ä¸ªæŸ¥è¯¢æ•°æ®åº“çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;pre>&lt;code> rows, err := db.Query(&amp;#34;select * from table1&amp;#34;)&lt;/code>&lt;/pre>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨è°ƒç”¨&lt;code>db.Query&lt;/code>æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">rows&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Rows&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿™é‡Œå°±åšäº†å¯¹å¤±æ•ˆçš„é“¾æ¥çš„é‡è¯•æ“ä½œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">maxBadConnRetries&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cachedOrNewConn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrBadConn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrBadConn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">query&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">query&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">alwaysNewConn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¿”å›ï¼Œå¯ä»¥ä»è¿™é‡Œçœ‹åˆ°ï¼š
&lt;a href="https://github.com/go-sql-driver/mysql/blob/master/packets.go#L35" target="_blank" rel="noopener">readPack&lt;/a>ï¼Œ&lt;a href="https://github.com/go-sql-driver/mysql/blob/master/packets.go#L132" target="_blank" rel="noopener">writePack&lt;/a>&lt;/p>
&lt;p>ç»§ç»­è·Ÿè¿›å»å°±åˆ°äº†&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">conn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strategy&lt;/span> &lt;span class="nx">connReuseStrategy&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">driverConn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æ–¹æ³•ä¸»è¦æ˜¯åˆ›å»ºtcpè¿æ¥ï¼Œå¹¶åˆ¤æ–­äº†è¿æ¥çš„ç”Ÿå­˜æ—¶é—´lifetimeï¼Œä»¥åŠè¿æ¥æ•°çš„ä¸€äº›é™åˆ¶ï¼Œå¦‚æœè¶…è¿‡çš„è®¾å®šçš„æœ€å¤§æ‰“å¼€é“¾æ¥æ•°é™åˆ¶ç­‰å¾…&lt;code>connRequest&lt;/code>ç®¡é“ä¸­æœ‰è¿æ¥äº§ç”Ÿ(åœ¨&lt;code>putConn&lt;/code>é‡Šæ”¾é“¾æ¥çš„æ—¶å€™å°±ä¼šå¾€è¿™ä¸ªç®¡é“ä¸­å†™å…¥æ•°æ®)&lt;/p>
&lt;p>&lt;strong>ä½•æ—¶é‡Šæ”¾é“¾æ¥?&lt;/strong>&lt;/p>
&lt;p>å½“æˆ‘ä»¬è°ƒç”¨&lt;code>rows.Close()&lt;/code>çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠå½“å‰æ­£åœ¨ä½¿ç”¨çš„é“¾æ¥é‡æ–°æ”¾å›&lt;code>freeConn&lt;/code>æˆ–è€…å†™å…¥åˆ°&lt;code>db.connRequests&lt;/code>ç®¡é“ä¸­&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//putConnDBLocked æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¦‚æœæœ‰db.connRequestsæœ‰åœ¨ç­‰å¾…è¿æ¥çš„è¯ï¼Œå°±æŠŠå½“å‰è¿æ¥ç»™å®ƒç”¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// This copy is O(n) but in practice faster than a linked list.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// TODO: consider compacting it down less often and&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// moving the base instead?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">copy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">connRequests&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">inUse&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">connRequest&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">conn&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">dc&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">maxIdleConnsLocked&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">freeConn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ²¡äººéœ€è¦æˆ‘è¿™ä¸ªé“¾æ¥ï¼Œæˆ‘å°±æŠŠä»–é‡æ–°è¿”å›`freeConn`è¿æ¥æ± ä¸­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">freeConn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">freeConn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">dc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">startCleanerLocked&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;h1>ä½¿ç”¨è¿æ¥æ± ç®¡ç†Thrifté“¾æ¥&lt;/h1>&lt;p>è¿™é‡Œæ˜¯ä½¿ç”¨è¿æ¥æ± &lt;a href="https://github.com/silenceper/pool" target="_blank" rel="noopener">https://github.com/silenceper/pool&lt;/a>ï¼Œå¦‚ä½•æ„å»ºä¸€ä¸ªthrifté“¾æ¥&lt;/p>
&lt;p>å®¢æˆ·ç«¯åˆ›å»ºThriftçš„ä»£ç ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Client&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UserClient&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//åˆ›å»ºThriftå®¢æˆ·ç«¯é“¾æ¥çš„æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">factory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">protocolFactory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">thrift&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTBinaryProtocolFactoryDefault&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">transportFactory&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">thrift&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTTransportFactory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">transport&lt;/span> &lt;span class="nx">thrift&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TTransport&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">transport&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">thrift&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTSocket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rpcConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Listen&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">transport&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">transportFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetTransport&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">transport&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//defer transport.Close()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rpcClient&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">user&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewUserClientFactory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">transport&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">protocolFactory&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//åœ¨è¿æ¥æ± ä¸­ç›´æ¥æ”¾ç½®Clientå¯¹è±¡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">UserClient&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">rpcClient&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å…³é—­è¿æ¥çš„æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">close&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">v&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">Transport&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//åˆ›å»ºäº†ä¸€ä¸ª åˆå§‹åŒ–è¿æ¥æ˜¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">poolConfig&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PoolConfig&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">InitialCap&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">MaxCap&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Factory&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">factory&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Close&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">close&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">IdleTimeout&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">300&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">pool&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewChannelPool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">poolConfig&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å–å¾—é“¾æ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>&lt;span class="nx">ä½¿ç”¨è¿æ¥è°ƒç”¨è¿œç¨‹æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//å°†è¿æ¥é‡æ–°æ”¾å›è¿æ¥æ± ä¸­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;hr>
&lt;p>å†™å®Œï¼Œå¬è§å¤–é¢çš„ğŸ“å¼€å§‹æ‰“é¸£äº†ã€‚&lt;/p></description></item><item><title>å¼€æºé¡¹ç›®ï¼šwechat sdk</title><link>/blog/201609/go-wechat-sdk/</link><pubDate>Fri, 16 Sep 2016 15:40:59 +0800</pubDate><guid>/blog/201609/go-wechat-sdk/</guid><description>
&lt;p>ä¸€ç›´å¾ˆæƒ³è‡ªå·±ç”¨golangå†™ä¸ªå¾®ä¿¡çš„sdkï¼Œç›®æ ‡æ˜¯ç®€å•å¥½ç”¨ï¼Œæ‰€ä»¥åˆ©ç”¨é—²æš‡æ—¶é—´ï¼ˆå‘¨æœ«ï¼Œä¸­ç§‹ğŸ˜ï¼‰ï¼Œå°±åšå‡ºæ¥ã€‚&lt;/p>
&lt;p>é¡¹ç›®åœ°å€:&lt;a href="https://github.com/silenceper/wechat" target="_blank" rel="noopener">https://github.com/silenceper/wechat&lt;/a>&lt;/p>
&lt;p>ç›®å‰å®ç°äº†æ¶ˆæ¯ç®¡ç†ï¼Œå¾®ä¿¡ç½‘é¡µæˆæƒï¼Œèœå•ç®¡ç†ï¼Œç´ æç®¡ç†å‡ ä¸ªæ¥å£ï¼Œçœ‹ä¸‹ä»–çš„åŸºæœ¬ä½¿ç”¨ï¼š&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¤„ç†æ¶ˆæ¯æ¥æ”¶ä»¥åŠå›å¤çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//é…ç½®å¾®ä¿¡å‚æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">config&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">wechat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AppID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;xxxx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AppSecret&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;xxxx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Token&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;xxxx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">EncodingAESKey&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;xxxx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Cache&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">memCache&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">wc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">wechat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewWechat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¼ å…¥requestå’ŒresponseWriter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">server&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">wc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">responseWriter&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetMessageHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MixMessage&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Reply&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å›å¤æ¶ˆæ¯ï¼šæ¼”ç¤ºå›å¤ç”¨æˆ·å‘é€çš„æ¶ˆæ¯&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">text&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">message&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewText&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Content&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Reply&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">message&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MsgText&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">text&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Serve&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Send&lt;/span>&lt;span class="p">()&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div></description></item><item><title>dcmp</title><link>/blog/201608/dcmp/</link><pubDate>Tue, 02 Aug 2016 15:40:59 +0800</pubDate><guid>/blog/201608/dcmp/</guid><description>
&lt;p>Distributed Configuration Management Platform&lt;/p>
&lt;p>æä¾›äº†ä¸€ä¸ªetcdçš„ç®¡ç†ç•Œé¢ï¼Œå¯é€šè¿‡ç•Œé¢ä¿®æ”¹é…ç½®ä¿¡æ¯ï¼Œå€ŸåŠ©confdå¯å®ç°é…ç½®æ–‡ä»¶çš„åŒæ­¥ã€‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/silenceper/dcmp/master/docs/image.png" alt="dcmp image" loading="lazy" />&lt;/p>
&lt;p>GITHUBï¼š&lt;a href="https://github.com/silenceper/dcmp" target="_blank" rel="noopener">https://github.com/silenceper/dcmp&lt;/a>&lt;/p>
&lt;hr>
&lt;p>APIé‡‡ç”¨çš„æ˜¯Gin Frameworkï¼Œå†™èµ·apiåº”ç”¨æ¥éå¸¸æ–¹ä¾¿ï¼Œå‰ç«¯å°è¯•äº†ä¸€ä¸‹reactã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä¼ åˆ°Githubä¸€çœ‹ï¼Œå‘ç°cssï¼Œjsçš„ä»£ç æ¯”golangè¿˜è¦å¤š ã€‚ ğŸ˜¢&lt;/p>
&lt;/blockquote></description></item><item><title>Golangä¸­httpåŒ…é»˜è®¤è·¯ç”±åŒ¹é…è§„åˆ™é˜…è¯»ç¬”è®°</title><link>/blog/201605/go-http-process/</link><pubDate>Sat, 28 May 2016 18:00:59 +0800</pubDate><guid>/blog/201605/go-http-process/</guid><description>
&lt;h1>ä¸€ã€æ‰§è¡Œæµç¨‹&lt;/h1>&lt;p>æ„å»ºä¸€ä¸ªç®€å•http serverï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;net/http&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello world&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä½¿ç”¨&lt;code>http://127.0.0.1:8080/&lt;/code> å°±å¯ä»¥çœ‹åˆ°è¾“å‡ºäº†&lt;/p>
&lt;p>é€šè¿‡è·Ÿè¸ªhttp.goåŒ…ä»£ç ï¼Œå¯ä»¥å‘ç°æ‰§è¡Œæµç¨‹åŸºæœ¬å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>1.åˆ›å»ºä¸€ä¸ª&lt;code>Listener&lt;/code>ç›‘å¬&lt;code>8080&lt;/code>ç«¯å£&lt;/p>
&lt;/li>
&lt;li>
&lt;p>2.è¿›å…¥&lt;code>for&lt;/code>å¾ªç¯å¹¶Acceptè¯·æ±‚ï¼Œæ²¡æœ‰è¯·æ±‚åˆ™å¤„äºé˜»å¡çŠ¶æ€&lt;/p>
&lt;/li>
&lt;li>
&lt;p>3.æ¥æ”¶åˆ°è¯·æ±‚ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªconnå¯¹è±¡ï¼Œæ”¾å…¥goroutineå¤„ç†ï¼ˆå®ç°é«˜å¹¶å‘å…³é”®ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>4.è§£æè¯·æ±‚æ¥æºä¿¡æ¯è·å¾—è¯·æ±‚è·¯å¾„ç­‰é‡è¦ä¿¡æ¯&lt;/p>
&lt;/li>
&lt;li>
&lt;p>5.è¯·æ±‚ServerHTTPæ–¹æ³•ï¼Œå·²ç»é€šè¿‡ä¸Šä¸€æ­¥è·å¾—äº†ResponseWriterå’ŒRequestå¯¹è±¡&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">sh&lt;/span> &lt;span class="nx">serverHandler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rw&lt;/span> &lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ­¤handlerå³ä¸ºhttp.ListenAndServe ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">handler&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">sh&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">srv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">handler&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¦‚æœhandlerä¸ºç©ºåˆ™ä½¿ç”¨å†…éƒ¨çš„DefaultServeMux è¿›è¡Œå¤„ç†&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">handler&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">DefaultServeMux&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RequestURI&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;*&amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;OPTIONS&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">handler&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">globalOptionsHandler&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è¿™é‡Œå°±å¼€å§‹å¤„ç†httpè¯·æ±‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¦‚æœéœ€è¦ä½¿ç”¨è‡ªå®šä¹‰çš„muxï¼Œå°±éœ€è¦å®ç°ServeHTTPæ–¹æ³•ï¼Œå³å®ç°Handleræ¥å£ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">handler&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>6.è¿›å…¥DefaultServeMuxä¸­çš„é€»è¾‘å°±æ˜¯æ ¹æ®è¯·æ±‚pathåœ¨mapä¸­åŒ¹é…æŸ¥æ‰¾handlerï¼Œå¹¶äº¤ç”±handlerå¤„ç†&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>httpè¯·æ±‚å¤„ç†æµç¨‹æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒ&lt;a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/03.3.md" target="_blank" rel="noopener">ã€ŠGo Web ç¼–ç¨‹
ã€‹3.3 Goå¦‚ä½•ä½¿å¾—Webå·¥ä½œ&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h1>äºŒã€DefaultServeMux è·¯ç”±åŒ¹é…è§„åˆ™&lt;/h1>&lt;p>å…ˆçœ‹å‡ ä¸ªè·¯ç”±è§„åˆ™ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;net/http&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è§„åˆ™1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello world&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è§„åˆ™2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/path/&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;pattern path: /path/ &amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//è§„åˆ™3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandleFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/path/subpath&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;pattern path: /path/subpath&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenAndServe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>æƒ…æ™¯ä¸€ï¼š&lt;/p>
&lt;p>è®¿é—®ï¼š&lt;code>http://127.0.0.1:8080/&lt;/code>&lt;/p>
&lt;p>è¿”å›ï¼š&lt;code>hello world&lt;/code>&lt;/p>
&lt;p>æƒ…æ™¯äºŒï¼š&lt;/p>
&lt;p>è®¿é—®ï¼š&lt;code>http://127.0.0.1:8080/path&lt;/code>&lt;/p>
&lt;p>è¿”å›ï¼š&lt;code>pattern path: /path/ &lt;/code>&lt;/p>
&lt;p>æƒ…æ™¯ä¸‰ï¼š&lt;/p>
&lt;p>è®¿é—®ï¼š&lt;code>http://127.0.0.1:8080/path/subpath/&lt;/code>&lt;/p>
&lt;p>è¿”å›ï¼š&lt;code>pattern path: /path/ &lt;/code>&lt;/p>
&lt;p>æƒ…æ™¯å››ï¼š&lt;/p>
&lt;p>è®¿é—®ï¼š&lt;code>http://127.0.0.1:8080/hahaha/&lt;/code>&lt;/p>
&lt;p>è¿”å›ï¼š&lt;code>hello world&lt;/code>&lt;/p>
&lt;p>å…ˆè¯´æ˜ä¸€äº›è§„åˆ™å§ï¼Œå†çœ‹ä»£ç æ˜¯æ€ä¹ˆå®ç°çš„ï¼š&lt;/p>
&lt;p>1.å¦‚æœåŒ¹é…è·¯å¾„ä¸­åå¸¦æœ‰&lt;code>/&lt;/code>ï¼Œåˆ™ä¼šè‡ªåŠ¨å¢åŠ ä¸€ä¸ªåŒ¹é…è§„åˆ™ä¸å¸¦&lt;code>/&lt;/code>åç¼€çš„ï¼Œå¹¶è·³è½¬è½¬åˆ°&lt;code>path/&lt;/code>,è§£é‡Šäº†æƒ…æ™¯äºŒçš„åœºæ™¯ï¼Œä¸ºä»€ä¹ˆåŒ¹é…åˆ°çš„&lt;code>/path/&lt;/code>&lt;/p>
&lt;p>2.æˆ‘è®¾ç½®äº†è¿™ä¹ˆå¤šè§„åˆ™ä¸ºä»€ä¹ˆè§„åˆ™ä¸€å¯ä»¥é€šç”¨åŒ¹é…æœªè®¾ç½®çš„è·¯ç”±ä¿¡æ¯ï¼Œè€Œä¸”åˆä¸å½±å“å·²ç»å­˜åœ¨è·¯ç”±ï¼Œ å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ&lt;/p>
&lt;h2>2.1 æ·»åŠ è·¯ç”±è§„åˆ™&lt;span class="hx-absolute -hx-mt-20" id="21-æ·»åŠ è·¯ç”±è§„åˆ™">&lt;/span>
&lt;a href="#21-%e6%b7%bb%e5%8a%a0%e8%b7%af%e7%94%b1%e8%a7%84%e5%88%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>å…ˆçœ‹ä¸¤ä¸ªstructï¼Œè¿™æ˜¯å­˜æ”¾é»˜è®¤è·¯ç”±è§„åˆ™çš„ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ServeMux&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RWMutex&lt;/span> &lt;span class="c1">//å¤„ç†å¹¶å‘ï¼Œå¢åŠ è¯»å†™é”&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">m&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">muxEntry&lt;/span> &lt;span class="c1">//å­˜æ”¾è§„åˆ™mapï¼Œkeyå³ä¸ºè®¾ç½®çš„path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">hosts&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="c1">// whether any patterns contain hostnamesï¼ˆæ˜¯å¦åŒ…å«hostï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">muxEntry&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">explicit&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="c1">//æ˜¯å¦å®Œå…¨åŒ¹é…&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span> &lt;span class="nx">Handler&lt;/span>&lt;span class="c1">//ç›¸åº”åŒ¹é…è§„åˆ™çš„handler&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pattern&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="c1">//åŒ¹é…è·¯å¾„&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>é€šè¿‡è·Ÿè¸ª&lt;code>http.HandleFunc&lt;/code>å®šä½åˆ°å¦‚ä¸‹ä»£ç ï¼Œæ­£æ˜¯å¾€ä¸Šé¢ä¸¤ä¸ª&lt;code>struct&lt;/code>ä¸­å¢åŠ è§„åˆ™ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">mux&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ServeMux&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pattern&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">handler&lt;/span> &lt;span class="nx">Handler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mux&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">mux&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">pattern&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http: invalid pattern &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">handler&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http: nil handler&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¦‚æœå·²ç»åŒ¹é…åˆ°äº†åˆ™panic&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">mux&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">pattern&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">explicit&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http: multiple registrations for &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¢åŠ ä¸€ä¸ªæ–°çš„åŒ¹é…è§„åˆ™&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mux&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">pattern&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">muxEntry&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">explicit&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">h&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">handler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ ¹æ®pathçš„ç¬¬ä¸€ä¸ªå­—æ¯åˆ¤æ–­æ˜¯å¦æœ‰host&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="sc">&amp;#39;/&amp;#39;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mux&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">hosts&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//ï¼ï¼è¿™é‡Œçœ‹æ¸…æ¥š å°±æ˜¯å®ç°äº†æƒ…æ™¯äºŒçš„æƒ…å†µ ï¼Œçœ‹åˆ¤æ–­æ¡ä»¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;/&amp;#39;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">mux&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">pattern&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]].&lt;/span>&lt;span class="nx">explicit&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// If pattern contains a host name, strip it and use remaining&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// path for redirect.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">path&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">pattern&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="sc">&amp;#39;/&amp;#39;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// In pattern, at least the last character is a &amp;#39;/&amp;#39;, so&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// strings.Index can&amp;#39;t be -1.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Index&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pattern&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">):]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">url&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">url&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">URL&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mux&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">pattern&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">muxEntry&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">h&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">RedirectHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">url&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">StatusMovedPermanently&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>ä¸Šé¢æœ‰ä¸ª&lt;code>Helpful behavior&lt;/code>çš„æ³¨é‡Šè¡Œä¸ºï¼Œå°±æ˜¯å®ç°äº†æƒ…æ™¯äºŒçš„æƒ…å†µï¼Œä»–æ˜¯åˆ¤æ–­å¦‚æœåŒ¹é…çš„è·¯å¾„ä¸­æœ€åå«æœ‰&lt;code>/&lt;/code>ï¼Œå¹¶ä¸”ä¹‹å‰ä¹Ÿä¸å­˜åœ¨æ·»åŠ å»é™¤åæ–œæ çš„è§„åˆ™çš„è¯ï¼Œå°±è‡ªåŠ¨ç»™ä»–å¢åŠ ä¸€ä¸ª301çš„è·³è½¬æŒ‡å‘&lt;code>/path/&lt;/code>&lt;/p>
&lt;h2>2.2 æŸ¥æ‰¾è·¯ç”±è§„åˆ™&lt;span class="hx-absolute -hx-mt-20" id="22-æŸ¥æ‰¾è·¯ç”±è§„åˆ™">&lt;/span>
&lt;a href="#22-%e6%9f%a5%e6%89%be%e8%b7%af%e7%94%b1%e8%a7%84%e5%88%99" class="subheading-anchor" aria-label="Permalink for this section">&lt;/a>&lt;/h2>&lt;p>è·¯ç”±è§„åˆ™çš„æŸ¥æ‰¾å°±æ˜¯ä»&lt;code>ServeMux &lt;/code>ä¸­çš„mapå»åŒ¹é…æŸ¥æ‰¾çš„,çš„åˆ°è¿™ä¸ªhandlerå¹¶æ‰§è¡Œï¼Œåªæ˜¯ä¼šæœ‰ä¸€äº›å¤„ç†æœºåˆ¶ï¼Œæ¯”å¦‚æ€ä¹ˆæ ·ç¡®ä¿è®¿é—®&lt;code>/path/subpath&lt;/code>çš„æ—¶å€™æ˜¯å…ˆåŒ¹é…&lt;code>/path/subpath&lt;/code>è€Œä¸æ˜¯åŒ¹é…&lt;code>/path/&lt;/code>å‘¢ï¼Ÿ&lt;/p>
&lt;p>å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œè·Ÿè¸ªåˆ°äº†&lt;code>mux.match&lt;/code>æ–¹æ³•ï¼š&lt;/p>
&lt;blockquote>
&lt;p>è¿‡ç¨‹&lt;code>mux.ServerHTTP&lt;/code>-&amp;gt;&lt;code>mux.Handler&lt;/code>-&amp;gt;&lt;code>mux.handler&lt;/code>-&amp;gt;&lt;code>mux.match&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">mux&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ServeMux&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">h&lt;/span> &lt;span class="nx">Handler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pattern&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">mux&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nf">pathMatch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å¦‚æœåŒ¹é…åˆ°äº†ä¸€ä¸ªè§„åˆ™ï¼Œå¹¶æ²¡æœ‰é©¬ä¸Šè¿”å›handlerï¼Œè€Œä¸”ç»§ç»­åŒ¹é…å¹¶ä¸”åˆ¤æ–­pathçš„é•¿åº¦æ˜¯å¦æ˜¯æœ€é•¿çš„ï¼Œè¿™æ˜¯å…³é”®ï¼ï¼ï¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">h&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">n&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">h&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">h&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pattern&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pattern&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>1.è¿™é‡Œå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆè®¾ç½®çš„ç²¾ç¡®çš„pathæ˜¯æœ€ä¼˜åŒ¹é…åˆ°çš„ï¼Œå› ä¸ºå®ƒæ˜¯æ ¹æ®pathçš„é•¿åº¦åˆ¤æ–­ã€‚
å½“ç„¶ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ&lt;code>/&lt;/code>å¯ä»¥åŒ¹é…æ‰€æœ‰ï¼ˆçœ‹&lt;code>pathMatch&lt;/code>å‡½æ•°å°±çŸ¥é“äº†ï¼Œ&lt;code>/&lt;/code>æ˜¯åŒ¹é…æ‰€æœ‰çš„ï¼Œåªæ˜¯è¿™æ˜¯æœ€åæ‰è¢«åŒ¹é…æˆåŠŸï¼‰&lt;/p>
&lt;p>2.å¾—åˆ°äº†å¤„ç†è¯·æ±‚çš„handlerï¼Œå†è°ƒç”¨&lt;code>h.ServeHTTP(w, r)&lt;/code>ï¼Œå»æ‰§è¡Œç›¸åº”çš„handleræ–¹æ³•ã€‚&lt;/p>
&lt;p>ç­‰ä¸€ä¸‹ï¼Œhandlerä¸­å“ªé‡Œæœ‰&lt;code>ServeHTTP&lt;/code>è¿™ä¸ªæ–¹æ³•ï¼Ÿï¼Ÿ&lt;/p>
&lt;p>å› ä¸ºåœ¨è°ƒç”¨ &lt;code>http.HandleFunc&lt;/code>çš„æ—¶å€™å·²ç»å°†è‡ªå®šä¹‰çš„handlerå¤„ç†å‡½æ•°ï¼Œå¼ºåˆ¶è½¬ä¸º&lt;code>HandlerFunc&lt;/code>ç±»å‹çš„ï¼Œå°±æ‹¥æœ‰äº†&lt;code>ServeHTTP&lt;/code>æ–¹æ³•ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">HandlerFunc&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ServeHTTP calls f(w, r).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="nx">HandlerFunc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;code>f(w,r)&lt;/code>å°±å®ç°äº†handlerçš„æ‰§è¡Œã€‚&lt;/p>
&lt;blockquote>
&lt;p>è„‘å­é‡Œé¢æ¸…æ¥šï¼Œä½†çœŸåˆ°è¡¨è¿°çš„æ—¶å€™ï¼Œå‘µå‘µï¼Œå½“åšç¬”è®°å•¦ã€‚ã€‚ã€‚&lt;/p>
&lt;/blockquote></description></item><item><title>tcp time_waité—®é¢˜</title><link>/blog/201601/tcp_time_wait_error/</link><pubDate>Sun, 03 Jan 2016 15:40:59 +0800</pubDate><guid>/blog/201601/tcp_time_wait_error/</guid><description>
&lt;h1>é—®é¢˜å‡ºç°ï¼š&lt;/h1>&lt;p>åœ¨å…ƒæ—¦å‰å¤•ï¼Œè‡ªå·±ç»´æŠ¤çš„ä¸€ä¸ªæœåŠ¡çªç„¶åœ¨é«˜å³°æ—¶æœŸæ”¶åˆ°å¤§é‡æŠ¥è­¦ï¼Œèµ¶ç´§ç™»ä¸ŠæœåŠ¡å™¨çœ‹ä¸€ä¸‹ï¼š&lt;/p>
&lt;p>æœ€å¼€å§‹çš„ååº”æ˜¯memcache tcp read time out ,å› ä¸ºä¹‹å‰ä¹Ÿå‡ºç°è¿‡ç±»ä¼¼çš„è­¦å‘Šæ‰€ä»¥å¼€å§‹å°è¯•åˆ‡æ¢memcacheï¼Œä½†æ˜¯è¿ç»´åé¦ˆå·²ç»åˆ‡æ¢äº†å¥½å‡ å°è¿˜æ˜¯ä¸èµ·ä½œç”¨ã€‚&lt;/p>
&lt;p>åˆçœ‹åˆ°æœ‰mysql è¿æ¥ä¸ä¸ŠæŠ¥é”™ï¼Œæ€€ç–‘æœºæˆ¿å†…ç½‘æœ‰é—®é¢˜ï¼Œç„¶åæœ‰å¼€å§‹åˆ‡æ¢æœºæˆ¿åŠ æœºå™¨ï¼Œå½“æ—¶é—®é¢˜è¿˜æ˜¯æ²¡æœ‰å¾—åˆ°è§£å†³ï¼Œè¿™ä¸‹çœŸæ™•äº†ã€‚ã€‚ã€‚ã€‚ å®Œå…¨æ’æŸ¥ä¸å‡ºä»€ä¹ˆé—®é¢˜ï¼ˆå› ä¸ºæ˜¯é«˜å³°æ—¶æœŸï¼Œtcpè¿æ¥æ•°è‡ªç„¶å¾ˆé«˜ï¼Œæ²¡æœ‰åœ¨æ„æ˜¯è¿™ä¸ªé—®é¢˜ï¼Œè‡ªå·±é¢„ä¼°ä¸å¤Ÿï¼‰&lt;/p>
&lt;p>åæ¥ååº”è¿‡æ¥çœ‹åˆ°æœ‰å¥½å‡ ä¸ªæ¥å£è¯·æ±‚æ•°å¢åŠ ï¼Œå› ä¸ºå‘ç‰ˆæœ¬çš„åŸå› ï¼Œæ˜¯æ–°ç‰ˆæœ¬æ‰ä¼šè¯·æ±‚è¿™äº›æ¥å£ï¼Œæ‰€ä»¥ æˆ‘æš‚æ—¶å±è”½äº†è¿™å‡ ä¸ªå£æ¥å£é—®é¢˜å¾—åˆ°éåˆ¶ï¼ˆå¹¸å¥½æ˜¯ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°çš„æ¥å£ï¼‰ã€‚&lt;/p>
&lt;h1>æ’æŸ¥ï¼š&lt;/h1>&lt;p>è¿™ä¸ªé—®é¢˜å›´ç»•æˆ‘å¥½å‡ å¤©ï¼Œæˆ‘å±è”½çš„é‚£å‡ ä¸ªæ¥å£ï¼Œåå¤çœ‹äº†å¥½å‡ éï¼Œè€Œä¸”åˆå°†å…¶ä¸­çš„sqlæŸ¥è¯¢åˆ†æï¼Œå¹¶æ²¡æœ‰æ…¢è¯·æ±‚ã€‚ã€‚ã€‚ è¿™ä¸‹åˆå½»åº•æ‡µäº†ï¼Œæ²¡æœ‰å¤´ç»ªã€‚&lt;/p>
&lt;p>è¯´æ¥ä¹Ÿå·§ï¼Œé«˜å³°æ—¶æœŸæˆ‘ç”¨&lt;code>netstat -an&lt;/code> å‘½ä»¤æŸ¥çœ‹äº†ä¸€äº›ï¼Œçœ‹åˆ°å¤§é‡tcp time_wait çš„è¿æ¥ï¼Œèµ¶ç´§Googleäº†ä¸‹ï¼Œtcp time_waitçŠ¶æ€æ˜¯åœ¨ä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹ä¿æŒçš„ä¸€ä¸ªçŠ¶æ€ï¼ˆä¸€èˆ¬æŒ‡å®¢æˆ·ç«¯ï¼‰ï¼Œ&lt;/p>
&lt;p>æ€»å…±çš„è¿æ¥æ•°åœ¨è¿‘3w(ss -så¯æŸ¥)ï¼Œå…¶ä¸­æœ‰2wå¤šéƒ½æ˜¯è¿™ç§è¿æ¥ï¼Œè€Œä¸”éƒ½æ˜¯mysql è¿æ¥ï¼ˆè¿™é‡Œè¾¹æœåŠ¡å™¨ç¨‹åºå°±ç›¸å½“äºå®¢æˆ·ç«¯å»è¿æ¥mysqlæœåŠ¡å™¨ï¼‰ï¼Œåˆ°è¿™é‡Œå¿ƒé‡Œå¤§è‡´æœ‰åº•äº†ï¼ŒæŠŠæ•°æ®åº“è¿æ¥æ± åŠ ä¸Šå°±å¥½äº†ï¼ŒGolangæä¾›äº†ä¸¤ä¸ªå‡½æ•°å¯è¿›è¡Œé…ç½®ï¼š&lt;/p>
&lt;div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">
&lt;div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">SetMaxOpenConnsç”¨äºè®¾ç½®æœ€å¤§æ‰“å¼€çš„è¿æ¥æ•°&lt;/span>&lt;span class="err">ï¼Œ&lt;/span>&lt;span class="nx">é»˜è®¤å€¼ä¸º0è¡¨ç¤ºä¸é™åˆ¶&lt;/span>&lt;span class="err">ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">SetMaxIdleConnsç”¨äºè®¾ç½®é—²ç½®çš„è¿æ¥æ•°&lt;/span>&lt;span class="err">ã€‚&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
&lt;button
class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
title="Copy code"
>
&lt;div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4">&lt;/div>
&lt;/button>
&lt;/div>
&lt;/div>
&lt;p>&lt;strong>ä¸ºä»€ä¹ˆä¼šæœ‰TIME_WAITçŠ¶æ€ï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>æºäºtcpé“¾æ¥å…³é—­ä¸­çš„å››æ¬¡æŒ¥æ‰‹ï¼Œæ˜¯ä¸»åŠ¨å…³é—­é“¾æ¥çš„ä¸€æ–¹äº§ç”Ÿçš„çŠ¶æ€ï¼š
TCPçŠ¶æ€è½¬åŒ–å›¾ä¸‰æ¬¡æ¡æ‰‹/å››æ¬¡æŒ¥æ‰‹ï¼š&lt;/p>
&lt;p>
&lt;img src=".././images/tcp.png" alt="TCPçŠ¶æ€è½¬åŒ–å›¾" loading="lazy" />&lt;/p>
&lt;p>å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹ï¼Œè°ƒç”¨close()ï¼›åè®®å±‚å‘é€FINåŒ…&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è¢«åŠ¨å…³é—­çš„ä¸€æ–¹æ”¶åˆ°FINåŒ…åï¼Œåè®®å±‚å›å¤ACKï¼›ç„¶åè¢«åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œè¿›å…¥CLOSE_WAITçŠ¶æ€ï¼Œä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ç­‰å¾…å¯¹æ–¹å…³é—­ï¼Œåˆ™è¿›å…¥FIN_WAIT_2çŠ¶æ€ï¼›æ­¤æ—¶ï¼Œä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ ç­‰å¾… è¢«åŠ¨å…³é—­ä¸€æ–¹çš„åº”ç”¨ç¨‹åºï¼Œè°ƒç”¨closeæ“ä½œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è¢«åŠ¨å…³é—­çš„ä¸€æ–¹åœ¨å®Œæˆæ‰€æœ‰æ•°æ®å‘é€åï¼Œè°ƒç”¨close()æ“ä½œï¼›æ­¤æ—¶ï¼Œåè®®å±‚å‘é€FINåŒ…ç»™ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œç­‰å¾…å¯¹æ–¹çš„ACKï¼Œè¢«åŠ¨å…³é—­çš„ä¸€æ–¹è¿›å…¥LAST_ACKçŠ¶æ€ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹æ”¶åˆ°FINåŒ…ï¼Œåè®®å±‚å›å¤ACKï¼›æ­¤æ—¶ï¼Œä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹ï¼Œè¿›å…¥TIME_WAITçŠ¶æ€ï¼›è€Œè¢«åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œè¿›å…¥CLOSEDçŠ¶æ€&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç­‰å¾…2MSLæ—¶é—´ï¼Œä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œç»“æŸTIME_WAITï¼Œè¿›å…¥CLOSEDçŠ¶æ€&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>æ‰€ä»¥time_waitå±äºtcpæ­£å¸¸çš„ä¸€ä¸ªçŠ¶æ€ï¼Œæ˜¯ä¸ºäº†è§£å†³ç½‘ç»œçš„ä¸¢åŒ…å’Œç½‘ç»œä¸ç¨³å®šé”å­˜åœ¨çš„ä¸€ä¸ªçŠ¶æ€ã€‚&lt;/p>
&lt;p>å› ä¸ºå½“å‰æœåŠ¡å™¨å¹¶å‘ç›¸å¯¹è¾ƒå¤§ï¼Œæ‰€ä»¥å­˜åœ¨äº†å¤§é‡çš„é“¾æ¥ä¸ºå…³é—­ï¼Œå¦‚æœåªæ˜¯å‡ ç™¾çš„è¯ï¼Œä¹Ÿä¸ä¼šå½±å“æœåŠ¡å™¨æ€§èƒ½ã€‚&lt;/p>
&lt;p>ä½¿ç”¨è¿æ¥æ± ä¿å­˜é•¿é“¾æ¥ï¼Œå¯ä½¿å¾—é“¾æ¥å¤ç”¨ï¼Œä¸ä¼šå‡ºç°å¤§é‡çš„è¿™ç§çŠ¶æ€ã€‚&lt;/p>
&lt;h1>åæ€ï¼š&lt;/h1>&lt;p>é—®é¢˜ç»ˆäºæ‰¾åˆ°è§£å†³ï¼Œä½†æ˜¯å›è¿‡å¤´æ¥æƒ³äº†ä¸€ä¸‹ï¼Œå…¶å®ä¸€å¼€å§‹å°±å¯ä»¥å®šä½åˆ°çš„ï¼Œåªæ˜¯å¾ˆå¤šé—®é¢˜é›†ä¸­åœ¨ä¸€èµ·å‡ºç°åè€Œè®©è‡ªå·±ä¸çŸ¥æ‰€æªï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæ˜¯æ•æ„Ÿçš„äººçš„è¯åº”è¯¥é©¬ä¸Šèƒ½å¤Ÿä»tcpçŠ¶æ€ä¸Šçœ‹å‡ºé—®é¢˜ï¼Œä¹‹åçº¿ä¸Šé‡åˆ°é—®é¢˜ï¼Œé‡è¦çš„æ˜¯å…ˆè§£å†³ï¼ˆä¸ç®¡é€šè¿‡ä»€ä¹ˆæ–¹å¼ï¼‰ï¼Œä¹‹åå†ä¸€æ­¥æ­¥æ’æŸ¥ã€‚&lt;/p></description></item></channel></rss>
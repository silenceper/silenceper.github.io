<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>利用Kubernetes中的leaderelection实现组件高可用 | silenceper</title>
        <meta name="Description" content="如何使用leaderelection以及对其源码进行分析"><meta property="og:title" content="利用Kubernetes中的leaderelection实现组件高可用" />
<meta property="og:description" content="如何使用leaderelection以及对其源码进行分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/202002/kubernetes-leaderelection/" />
<meta property="article:published_time" content="2020-02-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-02-15T00:00:00+00:00" /><meta property="og:site_name" content="silenceper" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="利用Kubernetes中的leaderelection实现组件高可用"/>
<meta name="twitter:description" content="如何使用leaderelection以及对其源码进行分析"/>
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-TileColor" content="#da532c">
<link rel="canonical" href="/blog/202002/kubernetes-leaderelection/" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="prev" href="/blog/202001/go-import-version/" /><link rel="next" href="/blog/202003/kubernetes-event/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><meta name="google-site-verification" content="VJ4lE3d3A73DNoyxuuXL_Cuu6MEErPtKXqfAv69pr6E" /><meta name="baidu-site-verification" content="k061nqJczY" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "利用Kubernetes中的leaderelection实现组件高可用",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/blog\/202002\/kubernetes-leaderelection\/"
        },"image": {
                "@type": "ImageObject",
                "url": "\/img\/silenceoer-avatar.jpg",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "go, kubernetes","wordcount":  4358 ,
        "url": "\/blog\/202002\/kubernetes-leaderelection\/","datePublished": "2020-02-15T00:00:00\u002b00:00","dateModified": "2020-02-15T00:00:00\u002b00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "silenceper",
                "logo": {
                "@type": "ImageObject",
                "url": "\/img\/silenceper-avatar.jpg",
                "width":  127 ,
                "height":  40 
                }
            },"description": "如何使用leaderelection以及对其源码进行分析"
    }
    </script></head>
    <body><script>
            if (!window.localStorage || !window.localStorage.getItem('theme')) {window.isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;} else {
                window.isDark = (window.localStorage && window.localStorage.getItem('theme')) === 'dark';
            }
            window.isDark && document.body.classList.add('dark-theme');
        </script><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title animated bounceIn">
            <a href="/">silenceper</a>
        </div>
        <div class="menu"><a class="menu-item" href="/posts/">文章</a><a class="menu-item" href="/tags/">标签</a><a class="menu-item" href="/categories/">分类</a><a class="menu-item" href="/about/">关于</a><a class="menu-item" href="/wechat/">微信SDK</a><a class="menu-item" href="/kubernetes-book/">Kubernetes笔记</a><a href="javascript:void(0);" class="theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-rotate-180 fa-fw"></i>
            </a>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-wrapper">
        <div class="header-container">
            <div class="header-title animated bounceIn">
                <a href="/">silenceper</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="/wechat/" title="">微信SDK</a><a class="menu-item" href="/kubernetes-book/" title="">Kubernetes笔记</a><a href="javascript:void(0);" class="theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-rotate-180 fa-fw"></i>
            </a>
        </div>
    </div>
</header>

<script>
    window.desktopHeaderMode = "fixed";
    window.mobileHeaderMode = "auto";
</script>
<main class="main">
                <div class="container"><article class="page single"><h1 class="single-title animated flipInX">利用Kubernetes中的leaderelection实现组件高可用</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author">
                    <a class="author" href="/" rel="author" target="_blank">
                        <i class="fas fa-user-circle fa-fw"></i>silenceper
                    </a>
                </span>&nbsp;<span class="post-category">收录于&nbsp;
                            <span>
                                <a href="/categories/tech">
                                    <i class="far fa-folder fa-fw"></i>Tech
                                </a>
                            </span></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-02-15&#32;00:00>2020-02-15 00:00</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>约 4358 字&nbsp;
                <i class="far fa-clock fa-fw"></i>预计阅读 9 分钟&nbsp;</div>
        </div><div class="featured-image"><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://silenceper.oss-cn-beijing.aliyuncs.com/blog/bg/qiao.jpg" alt="featured image" title="featured image" class="lazyload">
</div><div class="toc" id="toc-auto">
                <h2 class="toc-title">目录</h2>
                <div class="toc-content" id="toc-content-auto"></div>
            </div>
            <div class="toc" id="toc-static">
                <details>
                    <summary>
                        <div class="toc-title">
                            <span>目录</span>
                            <span><i class="details icon fas fa-angle-down"></i></span>
                        </div>
                    </summary>
                    <div class="toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#使用">使用</a></li>
    <li><a href="#深入理解">深入理解</a>
      <ul>
        <li><a href="#入口">入口</a></li>
        <li><a href="#获取的锁以及更新锁">获取的锁以及更新锁</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav></div>
                </details>
            </div><div class="content"><p>在Kubernetes中，通常kube-schduler和kube-controller-manager都是多副本进行部署的来保证高可用，而真正在工作的实例其实只有一个。这里就利用到 <code>leaderelection</code> 的选主机制，保证leader是处于工作状态，并且在leader挂掉之后，从其他节点选取新的leader保证组件正常工作。</p>
<p>不单单只是k8s中的这两个组件用到，在其他服务中也可以看到这个包的使用，比如<a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/" target="_blank" rel="noopener noreffer">cluster-autoscaler</a>
等都能看得到这个包的，今天就来看看这个包的使用以及它内部是如何实现的。</p>
<h2 id="使用">使用</h2>
<p>以下是一个简单使用的例子，编译完成之后同时启动多个进程，但是只有一个进程在工作，当把leader进程kill掉之后，会重新选举出一个leader进行工作，即执行其中的 <code>run</code> 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="cm">/*
</span><span class="cm">例子来源于client-go中的example包中
</span><span class="cm">*/</span>

<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;flag&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;os/signal&#34;</span>
	<span class="s">&#34;syscall&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;github.com/google/uuid&#34;</span>
	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class="nx">clientset</span> <span class="s">&#34;k8s.io/client-go/kubernetes&#34;</span>
	<span class="s">&#34;k8s.io/client-go/rest&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/leaderelection&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/leaderelection/resourcelock&#34;</span>
	<span class="s">&#34;k8s.io/klog&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">buildConfig</span><span class="p">(</span><span class="nx">kubeconfig</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">kubeconfig</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">cfg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">kubeconfig</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">cfg</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="nx">cfg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">InClusterConfig</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">cfg</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">InitFlags</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>

	<span class="kd">var</span> <span class="nx">kubeconfig</span> <span class="kt">string</span>
	<span class="kd">var</span> <span class="nx">leaseLockName</span> <span class="kt">string</span>
	<span class="kd">var</span> <span class="nx">leaseLockNamespace</span> <span class="kt">string</span>
	<span class="kd">var</span> <span class="nx">id</span> <span class="kt">string</span>

	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">kubeconfig</span><span class="p">,</span> <span class="s">&#34;kubeconfig&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;absolute path to the kubeconfig file&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">().</span><span class="nf">String</span><span class="p">(),</span> <span class="s">&#34;the holder identity name&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">leaseLockName</span><span class="p">,</span> <span class="s">&#34;lease-lock-name&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;the lease lock resource name&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">leaseLockNamespace</span><span class="p">,</span> <span class="s">&#34;lease-lock-namespace&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;the lease lock resource namespace&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">leaseLockName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;unable to get lease lock resource name (missing lease-lock-name flag).&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">leaseLockNamespace</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;unable to get lease lock resource namespace (missing lease-lock-namespace flag).&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// leader election uses the Kubernetes API by writing to a
</span><span class="c1"></span>	<span class="c1">// lock object, which can be a LeaseLock object (preferred),
</span><span class="c1"></span>	<span class="c1">// a ConfigMap, or an Endpoints (deprecated) object.
</span><span class="c1"></span>	<span class="c1">// Conflicting writes are detected and each client handles those actions
</span><span class="c1"></span>	<span class="c1">// independently.
</span><span class="c1"></span>	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">buildConfig</span><span class="p">(</span><span class="nx">kubeconfig</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">NewForConfigOrDie</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>

	<span class="nx">run</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// complete your controller loop here
</span><span class="c1"></span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Controller loop...&#34;</span><span class="p">)</span>

		<span class="k">select</span> <span class="p">{}</span>
	<span class="p">}</span>

	<span class="c1">// use a Go context so we can tell the leaderelection code when we
</span><span class="c1"></span>	<span class="c1">// want to step down
</span><span class="c1"></span>	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>

	<span class="c1">// listen for interrupts or the Linux SIGTERM signal and cancel
</span><span class="c1"></span>	<span class="c1">// our context, which the leader election code will observe and
</span><span class="c1"></span>	<span class="c1">// step down
</span><span class="c1"></span>	<span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="o">&lt;-</span><span class="nx">ch</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Received termination, signaling shutdown&#34;</span><span class="p">)</span>
		<span class="nf">cancel</span><span class="p">()</span>
	<span class="p">}()</span>

	<span class="c1">// we use the Lease lock type since edits to Leases are less common
</span><span class="c1"></span>	<span class="c1">// and fewer objects in the cluster watch &#34;all Leases&#34;.
</span><span class="c1"></span>    <span class="c1">// 指定锁的资源对象，这里使用了Lease资源，还支持configmap，endpoint，或者multilock(即多种配合使用)
</span><span class="c1"></span>	<span class="nx">lock</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">resourcelock</span><span class="p">.</span><span class="nx">LeaseLock</span><span class="p">{</span>
		<span class="nx">LeaseMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
			<span class="nx">Name</span><span class="p">:</span>      <span class="nx">leaseLockName</span><span class="p">,</span>
			<span class="nx">Namespace</span><span class="p">:</span> <span class="nx">leaseLockNamespace</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="nx">Client</span><span class="p">:</span> <span class="nx">client</span><span class="p">.</span><span class="nf">CoordinationV1</span><span class="p">(),</span>
		<span class="nx">LockConfig</span><span class="p">:</span> <span class="nx">resourcelock</span><span class="p">.</span><span class="nx">ResourceLockConfig</span><span class="p">{</span>
			<span class="nx">Identity</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">}</span>

	<span class="c1">// start the leader election code loop
</span><span class="c1"></span>	<span class="nx">leaderelection</span><span class="p">.</span><span class="nf">RunOrDie</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">leaderelection</span><span class="p">.</span><span class="nx">LeaderElectionConfig</span><span class="p">{</span>
		<span class="nx">Lock</span><span class="p">:</span> <span class="nx">lock</span><span class="p">,</span>
		<span class="c1">// IMPORTANT: you MUST ensure that any code you have that
</span><span class="c1"></span>		<span class="c1">// is protected by the lease must terminate **before**
</span><span class="c1"></span>		<span class="c1">// you call cancel. Otherwise, you could have a background
</span><span class="c1"></span>		<span class="c1">// loop still running and another process could
</span><span class="c1"></span>		<span class="c1">// get elected before your background loop finished, violating
</span><span class="c1"></span>		<span class="c1">// the stated goal of the lease.
</span><span class="c1"></span>		<span class="nx">ReleaseOnCancel</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="nx">LeaseDuration</span><span class="p">:</span>   <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="c1">//租约时间
</span><span class="c1"></span>		<span class="nx">RenewDeadline</span><span class="p">:</span>   <span class="mi">15</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="c1">//更新租约的
</span><span class="c1"></span>		<span class="nx">RetryPeriod</span><span class="p">:</span>     <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="c1">//非leader节点重试时间
</span><span class="c1"></span>		<span class="nx">Callbacks</span><span class="p">:</span> <span class="nx">leaderelection</span><span class="p">.</span><span class="nx">LeaderCallbacks</span><span class="p">{</span>
			<span class="nx">OnStartedLeading</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//变为leader执行的业务代码
</span><span class="c1"></span>				<span class="c1">// we&#39;re notified when we start - this is where you would
</span><span class="c1"></span>				<span class="c1">// usually put your code
</span><span class="c1"></span>				<span class="nf">run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
			<span class="p">},</span>
			<span class="nx">OnStoppedLeading</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                 <span class="c1">// 进程退出
</span><span class="c1"></span>				<span class="c1">// we can do cleanup here
</span><span class="c1"></span>				<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;leader lost: %s&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
				<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
			<span class="p">},</span>
			<span class="nx">OnNewLeader</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">identity</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//当产生新的leader后执行的方法
</span><span class="c1"></span>				<span class="c1">// we&#39;re notified when new leader elected
</span><span class="c1"></span>				<span class="k">if</span> <span class="nx">identity</span> <span class="o">==</span> <span class="nx">id</span> <span class="p">{</span>
					<span class="c1">// I just got the lock
</span><span class="c1"></span>					<span class="k">return</span>
				<span class="p">}</span>
				<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;new leader elected: %s&#34;</span><span class="p">,</span> <span class="nx">identity</span><span class="p">)</span>
			<span class="p">},</span>
		<span class="p">},</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>关键启动参数说明：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kubeconfig: 指定kubeconfig文件地址
lease-lock-name：指定lock的名称
lease-lock-namespace：指定lock存储的namespace
id: 例子中提供的区别参数，用于区分实例
logtostderr：klog提供的参数，指定log输出到控制台
v: 指定日志输出级别
</code></pre></td></tr></table>
</div>
</div><p><strong>同时启动两个进程：</strong><br /><strong>启动进程1</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">go run main.go -kubeconfig<span class="o">=</span>/Users/silenceper/.kube/config -logtostderr<span class="o">=</span><span class="nb">true</span> -lease-lock-name<span class="o">=</span>example -lease-lock-namespace<span class="o">=</span>default -id<span class="o">=</span><span class="m">1</span> -v<span class="o">=</span><span class="m">4</span>
I0215 19:56:37.049658   <span class="m">48045</span> leaderelection.go:242<span class="o">]</span> attempting to acquire leader lease  default/example...
I0215 19:56:37.080368   <span class="m">48045</span> leaderelection.go:252<span class="o">]</span> successfully acquired lease default/example
I0215 19:56:37.080437   <span class="m">48045</span> main.go:87<span class="o">]</span> Controller loop...
</code></pre></td></tr></table>
</div>
</div><p><strong>启动进程2：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">➜  leaderelection git:<span class="o">(</span>master<span class="o">)</span> ✗ go run main.go -kubeconfig<span class="o">=</span>/Users/silenceper/.kube/config -logtostderr<span class="o">=</span><span class="nb">true</span> -lease-lock-name<span class="o">=</span>example -lease-lock-namespace<span class="o">=</span>default -id<span class="o">=</span><span class="m">2</span> -v<span class="o">=</span><span class="m">4</span>
I0215 19:57:35.870051   <span class="m">48791</span> leaderelection.go:242<span class="o">]</span> attempting to acquire leader lease  default/example...
I0215 19:57:35.894735   <span class="m">48791</span> leaderelection.go:352<span class="o">]</span> lock is held by <span class="m">1</span> and has not yet expired
I0215 19:57:35.894769   <span class="m">48791</span> leaderelection.go:247<span class="o">]</span> failed to acquire lease default/example
I0215 19:57:35.894790   <span class="m">48791</span> main.go:151<span class="o">]</span> new leader elected: <span class="m">1</span>
I0215 19:57:44.532991   <span class="m">48791</span> leaderelection.go:352<span class="o">]</span> lock is held by <span class="m">1</span> and has not yet expired
I0215 19:57:44.533028   <span class="m">48791</span> leaderelection.go:247<span class="o">]</span> failed to acquire lease default/example
</code></pre></td></tr></table>
</div>
</div><p>这里可以看出来id=1的进程持有锁，并且运行的程序，而id=2的进程表示无法获取到锁，在不断的进程尝试。</p>
<p>现在kill掉id=1进程，在等待lock释放之后（有个LeaseDuration时间），leader变为id=2的进程执行工作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">I0215 20:01:41.489300   <span class="m">48791</span> leaderelection.go:252<span class="o">]</span> successfully acquired lease default/example
I0215 20:01:41.489577   <span class="m">48791</span> main.go:87<span class="o">]</span> Controller loop...
</code></pre></td></tr></table>
</div>
</div><p><a name="LypZI"></a></p>
<h2 id="深入理解">深入理解</h2>
<p>基本原理其实就是利用通过Kubernetes中 <code>configmap</code> ， <code>endpoints</code> 或者 <code>lease</code> 资源实现一个分布式锁，抢(acqure)到锁的节点成为leader，并且定期更新（renew）。其他进程也在不断的尝试进行抢占，抢占不到则继续等待下次循环。当leader节点挂掉之后，租约到期，其他节点就成为新的leader。</p>
<p><a name="iQapE"></a></p>
<h3 id="入口">入口</h3>
<p>通过 <code>leaderelection.RunOrDie</code> 启动，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">RunOrDie</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">lec</span> <span class="nx">LeaderElectionConfig</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">le</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewLeaderElector</span><span class="p">(</span><span class="nx">lec</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">lec</span><span class="p">.</span><span class="nx">WatchDog</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">lec</span><span class="p">.</span><span class="nx">WatchDog</span><span class="p">.</span><span class="nf">SetLeaderElection</span><span class="p">(</span><span class="nx">le</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">le</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>传入参数 <code>LeaderElectionConfig</code> ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">LeaderElectionConfig</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Lock 的类型
</span><span class="c1"></span>	<span class="nx">Lock</span> <span class="nx">rl</span><span class="p">.</span><span class="nx">Interface</span>
	<span class="c1">//持有锁的时间
</span><span class="c1"></span>	<span class="nx">LeaseDuration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
	<span class="c1">//在更新租约的超时时间
</span><span class="c1"></span>	<span class="nx">RenewDeadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
    <span class="c1">//竞争获取锁的时间
</span><span class="c1"></span>	<span class="nx">RetryPeriod</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
    <span class="c1">//状态变化时执行的函数，支持三种：
</span><span class="c1"></span>    <span class="c1">//1、OnStartedLeading 启动是执行的业务代码
</span><span class="c1"></span>    <span class="c1">//2、OnStoppedLeading leader停止执行的方法
</span><span class="c1"></span>    <span class="c1">//3、OnNewLeader 当产生新的leader后执行的方法
</span><span class="c1"></span>	<span class="nx">Callbacks</span> <span class="nx">LeaderCallbacks</span>

    <span class="c1">//进行监控检查
</span><span class="c1"></span>	<span class="c1">// WatchDog is the associated health checker
</span><span class="c1"></span>	<span class="c1">// WatchDog may be null if its not needed/configured.
</span><span class="c1"></span>	<span class="nx">WatchDog</span> <span class="o">*</span><span class="nx">HealthzAdaptor</span>
    <span class="c1">//leader退出时，是否执行release方法
</span><span class="c1"></span>	<span class="nx">ReleaseOnCancel</span> <span class="kt">bool</span>

	<span class="c1">// Name is the name of the resource lock for debugging
</span><span class="c1"></span>	<span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>LeaderElectionConfig.lock</code> <strong>支持保存在以下三种资源中：</strong><br /><code>configmap</code> <br /><code>endpoint</code> <br /><code>lease</code> <br />包中还提供了一个 <code>multilock</code> ，即可以进行选择两种，当其中一种保存失败时，选择第二张<br />可以在<a href="https://github.com/kubernetes/client-go/blob/master/tools/leaderelection/resourcelock/interface.go#L121" target="_blank" rel="noopener noreffer">interface.go</a>
中看到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="k">switch</span> <span class="nx">lockType</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">EndpointsResourceLock</span><span class="p">:</span><span class="c1">//保存在endpoints
</span><span class="c1"></span>		<span class="k">return</span> <span class="nx">endpointsLock</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="k">case</span> <span class="nx">ConfigMapsResourceLock</span><span class="p">:</span><span class="c1">//保存在configmaps
</span><span class="c1"></span>		<span class="k">return</span> <span class="nx">configmapLock</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="k">case</span> <span class="nx">LeasesResourceLock</span><span class="p">:</span><span class="c1">//保存在leases
</span><span class="c1"></span>		<span class="k">return</span> <span class="nx">leaseLock</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="k">case</span> <span class="nx">EndpointsLeasesResourceLock</span><span class="p">:</span><span class="c1">//优先尝试保存在endpoint失败时保存在lease
</span><span class="c1"></span>		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">MultiLock</span><span class="p">{</span>
			<span class="nx">Primary</span><span class="p">:</span>   <span class="nx">endpointsLock</span><span class="p">,</span>
			<span class="nx">Secondary</span><span class="p">:</span> <span class="nx">leaseLock</span><span class="p">,</span>
		<span class="p">},</span> <span class="kc">nil</span>
	<span class="k">case</span> <span class="nx">ConfigMapsLeasesResourceLock</span><span class="p">:</span><span class="c1">//优先尝试保存在configmap，失败时保存在lease
</span><span class="c1"></span>		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">MultiLock</span><span class="p">{</span>
			<span class="nx">Primary</span><span class="p">:</span>   <span class="nx">configmapLock</span><span class="p">,</span>
			<span class="nx">Secondary</span><span class="p">:</span> <span class="nx">leaseLock</span><span class="p">,</span>
		<span class="p">},</span> <span class="kc">nil</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Invalid lock-type %s&#34;</span><span class="p">,</span> <span class="nx">lockType</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以lease资源对象为例，可以在查看到保存的内容:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">➜  ~ kubectl get lease example -n default -o yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">coordination.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Lease</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-02-15T11:56:37Z&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;210675&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l">/apis/coordination.k8s.io/v1/namespaces/default/leases/example</span><span class="w">
</span><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">a3470a06-6fc3-42dc-8242-9d6cebdf5315</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">acquireTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-02-15T12:01:41.476971Z&#34;</span><span class="l">//获得锁时间</span><span class="w">
</span><span class="w">  </span><span class="nt">holderIdentity</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="l">//持有锁进程的标识</span><span class="w">
</span><span class="w">  </span><span class="nt">leaseDurationSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="l">//lease租约</span><span class="w">
</span><span class="w">  </span><span class="nt">leaseTransitions</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="l">//leader更换次数</span><span class="w">
</span><span class="w">  </span><span class="nt">renewTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-02-15T12:05:37.134655Z&#34;</span><span class="l">//更新租约的时间</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>关注其spec中的字段，分别进行标注,对应结构体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">LeaderElectionRecord</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">HolderIdentity</span>       <span class="kt">string</span>      <span class="s">`json:&#34;holderIdentity&#34;`</span><span class="c1">//持有锁进程的标识，一般可以利用主机名
</span><span class="c1"></span>	<span class="nx">LeaseDurationSeconds</span> <span class="kt">int</span>         <span class="s">`json:&#34;leaseDurationSeconds&#34;`</span><span class="c1">//  lock的租约
</span><span class="c1"></span>	<span class="nx">AcquireTime</span>          <span class="nx">metav1</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;acquireTime&#34;`</span><span class="c1">//持有锁的时间
</span><span class="c1"></span>	<span class="nx">RenewTime</span>            <span class="nx">metav1</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;renewTime&#34;`</span><span class="c1">//更新时间
</span><span class="c1"></span>	<span class="nx">LeaderTransitions</span>    <span class="kt">int</span>         <span class="s">`json:&#34;leaderTransitions&#34;`</span><span class="c1">//leader更换的次数
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a name="cGTSG"></a></p>
<h3 id="获取的锁以及更新锁">获取的锁以及更新锁</h3>
<p>Run方法中包含了获取锁以及更新锁的入口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Run starts the leader election loop
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">le</span> <span class="o">*</span><span class="nx">LeaderElector</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//进行退出执行
</span><span class="c1"></span>		<span class="nx">runtime</span><span class="p">.</span><span class="nf">HandleCrash</span><span class="p">()</span>
        <span class="c1">//停止时执行回调方法
</span><span class="c1"></span>		<span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">.</span><span class="nf">OnStoppedLeading</span><span class="p">()</span>
	<span class="p">}()</span>
    <span class="c1">//不断的进行获得锁，如果获得锁成功则执行后面的方法，否则不断的进行重试
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">le</span><span class="p">.</span><span class="nf">acquire</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="c1">// ctx signalled done
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
    <span class="c1">//获取锁成功，当前进程变为leader，执行回调函数中的业务代码
</span><span class="c1"></span>	<span class="k">go</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">.</span><span class="nf">OnStartedLeading</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    <span class="c1">//不断的循环进行进行租约的更新，保证锁一直被当前进行持有
</span><span class="c1"></span>	<span class="nx">le</span><span class="p">.</span><span class="nf">renew</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong><code>le.acquire</code> 和 <code>le.renew</code> 内部都是调用了 <code>le.tryAcquireOrRenew</code> 函数，只是对于返回结果的处理不一样。</strong></p>
<p><code>le.acquire</code> 对于 <code>le.tryAcquireOrRenew</code> 返回成功则退出，失败则继续。</p>
<p><code>le.renew</code> 则相反，成功则继续，失败则退出。</p>
<p>我们来看看 <code>tryAcquireOrRenew</code> 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">le</span> <span class="o">*</span><span class="nx">LeaderElector</span><span class="p">)</span> <span class="nf">tryAcquireOrRenew</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">now</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="c1">//锁资源对象内容
</span><span class="c1"></span>	<span class="nx">leaderElectionRecord</span> <span class="o">:=</span> <span class="nx">rl</span><span class="p">.</span><span class="nx">LeaderElectionRecord</span><span class="p">{</span>
		<span class="nx">HolderIdentity</span><span class="p">:</span>       <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nf">Identity</span><span class="p">(),</span><span class="c1">//唯一标识
</span><span class="c1"></span>		<span class="nx">LeaseDurationSeconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">LeaseDuration</span> <span class="o">/</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span>
		<span class="nx">RenewTime</span><span class="p">:</span>            <span class="nx">now</span><span class="p">,</span>
		<span class="nx">AcquireTime</span><span class="p">:</span>          <span class="nx">now</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// 1. obtain or create the ElectionRecord
</span><span class="c1"></span>    <span class="c1">// 第一步：从k8s资源中获取原有的锁
</span><span class="c1"></span>	<span class="nx">oldLeaderElectionRecord</span><span class="p">,</span> <span class="nx">oldLeaderElectionRawRecord</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error retrieving resource lock %v: %v&#34;</span><span class="p">,</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nf">Describe</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
        <span class="c1">//资源对象不存在，进行锁资源创建
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">leaderElectionRecord</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error initially creating leader election record: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
		<span class="nx">le</span><span class="p">.</span><span class="nx">observedRecord</span> <span class="p">=</span> <span class="nx">leaderElectionRecord</span>
		<span class="nx">le</span><span class="p">.</span><span class="nx">observedTime</span> <span class="p">=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">}</span>

	<span class="c1">// 2. Record obtained, check the Identity &amp; Time
</span><span class="c1"></span>    <span class="c1">// 第二步，对比存储在k8s中的锁资源与上一次获取的锁资源是否一致
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">le</span><span class="p">.</span><span class="nx">observedRawRecord</span><span class="p">,</span> <span class="nx">oldLeaderElectionRawRecord</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">le</span><span class="p">.</span><span class="nx">observedRecord</span> <span class="p">=</span> <span class="o">*</span><span class="nx">oldLeaderElectionRecord</span>
		<span class="nx">le</span><span class="p">.</span><span class="nx">observedRawRecord</span> <span class="p">=</span> <span class="nx">oldLeaderElectionRawRecord</span>
		<span class="nx">le</span><span class="p">.</span><span class="nx">observedTime</span> <span class="p">=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
	<span class="p">}</span>
    <span class="c1">//判断持有的锁是否到期以及是否被自己持有
</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">HolderIdentity</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="nx">le</span><span class="p">.</span><span class="nx">observedTime</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">LeaseDuration</span><span class="p">).</span><span class="nf">After</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">!</span><span class="nx">le</span><span class="p">.</span><span class="nf">IsLeader</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;lock is held by %v and has not yet expired&#34;</span><span class="p">,</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">HolderIdentity</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// 3. We&#39;re going to try to update. The leaderElectionRecord is set to it&#39;s default
</span><span class="c1"></span>	<span class="c1">// here. Let&#39;s correct it before updating.
</span><span class="c1"></span>    <span class="c1">//第三步：自己现在是leader，但是分两组情况，上一次也是leader和首次变为leader
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">le</span><span class="p">.</span><span class="nf">IsLeader</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//自己本身就是leader则不需要更新AcquireTime和LeaderTransitions
</span><span class="c1"></span>		<span class="nx">leaderElectionRecord</span><span class="p">.</span><span class="nx">AcquireTime</span> <span class="p">=</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">AcquireTime</span>
		<span class="nx">leaderElectionRecord</span><span class="p">.</span><span class="nx">LeaderTransitions</span> <span class="p">=</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">LeaderTransitions</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//首次自己变为leader则更新leader的更换次数
</span><span class="c1"></span>		<span class="nx">leaderElectionRecord</span><span class="p">.</span><span class="nx">LeaderTransitions</span> <span class="p">=</span> <span class="nx">oldLeaderElectionRecord</span><span class="p">.</span><span class="nx">LeaderTransitions</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="p">}</span>

    <span class="c1">//更新锁资源，这里如果在 Get 和 Update 之间有变化，将会更新失败
</span><span class="c1"></span>	<span class="c1">// update the lock itself
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Lock</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">leaderElectionRecord</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to update lock: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="nx">le</span><span class="p">.</span><span class="nx">observedRecord</span> <span class="p">=</span> <span class="nx">leaderElectionRecord</span>
	<span class="nx">le</span><span class="p">.</span><span class="nx">observedTime</span> <span class="p">=</span> <span class="nx">le</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>在这一步如果发生并发操作怎么样？</strong></p>
<p>这里很重要一点就是利用到了k8s api操作的原子性：</p>
<p>在 <code>le.config.Lock.Get()</code> 中会获取到锁的对象，其中有一个 <code>resourceVersion</code> 字段用于标识一个资源对象的内部版本，每次更新操作都会更新其值。如果一个更新操作附加上了 <code>resourceVersion</code> 字段，那么 apiserver 就会通过验证当前 <code>resourceVersion</code> 的值与指定的值是否相匹配来确保在此次更新操作周期内没有其他的更新操作，从而保证了更新操作的原子性。</p>
<h2 id="总结">总结</h2>
<p>leaderelection 主要是利用了k8s API操作的原子性实现了一个分布式锁，在不断的竞争中进行选举。选中为leader的进行才会执行具体的业务代码，这在k8s中非常的常见，而且我们很方便的利用这个包完成组件的编写，从而实现组件的高可用，比如部署为一个多副本的Deployment，当leader的pod退出后会重新启动，可能锁就被其他pod获取继续执行。</p>
<p>完整代码：<a href="https://github.com/go-demo/leaderelection" target="_blank" rel="noopener noreffer">https://github.com/go-demo/leaderelection</a>
</p>
<hr/>
            <figure>
                <img src="https://silenceper.oss-cn-beijing.aliyuncs.com/qrcode/search_study_program.png" data-sizes="auto" data-src="https://silenceper.oss-cn-beijing.aliyuncs.com/qrcode/search_study_program.png" class="lazyautosizes ls-is-cached lazyloaded">
                <figcaption class="image-caption">关注公众号，获取最新文章推送</figcaption>
            </figure>
        </div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>本文于 2020-02-15 00:00 更新</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/blog/202002/kubernetes-leaderelection/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share"><span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="/blog/202002/kubernetes-leaderelection/" data-title="利用Kubernetes中的leaderelection实现组件高可用" data-hashtags="go,kubernetes"><i class="fab fa-twitter fa-fw"></i>
</a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="/blog/202002/kubernetes-leaderelection/" data-hashtag="go"><i class="fab fa-facebook-square fa-fw"></i>
</a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="/blog/202002/kubernetes-leaderelection/" data-title="利用Kubernetes中的leaderelection实现组件高可用" data-image="https://silenceper.oss-cn-beijing.aliyuncs.com/blog/bg/qiao.jpg"><i class="fab fa-weibo fa-fw"></i>
</a><a href="javascript:void(0);" title="分享到 人人" data-sharer="renren" data-url="/blog/202002/kubernetes-leaderelection/"><i class="fab fa-renren fa-fw"></i>
</a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="/blog/202002/kubernetes-leaderelection/" data-title="利用Kubernetes中的leaderelection实现组件高可用"><i class="loveit it-baidu-fill"></i>
</a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="/blog/202002/kubernetes-leaderelection/" data-title="利用Kubernetes中的leaderelection实现组件高可用"><i class="fab fa-evernote fa-fw"></i>
</a></span></div>
        </div>
    </div>

    <div class="post-info-more">
        <section><span>
                        <a href="/tags/go">
                            <i class="fas fa-tag fa-fw"></i>go
                        </a>
                    </span>&nbsp;<span>
                        <a href="/tags/kubernetes">
                            <i class="fas fa-tag fa-fw"></i>kubernetes
                        </a>
                    </span>&nbsp;</section>
        <section>
            <span><a href="javascript:window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/blog/202001/go-import-version/" class="prev" rel="prev" title="如何在Go项目中输出版本信息？"><i class="fas fa-angle-left fa-fw"></i>如何在Go项目中输出版本信息？</a>
            <a href="/blog/202003/kubernetes-event/" class="next" rel="next" title="分析kubernetes中的事件机制">分析kubernetes中的事件机制<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div class="comment"><div id="gitalk"></div><script>
            document.addEventListener("DOMContentLoaded", function(event) {
                var gitalk = new Gitalk({
                    id: '2020-02-15 00:00:00 \u002b0000 UTC',
                    title: '利用Kubernetes中的leaderelection实现组件高可用',
                    clientID: 'e708cc1fbc3e2613a24d',
                    clientSecret: 'ffa9552c4ef788a7f135fa7b9510ffc672d0b914',
                    repo: 'silenceper.github.io',
                    owner: 'silenceper',
                    admin: ['silenceper'],
                    body: decodeURI(location.href),
                });
                gitalk.render('gitalk');
            });
        </script>
        <noscript>
            Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by Gitalk.</a>
        </noscript></div>
    </article></div>
            </main><footer class="footer">
    <div class="copyright"><div class="copyright-line">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a>
        </div>

        <div class="copyright-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2016 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">silenceper</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
    </div>
</footer>
</div><a href="#" class="dynamic-to-top animated faster" id="dynamic-to-top">
            <span>&nbsp;</span>
        </a><script>
        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$", right: "$", display: false },
                    { left: "$$", right: "$$", display: true },
                    { left: "\\(", right: "\\)", display: false },
                    { left: "\\[", right: "\\]", display: true },]
            });
        });
    </script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css"><link rel="stylesheet" href="/css/lib/iconfont/iconfont.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.2/dist/smooth-scroll.polyfills.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js"></script><script src="/js/lib/sharer/sharer.min.js"></script><script src=/js/theme.min.js></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-139557989-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?fe23775b1a9ea11a6797646a56df1cc7";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script></body>
</html>
